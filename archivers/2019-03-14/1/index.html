<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>MemoryModule-实现原理 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>14</span>
<span class=rest>Mar 2019</span></div></div><div class=matter><h1 class=title>MemoryModule-实现原理</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#dos-header--stub>DOS header / stub</a></li><li><a href=#pe-header>PE header</a></li><li><a href=#section-header>Section header</a></li></ol><ol><li><a href=#allocate-memory>Allocate memory</a></li><li><a href=#copy-sections>Copy sections</a></li><li><a href=#base-relocation>Base relocation</a></li><li><a href=#resolve-imports>Resolve imports</a></li><li><a href=#protect-memory>Protect memory</a></li><li><a href=#notify-library>Notify library</a></li></ol><ol><li><a href=#downloads>Downloads</a></li><li><a href=#known-issues>Known issues</a></li><li><a href=#license>License</a></li></ol></nav></aside><h1 id=url>URL</h1><p><a href=https://github.com/fancycode/MemoryModule/blob/master/doc/readme.rst>https://github.com/fancycode/MemoryModule/blob/master/doc/readme.rst</a></p><h1 id=overview>Overview</h1><p>The default windows API functions to load external libraries into a program
(LoadLibrary, LoadLibraryEx) only work with files on the filesystem. It&rsquo;s
therefore impossible to load a DLL from memory.
But sometimes, you need exactly this functionality (e.g. you don&rsquo;t want to
distribute a lot of files or want to make disassembling harder). Common
workarounds for this problems are to write the DLL into a temporary file
first and import it from there. When the program terminates, the temporary
file gets deleted.</p><p>In this tutorial, I will describe first, how DLL files are structured and
will present some code that can be used to load a DLL completely from memory -
without storing on the disk first.</p><h1 id=windows-executables---the-pe-format>Windows executables - the PE format</h1><p>Most windows binaries that can contain executable code (.exe, .dll, .sys)
share a common file format that consists of the following parts:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| DOS header     |
</span></span><span style=display:flex><span>|                |
</span></span><span style=display:flex><span>| DOS stub       |
</span></span><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| PE header      |
</span></span><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| Section header |
</span></span><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| Section 1      |
</span></span><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| Section 2      |
</span></span><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| . . .          |
</span></span><span style=display:flex><span>+----------------+
</span></span><span style=display:flex><span>| Section n      |
</span></span><span style=display:flex><span>+----------------+
</span></span></code></pre></td></tr></table></div></div><p>All structures given below can be found in the header file <code>winnt.h</code>.</p><h2 id=dos-header--stub>DOS header / stub</h2><p>The DOS header is only used for backwards compatibility. It precedes the DOS
stub that normally just displays an error message about the program not being
able to be run from DOS mode.</p><p>Microsoft defines the DOS header as follows::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_DOS_HEADER {      <span style=color:#75715e>// DOS .EXE header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_magic;                     <span style=color:#75715e>// Magic number
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_cblp;                      <span style=color:#75715e>// Bytes on last page of file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_cp;                        <span style=color:#75715e>// Pages in file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_crlc;                      <span style=color:#75715e>// Relocations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_cparhdr;                   <span style=color:#75715e>// Size of header in paragraphs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_minalloc;                  <span style=color:#75715e>// Minimum extra paragraphs needed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_maxalloc;                  <span style=color:#75715e>// Maximum extra paragraphs needed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_ss;                        <span style=color:#75715e>// Initial (relative) SS value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_sp;                        <span style=color:#75715e>// Initial SP value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_csum;                      <span style=color:#75715e>// Checksum
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_ip;                        <span style=color:#75715e>// Initial IP value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_cs;                        <span style=color:#75715e>// Initial (relative) CS value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_lfarlc;                    <span style=color:#75715e>// File address of relocation table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_ovno;                      <span style=color:#75715e>// Overlay number
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_res[<span style=color:#ae81ff>4</span>];                    <span style=color:#75715e>// Reserved words
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_oemid;                     <span style=color:#75715e>// OEM identifier (for e_oeminfo)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_oeminfo;                   <span style=color:#75715e>// OEM information; e_oemid specific
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        WORD   e_res2[<span style=color:#ae81ff>10</span>];                  <span style=color:#75715e>// Reserved words
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        LONG   e_lfanew;                    <span style=color:#75715e>// File address of new exe header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      } IMAGE_DOS_HEADER, <span style=color:#f92672>*</span>PIMAGE_DOS_HEADER;
</span></span></code></pre></td></tr></table></div></div><h2 id=pe-header>PE header</h2><p>The PE header contains informations about the different sections inside the
executable that are used to store code and data or to define imports from other
libraries or exports this libraries provides.</p><p>It&rsquo;s defined as follows::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_NT_HEADERS {
</span></span><span style=display:flex><span>        DWORD Signature;
</span></span><span style=display:flex><span>        IMAGE_FILE_HEADER FileHeader;
</span></span><span style=display:flex><span>        IMAGE_OPTIONAL_HEADER32 OptionalHeader;
</span></span><span style=display:flex><span>    } IMAGE_NT_HEADERS32, <span style=color:#f92672>*</span>PIMAGE_NT_HEADERS32;
</span></span></code></pre></td></tr></table></div></div><p>The <code>FileHeader</code> describes the <em>physical</em> format of the file, i.e. contents, informations
about symbols, etc::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_FILE_HEADER {
</span></span><span style=display:flex><span>        WORD    Machine;
</span></span><span style=display:flex><span>        WORD    NumberOfSections;
</span></span><span style=display:flex><span>        DWORD   TimeDateStamp;
</span></span><span style=display:flex><span>        DWORD   PointerToSymbolTable;
</span></span><span style=display:flex><span>        DWORD   NumberOfSymbols;
</span></span><span style=display:flex><span>        WORD    SizeOfOptionalHeader;
</span></span><span style=display:flex><span>        WORD    Characteristics;
</span></span><span style=display:flex><span>    } IMAGE_FILE_HEADER, <span style=color:#f92672>*</span>PIMAGE_FILE_HEADER;
</span></span></code></pre></td></tr></table></div></div><p>.. _OptionalHeader:</p><p>The <code>OptionalHeader</code> contains informations about the <em>logical</em> format of the library,
including required OS version, memory requirements and entry points::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>    typedef struct _IMAGE_OPTIONAL_HEADER {
</span></span><span style=display:flex><span>        //
</span></span><span style=display:flex><span>        // Standard fields.
</span></span><span style=display:flex><span>        //
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        WORD    Magic;
</span></span><span style=display:flex><span>        BYTE    MajorLinkerVersion;
</span></span><span style=display:flex><span>        BYTE    MinorLinkerVersion;
</span></span><span style=display:flex><span>        DWORD   SizeOfCode;
</span></span><span style=display:flex><span>        DWORD   SizeOfInitializedData;
</span></span><span style=display:flex><span>        DWORD   SizeOfUninitializedData;
</span></span><span style=display:flex><span>        DWORD   AddressOfEntryPoint;
</span></span><span style=display:flex><span>        DWORD   BaseOfCode;
</span></span><span style=display:flex><span>        DWORD   BaseOfData;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        //
</span></span><span style=display:flex><span>        // NT additional fields.
</span></span><span style=display:flex><span>        //
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DWORD   ImageBase;
</span></span><span style=display:flex><span>        DWORD   SectionAlignment;
</span></span><span style=display:flex><span>        DWORD   FileAlignment;
</span></span><span style=display:flex><span>        WORD    MajorOperatingSystemVersion;
</span></span><span style=display:flex><span>        WORD    MinorOperatingSystemVersion;
</span></span><span style=display:flex><span>        WORD    MajorImageVersion;
</span></span><span style=display:flex><span>        WORD    MinorImageVersion;
</span></span><span style=display:flex><span>        WORD    MajorSubsystemVersion;
</span></span><span style=display:flex><span>        WORD    MinorSubsystemVersion;
</span></span><span style=display:flex><span>        DWORD   Win32VersionValue;
</span></span><span style=display:flex><span>        DWORD   SizeOfImage;
</span></span><span style=display:flex><span>        DWORD   SizeOfHeaders;
</span></span><span style=display:flex><span>        DWORD   CheckSum;
</span></span><span style=display:flex><span>        WORD    Subsystem;
</span></span><span style=display:flex><span>        WORD    DllCharacteristics;
</span></span><span style=display:flex><span>        DWORD   SizeOfStackReserve;
</span></span><span style=display:flex><span>        DWORD   SizeOfStackCommit;
</span></span><span style=display:flex><span>        DWORD   SizeOfHeapReserve;
</span></span><span style=display:flex><span>        DWORD   SizeOfHeapCommit;
</span></span><span style=display:flex><span>        DWORD   LoaderFlags;
</span></span><span style=display:flex><span>        DWORD   NumberOfRvaAndSizes;
</span></span><span style=display:flex><span>        IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];
</span></span><span style=display:flex><span>    } IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;
</span></span></code></pre></td></tr></table></div></div><p>.. _DataDirectory:</p><p>The <code>DataDirectory</code> contains 16 (<code>IMAGE_NUMBEROF_DIRECTORY_ENTRIES</code>) entries
defining the logical components of the library:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>=====</span> <span style=color:#f92672>==========================</span>
</span></span><span style=display:flex><span>Index Description
</span></span><span style=display:flex><span><span style=color:#f92672>=====</span> <span style=color:#f92672>==========================</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>     Exported functions
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>     Imported functions
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>     Resources
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>     Exception informations
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>     Security informations
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>     Base relocation table
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>     Debug informations
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span>     Architecture specific data
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>     Global pointer
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>     <span style=color:#a6e22e>Thread</span> local storage
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>    Load configuration
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>    Bound imports
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span>    Import address table
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>13</span>    Delay load imports
</span></span><span style=display:flex><span><span style=color:#f92672>-----</span> <span style=color:#f92672>--------------------------</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>14</span>    COM runtime descriptor
</span></span><span style=display:flex><span><span style=color:#f92672>=====</span> <span style=color:#f92672>==========================</span>
</span></span></code></pre></td></tr></table></div></div><p>For importing the DLL we only need the entries describing the imports and the
base relocation table. In order to provide access to the exported functions,
the exports entry is required.</p><h2 id=section-header>Section header</h2><p>The section header is stored after the OptionalHeader_ structure in the PE
header. Microsoft provides the macro <code>IMAGE_FIRST_SECTION</code> to get the start
address based on the PE header.</p><p>Actually, the section header is a list of informations about each section in
the file::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_SECTION_HEADER {
</span></span><span style=display:flex><span>        BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>                DWORD   PhysicalAddress;
</span></span><span style=display:flex><span>                DWORD   VirtualSize;
</span></span><span style=display:flex><span>        } Misc;
</span></span><span style=display:flex><span>        DWORD   VirtualAddress;
</span></span><span style=display:flex><span>        DWORD   SizeOfRawData;
</span></span><span style=display:flex><span>        DWORD   PointerToRawData;
</span></span><span style=display:flex><span>        DWORD   PointerToRelocations;
</span></span><span style=display:flex><span>        DWORD   PointerToLinenumbers;
</span></span><span style=display:flex><span>        WORD    NumberOfRelocations;
</span></span><span style=display:flex><span>        WORD    NumberOfLinenumbers;
</span></span><span style=display:flex><span>        DWORD   Characteristics;
</span></span><span style=display:flex><span>    } IMAGE_SECTION_HEADER, <span style=color:#f92672>*</span>PIMAGE_SECTION_HEADER;
</span></span></code></pre></td></tr></table></div></div><p>A section can contain code, data, relocation informations, resources, export or
import definitions, etc.</p><h1 id=loading-the-library>Loading the library</h1><p>To emulate the PE loader, we must first understand, which steps are neccessary
to load the file to memory and prepare the structures so they can be called from
other programs.</p><p>When issuing the API call <code>LoadLibrary</code>, Windows basically performs these tasks:</p><ol><li><p>Open the given file and check the DOS and PE headers.</p></li><li><p>Try to allocate a memory block of <code>PEHeader.OptionalHeader.SizeOfImage</code> bytes
at position <code>PEHeader.OptionalHeader.ImageBase</code>.</p></li><li><p>Parse section headers and copy sections to their addresses. The destination
address for each section, relative to the base of the allocated memory block,
is stored in the <code>VirtualAddress</code> attribute of the <code>IMAGE_SECTION_HEADER</code>
structure.</p></li><li><p>If the allocated memory block differs from <code>ImageBase</code>, various references in
the code and/or data sections must be adjusted. This is called <em>Base
relocation</em>.</p></li><li><p>The required imports for the library must be resolved by loading the
corresponding libraries.</p></li><li><p>The memory regions of the different sections must be protected depending on
the section&rsquo;s characteristics. Some sections are marked as <em>discardable</em>
and therefore can be safely freed at this point. These sections normally
contain temporary data that is only needed during the import, like the
informations for the base relocation.</p></li><li><p>Now the library is loaded completely. It must be notified about this by
calling the entry point using the flag <code>DLL_PROCESS_ATTACH</code>.</p></li></ol><p>In the following paragraphs, each step is described.</p><h2 id=allocate-memory>Allocate memory</h2><p>All memory required for the library must be reserved / allocated using
<code>VirtualAlloc</code>, as Windows provides functions to protect these memory blocks.
This is required to restrict access to the memory, like blocking write access
to the code or constant data.</p><p>The OptionalHeader_ structure defines the size of the required memory block
for the library. It must be reserved at the address specified by <code>ImageBase</code>
if possible::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    memory <span style=color:#f92672>=</span> <span style=color:#a6e22e>VirtualAlloc</span>((LPVOID)(PEHeader<span style=color:#f92672>-&gt;</span>OptionalHeader.ImageBase),
</span></span><span style=display:flex><span>        PEHeader<span style=color:#f92672>-&gt;</span>OptionalHeader.SizeOfImage,
</span></span><span style=display:flex><span>        MEM_RESERVE,
</span></span><span style=display:flex><span>        PAGE_READWRITE);
</span></span></code></pre></td></tr></table></div></div><p>If the reserved memory differs from the address given in <code>ImageBase</code>, base
relocation as described below must be done.</p><h2 id=copy-sections>Copy sections</h2><p>Once the memory has been reserved, the file contents can be copied to the
system. The section header must get evaluated in order to determine the
position in the file and the target area in memory.</p><p>Before copying the data, the memory block must get committed::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    dest <span style=color:#f92672>=</span> <span style=color:#a6e22e>VirtualAlloc</span>(baseAddress <span style=color:#f92672>+</span> section<span style=color:#f92672>-&gt;</span>VirtualAddress,
</span></span><span style=display:flex><span>        section<span style=color:#f92672>-&gt;</span>SizeOfRawData,
</span></span><span style=display:flex><span>        MEM_COMMIT,
</span></span><span style=display:flex><span>        PAGE_READWRITE);
</span></span></code></pre></td></tr></table></div></div><p>Sections without data in the file (like data sections for the used variables)
have a <code>SizeOfRawData</code> of <code>0</code>, so you can use the <code>SizeOfInitializedData</code>
or <code>SizeOfUninitializedData</code> of the OptionalHeader_. Which one must get
choosen depending on the bit flags <code>IMAGE_SCN_CNT_INITIALIZED_DATA</code> and
<code>IMAGE_SCN_CNT_UNINITIALIZED_DATA</code> that may be set in the section`s
characteristics.</p><h2 id=base-relocation>Base relocation</h2><p>All memory addresses in the code / data sections of a library are stored relative
to the address defined by <code>ImageBase</code> in the OptionalHeader_. If the library
can&rsquo;t be imported to this memory address, the references must get adjusted
=> <em>relocated</em>. The file format helps for this by storing informations about
all these references in the base relocation table, which can be found in the
directory entry 5 of the DataDirectory_ in the OptionalHeader_.</p><p>This table consists of a series of this structure</p><p>::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_BASE_RELOCATION {
</span></span><span style=display:flex><span>        DWORD   VirtualAddress;
</span></span><span style=display:flex><span>        DWORD   SizeOfBlock;
</span></span><span style=display:flex><span>    } IMAGE_BASE_RELOCATION;
</span></span></code></pre></td></tr></table></div></div><p>It contains <code>(SizeOfBlock - IMAGE_SIZEOF_BASE_RELOCATION) / 2</code> entries of 16 bits
each. The upper 4 bits define the type of relocation, the lower 12 bits define
the offset relative to the <code>VirtualAddress</code>.</p><p>The only types that seem to be used in DLLs are</p><p>IMAGE_REL_BASED_ABSOLUTE
No operation relocation. Used for padding.
IMAGE_REL_BASED_HIGHLOW
Add the delta between the <code>ImageBase</code> and the allocated memory block to the
32 bits found at the offset.</p><h2 id=resolve-imports>Resolve imports</h2><p>The directory entry 1 of the DataDirectory_ in the OptionalHeader_ specifies
a list of libraries to import symbols from. Each entry in this list is defined
as follows::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_IMPORT_DESCRIPTOR {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>            DWORD   Characteristics;            <span style=color:#75715e>// 0 for terminating null import descriptor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            DWORD   OriginalFirstThunk;         <span style=color:#75715e>// RVA to original unbound IAT (PIMAGE_THUNK_DATA)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        };
</span></span><span style=display:flex><span>        DWORD   TimeDateStamp;                  <span style=color:#75715e>// 0 if not bound,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                                <span style=color:#75715e>// -1 if bound, and real date\time stamp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                                <span style=color:#75715e>//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                                <span style=color:#75715e>// O.W. date/time stamp of DLL bound to (Old BIND)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        DWORD   ForwarderChain;                 <span style=color:#75715e>// -1 if no forwarders
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DWORD   Name;
</span></span><span style=display:flex><span>        DWORD   FirstThunk;                     <span style=color:#75715e>// RVA to IAT (if bound this IAT has actual addresses)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } IMAGE_IMPORT_DESCRIPTOR;
</span></span></code></pre></td></tr></table></div></div><p>The <code>Name</code> entry describes the offset to the NULL-terminated string of the library
name (e.g. <code>KERNEL32.DLL</code>). The <code>OriginalFirstThunk</code> entry points to a list
of references to the function names to import from the external library.
<code>FirstThunk</code> points to a list of addresses that gets filled with pointers to
the imported symbols.</p><p>When we resolve the imports, we walk both lists in parallel, import the function
defined by the name in the first list and store the pointer to the symbol in the
second list::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    nameRef <span style=color:#f92672>=</span> (DWORD <span style=color:#f92672>*</span>)(baseAddress <span style=color:#f92672>+</span> importDesc<span style=color:#f92672>-&gt;</span>OriginalFirstThunk);
</span></span><span style=display:flex><span>    symbolRef <span style=color:#f92672>=</span> (DWORD <span style=color:#f92672>*</span>)(baseAddress <span style=color:#f92672>+</span> importDesc<span style=color:#f92672>-&gt;</span>FirstThunk);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (; <span style=color:#f92672>*</span>nameRef; nameRef<span style=color:#f92672>++</span>, symbolRef<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        PIMAGE_IMPORT_BY_NAME thunkData <span style=color:#f92672>=</span> (PIMAGE_IMPORT_BY_NAME)(codeBase <span style=color:#f92672>+</span> <span style=color:#f92672>*</span>nameRef);
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>symbolRef <span style=color:#f92672>=</span> (DWORD)<span style=color:#a6e22e>GetProcAddress</span>(handle, (LPCSTR)<span style=color:#f92672>&amp;</span>thunkData<span style=color:#f92672>-&gt;</span>Name);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>funcRef <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>handleImportError</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><h2 id=protect-memory>Protect memory</h2><p>Every section specifies permission flags in it&rsquo;s <code>Characteristics</code> entry.
These flags can be one or a combination of</p><p>IMAGE_SCN_MEM_EXECUTE
The section contains data that can be executed.</p><p>IMAGE_SCN_MEM_READ
The section contains data that is readable.</p><p>IMAGE_SCN_MEM_WRITE
The section contains data that is writeable.</p><p>These flags must get mapped to the protection flags</p><ul><li>PAGE_NOACCESS</li><li>PAGE_WRITECOPY</li><li>PAGE_READONLY</li><li>PAGE_READWRITE</li><li>PAGE_EXECUTE</li><li>PAGE_EXECUTE_WRITECOPY</li><li>PAGE_EXECUTE_READ</li><li>PAGE_EXECUTE_READWRITE</li></ul><p>Now, the function <code>VirtualProtect</code> can be used to limit access to the memory.
If the program tries to access it in a unauthorized way, an exception gets
raised by Windows.</p><p>In addition the section flags above, the following can be added:</p><p>IMAGE_SCN_MEM_DISCARDABLE
The data in this section can be freed after the import. Usually this is
specified for relocation data.</p><p>IMAGE_SCN_MEM_NOT_CACHED
The data in this section must not get cached by Windows. Add the bit
flag <code>PAGE_NOCACHE</code> to the protection flags above.</p><h2 id=notify-library>Notify library</h2><p>The last thing to do is to call the DLL entry point (defined by
<code>AddressOfEntryPoint</code>) and so notifying the library about being attached
to a process.</p><p>The function at the entry point is defined as</p><p>::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>BOOL</span> (WINAPI <span style=color:#f92672>*</span>DllEntryProc)(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpReserved);
</span></span></code></pre></td></tr></table></div></div><p>So the last code we need to execute is</p><p>::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	DllEntryProc entry <span style=color:#f92672>=</span> (DllEntryProc)(baseAddress <span style=color:#f92672>+</span> PEHeader<span style=color:#f92672>-&gt;</span>OptionalHeader.AddressOfEntryPoint);
</span></span><span style=display:flex><span>	(<span style=color:#f92672>*</span>entry)((HINSTANCE)baseAddress, DLL_PROCESS_ATTACH, <span style=color:#ae81ff>0</span>);
</span></span></code></pre></td></tr></table></div></div><p>Afterwards we can use the exported functions as with any normal library.</p><h1 id=exported-functions>Exported functions</h1><p>If you want to access the functions that are exported by the library, you need to find the entry
point to a symbol, i.e. the name of the function to call.</p><p>The directory entry 0 of the DataDirectory_ in the OptionalHeader_ contains informations about
the exported functions. It&rsquo;s defined as follows::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _IMAGE_EXPORT_DIRECTORY {
</span></span><span style=display:flex><span>        DWORD   Characteristics;
</span></span><span style=display:flex><span>        DWORD   TimeDateStamp;
</span></span><span style=display:flex><span>        WORD    MajorVersion;
</span></span><span style=display:flex><span>        WORD    MinorVersion;
</span></span><span style=display:flex><span>        DWORD   Name;
</span></span><span style=display:flex><span>        DWORD   Base;
</span></span><span style=display:flex><span>        DWORD   NumberOfFunctions;
</span></span><span style=display:flex><span>        DWORD   NumberOfNames;
</span></span><span style=display:flex><span>        DWORD   AddressOfFunctions;     <span style=color:#75715e>// RVA from base of image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DWORD   AddressOfNames;         <span style=color:#75715e>// RVA from base of image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        DWORD   AddressOfNameOrdinals;  <span style=color:#75715e>// RVA from base of image
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } IMAGE_EXPORT_DIRECTORY, <span style=color:#f92672>*</span>PIMAGE_EXPORT_DIRECTORY;
</span></span></code></pre></td></tr></table></div></div><p>First thing to do, is to map the name of the function to the ordinal number of the exported
symbol. Therefore, just walk the arrays defined by <code>AddressOfNames</code> and <code>AddressOfNameOrdinals</code>
parallel until you found the required name.</p><p>Now you can use the ordinal number to read the address by evaluating the n-th element of the
<code>AddressOfFunctions</code> array.</p><h1 id=freeing-the-library>Freeing the library</h1><p>To free the custom loaded library, perform the steps</p><ul><li><p>Call entry point to notify library about being detached::</p><p>DllEntryProc entry = (DllEntryProc)(baseAddress + PEHeader->OptionalHeader.AddressOfEntryPoint);
(*entry)((HINSTANCE)baseAddress, DLL_PROCESS_ATTACH, 0);</p></li><li><p>Free external libraries used to resolve imports.</p></li><li><p>Free allocated memory.</p></li></ul><h1 id=memorymodule>MemoryModule</h1><p>MemoryModule is a C-library that can be used to load a DLL from memory.</p><p>The interface is very similar to the standard methods for loading of libraries::</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>HMEMORYMODULE;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    HMEMORYMODULE <span style=color:#a6e22e>MemoryLoadLibrary</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>, <span style=color:#66d9ef>size_t</span>);
</span></span><span style=display:flex><span>    FARPROC <span style=color:#a6e22e>MemoryGetProcAddress</span>(HMEMORYMODULE, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>MemoryFreeLibrary</span>(HMEMORYMODULE);
</span></span></code></pre></td></tr></table></div></div><h2 id=downloads>Downloads</h2><p>The latest development release can always be grabbed from Github at
<a href=http://github.com/fancycode/MemoryModule/>http://github.com/fancycode/MemoryModule/</a></p><h2 id=known-issues>Known issues</h2><ul><li>All memory that is not protected by section flags is gets committed using <code>PAGE_READWRITE</code>.
I don&rsquo;t know if this is correct.</li></ul><h2 id=license>License</h2><p>Since version 0.0.2, the MemoryModule library is released under the Mozilla Public License (MPL).
Version 0.0.1 has been released unter the Lesser General Public License (LGPL).</p><p>It is provided as-is without ANY warranty. You may use it at your own risk.</p><h1 id=copyright>Copyright</h1><p>The MemoryModule library and this tutorial are
Copyright (c) 2004-2015 by Joachim Bauch.</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#dos-header--stub>DOS header / stub</a></li><li><a href=#pe-header>PE header</a></li><li><a href=#section-header>Section header</a></li></ol><ol><li><a href=#allocate-memory>Allocate memory</a></li><li><a href=#copy-sections>Copy sections</a></li><li><a href=#base-relocation>Base relocation</a></li><li><a href=#resolve-imports>Resolve imports</a></li><li><a href=#protect-memory>Protect memory</a></li><li><a href=#notify-library>Notify library</a></li></ol><ol><li><a href=#downloads>Downloads</a></li><li><a href=#known-issues>Known issues</a></li><li><a href=#license>License</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2019 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>