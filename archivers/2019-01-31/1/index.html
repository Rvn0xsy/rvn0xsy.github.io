<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>BMP位图隐写 - 倾旋的博客</title><meta name=theme-color><meta name=description content='0x01 BMP简介
BMP（全称Bitmap）是Windows操作系统中的标准图像文件格式，可以分成两类：设备有向量相关位图（DDB）和设备无向量相关位图（DIB），使用非常广。它采用位映射存储格式，除了图像深度可选以外，不采用其他任何压缩，因此，BMP文件所占用的空间很大。BMP文件的图像深度可选lbit、4bit、8bit及24bit。BMP文件存储数据时，图像的扫描方式是按从左到右、从下到上的顺序。由于BMP文件格式是Windows环境中交换与图有关的数据的一种标准，因此在Windows环境中运行的图形图像软件都支持BMP图像格式。
典型的BMP图像文件由四部分组成：

1：位图头文件数据结构，它包含BMP图像文件的类型、显示内容等信息；
2：位图信息数据结构，它包含有BMP图像的宽、高、压缩方法，以及定义颜色等信息；
3：调色板，这个部分是可选的，有些位图需要调色板，有些位图，比如真彩色图（24位的BMP）就不需要调色板；
4：位图数据，这部分的内容根据BMP位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用调色板中颜色索引值。

当然，我们不需要了解那么多，唯一比较重要的就是文件数据结构。
0x02 BMP文件格式
第一个知识点：BM (0x4D 0x42)

所有的BMP文件都以这两个字节开头（固定格式）。
详解大端模式和小端模式
由于个人计算机都是以小端存储的，所以你看到的0x4D 0x42都要从0x4D由右向左开始读取。
第二个知识点：BMP文件大小

0x00072D46 = 470342（Byte） = 470KB
所以这个BMP的文件大小是470KB，也就是说一个图片软件，校验图片是否损坏、是否完整，都是通过读取这四个字节来判断的。
当然在Web领域也是一样，在图片进行渲染的过程中也会判断文件是否完整。
0x03 偏移量-像素位置
BMP的格式我们不介绍太多，关键是找到像素的偏移量就够了，有了偏移量就能够覆盖像素，每一个像素的宽度是3个字节，也就是色光三原色的RGB值。

其中36前面的00 00 00 00是保留位，没有意义。
36 00 00 00(0x36)转换成十进制是54。
也就是说，从BMP文件的第一个字节开始，到第54个字节就是像素的开始。

三个D8就是一个像素。
0x04 写入内容
这个过程中，我们可以写入shellcode、PE文件、字符串等。
这里我只是写入了一个“Hello world !!!”：

// ConsoleApplication1.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there.
//

#include <iostream>
#include <Windows.h>
#include <winsock.h>
// int WinMain(HINSTANCE hinstance,HINSTANCE hprevinstance,LPSTR lpcmdline,int ncmdshow)
int main()
{
	CHAR text[] = "Hello world !!!";
	LPCWCHAR pFilename = TEXT("C:\\Users\\Rvn0xsy\\source\\repos\\ConsoleApplication1\\Debug\\splash.bmp");
	LPCWCHAR pSaveFilename = TEXT("C:\\Users\\Rvn0xsy\\source\\repos\\ConsoleApplication1\\Debug\\save.bmp");
	// 创建文件句柄，打开图片
	HANDLE hFile = CreateFile(pFilename, GENERIC_ALL, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
	if (hFile == INVALID_HANDLE_VALUE) {
		std::wcout << GetLastError();
		MessageBox(0, TEXT("CreateFile"), TEXT("Error"), MB_OK);
		return 0;
	}
	// 获取文件大小
	DWORD dwFileSize;
	dwFileSize=GetFileSize(hFile, NULL);
	// 申请一个与文件大小对应的内存空间
	CHAR * lpBuffer =(CHAR *) HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dwFileSize);
	// 将文件内容读入内存
	ReadFile(hFile, lpBuffer, dwFileSize, &amp;dwFileSize, NULL);
	// 获取第一个像素点对应的首字节
	DWORD * point = (DWORD*)(lpBuffer + 10);

	// 获取首个像素地址
	CHAR* lpData = (lpBuffer + (*point));
	// 写入内容
	CopyMemory(lpData, text, sizeof(text));
	//创建保存副本
	HANDLE hSave = CreateFile(pSaveFilename, GENERIC_ALL, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
	WriteFile(hSave, lpBuffer, dwFileSize, &amp;dwFileSize, NULL); // 写入文件
	CloseHandle(hSave); // 保存

	// 释放堆
	HeapFree(GetProcessHeap(), 0, lpBuffer);

	// 关闭文件
	CloseHandle(hFile);
}
效果如下：'><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="BMP位图隐写"><meta itemprop=description content="快过年了，最近学不进去东西，总结一下之前的基础知识，顺便结合起来。"><meta itemprop=datePublished content="2019-01-31T00:00:00+00:00"><meta itemprop=dateModified content="2019-01-31T00:00:00+00:00"><meta itemprop=wordCount content="198"><meta itemprop=keywords content="Windows"><meta property="og:url" content="https://payloads.online/archivers/2019-01-31/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="BMP位图隐写"><meta property="og:description" content="快过年了，最近学不进去东西，总结一下之前的基础知识，顺便结合起来。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-01-31T00:00:00+00:00"><meta property="article:modified_time" content="2019-01-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BMP位图隐写"><meta name=twitter:description content="快过年了，最近学不进去东西，总结一下之前的基础知识，顺便结合起来。"><link rel=canonical href=https://payloads.online/archivers/2019-01-31/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">BMP位图隐写</h1><div class="text-xs antialiased opacity-60"><time>Jan 31, 2019</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x01-bmp简介>0x01 BMP简介</h2><p>BMP（全称Bitmap）是Windows操作系统中的标准图像文件格式，可以分成两类：设备有向量相关位图（DDB）和设备无向量相关位图（DIB），使用非常广。它采用位映射存储格式，除了图像深度可选以外，不采用其他任何压缩，因此，BMP文件所占用的空间很大。BMP文件的图像深度可选lbit、4bit、8bit及24bit。BMP文件存储数据时，图像的扫描方式是按从左到右、从下到上的顺序。由于BMP文件格式是Windows环境中交换与图有关的数据的一种标准，因此在Windows环境中运行的图形图像软件都支持BMP图像格式。</p><p>典型的BMP图像文件由四部分组成：</p><ul><li>1：位图头文件数据结构，它包含BMP图像文件的类型、显示内容等信息；</li><li>2：位图信息数据结构，它包含有BMP图像的宽、高、压缩方法，以及定义颜色等信息；</li><li>3：调色板，这个部分是可选的，有些位图需要调色板，有些位图，比如真彩色图（24位的BMP）就不需要调色板；</li><li>4：位图数据，这部分的内容根据BMP位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用调色板中颜色索引值。</li></ul><p>当然，我们不需要了解那么多，唯一比较重要的就是文件数据结构。</p><h2 id=0x02-bmp文件格式>0x02 BMP文件格式</h2><p>第一个知识点：BM (0x4D 0x42)</p><p><img src=https://images.payloads.online/4be2fdaa-4f5f-11ec-aab0-00d861bf4abb.png alt=2019-01-31-16-00-25></p><p>所有的BMP文件都以这两个字节开头（固定格式）。</p><p><a href=https://www.cnblogs.com/mingcaoyouxin/p/4286310.html>详解大端模式和小端模式</a></p><p><strong>由于个人计算机都是以小端存储的，所以你看到的0x4D 0x42都要从0x4D由右向左开始读取。</strong></p><p>第二个知识点：BMP文件大小</p><p><img src=https://images.payloads.online/4c1ecef2-4f5f-11ec-a65b-00d861bf4abb.png alt=2019-01-31-16-02-53></p><p>0x00072D46 = 470342（Byte） = 470KB</p><p>所以这个BMP的文件大小是470KB，也就是说一个图片软件，校验图片是否损坏、是否完整，都是通过读取这四个字节来判断的。</p><p>当然在Web领域也是一样，在图片进行渲染的过程中也会判断文件是否完整。</p><h2 id=0x03-偏移量-像素位置>0x03 偏移量-像素位置</h2><p>BMP的格式我们不介绍太多，关键是找到像素的偏移量就够了，有了偏移量就能够覆盖像素，每一个像素的宽度是3个字节，也就是色光三原色的RGB值。</p><p><img src=https://images.payloads.online/4c568f90-4f5f-11ec-8291-00d861bf4abb.png alt=2019-01-31-16-16-59></p><p><strong>其中36前面的00 00 00 00是保留位，没有意义。</strong></p><p>36 00 00 00(0x36)转换成十进制是54。</p><p>也就是说，从BMP文件的第一个字节开始，到第54个字节就是像素的开始。</p><p><img src=https://images.payloads.online/4c8c9144-4f5f-11ec-982e-00d861bf4abb.png alt=2019-01-31-16-21-16></p><p>三个D8就是一个像素。</p><h2 id=0x04-写入内容>0x04 写入内容</h2><p>这个过程中，我们可以写入shellcode、PE文件、字符串等。</p><p>这里我只是写入了一个“Hello world !!!”：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ConsoleApplication1.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;winsock.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// int WinMain(HINSTANCE hinstance,HINSTANCE hprevinstance,LPSTR lpcmdline,int ncmdshow)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	CHAR text[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello world !!!&#34;</span>;
</span></span><span style=display:flex><span>	LPCWCHAR pFilename <span style=color:#f92672>=</span> <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Users</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Rvn0xsy</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>source</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>repos</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>ConsoleApplication1</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Debug</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>splash.bmp&#34;</span>);
</span></span><span style=display:flex><span>	LPCWCHAR pSaveFilename <span style=color:#f92672>=</span> <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Users</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Rvn0xsy</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>source</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>repos</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>ConsoleApplication1</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Debug</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>save.bmp&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建文件句柄，打开图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	HANDLE hFile <span style=color:#f92672>=</span> <span style=color:#a6e22e>CreateFile</span>(pFilename, GENERIC_ALL, <span style=color:#ae81ff>0</span>, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (hFile <span style=color:#f92672>==</span> INVALID_HANDLE_VALUE) {
</span></span><span style=display:flex><span>		std<span style=color:#f92672>::</span>wcout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>GetLastError</span>();
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>MessageBox</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;CreateFile&#34;</span>), <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Error&#34;</span>), MB_OK);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取文件大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	DWORD dwFileSize;
</span></span><span style=display:flex><span>	dwFileSize<span style=color:#f92672>=</span><span style=color:#a6e22e>GetFileSize</span>(hFile, NULL);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 申请一个与文件大小对应的内存空间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	CHAR <span style=color:#f92672>*</span> lpBuffer <span style=color:#f92672>=</span>(CHAR <span style=color:#f92672>*</span>) <span style=color:#a6e22e>HeapAlloc</span>(<span style=color:#a6e22e>GetProcessHeap</span>(), HEAP_ZERO_MEMORY, dwFileSize);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将文件内容读入内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ReadFile</span>(hFile, lpBuffer, dwFileSize, <span style=color:#f92672>&amp;</span>dwFileSize, NULL);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取第一个像素点对应的首字节
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	DWORD <span style=color:#f92672>*</span> point <span style=color:#f92672>=</span> (DWORD<span style=color:#f92672>*</span>)(lpBuffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取首个像素地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	CHAR<span style=color:#f92672>*</span> lpData <span style=color:#f92672>=</span> (lpBuffer <span style=color:#f92672>+</span> (<span style=color:#f92672>*</span>point));
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 写入内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CopyMemory</span>(lpData, text, <span style=color:#66d9ef>sizeof</span>(text));
</span></span><span style=display:flex><span>	<span style=color:#75715e>//创建保存副本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	HANDLE hSave <span style=color:#f92672>=</span> <span style=color:#a6e22e>CreateFile</span>(pSaveFilename, GENERIC_ALL, <span style=color:#ae81ff>0</span>, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WriteFile</span>(hSave, lpBuffer, dwFileSize, <span style=color:#f92672>&amp;</span>dwFileSize, NULL); <span style=color:#75715e>// 写入文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CloseHandle</span>(hSave); <span style=color:#75715e>// 保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 释放堆
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>HeapFree</span>(<span style=color:#a6e22e>GetProcessHeap</span>(), <span style=color:#ae81ff>0</span>, lpBuffer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 关闭文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CloseHandle</span>(hFile);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>效果如下：</p><p><img src=https://images.payloads.online/4ccb0744-4f5f-11ec-8fae-00d861bf4abb.png alt=2019-01-31-16-24-59></p><p>对图片的影响只是像素级别的，不会出现缺损问题。</p><h2 id=0x05-科普>0x05 科普</h2><p>使用CMD命令制作生成图片木马很可能会导致图片缺损，原因是有概率会覆盖掉偏移量、或者代码超出了偏移范围。</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2019-02-23/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>驱动人生供应链木马攻击2019.1.30变种木马分析</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2019-01-26/2/><span>Visual Studio 调试DLL</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>