<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>BMP位图隐写 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>31</span>
<span class=rest>Jan 2019</span></div></div><div class=matter><h1 class=title>BMP位图隐写</h1></div></div><h2 id=0x01-bmp简介>0x01 BMP简介</h2><p>BMP（全称Bitmap）是Windows操作系统中的标准图像文件格式，可以分成两类：设备有向量相关位图（DDB）和设备无向量相关位图（DIB），使用非常广。它采用位映射存储格式，除了图像深度可选以外，不采用其他任何压缩，因此，BMP文件所占用的空间很大。BMP文件的图像深度可选lbit、4bit、8bit及24bit。BMP文件存储数据时，图像的扫描方式是按从左到右、从下到上的顺序。由于BMP文件格式是Windows环境中交换与图有关的数据的一种标准，因此在Windows环境中运行的图形图像软件都支持BMP图像格式。</p><p>典型的BMP图像文件由四部分组成：</p><ul><li>1：位图头文件数据结构，它包含BMP图像文件的类型、显示内容等信息；</li><li>2：位图信息数据结构，它包含有BMP图像的宽、高、压缩方法，以及定义颜色等信息；</li><li>3：调色板，这个部分是可选的，有些位图需要调色板，有些位图，比如真彩色图（24位的BMP）就不需要调色板；</li><li>4：位图数据，这部分的内容根据BMP位图使用的位数不同而不同，在24位图中直接使用RGB，而其他的小于24位的使用调色板中颜色索引值。</li></ul><p>当然，我们不需要了解那么多，唯一比较重要的就是文件数据结构。</p><h2 id=0x02-bmp文件格式>0x02 BMP文件格式</h2><p>第一个知识点：BM (0x4D 0x42)</p><p><img src=https://images.payloads.online/4be2fdaa-4f5f-11ec-aab0-00d861bf4abb.png alt=2019-01-31-16-00-25></p><p>所有的BMP文件都以这两个字节开头（固定格式）。</p><p><a href=https://www.cnblogs.com/mingcaoyouxin/p/4286310.html>详解大端模式和小端模式</a></p><p><strong>由于个人计算机都是以小端存储的，所以你看到的0x4D 0x42都要从0x4D由右向左开始读取。</strong></p><p>第二个知识点：BMP文件大小</p><p><img src=https://images.payloads.online/4c1ecef2-4f5f-11ec-a65b-00d861bf4abb.png alt=2019-01-31-16-02-53></p><p>0x00072D46 = 470342（Byte） = 470KB</p><p>所以这个BMP的文件大小是470KB，也就是说一个图片软件，校验图片是否损坏、是否完整，都是通过读取这四个字节来判断的。</p><p>当然在Web领域也是一样，在图片进行渲染的过程中也会判断文件是否完整。</p><h2 id=0x03-偏移量-像素位置>0x03 偏移量-像素位置</h2><p>BMP的格式我们不介绍太多，关键是找到像素的偏移量就够了，有了偏移量就能够覆盖像素，每一个像素的宽度是3个字节，也就是色光三原色的RGB值。</p><p><img src=https://images.payloads.online/4c568f90-4f5f-11ec-8291-00d861bf4abb.png alt=2019-01-31-16-16-59></p><p><strong>其中36前面的00 00 00 00是保留位，没有意义。</strong></p><p>36 00 00 00(0x36)转换成十进制是54。</p><p>也就是说，从BMP文件的第一个字节开始，到第54个字节就是像素的开始。</p><p><img src=https://images.payloads.online/4c8c9144-4f5f-11ec-982e-00d861bf4abb.png alt=2019-01-31-16-21-16></p><p>三个D8就是一个像素。</p><h2 id=0x04-写入内容>0x04 写入内容</h2><p>这个过程中，我们可以写入shellcode、PE文件、字符串等。</p><p>这里我只是写入了一个“Hello world !!!”：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ConsoleApplication1.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;winsock.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// int WinMain(HINSTANCE hinstance,HINSTANCE hprevinstance,LPSTR lpcmdline,int ncmdshow)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	CHAR text[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello world !!!&#34;</span>;
</span></span><span style=display:flex><span>	LPCWCHAR pFilename <span style=color:#f92672>=</span> <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Users</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Rvn0xsy</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>source</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>repos</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>ConsoleApplication1</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Debug</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>splash.bmp&#34;</span>);
</span></span><span style=display:flex><span>	LPCWCHAR pSaveFilename <span style=color:#f92672>=</span> <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Users</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Rvn0xsy</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>source</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>repos</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>ConsoleApplication1</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Debug</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>save.bmp&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建文件句柄，打开图片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	HANDLE hFile <span style=color:#f92672>=</span> <span style=color:#a6e22e>CreateFile</span>(pFilename, GENERIC_ALL, <span style=color:#ae81ff>0</span>, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (hFile <span style=color:#f92672>==</span> INVALID_HANDLE_VALUE) {
</span></span><span style=display:flex><span>		std<span style=color:#f92672>::</span>wcout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>GetLastError</span>();
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>MessageBox</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;CreateFile&#34;</span>), <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Error&#34;</span>), MB_OK);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取文件大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	DWORD dwFileSize;
</span></span><span style=display:flex><span>	dwFileSize<span style=color:#f92672>=</span><span style=color:#a6e22e>GetFileSize</span>(hFile, NULL);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 申请一个与文件大小对应的内存空间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	CHAR <span style=color:#f92672>*</span> lpBuffer <span style=color:#f92672>=</span>(CHAR <span style=color:#f92672>*</span>) <span style=color:#a6e22e>HeapAlloc</span>(<span style=color:#a6e22e>GetProcessHeap</span>(), HEAP_ZERO_MEMORY, dwFileSize);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将文件内容读入内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ReadFile</span>(hFile, lpBuffer, dwFileSize, <span style=color:#f92672>&amp;</span>dwFileSize, NULL);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取第一个像素点对应的首字节
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	DWORD <span style=color:#f92672>*</span> point <span style=color:#f92672>=</span> (DWORD<span style=color:#f92672>*</span>)(lpBuffer <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取首个像素地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	CHAR<span style=color:#f92672>*</span> lpData <span style=color:#f92672>=</span> (lpBuffer <span style=color:#f92672>+</span> (<span style=color:#f92672>*</span>point));
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 写入内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CopyMemory</span>(lpData, text, <span style=color:#66d9ef>sizeof</span>(text));
</span></span><span style=display:flex><span>	<span style=color:#75715e>//创建保存副本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	HANDLE hSave <span style=color:#f92672>=</span> <span style=color:#a6e22e>CreateFile</span>(pSaveFilename, GENERIC_ALL, <span style=color:#ae81ff>0</span>, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WriteFile</span>(hSave, lpBuffer, dwFileSize, <span style=color:#f92672>&amp;</span>dwFileSize, NULL); <span style=color:#75715e>// 写入文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CloseHandle</span>(hSave); <span style=color:#75715e>// 保存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 释放堆
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>HeapFree</span>(<span style=color:#a6e22e>GetProcessHeap</span>(), <span style=color:#ae81ff>0</span>, lpBuffer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 关闭文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CloseHandle</span>(hFile);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>效果如下：</p><p><img src=https://images.payloads.online/4ccb0744-4f5f-11ec-8fae-00d861bf4abb.png alt=2019-01-31-16-24-59></p><p>对图片的影响只是像素级别的，不会出现缺损问题。</p><h2 id=0x05-科普>0x05 科普</h2><p>使用CMD命令制作生成图片木马很可能会导致图片缺损，原因是有概率会覆盖掉偏移量、或者代码超出了偏移范围。</p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>