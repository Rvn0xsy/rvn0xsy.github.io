<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Windows活动目录中的LDAP - 倾旋的博客</title><meta name=theme-color><meta name=description content="LDAP基础概念
条目（Entry）
一个条目有若干个属性，每一个属性应对一个或多个值，有些条目可以包含若干个子条目。
这里使用Active Directory Explorer连接一个域环境进行展示：

其中 DC=domain.16,DC=local 以下（包含本身），都是条目，每一个条目点开都拥有N个属性名和属性值，右侧密密麻麻的就是属性名和属性值。
识别名（Distinguished Name, DN）
它表示条目在LDAP目录树中从根出发的绝对路径，是条目的唯一标识。其中上一节中的DC=domain16,DC=local就是域的根，这个根的DN就是DC=domain16,DC=local，根的DN通常被称为Base DN。

我们随便点开一个计算机条目观看，发现他们都拥有一个objectCatory属性，这个属性的值就是用于描述条目的路径，也就是说，如果要从LDAP中精确的寻找到某个对象，就可以通过DN来寻找，编程的思路也是如此。
相对识别名（Relative Distinguished Name, RDN）
例如上方的USERPC1的DN为：CN=USERPC1,CN=Computers,DC=domain16,DC=local，那么CN=USERPC1,CN=Computers就是RDN，RDN是相对于Base DN的DN。
在一般情况下，RDN 以 dc=、ou=、c=、o= 开头的条目为容器，可以包含子条目。
模式（Schema）
模式是对象类（ObjectClass）、属性类型（AttributeType）、属性语法（Syntax）和匹配规则（MatchingRules）的集合。
对象类（ObjectClass）
对象类封装了必选的属性和可选的属性，同时对象类也是支持继承的。通过对象类可以很方便地指定条目的类型，一个条目也可以绑定多个对象类。
例如在Windows域内，每一个计算机都至少继承了computer类：

属性类型（AttributeType）
属性类型定义了属性值的设定规则（属性语法），以及同一个属性的各个数据相互比较的规则等。

LDAP Filter 进阶
LDAP objectCategory与objectClass
微软的网站上有一篇关于LDAP Filter非常详细的文章：https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx

获取所有域内计算机对象
通过ldapsearch可以跟进不同的条件去检索域内的数据，上面的表格中明确了objectCategory属性与objectClass属性组合可以获取指定对象，通过这个表格，我们尝试获取域内的所有机器:
ldapsearch -h 192.168.49.132 -b dc=domain16,dc=local -D cn=zhangsan,ou=officeuser,dc=domain16,dc=local -w San@123 objectClass=computer dn

LDAP Search Option 说明:

-H	ldapuri，格式为ldap://机器名或者IP:端口号，不能与-h和-p同时使用
-h	LDAP服务器IP或者可解析的hostname，与-p可结合使用，不能与-H同时使用
-p	LDAP服务器端口号，与-h可结合使用，不能与-H同时使用
-x	使用简单认证方式
-D	所绑定的服务器的DN
-w	绑定DN的密码，与-W二者选一
-W	不输入密码，会交互式的提示用户输入密码，与-w二者选一
-f	指定输入条件，在RFC 4515中有更详细的说明
-c	出错后忽略当前错误继续执行，缺省情况下遇到错误即终止
-n	模拟操作但并不实际执行，用于验证，常与-v一同使用进行问题定位
-v	显示详细信息
-d	显示debug信息，可设定级别
-s	指定搜索范围, 可选值：base|one|sub|children

获取所有域内用户对象
这里涉及到LDAP的条件逻辑运算，LDAP共有6个逻辑运算符，分别如下："><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="Windows活动目录中的LDAP"><meta itemprop=description content="如今互联网上关于LDAP介绍的文章已经很多了，并且LDAP的发展历史相对来说也是较长的，它被应用于Windows的活动目录中，这让我们不得不去学习LDAP的一些基本概念。本文不是一个科普文章，主旨在于从渗透测试的角度出发，看看从LDAP中能收集哪些信息。"><meta itemprop=datePublished content="2021-08-11T00:00:00+00:00"><meta itemprop=dateModified content="2021-08-11T00:00:00+00:00"><meta itemprop=wordCount content="141"><meta property="og:url" content="https://payloads.online/archivers/2021-08-11/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="Windows活动目录中的LDAP"><meta property="og:description" content="如今互联网上关于LDAP介绍的文章已经很多了，并且LDAP的发展历史相对来说也是较长的，它被应用于Windows的活动目录中，这让我们不得不去学习LDAP的一些基本概念。本文不是一个科普文章，主旨在于从渗透测试的角度出发，看看从LDAP中能收集哪些信息。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-11T00:00:00+00:00"><meta property="article:modified_time" content="2021-08-11T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Windows活动目录中的LDAP"><meta name=twitter:description content="如今互联网上关于LDAP介绍的文章已经很多了，并且LDAP的发展历史相对来说也是较长的，它被应用于Windows的活动目录中，这让我们不得不去学习LDAP的一些基本概念。本文不是一个科普文章，主旨在于从渗透测试的角度出发，看看从LDAP中能收集哪些信息。"><link rel=canonical href=https://payloads.online/archivers/2021-08-11/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">Windows活动目录中的LDAP</h1><div class="text-xs antialiased opacity-60"><time>Aug 11, 2021</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=ldap基础概念>LDAP基础概念</h2><h3 id=条目entry>条目（Entry）</h3><p>一个条目有若干个属性，每一个属性应对一个或多个值，有些条目可以包含若干个子条目。</p><p>这里使用Active Directory Explorer连接一个域环境进行展示：</p><p><img src=https://images.payloads.online/b59ad772-4f5f-11ec-9056-00d861bf4abb.png alt=2021-08-11-11-56-03></p><p>其中 <code>DC=domain.16,DC=local</code> 以下（包含本身），都是条目，每一个条目点开都拥有N个属性名和属性值，右侧密密麻麻的就是属性名和属性值。</p><h3 id=识别名distinguished-name-dn>识别名（Distinguished Name, DN）</h3><p>它表示条目在LDAP目录树中从根出发的绝对路径，是条目的唯一标识。其中上一节中的DC=domain16,DC=local就是域的根，这个根的DN就是DC=domain16,DC=local，根的DN通常被称为Base DN。</p><p><img src=https://images.payloads.online/b5e8c144-4f5f-11ec-8efa-00d861bf4abb.png alt=2021-08-11-11-56-39></p><p>我们随便点开一个计算机条目观看，发现他们都拥有一个objectCatory属性，这个属性的值就是用于描述条目的路径，也就是说，如果要从LDAP中精确的寻找到某个对象，就可以通过DN来寻找，编程的思路也是如此。</p><h3 id=相对识别名relative-distinguished-name-rdn>相对识别名（Relative Distinguished Name, RDN）</h3><p>例如上方的USERPC1的DN为：CN=USERPC1,CN=Computers,DC=domain16,DC=local，那么CN=USERPC1,CN=Computers就是RDN，RDN是相对于Base DN的DN。</p><p>在一般情况下，RDN 以 dc=、ou=、c=、o= 开头的条目为容器，可以包含子条目。</p><h3 id=模式schema>模式（Schema）</h3><p>模式是对象类（ObjectClass）、属性类型（AttributeType）、属性语法（Syntax）和匹配规则（MatchingRules）的集合。</p><h3 id=对象类objectclass>对象类（ObjectClass）</h3><p>对象类封装了必选的属性和可选的属性，同时对象类也是支持继承的。通过对象类可以很方便地指定条目的类型，一个条目也可以绑定多个对象类。</p><p>例如在Windows域内，每一个计算机都至少继承了computer类：</p><p><img src=https://images.payloads.online/b62b9456-4f5f-11ec-b8f6-00d861bf4abb.png alt=2021-08-11-11-56-58></p><h3 id=属性类型attributetype>属性类型（AttributeType）</h3><p>属性类型定义了属性值的设定规则（属性语法），以及同一个属性的各个数据相互比较的规则等。</p><p><img src=https://images.payloads.online/b689bbda-4f5f-11ec-8d2e-00d861bf4abb.png alt=2021-08-11-11-57-13></p><h2 id=ldap-filter-进阶>LDAP Filter 进阶</h2><h3 id=ldap-objectcategory与objectclass>LDAP objectCategory与objectClass</h3><p>微软的网站上有一篇关于LDAP Filter非常详细的文章：<a href=https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx>https://social.technet.microsoft.com/wiki/contents/articles/5392.active-directory-ldap-syntax-filters.aspx</a></p><p><img src=https://images.payloads.online/b6c23ce4-4f5f-11ec-a1ec-00d861bf4abb.png alt=2021-08-11-12-00-24></p><h3 id=获取所有域内计算机对象>获取所有域内计算机对象</h3><p>通过ldapsearch可以跟进不同的条件去检索域内的数据，上面的表格中明确了objectCategory属性与objectClass属性组合可以获取指定对象，通过这个表格，我们尝试获取域内的所有机器:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ldapsearch -h 192.168.49.132 -b dc<span style=color:#f92672>=</span>domain16,dc<span style=color:#f92672>=</span>local -D cn<span style=color:#f92672>=</span>zhangsan,ou<span style=color:#f92672>=</span>officeuser,dc<span style=color:#f92672>=</span>domain16,dc<span style=color:#f92672>=</span>local -w San@123 objectClass<span style=color:#f92672>=</span>computer dn
</span></span></code></pre></div><p><img src=https://images.payloads.online/b6fdd6a0-4f5f-11ec-ba51-00d861bf4abb.png alt=2021-08-11-12-00-55></p><p>LDAP Search Option 说明:</p><ul><li><code>-H</code> ldapuri，格式为ldap://机器名或者IP:端口号，不能与-h和-p同时使用</li><li><code>-h</code> LDAP服务器IP或者可解析的hostname，与-p可结合使用，不能与-H同时使用</li><li><code>-p</code> LDAP服务器端口号，与-h可结合使用，不能与-H同时使用</li><li><code>-x</code> 使用简单认证方式</li><li><code>-D</code> 所绑定的服务器的DN</li><li><code>-w</code> 绑定DN的密码，与-W二者选一</li><li><code>-W</code> 不输入密码，会交互式的提示用户输入密码，与-w二者选一</li><li><code>-f</code> 指定输入条件，在RFC 4515中有更详细的说明</li><li><code>-c</code> 出错后忽略当前错误继续执行，缺省情况下遇到错误即终止</li><li><code>-n</code> 模拟操作但并不实际执行，用于验证，常与-v一同使用进行问题定位</li><li><code>-v</code> 显示详细信息</li><li><code>-d</code> 显示debug信息，可设定级别</li><li><code>-s</code> 指定搜索范围, 可选值：base|one|sub|children</li></ul><h3 id=获取所有域内用户对象>获取所有域内用户对象</h3><p>这里涉及到LDAP的条件逻辑运算，LDAP共有6个逻辑运算符，分别如下：</p><p><img src=https://images.payloads.online/b73bb772-4f5f-11ec-bad4-00d861bf4abb.png alt=2021-08-11-12-02-01></p><p>逻辑运算语法：<code>(逻辑运算符(条件1)(条件2)....)</code></p><p>例如获取所有用户对象的条件语句：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>&amp;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>objectCategory<span style=color:#f92672>=</span>person<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>objectClass<span style=color:#f92672>=</span>user<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>ldapsearch的操作示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ldapsearch -h 192.168.49.132 -b dc<span style=color:#f92672>=</span>domain16,dc<span style=color:#f92672>=</span>local -D cn<span style=color:#f92672>=</span>zhangsan,ou<span style=color:#f92672>=</span>officeuser,dc<span style=color:#f92672>=</span>domain16,dc<span style=color:#f92672>=</span>local -w San@123 <span style=color:#e6db74>&#34;(&amp;(objectCategory=person)(objectClass=user))&#34;</span> dn | grep dn
</span></span></code></pre></div><p><img src=https://images.payloads.online/b77b94a0-4f5f-11ec-9d0a-00d861bf4abb.png alt=2021-08-11-12-02-40></p><h3 id=获取所有启用用户>获取所有启用用户</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ldapsearch -h 192.168.49.132 -b dc<span style=color:#f92672>=</span>domain16,dc<span style=color:#f92672>=</span>local -D cn<span style=color:#f92672>=</span>zhangsan,ou<span style=color:#f92672>=</span>officeuser,dc<span style=color:#f92672>=</span>domain16,dc<span style=color:#f92672>=</span>local -w San@123 <span style=color:#e6db74>&#34;(&amp;(objectCategory=person)(objectClass=user)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(!(userAccountControl:1.2.840.113556.1.4.803:=2)))&#34;</span> dn | grep dn
</span></span></code></pre></div><p><img src=https://images.payloads.online/b7b74b3a-4f5f-11ec-8d64-00d861bf4abb.png alt=2021-08-11-12-02-55></p><h3 id=特殊字符对照表>特殊字符对照表</h3><p>其中\2A等都是特殊字符，为了和LDAP语义进行区分，因此有一个对照表：</p><p><img src=https://images.payloads.online/b7fe4b3e-4f5f-11ec-94f9-00d861bf4abb.png alt=2021-08-11-12-03-52></p><h2 id=查看域内dns解析数据>查看域内DNS解析数据</h2><p>通过ADExplorer，可以看到域内存在关于DNS的DN：</p><p><img src=https://images.payloads.online/b83695b6-4f5f-11ec-a43d-00d861bf4abb.png alt=2021-08-11-12-04-10></p><p>其中DN为DC=mailserver,DC=domain16.local,CN=MicrosoftDNS,DC=DomainDnsZones,DC=domain16,DC=local的对象存在一个属性叫dnsRecord，通过参考adidnsdump 中代码，发现dnsRecord是一个文档化过的结构体。</p><p><img src=https://images.payloads.online/b87a3d34-4f5f-11ec-b15b-00d861bf4abb.png alt=2021-08-11-12-04-22></p><p>利用MS-DNSP文档能够构造结构体，从LDAP读取数据，自己也可以动手写一个收集域内DNS的工具。</p><h2 id=go语言操作ldap>Go语言操作LDAP</h2><p>开源地址：https://github.com/Rvn0xsy/goDomain</p><p><img src=https://images.payloads.online/b8cb3c20-4f5f-11ec-b1bc-00d861bf4abb.png alt=2021-08-11-12-04-39></p><p>使用go-ldap库能够连接LDAP服务，主要流程：</p><ul><li>连接LDAP服务器（支持TCP）</li><li>账户密码认证</li><li>执行LDAP语句，获取结果内容</li><li>遍历属性名来读取数据</li></ul><h3 id=获取非约束委派与约束委派机器>获取非约束委派与约束委派机器</h3><p>约束委派语法：<code>Query: (&(samAccountType=805306369)(msds-allowedtodelegateto=*)(objectClass=computer))</code></p><p>非约束委派语法：<code>(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288)(objectClass=computer))</code></p><p><img src=https://images.payloads.online/b90dd3a0-4f5f-11ec-b11c-00d861bf4abb.png alt=2021-08-11-12-04-54></p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2021-08-30/2/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>博客更新了</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2021-07-20/1/><span>Kubernetes(K8s)横向移动办法</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>