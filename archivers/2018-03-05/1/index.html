<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>C/C&#43;&#43; 子域名A记录枚举(多线程)</title>
    <meta name="description" content="倾旋的博客">
    <meta name="author" content='倾旋'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://payloads.online/favicon.ico">
    

    
        
    
</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" style="color: #dc3545;" href="https://payloads.online" title="倾旋的博客">
          
          倾旋的博客
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/about" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/links/" title="Links">
                        Links
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/post/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/index.xml" title="Rss">
                        Rss
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<div class="container">
    <p>分享一个C/C++ 子域名A记录枚举的一个工具，可以根据自己的需求再改进</p>
<ul>
<li>目录
{:toc}</li>
</ul>
<h2 id="0x00-为什么需要a记录枚举">0x00 为什么需要A记录枚举？</h2>
<p>DNS服务中的A记录是指：指定特定主机名映射到特定的IP地址上。</p>
<blockquote>
<p>这是非常重要记录也是常用的记录，比如解析主机名为www的到IP 1.1.1.1上就需要使用A记录进行</p>
</blockquote>
<p>在渗透测试的很多流程下，我们都需要不断的进行信息搜集，通过搜集到的信息来给我们的攻击带来更多思路。</p>
<h2 id="0x01-我用这些a记录可以干什么">0x01 我用这些A记录可以干什么？</h2>
<p>例如通过我枚举百度域名的结果可以进行分析：</p>
<pre><code>
payloads@Koone:~/cpp_program$ ./dns_enum baidu.com 2
start threads ... 0
[*]news.baidu.com. =&gt; 115.239.210.174
[*]news.baidu.com. =&gt; 180.97.33.136
[*]kaoshi.baidu.com. =&gt; 14.215.177.118
[*]www.baidu.com. =&gt; 115.239.211.112
[*]www.baidu.com. =&gt; 115.239.210.27
[*]bbs.baidu.com. =&gt; 180.97.34.146
[*]cdn.baidu.com. =&gt; 10.36.3.156
[*]api.baidu.com. =&gt; 115.239.210.90
end threads ... 2

</code></pre><p>上面我只是简单的给出了几个子域名结果，可以看到<code>cdn.baidu.com</code>指向了一个内网地址<code>10.36.3.156</code>。</p>
<p>在内网渗透中，域名枚举也有很大的作用，因为域控都是DNS服务器，为了在企业内部提供一些服务，则会频繁使用DNS服务来指向某些特定的服务器，所以，知道了域名，可以枚举内网中的一些OA、Email等服务器地址，进行定向渗透。</p>
<blockquote>
<p>当然不只是A记录，还有很多其他，可以移步搜索引擎搜索 DNS记录类型</p>
</blockquote>
<h2 id="0x02-本工具的实现">0x02 本工具的实现</h2>
<p>大概分为三块：</p>
<ul>
<li>多线程控制类</li>
<li>DNS请求类</li>
<li>主函数类</li>
</ul>
<p>由于之前已经铺垫了太多DNS相关的知识，就自己造个轮子，为了方便编译，我将代码都移植到了<code>main.cpp</code></p>
<h2 id="0x03-多线程锁的问题">0x03 多线程锁的问题</h2>
<p>在开发的过程中，必须要选择一个变量用来分离任务，不可能两个或多个线程处理同一个任务，资源浪费了。</p>
<p><code>static int threadLock = 0;</code></p>
<p>务必添加<code>static</code>关键字注册为全局变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">while</span>(threadLock<span style="color:#f92672">&lt;</span> Dns<span style="color:#f92672">-&gt;</span>_subdomain.size()){
        Dns<span style="color:#f92672">-&gt;</span>_mutex.lock();
        <span style="color:#75715e">//code ...
</span><span style="color:#75715e"></span>        threadLock<span style="color:#f92672">++</span>;
        Dns<span style="color:#f92672">-&gt;</span>_mutex.unlock();

    }
</code></pre></div><h2 id="0x04-源代码">0x04 源代码</h2>
<ul>
<li>源代码地址：http://payloads.online/tools/dns_enum.txt</li>
<li>字典地址：http://payloads.online/tools/dict.txt</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">
<span style="color:#75715e">//dns_enum
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstring&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdio&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;map&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;thread&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;mutex&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fstream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#define T_A 1 </span><span style="color:#75715e">//Ipv4 address
</span><span style="color:#75715e"></span><span style="color:#75715e">#define T_NS 2 </span><span style="color:#75715e">//Nameserver
</span><span style="color:#75715e"></span><span style="color:#75715e">#define T_CNAME 5 </span><span style="color:#75715e">// canonical name
</span><span style="color:#75715e"></span><span style="color:#75715e">#define T_SOA 6 </span><span style="color:#75715e">/* start of authority zone */</span><span style="color:#75715e">
</span><span style="color:#75715e">#define T_PTR 12 </span><span style="color:#75715e">/* domain name pointer */</span><span style="color:#75715e">
</span><span style="color:#75715e">#define T_MX 15 </span><span style="color:#75715e">//Mail server
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Mythread</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    Mythread();
    <span style="color:#f92672">~</span>Mythread();
    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">setThreads</span>(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">thread</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">runThreads</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>function)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> object),<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> object);
    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">setDetach</span>();
    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">setJoin</span>();
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">int</span> _thread <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span><span style="color:#f92672">&gt;</span> threads;
};

<span style="color:#66d9ef">bool</span> Mythread<span style="color:#f92672">::</span>setThreads(<span style="color:#66d9ef">int</span> <span style="color:#66d9ef">thread</span>) {
    <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">thread</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>){
        _thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">thread</span>;
    }<span style="color:#66d9ef">else</span>{
        _thread <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
    }
}


<span style="color:#66d9ef">bool</span> Mythread<span style="color:#f92672">::</span>runThreads(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>function)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) , <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> object) {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> _thread; <span style="color:#f92672">++</span>i) {
        threads.push_back(std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span>(function,object));

    }
}

<span style="color:#66d9ef">bool</span> Mythread<span style="color:#f92672">::</span>setDetach(){
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> _thread; <span style="color:#f92672">++</span>i) {
        threads[i].detach();
    }
}

<span style="color:#66d9ef">bool</span> Mythread<span style="color:#f92672">::</span>setJoin(){
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> _thread; <span style="color:#f92672">++</span>i) {
        threads[i].join();
    }
}

Mythread<span style="color:#f92672">::</span>Mythread() {
    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;start threads ... &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _thread <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
}


Mythread<span style="color:#f92672">::~</span>Mythread() {
    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;end threads ... &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _thread <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
}


<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span>
{
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> id; <span style="color:#75715e">// identification number
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> rd :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// recursion desired
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> tc :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// truncated message
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> aa :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// authoritive answer
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> opcode :<span style="color:#ae81ff">4</span>; <span style="color:#75715e">// purpose of message
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> qr :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// query/response flag
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> rcode :<span style="color:#ae81ff">4</span>; <span style="color:#75715e">// response code
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> cd :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// checking disabled
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> ad :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// authenticated data
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> z :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// its z! reserved
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> ra :<span style="color:#ae81ff">1</span>; <span style="color:#75715e">// recursion available
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> q_count; <span style="color:#75715e">// number of question entries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> ans_count; <span style="color:#75715e">// number of answer entries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> auth_count; <span style="color:#75715e">// number of authority entries
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> add_count; <span style="color:#75715e">// number of resource entries
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">//Constant sized fields of query structure
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span>
{
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> qtype;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> qclass;
};

<span style="color:#75715e">//Constant sized fields of the resource record structure
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma pack(push, 1)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">R_DATA</span>
{
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> type;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> _class;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> ttl;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> data_len;
};
<span style="color:#75715e">#pragma pack(pop)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//Pointers to resource record contents
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">RES_RECORD</span>
{
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">R_DATA</span> <span style="color:#f92672">*</span>resource;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>rdata;
};

<span style="color:#75715e">//Structure of a Query
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
{
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span> <span style="color:#f92672">*</span>ques;
} QUERY;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">dns</span> {

<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    std<span style="color:#f92672">::</span>string dnsServer;
    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> _subdomain <span style="color:#f92672">=</span> {};
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    dns();
    dns(std<span style="color:#f92672">::</span>string dnsServer);
    <span style="color:#f92672">~</span>dns();
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setHostname</span>(std<span style="color:#f92672">::</span>string hostname);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">request</span>(std<span style="color:#f92672">::</span>string hostname);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">changeToDnsNameFormat</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> dns,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> host);
    <span style="color:#66d9ef">int</span>  <span style="color:#a6e22e">setDnsServer</span>(std<span style="color:#f92672">::</span>string  dnsServer);
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">threadRequest</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> hostname);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">runThread</span>(<span style="color:#66d9ef">int</span> threadNum);
    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">addSubdomain</span>(std<span style="color:#f92672">::</span>string subdomainName);
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">void</span> setDnsHeader(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span> dns);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setQname</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> hostname);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setQinfo</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span> <span style="color:#f92672">*</span>qinfo);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestDnsServer</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span>dns);
    u_char<span style="color:#f92672">*</span> <span style="color:#a6e22e">ReadName</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> reader,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer,<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> count);

<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">int</span> dnsSock;
    std<span style="color:#f92672">::</span>string _dnsServer;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> _hostname[<span style="color:#ae81ff">100</span>];
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> _buff[<span style="color:#ae81ff">65535</span>];
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> _qname;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> _reader;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">RES_RECORD</span> _answers[<span style="color:#ae81ff">20</span>],_auth[<span style="color:#ae81ff">20</span>],_addit[<span style="color:#ae81ff">20</span>];
    std<span style="color:#f92672">::</span>map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>,std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span> _aResult;
    sockaddr_in _dest,_a;
    std<span style="color:#f92672">::</span>mutex _mutex;
    std<span style="color:#f92672">::</span>string _currentHostname;
};


<span style="color:#75715e">//
</span><span style="color:#75715e">// Created by payloads on 18-2-27.
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span>


dns<span style="color:#f92672">::</span>dns(){

}

dns<span style="color:#f92672">::</span>dns(std<span style="color:#f92672">::</span>string dnsServer){
    setDnsServer(dnsServer);
}

dns<span style="color:#f92672">::~</span>dns(){

    <span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> _aResult.begin();
    <span style="color:#66d9ef">for</span> (; it <span style="color:#f92672">!=</span> _aResult.end(); <span style="color:#f92672">++</span>it) {
        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[*]&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>_hostname <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; =&gt; &#34;</span> <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#f92672">*</span>it).second <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
    }
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param hostname
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>request(std<span style="color:#f92672">::</span>string hostname) {

    strcpy((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>_hostname,hostname.c_str());

    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span> dns <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span> <span style="color:#f92672">*</span>qinfo <span style="color:#f92672">=</span> NULL;

    setDnsHeader(dns);
    setQname((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)hostname.c_str());
    setQinfo(qinfo);


    requestDnsServer(dns);
    dns <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span><span style="color:#f92672">*</span>)_buff;



    _reader <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_buff[<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span>) <span style="color:#f92672">+</span> (strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)_qname)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span>)];

    <span style="color:#66d9ef">int</span> stop<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span>ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count);i<span style="color:#f92672">++</span>)
    {
        _answers[i].name<span style="color:#f92672">=</span>ReadName(_reader,_buff,<span style="color:#f92672">&amp;</span>stop);
        _reader <span style="color:#f92672">=</span> _reader <span style="color:#f92672">+</span> stop;
        _answers[i].resource <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">R_DATA</span><span style="color:#f92672">*</span>)(_reader);
        _reader <span style="color:#f92672">=</span> _reader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">R_DATA</span>);
        <span style="color:#66d9ef">if</span>(ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>type) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
        {
            _answers[i].rdata <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)malloc(ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len));

            <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ; j<span style="color:#f92672">&lt;</span>ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len) ; j<span style="color:#f92672">++</span>)
            {
                _answers[i].rdata[j]<span style="color:#f92672">=</span>_reader[j];
            }

            _answers[i].rdata[ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len)] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;

            _reader <span style="color:#f92672">=</span> _reader <span style="color:#f92672">+</span> ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len);
        }
        <span style="color:#66d9ef">else</span>
        {
            _answers[i].rdata <span style="color:#f92672">=</span> ReadName(_reader,_buff,<span style="color:#f92672">&amp;</span>stop);
            _reader <span style="color:#f92672">=</span> _reader <span style="color:#f92672">+</span> stop;
        }
    }

    printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Answer Records : %d </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> , ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count) );

    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count) ; i<span style="color:#f92672">++</span>)
    {
        <span style="color:#75715e">//printf(&#34;Name : %s &#34;,answers[i].name);
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span>( ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>type) <span style="color:#f92672">==</span> T_A) <span style="color:#75715e">//IPv4 address
</span><span style="color:#75715e"></span>        {

            std<span style="color:#f92672">::</span>string ipAddress;
            <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>p;
            p<span style="color:#f92672">=</span>(<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span>)_answers[i].rdata;
            _a.sin_addr.s_addr<span style="color:#f92672">=</span>(<span style="color:#f92672">*</span>p); <span style="color:#75715e">//working without ntohl
</span><span style="color:#75715e"></span>            <span style="color:#75715e">//printf(&#34;has IPv4 address : %s&#34;,inet_ntoa(a.sin_addr));
</span><span style="color:#75715e"></span>            ipAddress<span style="color:#f92672">=</span>inet_ntoa(_a.sin_addr);
            _aResult.insert(std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>,std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(i,ipAddress));
        }

        <span style="color:#66d9ef">if</span>(ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>type)<span style="color:#f92672">==</span><span style="color:#ae81ff">5</span>)
        {
            printf(<span style="color:#e6db74">&#34;has alias name : %s&#34;</span>,_answers[i].rdata);
        }

    }
    close(dnsSock);

    <span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> _aResult.begin();
    <span style="color:#66d9ef">for</span> (; it <span style="color:#f92672">!=</span> _aResult.end(); <span style="color:#f92672">++</span>it) {
        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[*]&#34;</span> <span style="color:#f92672">&lt;&lt;</span> hostname <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; =&gt; &#34;</span> <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#f92672">*</span>it).second <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
    }

    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count) ; i<span style="color:#f92672">++</span>){
        <span style="color:#66d9ef">if</span>(ntohs(_answers[i].resource<span style="color:#f92672">-&gt;</span>type) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">//if its an ipv4 address
</span><span style="color:#75715e"></span>        {
            free(_answers[i].rdata);
        }
    }
    _aResult.clear();
    <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>_hostname[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\0&#39;</span>;
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param dns
</span><span style="color:#75715e"> * @param host
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>changeToDnsNameFormat(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> dns,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> host)
{
    <span style="color:#66d9ef">int</span> lock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> , i;
    strcat((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)host,<span style="color:#e6db74">&#34;.&#34;</span>);

    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; i <span style="color:#f92672">&lt;</span> strlen((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)host) ; i<span style="color:#f92672">++</span>)
    {
        <span style="color:#66d9ef">if</span>(host[i]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;.&#39;</span>)
        {
            <span style="color:#f92672">*</span>dns<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> i<span style="color:#f92672">-</span>lock;
            <span style="color:#66d9ef">for</span>(;lock<span style="color:#f92672">&lt;</span>i;lock<span style="color:#f92672">++</span>)
            {
                <span style="color:#f92672">*</span>dns<span style="color:#f92672">++=</span>host[lock];
            }
            lock<span style="color:#f92672">++</span>; <span style="color:#75715e">//or lock=i+1;
</span><span style="color:#75715e"></span>        }
    }
    <span style="color:#f92672">*</span>dns<span style="color:#f92672">++=</span><span style="color:#e6db74">&#39;\0&#39;</span>;
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param dns
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>setDnsHeader(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span>dns) {
    dns <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span> )<span style="color:#f92672">&amp;</span>_buff;
    dns<span style="color:#f92672">-&gt;</span>id <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span>) htons(getpid());
    dns<span style="color:#f92672">-&gt;</span>qr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">//This is a query
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>opcode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">//This is a standard query
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>aa <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">//Not Authoritative
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>tc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">//This message is not truncated
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>rd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">//Recursion Desired
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>ra <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">//Recursion not available! hey we dont have it (lol)
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>z <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    dns<span style="color:#f92672">-&gt;</span>ad <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    dns<span style="color:#f92672">-&gt;</span>cd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    dns<span style="color:#f92672">-&gt;</span>rcode <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    dns<span style="color:#f92672">-&gt;</span>q_count <span style="color:#f92672">=</span> htons(<span style="color:#ae81ff">1</span>); <span style="color:#75715e">//we have only 1 question
</span><span style="color:#75715e"></span>    dns<span style="color:#f92672">-&gt;</span>ans_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    dns<span style="color:#f92672">-&gt;</span>auth_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    dns<span style="color:#f92672">-&gt;</span>add_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param hostname
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>setQname(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>hostname) {
    _qname <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_buff[<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span>)];
    changeToDnsNameFormat(_qname,hostname);
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param qinfo
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>setQinfo(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span> <span style="color:#f92672">*</span>qinfo) {
    qinfo <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_buff[<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span>)<span style="color:#f92672">+</span>strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)_qname)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>];
    qinfo<span style="color:#f92672">-&gt;</span>qtype<span style="color:#f92672">=</span> htons(<span style="color:#ae81ff">1</span>);
    qinfo<span style="color:#f92672">-&gt;</span>qclass<span style="color:#f92672">=</span> htons(<span style="color:#ae81ff">1</span>);
}


<span style="color:#75715e">/**
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param reader
</span><span style="color:#75715e"> * @param buffer
</span><span style="color:#75715e"> * @param count
</span><span style="color:#75715e"> * @return
</span><span style="color:#75715e"> */</span>
u_char <span style="color:#f92672">*</span> dns<span style="color:#f92672">::</span>ReadName(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> reader,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer,<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> count)
{
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> p<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,jumped<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,offset;
    <span style="color:#66d9ef">int</span> i , j;

    <span style="color:#f92672">*</span>count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    name <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)malloc(<span style="color:#ae81ff">256</span>);

    name[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\0&#39;</span>;

    <span style="color:#75715e">//read the names in 3www6google3com format
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">*</span>reader<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>)
    {
        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>reader<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">192</span>)
        {
            offset <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>reader)<span style="color:#f92672">*</span><span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>(reader<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">49152</span>; <span style="color:#75715e">//49152 = 11000000 00000000 ;)
</span><span style="color:#75715e"></span>            reader <span style="color:#f92672">=</span> buffer <span style="color:#f92672">+</span> offset <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
            jumped <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">//we have jumped to another location so counting wont go up!
</span><span style="color:#75715e"></span>        }
        <span style="color:#66d9ef">else</span>
        {
            name[p<span style="color:#f92672">++</span>]<span style="color:#f92672">=*</span>reader;
        }

        reader <span style="color:#f92672">=</span> reader<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>;

        <span style="color:#66d9ef">if</span>(jumped<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)
        {
            <span style="color:#f92672">*</span>count <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">//if we havent jumped to another location then we can count up
</span><span style="color:#75715e"></span>        }
    }

    name[p]<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\0&#39;</span>; <span style="color:#75715e">//string complete
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(jumped<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)
    {
        <span style="color:#f92672">*</span>count <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">//number of steps we actually moved forward in the packet
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">//now convert 3www6google3com0 to www.google.com
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span>(<span style="color:#66d9ef">int</span>)strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)name);i<span style="color:#f92672">++</span>)
    {
        p<span style="color:#f92672">=</span>name[i];
        <span style="color:#66d9ef">for</span>(j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;j<span style="color:#f92672">&lt;</span>(<span style="color:#66d9ef">int</span>)p;j<span style="color:#f92672">++</span>)
        {
            name[i]<span style="color:#f92672">=</span>name[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>];
            i<span style="color:#f92672">=</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>;
        }
        name[i]<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;.&#39;</span>;
    }
    name[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\0&#39;</span>; <span style="color:#75715e">//remove the last dot
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> name;
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * set name server
</span><span style="color:#75715e"> * @param dnsServer
</span><span style="color:#75715e"> * @return
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">int</span> dns<span style="color:#f92672">::</span>setDnsServer(std<span style="color:#f92672">::</span>string  dnsServer) {
    _dnsServer <span style="color:#f92672">=</span> dnsServer;
}


<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>requestDnsServer(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span> dns) {
    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(_dest);
    dnsSock <span style="color:#f92672">=</span> socket(AF_INET , SOCK_DGRAM , IPPROTO_UDP); <span style="color:#75715e">//UDP packet for DNS queries
</span><span style="color:#75715e"></span>    _dest.sin_family <span style="color:#f92672">=</span> AF_INET;
    _dest.sin_port <span style="color:#f92672">=</span> htons(<span style="color:#ae81ff">53</span>);
    _dest.sin_addr.s_addr <span style="color:#f92672">=</span> inet_addr(_dnsServer.c_str()); <span style="color:#75715e">//dns servers
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">timeval</span> timeout <span style="color:#f92672">=</span> {<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>};
    setsockopt(dnsSock,SOL_SOCKET,SO_RCVTIMEO,(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>timeout,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">timeval</span>));
    <span style="color:#66d9ef">if</span>(sendto(dnsSock,(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)_buff,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span>) <span style="color:#f92672">+</span> (strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)_qname)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span>),<span style="color:#ae81ff">0</span>,(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_dest,<span style="color:#66d9ef">sizeof</span>(_dest)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
    {
        <span style="color:#66d9ef">return</span>;
    }
    <span style="color:#66d9ef">if</span>(recvfrom (dnsSock,(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)_buff , <span style="color:#ae81ff">65536</span> , <span style="color:#ae81ff">0</span> , (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_dest , (socklen_t<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>i ) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
    {
        perror(<span style="color:#e6db74">&#34;recvfrom failed&#34;</span>);
    }

}


<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>threadRequest(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> DnsRequest) {

    dns <span style="color:#f92672">*</span> Dns <span style="color:#f92672">=</span> (dns <span style="color:#f92672">*</span>)DnsRequest;
    <span style="color:#75715e">//Dns-&gt;mutex.lock();
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> threadLock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">while</span>(threadLock<span style="color:#f92672">&lt;</span> Dns<span style="color:#f92672">-&gt;</span>_subdomain.size()){
        Dns<span style="color:#f92672">-&gt;</span>_mutex.lock();
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span> <span style="color:#f92672">*</span> dns <span style="color:#f92672">=</span> NULL;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span> <span style="color:#f92672">*</span>qinfo <span style="color:#f92672">=</span> NULL;
        Dns<span style="color:#f92672">-&gt;</span>_currentHostname.append(Dns<span style="color:#f92672">-&gt;</span>_subdomain[threadLock]);
        threadLock<span style="color:#f92672">++</span>;
        <span style="color:#66d9ef">char</span> hostBuff[<span style="color:#ae81ff">200</span>];
        sprintf(hostBuff,<span style="color:#e6db74">&#34;%s.%s&#34;</span>,Dns<span style="color:#f92672">-&gt;</span>_currentHostname.c_str(),Dns<span style="color:#f92672">-&gt;</span>_hostname);
        <span style="color:#75715e">//std::cout &lt;&lt; &#34;Domain =&gt; &#34;  &lt;&lt; hostBuff &lt;&lt; std::endl;
</span><span style="color:#75715e"></span>        Dns<span style="color:#f92672">-&gt;</span>setDnsHeader(dns);
        Dns<span style="color:#f92672">-&gt;</span>setQname((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)hostBuff);
        memset(hostBuff,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
        Dns<span style="color:#f92672">-&gt;</span>setQinfo(qinfo);
        Dns<span style="color:#f92672">-&gt;</span>_currentHostname.clear();
        Dns<span style="color:#f92672">-&gt;</span>requestDnsServer(dns);
        dns <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span><span style="color:#f92672">*</span>)Dns<span style="color:#f92672">-&gt;</span>_buff;
        Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>Dns<span style="color:#f92672">-&gt;</span>_buff[<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DNS_HEADER</span>) <span style="color:#f92672">+</span> (strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)Dns<span style="color:#f92672">-&gt;</span>_qname)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">QUESTION</span>)];
        <span style="color:#66d9ef">int</span> stop<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span>ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count);i<span style="color:#f92672">++</span>)
        {
            Dns<span style="color:#f92672">-&gt;</span>_answers[i].name<span style="color:#f92672">=</span>Dns<span style="color:#f92672">-&gt;</span>ReadName(Dns<span style="color:#f92672">-&gt;</span>_reader,Dns<span style="color:#f92672">-&gt;</span>_buff,<span style="color:#f92672">&amp;</span>stop);
            Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">=</span> Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">+</span> stop;
            Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">R_DATA</span><span style="color:#f92672">*</span>)(Dns<span style="color:#f92672">-&gt;</span>_reader);
            Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">=</span> Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">R_DATA</span>);
            <span style="color:#66d9ef">if</span>(ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>type) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">//if its an ipv4 address
</span><span style="color:#75715e"></span>            {
                Dns<span style="color:#f92672">-&gt;</span>_answers[i].rdata <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)malloc(ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len));

                <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> ; j<span style="color:#f92672">&lt;</span>ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len) ; j<span style="color:#f92672">++</span>)
                {
                    Dns<span style="color:#f92672">-&gt;</span>_answers[i].rdata[j]<span style="color:#f92672">=</span>Dns<span style="color:#f92672">-&gt;</span>_reader[j];
                }

                Dns<span style="color:#f92672">-&gt;</span>_answers[i].rdata[ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len)] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;

                Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">=</span> Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">+</span> ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>data_len);
            }
            <span style="color:#66d9ef">else</span>
            {
                Dns<span style="color:#f92672">-&gt;</span>_answers[i].rdata <span style="color:#f92672">=</span> Dns<span style="color:#f92672">-&gt;</span>ReadName(Dns<span style="color:#f92672">-&gt;</span>_reader,Dns<span style="color:#f92672">-&gt;</span>_buff,<span style="color:#f92672">&amp;</span>stop);
                Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">=</span> Dns<span style="color:#f92672">-&gt;</span>_reader <span style="color:#f92672">+</span> stop;
            }
        }

        <span style="color:#75715e">//printf(&#34;\nAnswer Records : %d \n&#34; , ntohs(dns-&gt;ans_count) );
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count) ; i<span style="color:#f92672">++</span>)
        {
            <span style="color:#75715e">//printf(&#34;Name : %s &#34;,answers[i].name);
</span><span style="color:#75715e"></span>
            <span style="color:#66d9ef">if</span>( ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>type) <span style="color:#f92672">==</span> T_A) <span style="color:#75715e">//IPv4 address
</span><span style="color:#75715e"></span>            {

                std<span style="color:#f92672">::</span>string ipAddress;
                <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>p;
                p<span style="color:#f92672">=</span>(<span style="color:#66d9ef">long</span><span style="color:#f92672">*</span>)Dns<span style="color:#f92672">-&gt;</span>_answers[i].rdata;
                Dns<span style="color:#f92672">-&gt;</span>_a.sin_addr.s_addr<span style="color:#f92672">=</span>(<span style="color:#f92672">*</span>p); <span style="color:#75715e">//working without ntohl
</span><span style="color:#75715e"></span>                <span style="color:#75715e">//printf(&#34; %s has IPv4 address : %s&#34;,hostBuff,inet_ntoa(Dns-&gt;a.sin_addr));
</span><span style="color:#75715e"></span>                ipAddress<span style="color:#f92672">=</span>inet_ntoa(Dns<span style="color:#f92672">-&gt;</span>_a.sin_addr);
                Dns<span style="color:#f92672">-&gt;</span>_aResult.insert(std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>,std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(i,ipAddress));
            }

            <span style="color:#66d9ef">if</span>(ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>type)<span style="color:#f92672">==</span><span style="color:#ae81ff">5</span>)
            {
                <span style="color:#75715e">//Canonical name for an alias
</span><span style="color:#75715e"></span>                <span style="color:#75715e">//printf(&#34;has alias name : %s&#34;,Dns-&gt;answers[i].rdata);
</span><span style="color:#75715e"></span>            }

        }
        close(Dns<span style="color:#f92672">-&gt;</span>dnsSock);


        <span style="color:#66d9ef">auto</span> it <span style="color:#f92672">=</span> Dns<span style="color:#f92672">-&gt;</span>_aResult.begin();
        <span style="color:#66d9ef">for</span> (; it <span style="color:#f92672">!=</span> Dns<span style="color:#f92672">-&gt;</span>_aResult.end(); <span style="color:#f92672">++</span>it) {
            std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;[*]&#34;</span> <span style="color:#f92672">&lt;&lt;</span> hostBuff <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; =&gt; &#34;</span> <span style="color:#f92672">&lt;&lt;</span> (<span style="color:#f92672">*</span>it).second <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
        }

        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> ntohs(dns<span style="color:#f92672">-&gt;</span>ans_count) ; i<span style="color:#f92672">++</span>){
            <span style="color:#66d9ef">if</span>(ntohs(Dns<span style="color:#f92672">-&gt;</span>_answers[i].resource<span style="color:#f92672">-&gt;</span>type) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">//if its an ipv4 address
</span><span style="color:#75715e"></span>            {
                free(Dns<span style="color:#f92672">-&gt;</span>_answers[i].rdata);
            }
        }
        Dns<span style="color:#f92672">-&gt;</span>_aResult.clear();
        Dns<span style="color:#f92672">-&gt;</span>_mutex.unlock();
    }
}


<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>setHostname(std<span style="color:#f92672">::</span>string hostname) {
    strcpy((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>_hostname,hostname.c_str());
}

<span style="color:#66d9ef">void</span> dns<span style="color:#f92672">::</span>runThread(<span style="color:#66d9ef">int</span> threadNum) {
    <span style="color:#75715e">// void * host = (void *)this;
</span><span style="color:#75715e"></span>    Mythread th;
    th.setThreads(threadNum);

    th.runThreads(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>threadRequest,(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span>);

    th.setJoin();
}


<span style="color:#66d9ef">bool</span> dns<span style="color:#f92672">::</span>addSubdomain(std<span style="color:#f92672">::</span>string subdomainName) {
    _subdomain.push_back(subdomainName);
}



<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[]) {
    std<span style="color:#f92672">::</span>string dictPath(<span style="color:#e6db74">&#34;dict.txt&#34;</span>);
    <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>){
        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Usage:&#34;</span> <span style="color:#f92672">&lt;&lt;</span> argv[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; &lt;domain name&gt; &lt;Threads&gt;&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;This program is developed by the Qingxuan&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Email: payloads@aliyun.com&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
        exit(<span style="color:#ae81ff">0</span>);
    }
    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;string &#34;</span>  <span style="color:#f92672">&lt;&lt;</span> argc<span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
    <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>){
        dictPath <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">3</span>];
    }
    dns  Enum(<span style="color:#e6db74">&#34;114.114.114.114&#34;</span>);
    std<span style="color:#f92672">::</span>string hostname <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
    Enum.setHostname(hostname);
    std<span style="color:#f92672">::</span>fstream IO(dictPath);
    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>IO.eof()){
        <span style="color:#66d9ef">char</span> lines[<span style="color:#ae81ff">100</span>];
        IO.getline(lines,<span style="color:#ae81ff">100</span>);
        std<span style="color:#f92672">::</span>string lin(lines);
        Enum.addSubdomain(lin);
    }
    Enum.runThread(atoi(argv[<span style="color:#ae81ff">2</span>]));
}

</code></pre></div><p>它可以直接通过**g++**编译，不需要任何第三方库。</p>
<h2 id="0x05-编译及使用">0x05 编译及使用</h2>
<ul>
<li>
<p>编译命令：<code>g++ main.cpp -lpthread -o dns_enum</code></p>
</li>
<li>
<p>使用方式：<code>./dns_enum &lt;domain name&gt; &lt;Threads&gt;</code></p>
</li>
<li>
<p>使用效果：</p>
</li>
</ul>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2018-03-05/0x01.png" alt="0x01"></p>
<p><strong>注意：必须在当前程序目录下新建一个字典，名为：<code>dict.txt</code></strong></p>
<h3 id="使用其他字典">使用其他字典</h3>
<ul>
<li>使用命令：<code>./dns_enum payloads.online 10 /usr/dict/Subdomain.txt</code></li>
</ul>
<h2 id="0x06-最后">0x06 最后</h2>
<p>这只是我一个大项目中的一部分，近期发现了不少网络扫描的lib，以后的以后再慢慢学习。</p>
<p>DNS枚举这块可以再进行优化，目前只是支持多线程，网络层那块并没有做优化，原生态的数据包发送，真是锻炼人！</p>
</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
            <a href="https://twitter.com/Rvn0xsy" class="fab fa-twitter fa-1x" title="Twitter"></a>
        
            <a href="mailto:rvn0xsy@gmail.com" class="fas fa-envelope fa-1x" title="E-mail"></a>
        
    </div>
    
        <div class="container text-center">
            <a href="https://payloads.online" title="- PAYLOADS.ONLINE -"><small>- PAYLOADS.ONLINE -</small></a>
        </div>
    
</div>
</body>
</html>
