<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>OWASP - 吉林沙龙《后渗透与邮件安全》 议题解读</title>
    <meta name="description" content="倾旋的博客">
    <meta name="author" content='倾旋'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://payloads.online/favicon.ico">
    

    
        
    
</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" style="color: #dc3545;" href="https://payloads.online" title="倾旋的博客">
          
          倾旋的博客
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/about" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/projects/" title="Projects">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-terminal-fill" viewBox="0 0 16 16"><path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm9.5 5.5h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zm-6.354-.354a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146z"/></svg>Projects
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/links/" title="Links">
                        Links
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/post/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/index.xml" title="Rss">
                        Rss
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/tools/" title="Tools">
                        Tools
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<div class="container">
    <blockquote>
<p>在线地址：<a href="https://www.bilibili.com/video/av51712186/">https://www.bilibili.com/video/av51712186/</a></p>
</blockquote>
<iframe src="//player.bilibili.com/player.html?aid=51712186&page=1&cid=" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="95%" height="450"> </iframe>
<h2 id="0x00-前言">0x00 前言</h2>
<p>本文的研究与收获，话费了我近一个季度的时间去掌握，写下这篇文章的意义就在于给自己一个总结，另外，由衷感谢我的前辈给予我的指导，一言一行影响着我。</p>
<p>“如果某天你也有这种打算了，可能那个时候我也不一定在了，无论在不在，告诉我，我不问，你不说，我不拦，但是我想送你” - Micropoor</p>
<h2 id="0x01-后渗透的定义">0x01 后渗透的定义</h2>
<p>这个是一个宽泛的概念，我认为后渗透的定义就是：</p>
<pre><code>[root@localhost ~]# ./pentest 
    ==&gt; “在拥有目标一定权限后的持续渗透行为。”
</code></pre><h2 id="0x02-c2command-and-control简介">0x02 C2(Command and Control)简介</h2>
<p>C2，其含义在安全领域中意思是命令与控制，具体的技术表现为远控木马。
是一种通常用于持续控制一个或多个目标的技术手段，这个技术手段覆盖了<strong>多种</strong>网络通信（计算机交互、通信）的方式。</p>
<p>这个“多种”指的是有很多种方式，基于HTTP、SMTP、HTTPS、纯数据报文、&hellip;.</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/58cc95dce1e2e2d86fb72fddeb8cbc0b.png" alt="2019-03-30-13-59-17"></p>
<h2 id="0x03-c2的原理">0x03 C2的原理</h2>
<p>命令与控制的原理就是目标机器主动或被动的与控制端进行交互，不断获取指令执行。</p>
<p>交互：可能不是一个直接的网络连接</p>
<p>命令与控制在行为上一般需要与许多操作系统接口进行交互，例如：网络通信、文件读写、进程管理等。</p>
<h2 id="0x04-后渗透平台--cobalt-strike">0x04 后渗透平台 – Cobalt Strike</h2>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/ea1f2c3ece83812cfbe9684f9bbbacb5.png" alt="2019-03-30-14-01-17"></p>
<p>Cobalt Strike是一个跨平台、多人协作式、红队评估后渗透平台。
它支持多人通信、权限维持、文件操作、提权、横向渗透……等多种功能，使用者只需要部署好teamserver就可以在任意平台上连接teamserver进行渗透。</p>
<p><a href="https://www.cobaltstrike.com/">https://www.cobaltstrike.com/</a></p>
<h2 id="0x05-后渗透平台--metasploit-framework">0x05 后渗透平台 – Metasploit Framework</h2>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/f21848f472bb733d1c3e86501fb3905f.png" alt="2019-03-30-14-02-15"></p>
<p>Metasploit Framework是一个跨平台、开源、较为开放式的安全评估平台。
它支持权限维持、文件操作、提权、横向渗透、载荷生成……等多种功能，使得渗透更加灵活。</p>
<p><a href="https://www.metasploit.com/">https://www.metasploit.com/</a></p>
<h2 id="0x06-后渗透的需求">0x06 后渗透的需求</h2>
<p>通过一些常用的平台、工具总结，我得出一些以下几个基本需求：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/b3396f2471af1c8eca20d922c67884e1.png" alt="2019-03-30-14-03-35"></p>
<p>这些需求就必定要形成一个跨平台支持、兼容性最好、拓展性强的框架，而大部分框架的基础模式就是如下所说。</p>
<h3 id="框架基本组成">框架基本组成</h3>
<ul>
<li>PAYLOAD</li>
<li>模块</li>
<li>漏洞</li>
</ul>
<h2 id="0x07-payload进入目标机器内存的方式">0x07 PAYLOAD进入目标机器内存的方式</h2>
<p>在常规的渗透过程里，为了获得一定的权限，基本上绝大部分的动机都是在目标机器上的内存种执行指令，它的表现形式大部分都是一个后门、加载器等。</p>
<p>而进入的方式就如下：</p>
<ul>
<li>文件上传木马执行 – 落地</li>
<li>Powershell -&gt; IEX</li>
<li>DLL注入 -&gt; regsvr32、rundll32</li>
<li>.NET技术  -&gt; .cs -&gt; csc.exe -&gt; target.exe</li>
<li>……</li>
</ul>
<h2 id="0x08-payload的类型">0x08 PAYLOAD的类型</h2>
<ul>
<li>独立版</li>
<li>DLL Injection（DLL注入）</li>
<li><strong>Reflective DLL injection（反射DLL注入）</strong></li>
<li>Stager</li>
</ul>
<p>其中，大部分默认情况下，Metasploit生成的都是Stager，可以把它作为一个支持众多模块的通用加载器，而模块的表现形式就是Shellcode、DLL甚至EXE等PE格式的文件。</p>
<p>独立版意思就是它只有单一的功能，例如反弹一个cmd、执行一个操作系统命令。</p>
<p>DLL Injection，其实放在这里感觉上是不合适的，因为它只是一个PE文件，但是它能够实现一个加载器的功能，表现形式不同，所以归并到这里。</p>
<p>Reflective DLL injection（反射DLL注入），这个技术其实有点历史了，它是一个双刃剑也是本次议题所覆盖的核心技术，下面听我慢慢道来。</p>
<h2 id="0x09-dll-injection与dll-hijacking的共性">0x09 DLL Injection与DLL Hijacking的共性</h2>
<p>DLL 劫持与DLL 注入相信看过我之前的议题，基本上都不会陌生，它们的共性就是目的相同：“DLL 注入与DLL劫持的目的都是将DLL代码载入目标进程执行的一种技术手段。”</p>
<h2 id="0x10-dll-injection与dll-hijacking的个性">0x10 DLL Injection与DLL Hijacking的个性</h2>
<p>Injection：</p>
<ul>
<li>DLL注入能够远程、本地加载代码执行。</li>
<li>DLL注入需要创建一个进程用于执行注入操作的代码。</li>
</ul>
<p>Hijacking</p>
<ul>
<li>DLL 劫持只能本地加载代码执行。</li>
<li>DLL 劫持不需要创建进程，被动加载。</li>
</ul>
<h2 id="0x11-windows内存管理方式">0x11 Windows内存管理方式</h2>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/c0d96ff6e4d93551d07a161105257476.png" alt="2019-03-30-14-15-26"></p>
<p>在32位Windows操作系统中，每个进程都拥有一个独立的线性4GB虚拟地址空间。由内存管理器将虚拟地址空间与物理内存地址进行对应。</p>
<ul>
<li>32位地址：0x00000000 ~ 0xFFFFFFFF</li>
<li>64位地址： 0x00000000*2 ～0xFFFFFFFF * 2</li>
</ul>
<p>由于内存隔离的原因所以我们才需要使用DLL注入、DLL劫持的技术使得目标进程执行我们的代码，代码在目标进程的虚拟地址空间中执行的过程中，就可以修改、读写目标进程的内存了。</p>
<h2 id="0x12-实现一个dll-injecion">0x12 实现一个DLL Injecion</h2>
<p>说了那么多，你有实现过一个DLL注入吗？</p>
<p>DLL注入的流程：</p>
<ul>
<li>获取进程权限</li>
<li>申请内存</li>
<li>写入DLL路径</li>
<li>获取LoadLibrary函数地址</li>
<li>创建线程</li>
</ul>
<p><a href="http://payloads.online/archivers/2019-01-20/">DLL Injection Example</a></p>
<h2 id="0x13-反射dll注入reflective-dll-injection">0x13 反射DLL注入（Reflective DLL injection）</h2>
<p>这里不得不铺垫一些Windows PE格式的基本概念：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/000bc13f33d9269ddff3652880408a20.png" alt="2019-03-30-14-19-33"></p>
<p>在Windows中，所有的（exe、dll）等文件的格式都是同一套标准，例如当你双击启动一个软件的时候，操作系统会读取你双击启动的那个程序到内存去根据PE格式解析，把该加载的资源加载到位。</p>
<p>每个PE文件至少有以下几个元素组成：</p>
<ul>
<li>DOS头</li>
<li>PE头</li>
<li>节表</li>
<li>节数据</li>
</ul>
<p>其中DOS头中主要用来支持在DOS模式下运行，PE头主要用于标识当前PE文件的各个属性，而节表用于确定PE文件的资源、导入模块、节数据的位置等等很多信息。</p>
<p>每个PE文件的节表中都有一个叫导入表的一张表，这个表里指明了运行这个PE文件之前，需要加载哪些DLL模块。</p>
<p>举个例子：如果我写了一个程序，编译出它名为Q.exe，而Q.exe的源代码中调用了A.dll中的<code>exec</code>函数。那么编译器生成Q.exe的时候，会在导入表中写入A.dll这个名字，Q.exe运行时，操作系统会读取导入表，把A.dll加载到Q.exe的内存空间中，这样Q才能调用A的exec函数。</p>
<p>这个过程中本质上都会调用一个Windows操作系统API  ： <code>LoadLibrary</code></p>
<p>因此，实现一个反射DLL注入等于实现Windows LoadLibrary</p>
<p><a href="https://github.com/fancycode/MemoryModule">https://github.com/fancycode/MemoryModule</a></p>
<p>那反病毒软件（Anti-virus software）是如何拦截DLL注入的呢？</p>
<p>答案就是：Hook LoadLibrary，读取LoadLibrary的参数，定位到DLL文件进行查杀。</p>
<p>如果我们手动实现一个LoadLibrary，就能绕过大部分反病毒软件，从而让后渗透框架使用起来更加得心应手。</p>
<p>PS：实现了一个LoadLibrary还要实现一个加密通道，支持框架中的不同模块进行传输，这里可以参考Metasploit的Stager模式，不铺垫细节了。</p>
<h2 id="0x14-cobalt-strike-external-c2">0x14 Cobalt Strike external C2</h2>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/315c80a6bb098df3b5a3c3fb1ae877df.png" alt="2019-03-30-14-33-50"></p>
<p>Cobalt Strike支持拓展C2，这个拓展C2的工作方式可谓是非常灵活，太具体细节不作介绍，我只介绍它的工作流程，可以去官网下载PDF，文末有参考文章。</p>
<p>工作原理：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/23e0ddaf239370a0917e1971e58c4eca.png" alt="2019-03-30-14-35-34"></p>
<p>其中有4个角色：</p>
<ul>
<li>Team Server ： Cobalt Strike 后端的主程序</li>
<li>Cobalt Strike external C2 Server：主要由TeamServer派生，用于发送PAYLOAD和接收客户端数据</li>
<li>Controller ： 控制器，用于和第三方管道交互</li>
<li>Other Beacon：这个就是最终木马</li>
</ul>
<p>流程简介：启动teamserver，加载扩展服务，在目标机器上运行控制器，控制器会向扩展服务取得PAYLOAD，写入一个管道，另外木马读取管道，运行代码，通过管道与控制器不断交互，控制器把数据反馈给扩展服务，这样就形成了一个多样化的C2。</p>
<p>控制器客户端与控制器通信的报文格式：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/5b127e387c6aa1fa8e148e2db4ff7414.png" alt="2019-03-30-14-44-02"></p>
<p>前四个字节是数据包的大小（不包含本身），后面就是数据。</p>
<p>这种报文在控制与管道再到木马的传输过程中可以改变为任意应用层协议，可以是文件、内存、管道、油槽等&hellip;.</p>
<p>Tips：在目标机器管道与控制器客户端之间的传输可以进行流量混淆，轻松绕过网络告警设备。</p>
<p>以下是Windows可用于进程通信的列表：</p>
<table>
<thead>
<tr>
<th>Windows 进程通信</th>
<th>函数</th>
</tr>
</thead>
<tbody>
<tr>
<td>文件（I/O设备）</td>
<td>ReadFile/WriteFile</td>
</tr>
<tr>
<td>油槽</td>
<td>CreateMailslot</td>
</tr>
<tr>
<td>管道</td>
<td>CreatePipe</td>
</tr>
<tr>
<td>套接字</td>
<td>socket</td>
</tr>
<tr>
<td>剪贴板</td>
<td>OpenClipboard</td>
</tr>
<tr>
<td>文件映射</td>
<td>CreateFileMapping</td>
</tr>
</tbody>
</table>
<p>官方举的例子是通过网络文件共享。</p>
<h2 id="0x15-cooolis--bypass-avcobalt-metasploit">0x15 Cooolis – Bypass AV（Cobalt Metasploit）</h2>
<p>Cooolis是我写的一个支持Cobalt Strike、Metasploit全版本上线的加载器，这里演示以下我如何绕过的Windows Defender：</p>
<video src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/video/windows-defender.mp4" controls="controls" width="500px">
哎呀~ 换个浏览器试试吧！
</video>
<p>目前我已经开发出DLL版，可通过rundll32调用。</p>
<h2 id="0x15-cooolis--bypass-av---原理">0x15 Cooolis – Bypass AV - 原理</h2>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/7618f6767ba7e443f24028de1344ed78.png" alt="2019-03-30-14-55-52"></p>
<p>在Metasploit环境下，我使用了<code>windows/patchupdllinject/reverse_tcp</code>用于充当加载器的前半部分，建立连接后发送一个DLL过去。</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/6f4583ab4140f154544796ce4ec79952.png" alt="2019-03-30-14-57-54"></p>
<p>接收完毕后，<code>Cooolis</code>负责在内存寻找<code>PE</code>文件头，然后加载模块到内存空间，调用<code>DLL Main</code>实现上线。</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/862d47008d99747b80f23235c671d17c.png" alt="2019-03-30-14-59-04"></p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/72017cae36dd223f5c3ef04dad0fe79b.png" alt="2019-03-30-14-59-10"></p>
<h2 id="0x16-高度安全下的apt邮服实验">0x16 高度安全下的APT邮服实验</h2>
<p>这个先晾在这，部门分享完毕继续写。。。</p>
<h2 id="结语">结语</h2>
<p>文章只做技术分享、技术交流，一切非法用途产生的后果自负。</p>
<p>纵览那么多后门、病毒，基本上都有一定的反病毒能力，其实大多都是使用了加密解密+反射注入的技术，增大了反病毒软件的困难。</p>
<p>有时间录制个视频，再讲一遍。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="http://www.otpub.com/home/article/details/id/5736.html">http://www.otpub.com/home/article/details/id/5736.html</a></li>
<li><a href="https://blog.csdn.net/china_jeffery/article/details/79610915">https://blog.csdn.net/china_jeffery/article/details/79610915</a></li>
<li><a href="https://www.cnblogs.com/HsinTsao/p/6528053.html">https://www.cnblogs.com/HsinTsao/p/6528053.html</a></li>
<li><a href="https://www.cnblogs.com/inva/p/4971331.html">https://www.cnblogs.com/inva/p/4971331.html</a></li>
<li><a href="https://www.cnblogs.com/LittleHann/p/6336950.html">https://www.cnblogs.com/LittleHann/p/6336950.html</a></li>
<li><a href="https://www.cnblogs.com/h2zZhou/p/7721797.html">https://www.cnblogs.com/h2zZhou/p/7721797.html</a></li>
<li><a href="https://www.cnblogs.com/cuish/p/3804990.html">https://www.cnblogs.com/cuish/p/3804990.html</a></li>
<li><a href="https://www.jianshu.com/p/c400b2067c6e">https://www.jianshu.com/p/c400b2067c6e</a></li>
<li><a href="https://gitee.com/china_jeffery/MemoryModule/blob/master/sample/DllLoader/DllLoader.cpp">https://gitee.com/china_jeffery/MemoryModule/blob/master/sample/DllLoader/DllLoader.cpp</a></li>
<li><a href="https://qiye.163.com/help/3338ea.html">https://qiye.163.com/help/3338ea.html</a></li>
<li><a href="https://www.cobaltstrike.com/downloads/externalc2spec.pdf">https://www.cobaltstrike.com/downloads/externalc2spec.pdf</a></li>
</ul>

</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
            <a href="https://twitter.com/Rvn0xsy" class="fab fa-twitter fa-1x" title="Twitter"></a>
        
            <a href="mailto:rvn0xsy@gmail.com" class="fas fa-envelope fa-1x" title="E-mail"></a>
        
    </div>
    
        <div class="container text-center">
            <a href="https://payloads.online" title="- PAYLOADS.ONLINE -"><small>- PAYLOADS.ONLINE -</small></a>
        </div>
    
</div>



<script src="https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js" integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin="anonymous"></script>
<script>
(function(){
  let plantumlPrefix = "language-plantuml";
  Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function(code){
    let image = document.createElement("IMG");
    image.loading = 'lazy'; 
    image.src = 'http://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
    code.parentNode.insertBefore(image, code);
    code.style.display = 'none';
  });
})();
</script>

</body>
</html>
