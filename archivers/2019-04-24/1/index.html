<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Nmap扩展开发（一） - 倾旋的博客</title><meta name=theme-color><meta name=description content="0x00 前言
PS ：如果你不知道你是否需要学习这个技术，那么我可以先告诉你Nmap能够做什么：

网络结构画像
漏洞扫描
漏洞利用
端口扫描
爬虫
信息搜集
&mldr;.

我的分类不是很清晰，但是对于一个渗透测试人员、运维人员、甲、乙方的工程师都会需要它的定制化功能，例如：将扫描结果写到数据库？新的漏洞出了POC，客户需要立即进行漏洞扫描？
导出扫描结果这个问题，Nmap官方做出如下回应：

Nmap Network Scanning

一个共同的愿望是将Nmap结果输出到数据库以便于查询和跟踪。这允许用户来自个人渗透测试仪 到国际企业存储他们的所有扫描结果并轻松比较它们。企业可能每天运行大型扫描，并为新打开的端口或可用计算机的邮件管理员安排查询。渗透测试人员可能会了解新漏洞并搜索受影响应用程序的所有旧扫描结果，以便他可以警告相关客户端。研究人员可以扫描数百万个IP地址，并将结果保存在数据库中，以便进行实时查询。

虽然这些目标值得称赞，但Nmap不提供直接的数据库输出功能。我不仅有太多不同的数据库类型支持它们，而且用户的需求变化如此之大，以至于没有单一的数据库模式是合适的。企业，笔测试员和研究人员的需求都需要不同的表结构。
而很多朋友大多都是使用Python来调用Nmap进行格式解析，这种方式无法预估扫描进度，不能进行状态交互，效率很差，如果我们需要一个实时进行独写、漏洞检测等定制化的操作，那么就可以跟我一起来学习如何写一个自己的Nmap脚本，这本书涵盖的知识比较多，会涉及安全、网络协议、编程技术这些相关知识，相信你能够收获很多。
笔者写扩展脚本开发系列的初衷是让大家了解nmap这个优秀的开源工具的功能，解决一些定制化的扫描需求。
在开始之前，需要读者具备：能够熟练使用Nmap进行端口扫描、了解Nmap目录结构、懂得常见的网络知识、Lua基础（如果需要的话，我会在后期铺垫）。
0x02 Nmap扩展脚本分类

auth	处理身份验证
broadcast 网络广播
brute	暴力猜解
default	默认
discovery	服务发现
dos	拒绝服务
exploit	漏洞利用
external	外部扩展
fuzzer	模糊测试
intrusive	扫描可能造成不良后果
malware	检测后门
safe	扫描危害较小
version	版本识别
vuln 漏洞检测

0X03 Nmap扩展脚本铺垫
相信网上已经有很多文章去写如何使用扩展脚本了，这块我不准备过多的铺垫。
主要介绍如下几点：

Nmap扩展脚本用途
Nmap扩展脚本使用方法
如何查看Nmap扩展脚本的Usage（使用方法）

0X03 Nmap扩展脚本用途
Nmap扩展脚本能够帮助我们实现更多定制化的需求扫描、结果的处理、漏洞的检测、漏洞的利用等。在0x02中已经列出了扩展脚本的分类，根据说明我们能理解一个大概，这些分类代表了Nmap各个方面的能力。
0x03 Nmap扩展脚本使用方法
在很早之前，我写过一篇科普文章，主要介绍了Nmap的脚本分类、使用方法，链接：
http://zhuanlan.zhihu.com/p/26618074
本章没有太多概念性的东西，希望读者能够边看边做。首先设定一个需求，我有一个需要搜集某个IP或某组IP所有开放HTTP服务的中间件信息。那么Nmap有一个脚本是可以直接满足我们需求的："><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.150.0"><meta itemprop=name content="Nmap扩展开发（一）"><meta itemprop=description content="本来是想写成一本书的，但是可能断断续续没有很好的产出，我只能以文章的形式分享出来了，希望我的研究成果能够给大家带来便利。—— 作者：倾旋"><meta itemprop=datePublished content="2019-04-24T00:00:00+00:00"><meta itemprop=dateModified content="2019-04-24T00:00:00+00:00"><meta itemprop=wordCount content="110"><meta itemprop=keywords content="安全开发"><meta property="og:url" content="https://payloads.online/archivers/2019-04-24/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="Nmap扩展开发（一）"><meta property="og:description" content="本来是想写成一本书的，但是可能断断续续没有很好的产出，我只能以文章的形式分享出来了，希望我的研究成果能够给大家带来便利。—— 作者：倾旋"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-24T00:00:00+00:00"><meta property="article:modified_time" content="2019-04-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nmap扩展开发（一）"><meta name=twitter:description content="本来是想写成一本书的，但是可能断断续续没有很好的产出，我只能以文章的形式分享出来了，希望我的研究成果能够给大家带来便利。—— 作者：倾旋"><link rel=canonical href=https://payloads.online/archivers/2019-04-24/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">Nmap扩展开发（一）</h1><div class="text-xs antialiased opacity-60"><time>Apr 24, 2019</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x00-前言>0x00 前言</h2><p>PS ：如果你不知道你是否需要学习这个技术，那么我可以先告诉你Nmap能够做什么：</p><ul><li>网络结构画像</li><li>漏洞扫描</li><li>漏洞利用</li><li>端口扫描</li><li>爬虫</li><li>信息搜集</li><li>&mldr;.</li></ul><p>我的分类不是很清晰，但是对于一个渗透测试人员、运维人员、甲、乙方的工程师都会需要它的定制化功能，例如：将扫描结果写到数据库？新的漏洞出了POC，客户需要立即进行漏洞扫描？</p><p>导出扫描结果这个问题，Nmap官方做出如下回应：</p><blockquote><p><a href="https://link.zhihu.com/?target=https%3A//nmap.org/book/output-formats-output-to-database.html">Nmap Network Scanning</a></p></blockquote><blockquote><p>一个共同的愿望是将Nmap结果输出到数据库以便于查询和跟踪。这允许用户来自个人渗透测试仪 到国际企业存储他们的所有扫描结果并轻松比较它们。企业可能每天运行大型扫描，并为新打开的端口或可用计算机的邮件管理员安排查询。渗透测试人员可能会了解新漏洞并搜索受影响应用程序的所有旧扫描结果，以便他可以警告相关客户端。研究人员可以扫描数百万个IP地址，并将结果保存在数据库中，以便进行实时查询。</p></blockquote><blockquote><p>虽然这些目标值得称赞，但Nmap不提供直接的数据库输出功能。我不仅有太多不同的数据库类型支持它们，而且用户的需求变化如此之大，以至于没有单一的数据库模式是合适的。企业，笔测试员和研究人员的需求都需要不同的表结构。</p></blockquote><p>而很多朋友大多都是使用Python来调用Nmap进行格式解析，这种方式无法预估扫描进度，不能进行状态交互，效率很差，如果我们需要一个实时进行独写、漏洞检测等定制化的操作，那么就可以跟我一起来学习如何写一个自己的Nmap脚本，这本书涵盖的知识比较多，会涉及安全、网络协议、编程技术这些相关知识，相信你能够收获很多。</p><p>笔者写扩展脚本开发系列的初衷是让大家了解nmap这个优秀的开源工具的功能，解决一些定制化的扫描需求。</p><p>在开始之前，需要读者具备：能够熟练使用Nmap进行端口扫描、了解Nmap目录结构、懂得常见的网络知识、<strong>Lua基础（如果需要的话，我会在后期铺垫）</strong>。</p><h2 id=0x02-nmap扩展脚本分类>0x02 Nmap扩展脚本分类</h2><ul><li>auth 处理身份验证</li><li>broadcast 网络广播</li><li>brute 暴力猜解</li><li>default 默认</li><li>discovery 服务发现</li><li>dos 拒绝服务</li><li>exploit 漏洞利用</li><li>external 外部扩展</li><li>fuzzer 模糊测试</li><li>intrusive 扫描可能造成不良后果</li><li>malware 检测后门</li><li>safe 扫描危害较小</li><li>version 版本识别</li><li>vuln 漏洞检测</li></ul><h2 id=0x03-nmap扩展脚本铺垫>0X03 Nmap扩展脚本铺垫</h2><p>相信网上已经有很多文章去写如何使用扩展脚本了，这块我不准备过多的铺垫。</p><p>主要介绍如下几点：</p><ul><li>Nmap扩展脚本用途</li><li>Nmap扩展脚本使用方法</li><li>如何查看Nmap扩展脚本的Usage（使用方法）</li></ul><h3 id=0x03-nmap扩展脚本用途>0X03 Nmap扩展脚本用途</h3><p>Nmap扩展脚本能够帮助我们实现更多定制化的需求扫描、结果的处理、漏洞的检测、漏洞的利用等。在0x02中已经列出了扩展脚本的分类，根据说明我们能理解一个大概，这些分类代表了Nmap各个方面的能力。</p><h3 id=0x03-nmap扩展脚本使用方法>0x03 Nmap扩展脚本使用方法</h3><p>在很早之前，我写过一篇科普文章，主要介绍了Nmap的脚本分类、使用方法，链接：</p><p><a href=http://zhuanlan.zhihu.com/p/26618074>http://zhuanlan.zhihu.com/p/26618074</a></p><p>本章没有太多概念性的东西，希望读者能够边看边做。首先设定一个需求，我有一个需要搜集某个IP或某组IP所有开放HTTP服务的中间件信息。那么Nmap有一个脚本是可以直接满足我们需求的：</p><p><code>http-server-header.nse</code></p><p>扫描命令：<code>nmap --script=http-server-header &lt;TARGET></code></p><p>例如我需要扫描192.168.85.132的HTTP服务的中间件信息，使用Nmap时需要输入以下命令：</p><p><code>nmap --script=http-server-header 192.168.85.132</code></p><p>执行结果如下：</p><p><img src=https://images.payloads.online/6c77ed3c-4f5f-11ec-b582-00d861bf4abb.png alt=2019-04-24-09-51-33></p><p>从扫描结果可以看出，在扫描到80端口的开放状态及服务名称下方会输出关于http-server-header脚本的结果：Apache/2.4.29 (Debian)</p><p>一般情况下，在nmap安装目录下有一个scripts文件夹，里面存放了很多供我们调用的脚本，脚本的语言是lua，文件扩展名是nse。使用脚本时我们不需要输入脚本的全名，例如，调用http-server-header.nse时，只需要输入文件名http-server-header即可。</p><p>下面介绍一些带参数的扩展脚本使用方法。同样的，设定一个需求，我需要扫描192.168.85.132的HTTP服务下有哪些目录或者文件，那么可以采用http-enum.nse脚本。</p><p><strong>http-enum.nse用于枚举http服务下的目录或文件</strong></p><p>但是单单使用这个脚本，而不根据实际情况设定内置参数，结果可能并不理想。这个脚本有一些参数：</p><ul><li>http-enum.basepath 开始目录</li><li>http-enum.displayall 是否显示全部（默认HTTP状态码200显示，401不显示）</li><li>http-enum.fingerprintfile 指定其他文件，从中读取指纹</li><li>http-enum.category 设置类别（&lsquo;attacks&rsquo;,&lsquo;database&rsquo;, &lsquo;general&rsquo;, &lsquo;microsoft&rsquo;, &lsquo;printer&rsquo;）</li><li>http-fingerprints.nikto-db-path 指定nikto数据库的路径</li></ul><p>假设要从admin目录开始进行枚举，需要输入如下命令：</p><p><code>nmap --script=http-enum --script-args 'http-enum.basepath=admin' 192.168.85.132</code></p><p><img src=https://images.payloads.online/6cbb77d2-4f5f-11ec-a8eb-00d861bf4abb.png alt=2019-04-24-09-52-35></p><h3 id=0x03-如何查看nmap扩展脚本的usage使用方法>0X03 如何查看Nmap扩展脚本的Usage（使用方法）</h3><p>使用&ndash;script-help参数</p><p><code>nmap --script-help=http-enum</code></p><p><img src=https://images.payloads.online/6cf45d9a-4f5f-11ec-b58b-00d861bf4abb.png alt=2019-04-24-09-53-19></p><p>直接查看脚本文件</p><p><code>cat /usr/share/nmap/scripts/http-enum.nse</code></p><p><img src=https://images.payloads.online/6d35774e-4f5f-11ec-a2c3-00d861bf4abb.png alt=2019-04-24-09-53-40></p><p>下一章：扩展脚本（NSE引擎）执行规则</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2019-05-09/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Swaks伪造邮件</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2019-04-24/3/><span>Nmap扩展开发（三）</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>