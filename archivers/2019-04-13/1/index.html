<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>最快的方式搭建域环境 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>13</span>
<span class=rest>Apr 2019</span></div></div><div class=matter><h1 class=title>最快的方式搭建域环境</h1></div></div><h2 id=0x00-自动化搭建>0x00 自动化搭建</h2><p>准备环境：</p><ul><li>Windows 2008 R2 X64</li><li>Windows 2016</li><li>Windows 10</li></ul><p>注意：安装活动目录服务之前，要确保当前机器已经设置静态IP，并且将DNS首选服务器设置为<code>127.0.0.1</code>。</p><p>首先我先介绍自动化的方式搭建，后面再介绍手动方式。</p><p>在微软官方的手册中，有提到如何使用Powershell去安装活动目录服务：<a href=https://github.com/MicrosoftDocs/windowsserverdocs/blob/master/WindowsServerDocs/identity/ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md>Install Active Directory Domain Services (Level 100)</a></p><p>第一步：安装活动目录服务</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$ Install-Windowsfeature AD-Domain-Services
</span></span></code></pre></td></tr></table></div></div><p>第二步：导入<a href="https://docs.microsoft.com/en-us/powershell/module/addsdeployment/?redirectedfrom=MSDN&amp;view=windowsserver2019-ps">Addsdeployment</a>模块</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Import-Module Addsdeployment
</span></span></code></pre></td></tr></table></div></div><p>第三步：调用<a href=https://github.com/MicrosoftDocs/windowsserverdocs/blob/master/WindowsServerDocs/identity/ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md>Install-ADDSForest</a>设置域的信息执行安装</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-ADDSForest -CreateDnsDelegation:$false -DomainMode <span style=color:#e6db74>&#34;7&#34;</span> -DomainName <span style=color:#e6db74>&#34;PAYLOADS.ONLINE&#34;</span> -DomainNetbiosName <span style=color:#e6db74>&#34;PAYLOADS&#34;</span> -ForestMode <span style=color:#e6db74>&#34;7&#34;</span> -InstallDns:$true -NoRebootOnCompletion:$false -Force:$true
</span></span></code></pre></td></tr></table></div></div><p>Install-ADDSForest 的参数解释：</p><ul><li>CreateDnsDelegation 是否创建引用与域控制器一起安装的新DNS服务器的DNS委派。 仅对 Active Directory“集成 DNS 有效。默认值是根据环境自动计算的。</li><li>DomainMode 指定创建新林时第一个域的域功能级别。<ul><li>Windows Server 2003: 2 or Win2003</li><li>Windows Server 2008: 3 or Win2008</li><li>Windows Server 2008 R2: 4 or Win2008R2</li><li>Windows Server 2012: 5 or Win2012</li><li>Windows Server 2012 R2: 6 or Win2012R2</li><li>Windows Server 2016: 7 or WinThreshold</li></ul></li><li>DomainName 域名</li><li>DomainNetbiosName 域的Netbios名称</li><li>ForestMode 与 DomainMode 等同，该选项主要用于尽可能的自动化</li><li>InstallDns 是否安装DNS服务</li><li>NoRebootOnCompletion 不重启完成安装</li></ul><p>总结：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Windowsfeature AD-Domain-Services
</span></span><span style=display:flex><span>Import-Module Addsdeployment
</span></span><span style=display:flex><span>Install-ADDSForest -CreateDnsDelegation:$false -DomainMode <span style=color:#e6db74>&#34;7&#34;</span> -DomainName <span style=color:#e6db74>&#34;PAYLOADS.ONLINE&#34;</span> -DomainNetbiosName <span style=color:#e6db74>&#34;PAYLOADS&#34;</span> -ForestMode <span style=color:#e6db74>&#34;7&#34;</span> -InstallDns:$true -NoRebootOnCompletion:$false -Force:$true
</span></span></code></pre></td></tr></table></div></div><h2 id=0x01-配置静态ip>0x01 配置静态IP</h2><p><img src=https://images.payloads.online/615cc06c-4f5f-11ec-9a77-00d861bf4abb.png alt=2019-04-13-00-08-08></p><p>设置一个DNS指向本机，因为它后面是一个域控的角色。</p><h2 id=0x02-安装活动目录角色>0x02 安装活动目录角色</h2><p><img src=https://images.payloads.online/61a34de8-4f5f-11ec-a907-00d861bf4abb.png alt=2019-04-13-00-08-34></p><p>点击“添加角色”：</p><p><img src=https://images.payloads.online/61ddd828-4f5f-11ec-bf8c-00d861bf4abb.png alt=2019-04-13-00-08-45></p><p>必须具备两点：</p><ul><li>Administrator强密码</li><li><strong>配置静态IP</strong></li></ul><p>单击下一步：</p><p><img src=https://images.payloads.online/622438f4-4f5f-11ec-85d8-00d861bf4abb.png alt=2019-04-13-00-09-17></p><p>勾选“Active Directory 域服务”，然后下一步：</p><p><img src=https://images.payloads.online/6262626e-4f5f-11ec-882a-00d861bf4abb.png alt=2019-04-13-00-09-37></p><p><strong>这里表明，后续会有安装DNS服务的过程，所以网上要先安装DNS的文章会导致域搭建失败，因为安装向导会创建一些DNS记录，以及查找域。</strong></p><p>单击“下一步”：</p><p><img src=https://images.payloads.online/62a4d0f4-4f5f-11ec-a5c5-00d861bf4abb.png alt=2019-04-13-00-09-59></p><p>点击“安装”。</p><p><img src=https://images.payloads.online/62ddc2f6-4f5f-11ec-9b7f-00d861bf4abb.png alt=2019-04-13-00-10-08></p><p>一分钟不到就可以安装完毕，但是域的搭建还没有完成。</p><h2 id=0x03-安装向导>0x03 安装向导</h2><p>打开“服务器管理器”，找到Active Directory安装向导：</p><p><img src=https://images.payloads.online/633ce394-4f5f-11ec-ac18-00d861bf4abb.png alt=2019-04-13-00-10-32></p><p>点击“dcpromo.exe”，就可以进入向导：</p><p><img src=https://images.payloads.online/637b65d8-4f5f-11ec-b082-00d861bf4abb.png alt=2019-04-13-00-10-42></p><p>好奇的可以看看<strong>高级模式</strong>，为了快速搭建，就直接下一步：</p><p><img src=https://images.payloads.online/63ccbc30-4f5f-11ec-a9c2-00d861bf4abb.png alt=2019-04-13-00-10-57></p><p>这里说一下，<strong>“Windows NT 4.0兼容的加密算法”</strong>，指的是低版本的SMBv1客户端，在进行NTLM网络认证的过程中采用的算法较为简单，能够轻易破解；其次，未升级到SMB v2的服务器可能会受到Pass The Hash的技术手段利用、MS17-010等漏洞的危害，为了后续的学习，我们直接选择下一步，暂时不去做加固。</p><p><img src=https://images.payloads.online/64163dba-4f5f-11ec-9091-00d861bf4abb.png alt=2019-04-13-00-11-20></p><p>目前我们只有一个域，所以直接选择第二项：“在新林中新建域”，在有域的情况下，可以将域纳入“林”中。多个域称之为“林”。</p><p><img src=https://images.payloads.online/6452e4e0-4f5f-11ec-a417-00d861bf4abb.png alt=2019-04-13-00-11-29></p><p>设置“域名”：</p><p><img src=https://images.payloads.online/64b93e5c-4f5f-11ec-8938-00d861bf4abb.png alt=2019-04-13-00-11-39></p><p>这里必须符合DNS对域名的名称标准规范，如我就将域名定为：payloads.online：</p><p><img src=https://images.payloads.online/64fa5c0c-4f5f-11ec-8582-00d861bf4abb.png alt=2019-04-13-00-11-49></p><p>点击下一步会有一个检查，等待即可，这是为了防止域冲突：</p><p><img src=https://images.payloads.online/6531e56e-4f5f-11ec-ab47-00d861bf4abb.png alt=2019-04-13-00-11-58></p><p>选择林功能级别：</p><p><img src=https://images.payloads.online/656de2c6-4f5f-11ec-84d0-00d861bf4abb.png alt=2019-04-13-00-12-09></p><p>为了保持向下兼容，我们选择Windows 2003的林功能级别，如果选择2008的，未来加入的域控制器必须是Windows 2008。</p><p><img src=https://images.payloads.online/65b51862-4f5f-11ec-8394-00d861bf4abb.png alt=2019-04-13-00-12-18></p><p>单击“下一步”，选择域功能级别，上面已经解释了，是为了兼容性，我们也选择2003：</p><p><img src=https://images.payloads.online/65fce2fa-4f5f-11ec-b4fd-00d861bf4abb.png alt=2019-04-13-00-12-29></p><p>单击下一步，此时进入DNS服务器的安装过程：</p><p><img src=https://images.payloads.online/663825fe-4f5f-11ec-850c-00d861bf4abb.png alt=2019-04-13-00-12-42></p><p>这里是由于在“payloads.online”中没有委派关系，所以我们自建：</p><p><img src=https://images.payloads.online/66995298-4f5f-11ec-8566-00d861bf4abb.png alt=2019-04-13-00-12-51></p><p>单击“是”，进入选择数据库、日志、SYSOL的存放路径，这三个东西在后续的红队目录里都会介绍攻击手段以及防御方法：</p><p><img src=https://images.payloads.online/66dea744-4f5f-11ec-ade2-00d861bf4abb.png alt=2019-04-13-00-13-01></p><p>默认选择“下一步”，设置DC管理员(Administrator)密码：</p><p><img src=https://images.payloads.online/6724caa8-4f5f-11ec-b795-00d861bf4abb.png alt=2019-04-13-00-13-13></p><p>单击“下一步”，可以看到刚才的设置:</p><p><img src=https://images.payloads.online/676d6bd2-4f5f-11ec-9971-00d861bf4abb.png alt=2019-04-13-00-13-24></p><p>这里你也可以导出设置，用于下次安装的时候自动配置。单击“下一步”就可以安装了。</p><p><img src=https://images.payloads.online/67ae3f04-4f5f-11ec-9199-00d861bf4abb.png alt=2019-04-13-00-13-34></p><p>勾选“重新启动”，去喝杯茶，回来它就安装完毕了！</p><p>安装完毕后，会默认使用域内账户Administrator登录：
<img src=https://images.payloads.online/67ee1e08-4f5f-11ec-b611-00d861bf4abb.png alt=2019-04-13-00-13-47></p><p>登录进入后，会弹出“初始化配置任务”窗口，这里有关于本机的信息：</p><p><img src=https://images.payloads.online/68308f68-4f5f-11ec-bc5f-00d861bf4abb.png alt=2019-04-13-00-13-57></p><p>出现域，就代表搭建完成了，域控的IP是：192.168.117.169，域名称是：payloads.online。</p><h2 id=0x04-加入域>0x04 加入域</h2><p>打开一个Windows，这里我用我的Windows 10来举例：</p><p><img src=https://images.payloads.online/686c9a3a-4f5f-11ec-9035-00d861bf4abb.png alt=2019-04-13-00-14-19></p><p>首先要确保能与域控进行通信，然后将当前主机的DNS服务器设置为DC的IP：</p><p><img src=https://images.payloads.online/68ae5470-4f5f-11ec-aff1-00d861bf4abb.png alt=2019-04-13-00-14-27></p><p><img src=https://images.payloads.online/68ef6456-4f5f-11ec-af10-00d861bf4abb.png alt=2019-04-13-00-14-33></p><p>紧接着找到系统属性：</p><p><img src=https://images.payloads.online/6932ad74-4f5f-11ec-b181-00d861bf4abb.png alt=2019-04-13-00-14-41></p><p>单击“网络”：</p><p><img src=https://images.payloads.online/6971be38-4f5f-11ec-aff2-00d861bf4abb.png alt=2019-04-13-00-14-52></p><p>默认“下一步”：</p><p><img src=https://images.payloads.online/69b1fd54-4f5f-11ec-a0a2-00d861bf4abb.png alt=2019-04-13-00-15-03></p><p>既然加域嘛，肯定选择带有域的，单击“下一步”：</p><p><img src=https://images.payloads.online/69e8094e-4f5f-11ec-9e97-00d861bf4abb.png alt=2019-04-13-00-15-34></p><p>这个时候你需要在<strong>域控</strong>上创建一个用户：</p><p><img src=https://images.payloads.online/6a1f28f2-4f5f-11ec-8d6a-00d861bf4abb.png alt=2019-04-13-00-15-49></p><p>主要填写“登录名”就可以了</p><p><img src=https://images.payloads.online/6a5b0ef8-4f5f-11ec-bf98-00d861bf4abb.png alt=2019-04-13-00-16-05></p><p>单击“下一步”，设置密码：</p><p><img src=https://images.payloads.online/6aa8f776-4f5f-11ec-9eaa-00d861bf4abb.png alt=2019-04-13-00-16-14></p><p>下一步，创建完成。</p><p>此时回到Windows 10，填写好这个创建好的用户：</p><p><img src=https://images.payloads.online/6ae609fe-4f5f-11ec-a1ac-00d861bf4abb.png alt=2019-04-13-00-16-28></p><p><img src=https://images.payloads.online/6b1df440-4f5f-11ec-9c3f-00d861bf4abb.png alt=2019-04-13-00-16-33></p><p>单击“下一步”：</p><p><img src=https://images.payloads.online/6b5b1df2-4f5f-11ec-95b7-00d861bf4abb.png alt=2019-04-13-00-16-45></p><p>这里授予权限时，设置为“Users”，不然很多东西操作不了。</p><p><img src=https://images.payloads.online/6b989c2c-4f5f-11ec-b554-00d861bf4abb.png alt=2019-04-13-00-16-55></p><p>单击“完成”，重启计算机。</p><p><img src=https://images.payloads.online/6bd31172-4f5f-11ec-8da2-00d861bf4abb.png alt=2019-04-13-00-17-05></p><p><img src=https://images.payloads.online/6c209d3e-4f5f-11ec-a218-00d861bf4abb.png alt=2019-04-13-00-17-10></p><p>此时，客户机既能上网，也能处于域环境下。</p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>