<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>最快的方式搭建域环境 - 倾旋的博客</title><meta name=theme-color><meta name=description content='0x00 自动化搭建
准备环境：

Windows 2008 R2 X64
Windows 2016
Windows 10

注意：安装活动目录服务之前，要确保当前机器已经设置静态IP，并且将DNS首选服务器设置为127.0.0.1。
首先我先介绍自动化的方式搭建，后面再介绍手动方式。
在微软官方的手册中，有提到如何使用Powershell去安装活动目录服务：Install Active Directory Domain Services (Level 100)
第一步：安装活动目录服务
$ Install-Windowsfeature AD-Domain-Services
第二步：导入Addsdeployment模块
Import-Module Addsdeployment
第三步：调用Install-ADDSForest设置域的信息执行安装
Install-ADDSForest -CreateDnsDelegation:$false -DomainMode "7" -DomainName "PAYLOADS.ONLINE" -DomainNetbiosName "PAYLOADS" -ForestMode "7" -InstallDns:$true -NoRebootOnCompletion:$false -Force:$true
Install-ADDSForest 的参数解释：

CreateDnsDelegation 是否创建引用与域控制器一起安装的新DNS服务器的DNS委派。 仅对 Active Directory“集成 DNS 有效。默认值是根据环境自动计算的。
DomainMode 指定创建新林时第一个域的域功能级别。

Windows Server 2003: 2 or Win2003
Windows Server 2008: 3 or Win2008
Windows Server 2008 R2: 4 or Win2008R2
Windows Server 2012: 5 or Win2012
Windows Server 2012 R2: 6 or Win2012R2
Windows Server 2016: 7 or WinThreshold


DomainName 域名
DomainNetbiosName 域的Netbios名称
ForestMode 与 DomainMode 等同，该选项主要用于尽可能的自动化
InstallDns 是否安装DNS服务
NoRebootOnCompletion 不重启完成安装

总结：'><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="最快的方式搭建域环境"><meta itemprop=description content="网上的文章都太复杂了，我就写一个简单、详细的，刚好虚拟机都删了。"><meta itemprop=datePublished content="2019-04-13T00:00:00+00:00"><meta itemprop=dateModified content="2019-04-13T00:00:00+00:00"><meta itemprop=wordCount content="187"><meta property="og:url" content="https://payloads.online/archivers/2019-04-13/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="最快的方式搭建域环境"><meta property="og:description" content="网上的文章都太复杂了，我就写一个简单、详细的，刚好虚拟机都删了。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2019-04-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="最快的方式搭建域环境"><meta name=twitter:description content="网上的文章都太复杂了，我就写一个简单、详细的，刚好虚拟机都删了。"><link rel=canonical href=https://payloads.online/archivers/2019-04-13/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">最快的方式搭建域环境</h1><div class="text-xs antialiased opacity-60"><time>Apr 13, 2019</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x00-自动化搭建>0x00 自动化搭建</h2><p>准备环境：</p><ul><li>Windows 2008 R2 X64</li><li>Windows 2016</li><li>Windows 10</li></ul><p>注意：安装活动目录服务之前，要确保当前机器已经设置静态IP，并且将DNS首选服务器设置为<code>127.0.0.1</code>。</p><p>首先我先介绍自动化的方式搭建，后面再介绍手动方式。</p><p>在微软官方的手册中，有提到如何使用Powershell去安装活动目录服务：<a href=https://github.com/MicrosoftDocs/windowsserverdocs/blob/master/WindowsServerDocs/identity/ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md>Install Active Directory Domain Services (Level 100)</a></p><p>第一步：安装活动目录服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$ Install-Windowsfeature AD-Domain-Services
</span></span></code></pre></div><p>第二步：导入<a href="https://docs.microsoft.com/en-us/powershell/module/addsdeployment/?redirectedfrom=MSDN&amp;view=windowsserver2019-ps">Addsdeployment</a>模块</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Import-Module Addsdeployment
</span></span></code></pre></div><p>第三步：调用<a href=https://github.com/MicrosoftDocs/windowsserverdocs/blob/master/WindowsServerDocs/identity/ad-ds/deploy/Install-Active-Directory-Domain-Services--Level-100-.md>Install-ADDSForest</a>设置域的信息执行安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-ADDSForest -CreateDnsDelegation:$false -DomainMode <span style=color:#e6db74>&#34;7&#34;</span> -DomainName <span style=color:#e6db74>&#34;PAYLOADS.ONLINE&#34;</span> -DomainNetbiosName <span style=color:#e6db74>&#34;PAYLOADS&#34;</span> -ForestMode <span style=color:#e6db74>&#34;7&#34;</span> -InstallDns:$true -NoRebootOnCompletion:$false -Force:$true
</span></span></code></pre></div><p>Install-ADDSForest 的参数解释：</p><ul><li>CreateDnsDelegation 是否创建引用与域控制器一起安装的新DNS服务器的DNS委派。 仅对 Active Directory“集成 DNS 有效。默认值是根据环境自动计算的。</li><li>DomainMode 指定创建新林时第一个域的域功能级别。<ul><li>Windows Server 2003: 2 or Win2003</li><li>Windows Server 2008: 3 or Win2008</li><li>Windows Server 2008 R2: 4 or Win2008R2</li><li>Windows Server 2012: 5 or Win2012</li><li>Windows Server 2012 R2: 6 or Win2012R2</li><li>Windows Server 2016: 7 or WinThreshold</li></ul></li><li>DomainName 域名</li><li>DomainNetbiosName 域的Netbios名称</li><li>ForestMode 与 DomainMode 等同，该选项主要用于尽可能的自动化</li><li>InstallDns 是否安装DNS服务</li><li>NoRebootOnCompletion 不重启完成安装</li></ul><p>总结：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Windowsfeature AD-Domain-Services
</span></span><span style=display:flex><span>Import-Module Addsdeployment
</span></span><span style=display:flex><span>Install-ADDSForest -CreateDnsDelegation:$false -DomainMode <span style=color:#e6db74>&#34;7&#34;</span> -DomainName <span style=color:#e6db74>&#34;PAYLOADS.ONLINE&#34;</span> -DomainNetbiosName <span style=color:#e6db74>&#34;PAYLOADS&#34;</span> -ForestMode <span style=color:#e6db74>&#34;7&#34;</span> -InstallDns:$true -NoRebootOnCompletion:$false -Force:$true
</span></span></code></pre></div><h2 id=0x01-配置静态ip>0x01 配置静态IP</h2><p><img src=https://images.payloads.online/615cc06c-4f5f-11ec-9a77-00d861bf4abb.png alt=2019-04-13-00-08-08></p><p>设置一个DNS指向本机，因为它后面是一个域控的角色。</p><h2 id=0x02-安装活动目录角色>0x02 安装活动目录角色</h2><p><img src=https://images.payloads.online/61a34de8-4f5f-11ec-a907-00d861bf4abb.png alt=2019-04-13-00-08-34></p><p>点击“添加角色”：</p><p><img src=https://images.payloads.online/61ddd828-4f5f-11ec-bf8c-00d861bf4abb.png alt=2019-04-13-00-08-45></p><p>必须具备两点：</p><ul><li>Administrator强密码</li><li><strong>配置静态IP</strong></li></ul><p>单击下一步：</p><p><img src=https://images.payloads.online/622438f4-4f5f-11ec-85d8-00d861bf4abb.png alt=2019-04-13-00-09-17></p><p>勾选“Active Directory 域服务”，然后下一步：</p><p><img src=https://images.payloads.online/6262626e-4f5f-11ec-882a-00d861bf4abb.png alt=2019-04-13-00-09-37></p><p><strong>这里表明，后续会有安装DNS服务的过程，所以网上要先安装DNS的文章会导致域搭建失败，因为安装向导会创建一些DNS记录，以及查找域。</strong></p><p>单击“下一步”：</p><p><img src=https://images.payloads.online/62a4d0f4-4f5f-11ec-a5c5-00d861bf4abb.png alt=2019-04-13-00-09-59></p><p>点击“安装”。</p><p><img src=https://images.payloads.online/62ddc2f6-4f5f-11ec-9b7f-00d861bf4abb.png alt=2019-04-13-00-10-08></p><p>一分钟不到就可以安装完毕，但是域的搭建还没有完成。</p><h2 id=0x03-安装向导>0x03 安装向导</h2><p>打开“服务器管理器”，找到Active Directory安装向导：</p><p><img src=https://images.payloads.online/633ce394-4f5f-11ec-ac18-00d861bf4abb.png alt=2019-04-13-00-10-32></p><p>点击“dcpromo.exe”，就可以进入向导：</p><p><img src=https://images.payloads.online/637b65d8-4f5f-11ec-b082-00d861bf4abb.png alt=2019-04-13-00-10-42></p><p>好奇的可以看看<strong>高级模式</strong>，为了快速搭建，就直接下一步：</p><p><img src=https://images.payloads.online/63ccbc30-4f5f-11ec-a9c2-00d861bf4abb.png alt=2019-04-13-00-10-57></p><p>这里说一下，<strong>“Windows NT 4.0兼容的加密算法”</strong>，指的是低版本的SMBv1客户端，在进行NTLM网络认证的过程中采用的算法较为简单，能够轻易破解；其次，未升级到SMB v2的服务器可能会受到Pass The Hash的技术手段利用、MS17-010等漏洞的危害，为了后续的学习，我们直接选择下一步，暂时不去做加固。</p><p><img src=https://images.payloads.online/64163dba-4f5f-11ec-9091-00d861bf4abb.png alt=2019-04-13-00-11-20></p><p>目前我们只有一个域，所以直接选择第二项：“在新林中新建域”，在有域的情况下，可以将域纳入“林”中。多个域称之为“林”。</p><p><img src=https://images.payloads.online/6452e4e0-4f5f-11ec-a417-00d861bf4abb.png alt=2019-04-13-00-11-29></p><p>设置“域名”：</p><p><img src=https://images.payloads.online/64b93e5c-4f5f-11ec-8938-00d861bf4abb.png alt=2019-04-13-00-11-39></p><p>这里必须符合DNS对域名的名称标准规范，如我就将域名定为：payloads.online：</p><p><img src=https://images.payloads.online/64fa5c0c-4f5f-11ec-8582-00d861bf4abb.png alt=2019-04-13-00-11-49></p><p>点击下一步会有一个检查，等待即可，这是为了防止域冲突：</p><p><img src=https://images.payloads.online/6531e56e-4f5f-11ec-ab47-00d861bf4abb.png alt=2019-04-13-00-11-58></p><p>选择林功能级别：</p><p><img src=https://images.payloads.online/656de2c6-4f5f-11ec-84d0-00d861bf4abb.png alt=2019-04-13-00-12-09></p><p>为了保持向下兼容，我们选择Windows 2003的林功能级别，如果选择2008的，未来加入的域控制器必须是Windows 2008。</p><p><img src=https://images.payloads.online/65b51862-4f5f-11ec-8394-00d861bf4abb.png alt=2019-04-13-00-12-18></p><p>单击“下一步”，选择域功能级别，上面已经解释了，是为了兼容性，我们也选择2003：</p><p><img src=https://images.payloads.online/65fce2fa-4f5f-11ec-b4fd-00d861bf4abb.png alt=2019-04-13-00-12-29></p><p>单击下一步，此时进入DNS服务器的安装过程：</p><p><img src=https://images.payloads.online/663825fe-4f5f-11ec-850c-00d861bf4abb.png alt=2019-04-13-00-12-42></p><p>这里是由于在“payloads.online”中没有委派关系，所以我们自建：</p><p><img src=https://images.payloads.online/66995298-4f5f-11ec-8566-00d861bf4abb.png alt=2019-04-13-00-12-51></p><p>单击“是”，进入选择数据库、日志、SYSOL的存放路径，这三个东西在后续的红队目录里都会介绍攻击手段以及防御方法：</p><p><img src=https://images.payloads.online/66dea744-4f5f-11ec-ade2-00d861bf4abb.png alt=2019-04-13-00-13-01></p><p>默认选择“下一步”，设置DC管理员(Administrator)密码：</p><p><img src=https://images.payloads.online/6724caa8-4f5f-11ec-b795-00d861bf4abb.png alt=2019-04-13-00-13-13></p><p>单击“下一步”，可以看到刚才的设置:</p><p><img src=https://images.payloads.online/676d6bd2-4f5f-11ec-9971-00d861bf4abb.png alt=2019-04-13-00-13-24></p><p>这里你也可以导出设置，用于下次安装的时候自动配置。单击“下一步”就可以安装了。</p><p><img src=https://images.payloads.online/67ae3f04-4f5f-11ec-9199-00d861bf4abb.png alt=2019-04-13-00-13-34></p><p>勾选“重新启动”，去喝杯茶，回来它就安装完毕了！</p><p>安装完毕后，会默认使用域内账户Administrator登录：
<img src=https://images.payloads.online/67ee1e08-4f5f-11ec-b611-00d861bf4abb.png alt=2019-04-13-00-13-47></p><p>登录进入后，会弹出“初始化配置任务”窗口，这里有关于本机的信息：</p><p><img src=https://images.payloads.online/68308f68-4f5f-11ec-bc5f-00d861bf4abb.png alt=2019-04-13-00-13-57></p><p>出现域，就代表搭建完成了，域控的IP是：192.168.117.169，域名称是：payloads.online。</p><h2 id=0x04-加入域>0x04 加入域</h2><p>打开一个Windows，这里我用我的Windows 10来举例：</p><p><img src=https://images.payloads.online/686c9a3a-4f5f-11ec-9035-00d861bf4abb.png alt=2019-04-13-00-14-19></p><p>首先要确保能与域控进行通信，然后将当前主机的DNS服务器设置为DC的IP：</p><p><img src=https://images.payloads.online/68ae5470-4f5f-11ec-aff1-00d861bf4abb.png alt=2019-04-13-00-14-27></p><p><img src=https://images.payloads.online/68ef6456-4f5f-11ec-af10-00d861bf4abb.png alt=2019-04-13-00-14-33></p><p>紧接着找到系统属性：</p><p><img src=https://images.payloads.online/6932ad74-4f5f-11ec-b181-00d861bf4abb.png alt=2019-04-13-00-14-41></p><p>单击“网络”：</p><p><img src=https://images.payloads.online/6971be38-4f5f-11ec-aff2-00d861bf4abb.png alt=2019-04-13-00-14-52></p><p>默认“下一步”：</p><p><img src=https://images.payloads.online/69b1fd54-4f5f-11ec-a0a2-00d861bf4abb.png alt=2019-04-13-00-15-03></p><p>既然加域嘛，肯定选择带有域的，单击“下一步”：</p><p><img src=https://images.payloads.online/69e8094e-4f5f-11ec-9e97-00d861bf4abb.png alt=2019-04-13-00-15-34></p><p>这个时候你需要在<strong>域控</strong>上创建一个用户：</p><p><img src=https://images.payloads.online/6a1f28f2-4f5f-11ec-8d6a-00d861bf4abb.png alt=2019-04-13-00-15-49></p><p>主要填写“登录名”就可以了</p><p><img src=https://images.payloads.online/6a5b0ef8-4f5f-11ec-bf98-00d861bf4abb.png alt=2019-04-13-00-16-05></p><p>单击“下一步”，设置密码：</p><p><img src=https://images.payloads.online/6aa8f776-4f5f-11ec-9eaa-00d861bf4abb.png alt=2019-04-13-00-16-14></p><p>下一步，创建完成。</p><p>此时回到Windows 10，填写好这个创建好的用户：</p><p><img src=https://images.payloads.online/6ae609fe-4f5f-11ec-a1ac-00d861bf4abb.png alt=2019-04-13-00-16-28></p><p><img src=https://images.payloads.online/6b1df440-4f5f-11ec-9c3f-00d861bf4abb.png alt=2019-04-13-00-16-33></p><p>单击“下一步”：</p><p><img src=https://images.payloads.online/6b5b1df2-4f5f-11ec-95b7-00d861bf4abb.png alt=2019-04-13-00-16-45></p><p>这里授予权限时，设置为“Users”，不然很多东西操作不了。</p><p><img src=https://images.payloads.online/6b989c2c-4f5f-11ec-b554-00d861bf4abb.png alt=2019-04-13-00-16-55></p><p>单击“完成”，重启计算机。</p><p><img src=https://images.payloads.online/6bd31172-4f5f-11ec-8da2-00d861bf4abb.png alt=2019-04-13-00-17-05></p><p><img src=https://images.payloads.online/6c209d3e-4f5f-11ec-a218-00d861bf4abb.png alt=2019-04-13-00-17-10></p><p>此时，客户机既能上网，也能处于域环境下。</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2019-04-24/4/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Nmap扩展开发（四）</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2019-04-08/1/><span>又见四月</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>