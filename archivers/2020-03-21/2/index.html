<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>SSRF漏洞配合Flask的巧妙利用 - 内网漫游 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>21</span>
<span class=rest>Mar 2020</span></div></div><div class=matter><h1 class=title>SSRF漏洞配合Flask的巧妙利用 - 内网漫游</h1></div></div><h2 id=ssrf-服务器请求伪造>SSRF 服务器请求伪造</h2><p>SSRF(Server-side Request Forge, 服务端请求伪造)。由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。</p><h3 id=常见的功能点>常见的功能点</h3><p><img src=https://images.payloads.online/960b6a34-4f5f-11ec-80ff-00d861bf4abb.png alt=2020-03-21-16-58-32></p><ul><li>Net-NTLM && NTLM Relay</li><li>获取服务器真实IP</li><li>端口扫描</li><li><strong>网页代理</strong></li><li>&mldr;&mldr;</li></ul><h3 id=网页代理---http-proxy>网页代理 - HTTP Proxy</h3><p><img src=https://images.payloads.online/964b0f36-4f5f-11ec-85c3-00d861bf4abb.png alt=2020-03-21-17-01-01></p><p><strong>客户端应用HTTP代理后，可通过代理服务器访问内网HTTP协议资源</strong></p><p><strong>而在SSRF场景，需要SSRF具备支持HTTP两大请求方式：GET、POST，且有响应Body</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>POST /application/services/proxy/doPostAndGet HTTP/1.1
</span></span><span style=display:flex><span>Host: app.domain.com
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Content-Length: XX
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Accept: */*
</span></span><span style=display:flex><span>Referer: http://app.domain.com/application/portal/
</span></span><span style=display:flex><span>Accept-Encoding: gzip, deflate
</span></span><span style=display:flex><span>Accept-Language: zh-CN,zh;q=0.9
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;url&#34;:&#34;http://domain.com/sso?login&#34;,
</span></span><span style=display:flex><span>    &#34;method&#34;:&#34;post&#34;,
</span></span><span style=display:flex><span>    &#34;jsonBody&#34;:&#34;{\&#34;username\&#34;:\&#34;123456\&#34;}&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=flask-框架>Flask 框架</h2><p><img src=https://images.payloads.online/9685f1a0-4f5f-11ec-b8a6-00d861bf4abb.png alt=2020-03-21-17-02-11></p><p>Flask是一个用Python编写的Web应用程序框架，它基于Werkzeug WSGI工具包和Jinja2模板引擎。</p><p>Flask也被称为“microframework” ，因为它使用简单的核心，用extension增加其他功能，它没有默认使用的数据库、窗体验证工具。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hello_world</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Hello, World!&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://images.payloads.online/96ce8dca-4f5f-11ec-826f-00d861bf4abb.png alt=2020-03-21-17-02-36></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>$</span> <span style=color:#66d9ef>export</span> FLASK_APP<span style=color:#f92672>=</span>hello<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#f92672>$</span> python <span style=color:#f92672>-</span>m flask run
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> Running on http:<span style=color:#f92672>//</span><span style=color:#ae81ff>127.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.1</span>:<span style=color:#ae81ff>5000</span><span style=color:#f92672>/</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=flask-框架的请求流程>Flask 框架的请求流程</h3><ol><li>befor_first_request</li><li>befor_request</li><li>after_request</li><li>teardown_request → 异常处理</li><li>after_this_request</li></ol><p><img src=https://images.payloads.online/97b9303c-4f5f-11ec-a5f5-00d861bf4abb.png alt=2020-03-21-17-03-02></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, request, Response
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.before_request</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_proxy</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>request(
</span></span><span style=display:flex><span>        method<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>method,
</span></span><span style=display:flex><span>        url<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>url,
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>=</span>{key: value <span style=color:#66d9ef>for</span> (key, value) <span style=color:#f92672>in</span> request<span style=color:#f92672>.</span>headers},
</span></span><span style=display:flex><span>        data<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>get_data(),
</span></span><span style=display:flex><span>        cookies<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>cookies,
</span></span><span style=display:flex><span>        allow_redirects<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    excluded_headers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;content-encoding&#39;</span>, <span style=color:#e6db74>&#39;content-length&#39;</span>, <span style=color:#e6db74>&#39;transfer-encoding&#39;</span>, <span style=color:#e6db74>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>    headers <span style=color:#f92672>=</span> [(name, value) <span style=color:#66d9ef>for</span> (name, value) <span style=color:#f92672>in</span> resp<span style=color:#f92672>.</span>raw<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>items()
</span></span><span style=display:flex><span>               <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>lower() <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> excluded_headers]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> Response(resp<span style=color:#f92672>.</span>content, resp<span style=color:#f92672>.</span>status_code, headers)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run(debug<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></td></tr></table></div></div><p>Flask的默认端口是：5000</p><p><img src=https://images.payloads.online/97f79534-4f5f-11ec-ac7e-00d861bf4abb.png alt=2020-03-21-17-03-33></p><p>插件名称：SwitchyOmega</p><p><img src=https://images.payloads.online/982fb572-4f5f-11ec-b357-00d861bf4abb.png alt=2020-03-21-17-03-48></p><p>通过把代理服务器设置为5000（Flask默认）端口，浏览器的所有请求都会经过这五个装饰器，在每个装饰器中，可以写自己的检测规则。由于许多的SSRF漏洞接口返回的Content-Type始终都是一样的，因此会产生图片、JS等静态文件无法加载，下面我们将解决这个问题。</p><h3 id=解决文件类型问题>解决文件类型问题</h3><p>遇到这个问题，首先分析浏览器为什么无法加载。</p><ol><li>SSRF漏洞接口返回的Content-Type是Json，那么我们还需要将Json转化为一个字典，把DATA取出。</li><li>根据SSRF漏洞请求的URI来定义MIME Type，Response返回对应的MIME Type即可解决</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_filetype</span>(url):
</span></span><span style=display:flex><span>    content_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;text/html&#39;</span>
</span></span><span style=display:flex><span>    response_mimetype <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.png&#39;</span>:<span style=color:#e6db74>&#39;image/png&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.js&#39;</span>:<span style=color:#e6db74>&#39;application/javascript&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.jpg&#39;</span>:<span style=color:#e6db74>&#39;image/jpeg&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.gif&#39;</span>: <span style=color:#e6db74>&#39;image/gif&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.jpeg&#39;</span>:<span style=color:#e6db74>&#39;image/jpeg&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.ico&#39;</span>:<span style=color:#e6db74>&#39;image/x-icon&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.css&#39;</span>:<span style=color:#e6db74>&#39;text/css&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.svg&#39;</span>:<span style=color:#e6db74>&#39;image/svg+xml&#39;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    disassembled <span style=color:#f92672>=</span> urlparse(url)
</span></span><span style=display:flex><span>    filename, file_ext <span style=color:#f92672>=</span> splitext(basename(disassembled<span style=color:#f92672>.</span>path))
</span></span><span style=display:flex><span>    content_type <span style=color:#f92672>=</span> response_mimetype<span style=color:#f92672>.</span>get(file_ext, <span style=color:#e6db74>&#39;text/html&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> content_type
</span></span></code></pre></td></tr></table></div></div><p>这里定义了一些常见的MIME类型，通过截取URI的文件扩展名来找到对应的MIME类型，默认找不到就以HTML返回，不知道还有没有更赞的办法，如果有欢迎分享。</p><h3 id=content-encoding问题>Content-Encoding问题</h3><p>Accept-Encoding 和Content-Encoding是HTTP中用来对采用哪种编码格式传输正文进行协定的一对头部字段。</p><p>通过SSRF漏洞接口返回的通常可能是附带Content-Encoding头的响应，但与SSRF目标返回的不匹配，会造成网页展示不完全的情况。（本质上是接口取回的内容已经是解码后的，但接口本身可能又有编码头）</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>excluded_headers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;content-encoding&#39;</span>, <span style=color:#e6db74>&#39;content-length&#39;</span>, <span style=color:#e6db74>&#39;transfer-encoding&#39;</span>, <span style=color:#e6db74>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> [(name, value) <span style=color:#66d9ef>for</span> (name, value) <span style=color:#f92672>in</span> resp<span style=color:#f92672>.</span>raw<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>items()
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>lower() <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> excluded_headers]
</span></span></code></pre></td></tr></table></div></div><p>这里的解决方式是剔除编码头 Content-Encoding。</p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark_tritanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>