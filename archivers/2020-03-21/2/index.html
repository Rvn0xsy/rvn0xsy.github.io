<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>SSRF漏洞配合Flask的巧妙利用 - 内网漫游 - 倾旋的博客</title><meta name=theme-color><meta name=description content='SSRF 服务器请求伪造
SSRF(Server-side Request Forge, 服务端请求伪造)。由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。
常见的功能点


Net-NTLM && NTLM Relay
获取服务器真实IP
端口扫描
网页代理
&mldr;&mldr;

网页代理 - HTTP Proxy

客户端应用HTTP代理后，可通过代理服务器访问内网HTTP协议资源
而在SSRF场景，需要SSRF具备支持HTTP两大请求方式：GET、POST，且有响应Body
POST /application/services/proxy/doPostAndGet HTTP/1.1
Host: app.domain.com
Connection: keep-alive
Content-Length: XX
Content-Type: application/json
Accept: */*
Referer: http://app.domain.com/application/portal/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

{
    "url":"http://domain.com/sso?login",
    "method":"post",
    "jsonBody":"{\"username\":\"123456\"}"
}
Flask 框架

Flask是一个用Python编写的Web应用程序框架，它基于Werkzeug WSGI工具包和Jinja2模板引擎。
Flask也被称为“microframework” ，因为它使用简单的核心，用extension增加其他功能，它没有默认使用的数据库、窗体验证工具。
from flask import Flask
app = Flask(__name__)

@app.route(&#39;/&#39;)
def hello_world():
    return &#39;Hello, World!&#39;

$ export FLASK_APP=hello.py
$ python -m flask run
 * Running on http://127.0.0.1:5000/
Flask 框架的请求流程

befor_first_request
befor_request
after_request
teardown_request → 异常处理
after_this_request

'><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="SSRF漏洞配合Flask的巧妙利用 - 内网漫游"><meta itemprop=description content="SSRF(Server-side Request Forge, 服务端请求伪造)。由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务..."><meta itemprop=datePublished content="2020-03-21T00:00:00+00:00"><meta itemprop=dateModified content="2020-03-21T00:00:00+00:00"><meta itemprop=wordCount content="215"><meta property="og:url" content="https://payloads.online/archivers/2020-03-21/2/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="SSRF漏洞配合Flask的巧妙利用 - 内网漫游"><meta property="og:description" content="SSRF(Server-side Request Forge, 服务端请求伪造)。由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务..."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-21T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-21T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SSRF漏洞配合Flask的巧妙利用 - 内网漫游"><meta name=twitter:description content="SSRF(Server-side Request Forge, 服务端请求伪造)。由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务..."><link rel=canonical href=https://payloads.online/archivers/2020-03-21/2/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">SSRF漏洞配合Flask的巧妙利用 - 内网漫游</h1><div class="text-xs antialiased opacity-60"><time>Mar 21, 2020</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=ssrf-服务器请求伪造>SSRF 服务器请求伪造</h2><p>SSRF(Server-side Request Forge, 服务端请求伪造)。由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。</p><h3 id=常见的功能点>常见的功能点</h3><p><img src=https://images.payloads.online/960b6a34-4f5f-11ec-80ff-00d861bf4abb.png alt=2020-03-21-16-58-32></p><ul><li>Net-NTLM && NTLM Relay</li><li>获取服务器真实IP</li><li>端口扫描</li><li><strong>网页代理</strong></li><li>&mldr;&mldr;</li></ul><h3 id=网页代理---http-proxy>网页代理 - HTTP Proxy</h3><p><img src=https://images.payloads.online/964b0f36-4f5f-11ec-85c3-00d861bf4abb.png alt=2020-03-21-17-01-01></p><p><strong>客户端应用HTTP代理后，可通过代理服务器访问内网HTTP协议资源</strong></p><p><strong>而在SSRF场景，需要SSRF具备支持HTTP两大请求方式：GET、POST，且有响应Body</strong></p><pre tabindex=0><code>POST /application/services/proxy/doPostAndGet HTTP/1.1
Host: app.domain.com
Connection: keep-alive
Content-Length: XX
Content-Type: application/json
Accept: */*
Referer: http://app.domain.com/application/portal/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9

{
    &#34;url&#34;:&#34;http://domain.com/sso?login&#34;,
    &#34;method&#34;:&#34;post&#34;,
    &#34;jsonBody&#34;:&#34;{\&#34;username\&#34;:\&#34;123456\&#34;}&#34;
}
</code></pre><h2 id=flask-框架>Flask 框架</h2><p><img src=https://images.payloads.online/9685f1a0-4f5f-11ec-b8a6-00d861bf4abb.png alt=2020-03-21-17-02-11></p><p>Flask是一个用Python编写的Web应用程序框架，它基于Werkzeug WSGI工具包和Jinja2模板引擎。</p><p>Flask也被称为“microframework” ，因为它使用简单的核心，用extension增加其他功能，它没有默认使用的数据库、窗体验证工具。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hello_world</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Hello, World!&#39;</span>
</span></span></code></pre></div><p><img src=https://images.payloads.online/96ce8dca-4f5f-11ec-826f-00d861bf4abb.png alt=2020-03-21-17-02-36></p><pre tabindex=0><code>$ export FLASK_APP=hello.py
$ python -m flask run
 * Running on http://127.0.0.1:5000/
</code></pre><h3 id=flask-框架的请求流程>Flask 框架的请求流程</h3><ol><li>befor_first_request</li><li>befor_request</li><li>after_request</li><li>teardown_request → 异常处理</li><li>after_this_request</li></ol><p><img src=https://images.payloads.online/97b9303c-4f5f-11ec-a5f5-00d861bf4abb.png alt=2020-03-21-17-03-02></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, request, Response
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.before_request</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_proxy</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>    resp <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>request(
</span></span><span style=display:flex><span>        method<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>method,
</span></span><span style=display:flex><span>        url<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>url,
</span></span><span style=display:flex><span>        headers<span style=color:#f92672>=</span>{key: value <span style=color:#66d9ef>for</span> (key, value) <span style=color:#f92672>in</span> request<span style=color:#f92672>.</span>headers},
</span></span><span style=display:flex><span>        data<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>get_data(),
</span></span><span style=display:flex><span>        cookies<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>cookies,
</span></span><span style=display:flex><span>        allow_redirects<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    excluded_headers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;content-encoding&#39;</span>, <span style=color:#e6db74>&#39;content-length&#39;</span>, <span style=color:#e6db74>&#39;transfer-encoding&#39;</span>, <span style=color:#e6db74>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>    headers <span style=color:#f92672>=</span> [(name, value) <span style=color:#66d9ef>for</span> (name, value) <span style=color:#f92672>in</span> resp<span style=color:#f92672>.</span>raw<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>items()
</span></span><span style=display:flex><span>               <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>lower() <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> excluded_headers]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> Response(resp<span style=color:#f92672>.</span>content, resp<span style=color:#f92672>.</span>status_code, headers)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run(debug<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div><p>Flask的默认端口是：5000</p><p><img src=https://images.payloads.online/97f79534-4f5f-11ec-ac7e-00d861bf4abb.png alt=2020-03-21-17-03-33></p><p>插件名称：SwitchyOmega</p><p><img src=https://images.payloads.online/982fb572-4f5f-11ec-b357-00d861bf4abb.png alt=2020-03-21-17-03-48></p><p>通过把代理服务器设置为5000（Flask默认）端口，浏览器的所有请求都会经过这五个装饰器，在每个装饰器中，可以写自己的检测规则。由于许多的SSRF漏洞接口返回的Content-Type始终都是一样的，因此会产生图片、JS等静态文件无法加载，下面我们将解决这个问题。</p><h3 id=解决文件类型问题>解决文件类型问题</h3><p>遇到这个问题，首先分析浏览器为什么无法加载。</p><ol><li>SSRF漏洞接口返回的Content-Type是Json，那么我们还需要将Json转化为一个字典，把DATA取出。</li><li>根据SSRF漏洞请求的URI来定义MIME Type，Response返回对应的MIME Type即可解决</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_filetype</span>(url):
</span></span><span style=display:flex><span>    content_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;text/html&#39;</span>
</span></span><span style=display:flex><span>    response_mimetype <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.png&#39;</span>:<span style=color:#e6db74>&#39;image/png&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.js&#39;</span>:<span style=color:#e6db74>&#39;application/javascript&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.jpg&#39;</span>:<span style=color:#e6db74>&#39;image/jpeg&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.gif&#39;</span>: <span style=color:#e6db74>&#39;image/gif&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.jpeg&#39;</span>:<span style=color:#e6db74>&#39;image/jpeg&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.ico&#39;</span>:<span style=color:#e6db74>&#39;image/x-icon&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.css&#39;</span>:<span style=color:#e6db74>&#39;text/css&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;.svg&#39;</span>:<span style=color:#e6db74>&#39;image/svg+xml&#39;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    disassembled <span style=color:#f92672>=</span> urlparse(url)
</span></span><span style=display:flex><span>    filename, file_ext <span style=color:#f92672>=</span> splitext(basename(disassembled<span style=color:#f92672>.</span>path))
</span></span><span style=display:flex><span>    content_type <span style=color:#f92672>=</span> response_mimetype<span style=color:#f92672>.</span>get(file_ext, <span style=color:#e6db74>&#39;text/html&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> content_type
</span></span></code></pre></div><p>这里定义了一些常见的MIME类型，通过截取URI的文件扩展名来找到对应的MIME类型，默认找不到就以HTML返回，不知道还有没有更赞的办法，如果有欢迎分享。</p><h3 id=content-encoding问题>Content-Encoding问题</h3><p>Accept-Encoding 和Content-Encoding是HTTP中用来对采用哪种编码格式传输正文进行协定的一对头部字段。</p><p>通过SSRF漏洞接口返回的通常可能是附带Content-Encoding头的响应，但与SSRF目标返回的不匹配，会造成网页展示不完全的情况。（本质上是接口取回的内容已经是解码后的，但接口本身可能又有编码头）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>excluded_headers <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;content-encoding&#39;</span>, <span style=color:#e6db74>&#39;content-length&#39;</span>, <span style=color:#e6db74>&#39;transfer-encoding&#39;</span>, <span style=color:#e6db74>&#39;connection&#39;</span>]
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> [(name, value) <span style=color:#66d9ef>for</span> (name, value) <span style=color:#f92672>in</span> resp<span style=color:#f92672>.</span>raw<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>items()
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>if</span> name<span style=color:#f92672>.</span>lower() <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> excluded_headers]
</span></span></code></pre></div><p>这里的解决方式是剔除编码头 Content-Encoding。</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2020-04-02/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>如何实现一个Psexec</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2020-03-21/1/><span>Windows特权提升漏洞-符号</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>