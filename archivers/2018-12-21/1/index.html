<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Windows - 内存管理 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>21</span>
<span class=rest>Dec 2018</span></div></div><div class=matter><h1 class=title>Windows - 内存管理</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#0x00-windows-heap>0x00 Windows Heap</a></li><li><a href=#0x01-申请堆空间的步骤---heap-api>0x01 申请堆空间的步骤 - Heap API</a></li><li><a href=#0x02-heapcreate-example>0x02 HeapCreate Example</a></li><li><a href=#0x03-虚拟内存页管理>0x03 虚拟内存页管理</a><ol><li><a href=#申请虚拟内存页>申请虚拟内存页</a></li><li><a href=#return-value>Return value</a></li><li><a href=#内存的保护属性>内存的保护属性</a></li><li><a href=#virtualalloc-example>VirtualAlloc Example</a></li></ol></li><li><a href=#0x04-各种内存分配方式的关系>0x04 各种内存分配方式的关系</a><ol><li><a href=#各自的定义和理解>各自的定义和理解</a></li><li><a href=#区别与联系>区别与联系</a></li><li><a href=#关于内存的初始化和使用>关于内存的初始化和使用</a></li></ol></li></ol></nav></aside><h2 id=0x00-windows-heap>0x00 Windows Heap</h2><p>每个线程都有自己的堆栈，堆用于在内存中存储未知大小的数据，由堆管理器管理，而栈用于保存函数执行状态，存储局部变量。</p><h2 id=0x01-申请堆空间的步骤---heap-api>0x01 申请堆空间的步骤 - Heap API</h2><ul><li>HeapCreate // 创建堆句柄（内核对象）</li><li>GetProcessHeap // 获取一个堆句柄</li><li>GetProcessHeaps // 获取所有堆句柄</li><li>HeapAlloc // 申请堆空间</li><li>HeapReAlloc // 在HeapAlloc的基础上申请一块堆空间</li><li>HeapFree // 释放堆空间</li><li>HeapDestory // 销毁堆句柄</li></ul><h2 id=0x02-heapcreate-example>0x02 HeapCreate Example</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// ConsoleApplication2.cpp : 定义控制台应用程序的入口点。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 堆管理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;stdafx.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>VOID <span style=color:#a6e22e>P</span>(<span style=color:#66d9ef>wchar_t</span> <span style=color:#f92672>*</span> contents) {
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span><span style=color:#a6e22e>wprintf</span>(contents);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;pause&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>_tmain</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 堆管理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	# 创建堆
</span></span></span><span style=display:flex><span><span style=color:#75715e>	HANDLE HeapCreate(
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  DWORD  flOptions,
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  SIZE_T dwInitialSize,
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  SIZE_T dwMaximumSize
</span></span></span><span style=display:flex><span><span style=color:#75715e>	);
</span></span></span><span style=display:flex><span><span style=color:#75715e>	
</span></span></span><span style=display:flex><span><span style=color:#75715e>	flOptions: 1.HEAP_CREATE_ENABLE_EXECUTE 代码允许执行
</span></span></span><span style=display:flex><span><span style=color:#75715e>			   2.HEAP_GENERATE_EXCEPTIONS 如果分配内存失败，会产生异常
</span></span></span><span style=display:flex><span><span style=color:#75715e>			   3.HEAP_NO_SERIALIZE 不进行连续存取
</span></span></span><span style=display:flex><span><span style=color:#75715e>	dwInitialSize: 堆的初始化大小，如果为0，则系统会自动分配一个大小。
</span></span></span><span style=display:flex><span><span style=color:#75715e>	dwMaximumSize: 堆的最大值，如果为0，将是一个可增长的堆，可以达到系统能够分配的最大值。
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	HANDLE hHeap <span style=color:#f92672>=</span> <span style=color:#a6e22e>HeapCreate</span>(HEAP_CREATE_ENABLE_EXECUTE, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (hHeap <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>P</span>(<span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Error HeapCreate() ...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	# 获取堆句柄
</span></span></span><span style=display:flex><span><span style=color:#75715e>	HANDLE GetProcessHeap();
</span></span></span><span style=display:flex><span><span style=color:#75715e>	函数返回堆句柄，如果返回值为NULL，获取堆失败
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	HANDLE hHeapRand <span style=color:#f92672>=</span> <span style=color:#a6e22e>GetProcessHeap</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (hHeapRand <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>P</span>(<span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;GetProcessHeap() : No Heap ...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	# 获取堆句柄
</span></span></span><span style=display:flex><span><span style=color:#75715e>	DWORD GetProcessHeaps(
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  DWORD   NumberOfHeaps, // 输入参数，要获取的句柄数量
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  PHANDLE ProcessHeaps   // 输出参数，句柄数组，用于保存多个句柄
</span></span></span><span style=display:flex><span><span style=color:#75715e>	);
</span></span></span><span style=display:flex><span><span style=color:#75715e>	函数返回堆句柄，如果返回值为NULL，获取堆失败
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	CONST DWORD dwHeapMax <span style=color:#f92672>=</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>	HANDLE hHeapsNum[dwHeapMax];
</span></span><span style=display:flex><span>	DWORD dwHeapNum <span style=color:#f92672>=</span> <span style=color:#a6e22e>GetProcessHeaps</span>(dwHeapMax, hHeapsNum);
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span>wcout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Heap number : &#34;</span> <span style=color:#f92672>&lt;&lt;</span> dwHeapNum <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	# 为堆分配内存
</span></span></span><span style=display:flex><span><span style=color:#75715e>	DECLSPEC_ALLOCATOR LPVOID HeapAlloc(
</span></span></span><span style=display:flex><span><span style=color:#75715e>		HANDLE hHeap,  // 堆句柄
</span></span></span><span style=display:flex><span><span style=color:#75715e>		DWORD  dwFlags,// 内存分配标志
</span></span></span><span style=display:flex><span><span style=color:#75715e>		SIZE_T dwBytes // 分配大小（字节为单位）
</span></span></span><span style=display:flex><span><span style=color:#75715e>	);
</span></span></span><span style=display:flex><span><span style=color:#75715e>	dwFlags: 
</span></span></span><span style=display:flex><span><span style=color:#75715e>		HEAP_GENERATE_EXCEPTIONS -&gt; 抛出异常
</span></span></span><span style=display:flex><span><span style=color:#75715e>		HEAP_NO_SERIALIZE -&gt; 不连续存储
</span></span></span><span style=display:flex><span><span style=color:#75715e>		HEAP_ZERO_MEMORY -&gt; 将内存块全部清零
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	LPTSTR tAlloc <span style=color:#f92672>=</span> (LPTSTR)<span style=color:#a6e22e>HeapAlloc</span>(hHeapRand, HEAP_ZERO_MEMORY, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	# 在已分配的基础上继续分配
</span></span></span><span style=display:flex><span><span style=color:#75715e>	DECLSPEC_ALLOCATOR LPVOID HeapReAlloc(
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  HANDLE                 hHeap, // 堆句柄
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  DWORD                  dwFlags, // 内存分配标志
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  _Frees_ptr_opt_ LPVOID lpMem, // 分配内存后的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  SIZE_T                 dwBytes // 分配大小（字节为单位）
</span></span></span><span style=display:flex><span><span style=color:#75715e>	);
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HeapReAlloc</span>(hHeapRand, HEAP_ZERO_MEMORY<span style=color:#f92672>|</span> HEAP_REALLOC_IN_PLACE_ONLY, (LPVOID)tAlloc,<span style=color:#ae81ff>24</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lstrcpy</span>((LPTSTR)tAlloc, <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;HEllo&#34;</span>));
</span></span><span style=display:flex><span>	DWORD dwHeapSize <span style=color:#f92672>=</span> <span style=color:#a6e22e>HeapSize</span>(hHeapRand, HEAP_NO_SERIALIZE, tAlloc);
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span>wcout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;HeapSize : &#34;</span> <span style=color:#f92672>&lt;&lt;</span> dwHeapSize <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HeapFree</span>(hHeapRand, HEAP_NO_SERIALIZE, tAlloc);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HeapDestroy</span>(hHeapRand);
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span><span style=color:#a6e22e>wprintf</span>(<span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Success ... </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;pause&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=0x03-虚拟内存页管理>0x03 虚拟内存页管理</h2><h3 id=申请虚拟内存页>申请虚拟内存页</h3><p><strong>VirtualAlloc</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>LPVOID WINAPI <span style=color:#a6e22e>VirtualAlloc</span>(
</span></span><span style=display:flex><span>  _In_opt_ LPVOID lpAddress, <span style=color:#960050;background-color:#1e0010>分配内存页面的起始位置</span>
</span></span><span style=display:flex><span>  _In_     SIZE_T dwSize,    <span style=color:#960050;background-color:#1e0010>内存区域大小（</span>Byte<span style=color:#960050;background-color:#1e0010>）</span>
</span></span><span style=display:flex><span>  _In_     DWORD  flAllocationType, <span style=color:#960050;background-color:#1e0010>分配类型（</span>MEM_COMMIT<span style=color:#f92672>|</span>MEM_RESERVED<span style=color:#f92672>|</span>MEM_RESET<span style=color:#f92672>|</span>MEM_RESET_UNDO<span style=color:#960050;background-color:#1e0010>）</span>
</span></span><span style=display:flex><span>  _In_     DWORD  flProtect <span style=color:#960050;background-color:#1e0010>内存的保护属性</span> (PAGE_NOACCESS<span style=color:#f92672>|</span>PAGE_GUARD<span style=color:#f92672>|</span>PAGE_NOCACHE<span style=color:#f92672>|</span>PAGE_WRITECOMBINE)
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><p>进程的虚拟内存页面存在三种状态：</p><ul><li>Free（空闲）</li><li>Reserved（保留）</li><li>Committed（提交）</li></ul><p>Free：进程不能访问这种页面，因为这个页面还没有被分配。任何属于这个页面的虚拟内存地址进行访问都将引用异常。</p><p>Reserved：页面被保留以备将来使用，这些页面已被分配，但是没使用，物理地址空间中的内存不存在与其对应的物理内存分页。处于被保留的内存分页也不能被访问。</p><p>Committed：内存已经被分配，并且已经被使用，具有与之对应的物理地址空间中的内存分页。</p><p>VirtualAlloc可用于指定分配的内存是什么状态，如果当前内存的状态是Committed，则可以直接访问。</p><p>VirtualAlloc能够将内存页面的状态从Free、Reserved改为Committed，也可以将Free->Reserved，Reserved->Committed。</p><h3 id=return-value>Return value</h3><p>如果函数成功，则返回值是分配的页面区域的基址。</p><p>如果函数失败，则返回值为NULL。</p><h3 id=内存的保护属性>内存的保护属性</h3><ul><li>PAGE_NOACCESS</li><li>PAGE_GUARD</li><li>PAGE_NOCACHE</li><li>PAGE_WRITECOMBINE</li></ul><p><strong>>> <a href=https://docs.microsoft.com/zh-cn/windows/desktop/Memory/memory-protection-constants>内存保护常量</a></strong></p><h3 id=virtualalloc-example>VirtualAlloc Example</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// ConsoleApplication2.cpp : 定义控制台应用程序的入口点。
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 虚拟内存页管理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;stdafx.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;Windows.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>VOID <span style=color:#a6e22e>P</span>(<span style=color:#66d9ef>wchar_t</span> <span style=color:#f92672>*</span> contents) {
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span><span style=color:#a6e22e>wprintf</span>(contents);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;pause&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>_tmain</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span><span style=color:#a6e22e>wprintf</span>(<span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Success ... </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	LPVOID WINAPI VirtualAlloc(
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  _In_opt_ LPVOID lpAddress, 分配内存页面的起始位置
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  _In_     SIZE_T dwSize,    内存区域大小（Byte）
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  _In_     DWORD  flAllocationType, 分配类型（MEM_COMMIT|MEM_RESERVED|MEM_RESET|MEM_RESET_UNDO）
</span></span></span><span style=display:flex><span><span style=color:#75715e>	  _In_     DWORD  flProtect 内存的保护属性 (PAGE_NOACCESS|PAGE_GUARD|PAGE_NOCACHE|PAGE_WRITECOMBINE)
</span></span></span><span style=display:flex><span><span style=color:#75715e>	);
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	LPTSTR lpVirMem;
</span></span><span style=display:flex><span>	DWORD virtualMemSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>	MEMORY_BASIC_INFORMATION mbi;
</span></span><span style=display:flex><span>	lpVirMem <span style=color:#f92672>=</span> (LPTSTR)<span style=color:#a6e22e>VirtualAlloc</span>(NULL, virtualMemSize, MEM_COMMIT, PAGE_READWRITE);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (lpVirMem <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>P</span>(<span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Alloc Error ! </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VirtualQuery</span>(lpVirMem, <span style=color:#f92672>&amp;</span>mbi, <span style=color:#66d9ef>sizeof</span>(mbi));
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span>wcout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Virtual BaseAddress :&#34;</span> <span style=color:#f92672>&lt;&lt;</span> mbi.BaseAddress <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl <span style=color:#f92672>&lt;&lt;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;AllocationBase :&#34;</span> <span style=color:#f92672>&lt;&lt;</span> mbi.AllocationBase <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl <span style=color:#f92672>&lt;&lt;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;AllocationProtect :&#34;</span> <span style=color:#f92672>&lt;&lt;</span> mbi.AllocationProtect <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ZeroMemory</span>(lpVirMem, virtualMemSize);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CopyMemory</span>(lpVirMem, <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Hello World !!!&#34;</span>), <span style=color:#66d9ef>sizeof</span>(<span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;Hello World !!!&#34;</span>)));
</span></span><span style=display:flex><span>	std<span style=color:#f92672>::</span>wcout <span style=color:#f92672>&lt;&lt;</span> lpVirMem <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34; | &#34;</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#66d9ef>sizeof</span>(lpVirMem) <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ********************************************************************
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>VirtualFree</span>(lpVirMem, <span style=color:#ae81ff>0</span>, MEM_RELEASE);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>system</span>(<span style=color:#e6db74>&#34;pause&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>Out:
</span></span></span><span style=display:flex><span><span style=color:#75715e>Success ...
</span></span></span><span style=display:flex><span><span style=color:#75715e>Virtual BaseAddress :00310000
</span></span></span><span style=display:flex><span><span style=color:#75715e>AllocationBase :00310000
</span></span></span><span style=display:flex><span><span style=color:#75715e>AllocationProtect :4
</span></span></span><span style=display:flex><span><span style=color:#75715e>Hello World !!! | 4
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=0x04-各种内存分配方式的关系>0x04 各种内存分配方式的关系</h2><blockquote><p>内容来源：https://www.cnblogs.com/arsense/p/6505690.html</p></blockquote><h3 id=各自的定义和理解>各自的定义和理解</h3><ul><li>GlobalAlloc()</li></ul><p>GlobalAlloc()主要用于Win32应用程序实现从全局堆中分配出内存供2017-03-05程序使用，是16位WINDOWS程序使用的API，对应于系统的全局栈，返回一个内存句柄，在实际需要使用时，用GlobalLock()来实际得到内存 区。但32位WINDOWS系统中全局栈和局部堆的区别已经不存在了，因此不推荐在Win32中使用该函数，应使用新的内存分配函数HeapAlloc()以得到更好的支持，GlobalAlloc()还可以用，主要是为了 兼容。</p><p>一般情况下我们在编程的时候，给应用程序分配的内存都是可以移动的或者是可以丢弃的，这样能使有限的内存资源充分利用，所以，在某一个时候我们分配的那块 内存的地址是不确定的，因为他是可以移动的，所以得先锁定那块内存块，这儿应用程序需要调用API函数GlobalLock函数来锁定句柄。如下： lpMem=GlobalLock(hMem); 这样应用程序才能存取这块内存。所以我们在使用GlobalAllock时，通常搭配使用GlobalLock，当然在不使用内存时，一定记得使用 GlobalUnlock，否则被锁定的内存块一直不能被其他变量使用。</p><p>GlobalAlloc对应的释放空间的函数为GlobalFree。</p><ul><li>HeapAlloc()</li></ul><p>HeapALloc是从堆上分配一块内存，且分配的内存是不可移动的（即如果没有连续的空间能满足分配的大小，程序不能将其他零散的 空间利用起来，从而导致分配失败），该分配方法是从一指定地址开始分配，而不像GloabalAlloc是从全局堆上分配，这个有可能是全局，也有可能是局部。</p><ul><li>malloc()</li></ul><p>是C运行库中的动态内存分配函数，主要用于ANSI C程序中，是标准库函数。WINDOWS程序基本不再使用这种方法进行内存操作，因为它比WINDOWS内存分配函数少了一些特性，如：整理内存。</p><ul><li>new</li></ul><p>标准C++一般使用new语句分配动态的内存空间，需要申请数组时，可以直接使用new int[3]这样的方式，释放该方法申请的内存空间使用对应的delete语句，需要释放的内存空间为一个数组，则使用delete [] ary;这样的方式。</p><p>要访问new所开辟的结构体空间,无法直接通过变量名进行,只能通过赋值的指针进行访问.</p><p>new在内部调用malloc来分配内存，delete在内部调用free来释放内存。</p><ul><li>VirtualAlloc</li></ul><p>下面是网友的解释 但我个人的理解这个才是内存申请的鼻祖，所有的内存的申请都感觉默认调用了它。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>PVOID <span style=color:#a6e22e>VirtualAlloc</span>(
</span></span><span style=display:flex><span>    PVOID pvAddress, 
</span></span><span style=display:flex><span>    SIZE_T dwSize, 
</span></span><span style=display:flex><span>    DWORD fdwAllocationType, 
</span></span><span style=display:flex><span>    DWORD fdwProtect)
</span></span></code></pre></td></tr></table></div></div><p>VirtualAlloc是Windows提供的API，通常用来分配大块的内存。例如如果想在进程A和进程B之间通过共享内存的方式实现通信，可以使用该函数（这也是较常用的情况）。不要用该函数实现通常情况的内存分配。该函数的一个重要特性是可以预定指定地址和大小的虚拟内存空间。例如，希望在进程的地址空间中第50MB的地方分配内存，那么将参数 50*1024*`1024 = 52428800 传递给pvAddress，将需要的内存大小传递给dwSize。如果系统有足够大的闲置区域能满足请求，则系统会将该块区域预订下来并返回预订内存的基地址，否则返回NULL。</p><p>使用VirtualAlloc分配的内存需要使用VirtualFree来释放。</p><h3 id=区别与联系>区别与联系</h3><p>它们之间的区别主要有以下几点：</p><p>1、GlobalAlloc()函数在程序的堆中分配一定的内存，是Win16的函数，对应于系统的全局栈，而在Win32中全局栈和局部堆的区别已经不存在了，因此不推荐在Win32中使用该函数。</p><p>2、malloc()是标准库函数，而new则是运算符，它们都可以用于申请动态内存。</p><p>3、new()实际上调用的是malloc()函数。</p><p>4、new运算符除了分配内存，还可以调用构造函数，但是malloc()函数只负责分配内存。</p><p>5、对于非内部数据类型的对象而言，只使用malloc()函数将无法满足动态对象的要求，因为malloc()函数不能完成执行构造函数的任务。</p><p>6、malloc(); 和 HeapAlloc(); 都是从堆中分配相应的内存，不同的是一个是c run time的函数，一个是windows系统的函数， 对于windows程序来说，使用HeapAlloc();会比malloc();效率稍稍高一些。</p><h3 id=关于内存的初始化和使用>关于内存的初始化和使用</h3><p><strong>内存分配方式</strong></p><p>内存分配方式有三种：</p><p>1）从静态存储区域分配。内存在程序编译的时候就已经分配好，这块内存在程序的整个运行期间都存在。例如全局变量，static变量。</p><p>（2）在栈上创建。在执行函数时，函数内局部变量的存储单元都可以在栈上创建，函数执行结束时这些存</p><p>储单元自动被释放。栈内存分配运算内置于处理器的指令集中，效率很高，但是分配的内存容量有限。</p><p>（3） 从堆上分配，亦称动态内存分配。程序在运行的时候用malloc或new申请任意多少的内存，程序员自己负责在何时用free或delete释放内存。动态内存的生存期由我们决定，使用非常灵活，但问题也最多。</p><p><strong>内存使用错误</strong></p><p>发生内存错误是件非常麻烦的事情。编译器不能自动发现这些错误，通常是在程序运行时才能捕捉到。</p><p>而这些错误大多没有明显的症状，时隐时现，增加了改错的难度。有时用户怒气冲冲地把你找来，程序却没有</p><p>发生任何问题，你一走，错误又发作了。 常见的内存错误及其对策如下：</p><ul><li>内存分配未成功，却使用了它。</li></ul><p>　　编程新手常犯这种错误，因为他们没有意识到内存分配会不成功。常用解决办法是，在使用内存之前检查指针是否为NULL。如果是用malloc或new来申请内存，应该用if(p==NULL) 或if(p!=NULL)进行防错处理。</p><ul><li>内存分配虽然成功，但是尚未初始化就引用它。</li></ul><p>　　犯这种错误主要有两个起因：一是没有初始化的观念；二是误以为内存的缺省初值全为零，导致引用初值</p><p>错误（例如数组）。 内存的缺省初值究竟是什么并没有统一的标准，尽管有些时候为零值，我们宁可信其无不</p><p>可信其有。所以无论用何种方式创建数组，都别忘了赋初值，即便是赋零值也不可省略，不要嫌麻烦。</p><ul><li>内存分配成功并且已经初始化，但操作越过了内存的边界。</li></ul><p>　　例如在使用数组时经常发生下标“多1”或者“少1”的操作。特别是在for循环语句中，循环次数很容易搞</p><p>错，导致数组操作越界。</p><ul><li>忘记了释放内存，造成内存泄露。</li></ul><p>　　含有这种错误的函数每被调用一次就丢失一块内存。刚开始时系统的内存充足，你看不到错误。终有一次程序突然死掉，系统出现提示：内存耗尽。</p><p>　　动态内存的申请与释放必须配对，程序中malloc与free的使用次数一定要相同，否则肯定有错误</p><p>（new/delete同理）。</p><ul><li>释放了内存却继续使用它。</li></ul><p>　
有三种情况：</p><p>　　（1）程序中的对象调用关系过于复杂，实在难以搞清楚某个对象究竟是否已经释放了内存，此时应该重新</p><p>设计数据结构，从根本上解决对象管理的混乱局面。</p><p>　　（2）函数的return语句写错了，注意不要返回指向“栈内存”的“指针”或者“引用”，因为该内存在函</p><p>数体结束时被自动销毁。</p><p>　　（3）使用free或delete释放了内存后，没有将指针设置为NULL。导致产生“野指针”。</p><hr><p>　　【规则1】用malloc或new申请内存之后，应该立即检查指针值是否为NULL。防止使用指针值为NULL的内存</p><p>　　【规则2】不要忘记为数组和动态内存赋初值。防止将未被初始化的内存作为右值使用。</p><p>　　【规则3】避免数组或指针的下标越界，特别要当心发生“多1”或者“少1”操作。</p><p>　　【规则4】动态内存的申请与释放必须配对，防止内存泄漏。</p><p>　　【规则5】用free或delete释放了内存之后，立即将指针设置为NULL，防止产生“野指针”。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#0x00-windows-heap>0x00 Windows Heap</a></li><li><a href=#0x01-申请堆空间的步骤---heap-api>0x01 申请堆空间的步骤 - Heap API</a></li><li><a href=#0x02-heapcreate-example>0x02 HeapCreate Example</a></li><li><a href=#0x03-虚拟内存页管理>0x03 虚拟内存页管理</a><ol><li><a href=#申请虚拟内存页>申请虚拟内存页</a></li><li><a href=#return-value>Return value</a></li><li><a href=#内存的保护属性>内存的保护属性</a></li><li><a href=#virtualalloc-example>VirtualAlloc Example</a></li></ol></li><li><a href=#0x04-各种内存分配方式的关系>0x04 各种内存分配方式的关系</a><ol><li><a href=#各自的定义和理解>各自的定义和理解</a></li><li><a href=#区别与联系>区别与联系</a></li><li><a href=#关于内存的初始化和使用>关于内存的初始化和使用</a></li></ol></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2018 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>