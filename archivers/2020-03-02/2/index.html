<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>红队分享-如何挖掘Windows Bypass UAC（第一课） - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>02</span>
<span class=rest>Mar 2020</span></div></div><div class=matter><h1 class=title>红队分享-如何挖掘Windows Bypass UAC（第一课）</h1></div></div><h2 id=什么是uac>什么是UAC</h2><p>用户帐户控制（User Account Control，简写作UAC)是微软公司在其Windows Vista及更高版本操作系统中采用的一种控制机制。其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权，以达到帮助阻止恶意程序（有时也称为“恶意软件”）损坏系统的效果。</p><p>先观察一下：</p><ul><li>在Windows 7下打开注册表</li></ul><p><img src=https://images.payloads.online/8c25d4c8-4f5f-11ec-b9cf-00d861bf4abb.png alt=2020-03-01-11-29-43></p><ul><li>在Windows 7上管理计算机</li></ul><p><img src=https://images.payloads.online/8c5f7cdc-4f5f-11ec-9819-00d861bf4abb.png alt=2020-03-01-11-29-52></p><ul><li>在Windows 10上管理计算机</li></ul><p><img src=https://images.payloads.online/8ca0a0b8-4f5f-11ec-910f-00d861bf4abb.png alt=2020-03-01-11-30-00></p><p>有的需要授权、有的不需要，是因为UAC是分授权等级的：</p><p>首先请按Win+R，输入gpedit.msc，打开组策略。</p><p>然后我们在左侧窗口找到“计算机配置&ndash;Windows设置&ndash;安全设置&ndash;本地策略&ndash;安全选项”，再在右侧窗口找到“用户帐户控制： 管理员批准模式中管理员的提升权限提示的行为”，双击该条目，打开设置窗口，如下图：</p><p><img src=https://images.payloads.online/8cdd2132-4f5f-11ec-ba0d-00d861bf4abb.png alt=2020-03-01-11-30-10></p><ul><li>不提示直接提升：关闭UAC，需要权限时直接提升权限。</li><li>在安全桌面上提示凭据：需要权限时在安全桌面上输入管理员密码提升权限。</li><li>在安全桌面上同意提示：需要权限时在安全桌面上选择“允许”提升权限。</li><li>提示凭据：需要权限时在普通窗口中输入管理员密码提升权限。</li><li>同意提示：需要权限时在普通窗口中选择“允许”提升权限。</li><li>非 Windows 二进制文件的同意提示：(默认设置)当非 Microsoft 应用程序的某个操作需要提升权限时，选择“允许”提升权限。</li></ul><h2 id=为什么有的应用程序不需要提示uac>为什么有的应用程序不需要提示UAC？</h2><p>因为普通应用执行权限有限，某些操作必然会要求更高的管理员权限。此时，通常就需要一个权限提升的操作。程序可以向系统请求提权，系统会将此请求通过提一个提示框，请用户确认。</p><p>如果当前用户的用户组权限不是管理员，提权操作是要求输入管理员密码的，这点和在Linux中的相应操作类似。</p><ul><li>程序只能在运行前要求提权。如果已经在运行了，那么将失去申请提权的能力</li><li>权限提升仅对此次进程有效</li></ul><p>提升权限的操作大致有两个：</p><ul><li>自动提权请求</li><li>手动提权请求</li></ul><p>手动提权就是“以管理员身份运行”，自动提权请求就是程序本身就一运行就开始申请权限，如：注册表编辑器</p><p>在开发的过程中，程序员若要开发一个程序，可以在编译器配置，写入一个配置文件，用于向系统标识该应用程序是必须要管理员权限运行的。</p><h3 id=manifest文件>manifest文件</h3><p>这个文件本质上是一个XML文件，用于标识当前应用程序的配置属性。</p><p><img src=https://images.payloads.online/8d18d466-4f5f-11ec-a514-00d861bf4abb.png alt=2020-03-01-11-30-21></p><ul><li>aslnvoker 默认权限</li><li>highestAvailable 最高权限</li><li>requireAdministrator 必须是管理员权限</li></ul><p>我编译选项调整为requireAdministrator,当用户运行程序后,将获得管理员权限会话,不需要绕过UAC了。</p><p>manifest中其实还有其他属性，如：autoElevate（自动提升）</p><p><strong>拥有自动权限提升属性的文件，当默认以管理员权限运行，不需要经过用户的授权。</strong></p><h2 id=寻找auto-elevate>寻找auto Elevate</h2><p>工具地址：https://github.com/g3rzi/Manifesto</p><p><img src=https://images.payloads.online/8da15bba-4f5f-11ec-8638-00d861bf4abb.png alt=2020-03-01-11-30-30></p><p>通过不断遍历autoElevate属性，寻找自动权限提升的程序。</p><p><img src=https://images.payloads.online/8ded3224-4f5f-11ec-811d-00d861bf4abb.png alt=2020-03-01-11-30-37></p><p>我使用Powershell启动：C:\Windows\system32\eudcedit.exe</p><p><img src=https://images.payloads.online/8e2829b0-4f5f-11ec-8f21-00d861bf4abb.png alt=2020-03-01-11-30-50></p><p>发现没有弹出UAC确认，没有继承Powershell的权限，它的权限是High。</p><p>假设，如果C:\Windows\system32\eudcedit.exe存在一个DLL劫持漏洞，那么普通用户就可以用低权限绕过UAC确认，以高权限执行任意代码。</p><h2 id=手动bypass-uac>手动Bypass UAC</h2><p><img src=https://images.payloads.online/8e643284-4f5f-11ec-b3f3-00d861bf4abb.png alt=2020-03-01-11-31-01></p><p>C:\Windows\system32\odbcad32.exe 该程序用于配置ODBC数据源，但提供了一个输入点，那就是文件浏览器，通过文件浏览器我们可以打开一个管理员权限的Powershell。</p><p><img src=https://images.payloads.online/8eb26f12-4f5f-11ec-ad7f-00d861bf4abb.png alt=2020-03-01-11-31-10></p><p><img src=https://images.payloads.online/8eef7e84-4f5f-11ec-bff5-00d861bf4abb.png alt=2020-03-01-11-31-20></p><p>使用Powershell启动其他程序，也都是以管理员权限运行：</p><p><img src=https://images.payloads.online/8f2ae96a-4f5f-11ec-b687-00d861bf4abb.png alt=2020-03-01-11-31-27></p><p>下一章，将分析几个UAC的绕过例子。</p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>