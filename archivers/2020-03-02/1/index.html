<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>通过反射DLL注入来构建后渗透模块（第一课） - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>02</span>
<span class=rest>Mar 2020</span></div></div><div class=matter><h1 class=title>通过反射DLL注入来构建后渗透模块（第一课）</h1></div></div><h2 id=aggressor-script>Aggressor Script</h2><p>Aggressor Script是Cobalt Strike 3.0版本以上的一个内置脚本语言，由<a href=http://sleep.dashnine.org/manual>Sleep</a>语言解析，Cobalt Strike 3.0以上版本的菜单、选项、事件都由default.cna构建。红队人员可以通过它来调用一些IRC、Webhook接口去对接机器人，实现自动化渗透与监控，Aggressor Script是Cobalt Strike这款C2平台的画龙点睛之笔。</p><p>对于Python、C/C++爱好者来说，Sleep语言一开始接触的时候感觉很奇怪，会有很多想吐槽的点，但久而久之，就会发现它的便捷之处。</p><h2 id=反射-dll注入>反射 DLL注入</h2><p>Aggressor Script脚本提供了一些关于反射DLL的接口：https://cobaltstrike.com/aggressor-script/functions.html#bdllspawn</p><p>话不多说，先上代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>BOOL WINAPI <span style=color:#a6e22e>DllMain</span>( HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpReserved ) {
</span></span><span style=display:flex><span>	BOOL bReturnValue <span style=color:#f92672>=</span> TRUE;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span>( dwReason ) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> DLL_QUERY_HMODULE:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span>( lpReserved <span style=color:#f92672>!=</span> NULL )
</span></span><span style=display:flex><span>				<span style=color:#f92672>*</span>(HMODULE <span style=color:#f92672>*</span>)lpReserved <span style=color:#f92672>=</span> hAppInstance;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> DLL_PROCESS_ATTACH:
</span></span><span style=display:flex><span>			hAppInstance <span style=color:#f92672>=</span> hinstDLL;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* print some output to the operator */</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (lpReserved <span style=color:#f92672>!=</span> NULL) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Hello from test.dll. Parameter is &#39;%s&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)lpReserved);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Hello from test.dll. There is no parameter</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* flush STDOUT */</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>/* we&#39;re done, so let&#39;s exit */</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ExitProcess</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> DLL_PROCESS_DETACH:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> DLL_THREAD_ATTACH:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> DLL_THREAD_DETACH:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> bReturnValue;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>很明显，这是一个DLL的主函数，在经过DLL_PROCESS_ATTACH的时候，开始执行代码。程序通过DLLMain函数的lpReserved来当做参数传递。</p><p>但光看一个DLLMain是看不出后面的奇妙的，我们把目光转向反射DLL注入技术的作者：</p><p><img src=https://images.payloads.online/8f753ce0-4f5f-11ec-8dde-00d861bf4abb.png alt=2020-03-01-11-25-55></p><p>这里有一个完整示例。</p><p>通过跟踪代码：https://github.com/stephenfewer/ReflectiveDLLInjection/blob/master/inject/src/LoadLibraryR.c</p><p><img src=https://images.payloads.online/8fbd8f0e-4f5f-11ec-b422-00d861bf4abb.png alt=2020-03-01-11-26-06></p><p>发现该函数会寻找ReflectiveLoader这个导出函数的地址，然后直接创建一个远程线程执行这个函数，这个函数本身又会自动模拟整个LoadLibrary API，从而执行DLLMain，最终完成代码执行。</p><h2 id=开发自己的反射dll>开发自己的反射DLL</h2><p>首先，可以直接将反射DLL注入作者的项目拿过来使用：</p><p><img src=https://images.payloads.online/9001d0a6-4f5f-11ec-a6e0-00d861bf4abb.png alt=2020-03-01-11-26-50></p><p>接着就要编写cna脚本了。</p><p><img src=https://images.payloads.online/904b1d92-4f5f-11ec-a8c4-00d861bf4abb.png alt=2020-03-01-11-27-00></p><p>文件目录：</p><p><img src=https://images.payloads.online/908c7b7a-4f5f-11ec-9b50-00d861bf4abb.png alt=2020-03-01-11-27-08></p><p>通过Cobaltstrike加载后，可以执行reflective_dll在客户端弹出一个信息框。</p><p><img src=https://images.payloads.online/90c98740-4f5f-11ec-9e06-00d861bf4abb.png alt=2020-03-01-11-27-21></p><p>整个过程是拥有极少的敏感行为特征，因此可以非常容易的绕过一些反病毒查杀。</p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>