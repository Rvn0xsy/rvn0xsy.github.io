<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Nmap扩展开发 - 倾旋的博客</title><meta name=theme-color><meta name=description content="0x00 资产扫描、汇总、实时监控
资产扫描能够有利于企业内部查看终端、监控终端、对终端进行安全加固。周期性的扫描能有效快速修补漏洞、降低办公网络风险。
如何进行汇总、实时监控？
在我们要进行汇总的时候，有如下几个可以考虑的方案。

PDF
Excel
Text
Database / SQL

PDF && Excel && Text 都不适合实时View
Database / SQL 有利于生成数据汇总、图表，并且可移植性很高。
Database -> Web -> Excel/PDF &mldr;. 可行性都变得高了起来
实时监控采用任务调度，数据库采用IO效率高的NO SQL产品，详细信息采用普通的数据库：MySQL、SQL Server、Oracel&mldr;
0X01 解决方案

Nmap简介、目录结构、扫描流程、Nse Engine

0X02 简介
Nmap (“Network Mapper(网络映射器)”) 是一款开放源代码的 网络探测和安全审核的工具。它的设计目标是快速地扫描大型网络，当然用它扫描单个 主机也没有问题。Nmap以新颖的方式使用原始IP报文来发现网络上有哪些主机，那些 主机提供什么服务(应用程序名和版本)，那些服务运行在什么操作系统(包括版本信息)， 它们使用什么类型的报文过滤器/防火墙，以及一堆其它功能。虽然Nmap通常用于安全审核， 许多系统管理员和网络管理员也用它来做一些日常的工作，比如查看整个网络的信息， 管理服务升级计划，以及监视主机和服务的运行。
目录结构


    
        文件名称
        文件说明
    
    
		nmap.dtd
		
		Nmap输出的XML格式内部变量的定义
		
    
    
		nmap-mac-prefixes
		是Nmap针对不同终端的MAC地址所收集的指纹（常用于内网扫描）
    
        
		nmap-os-db
		Nmap针对不同终端的操作系统返回的数据包特征所收集的指纹
    
        
		nmap-payloads
		是Nmap在扫描时将payload向扫描目标发送的数据
    
        
		nmap-protocols
		Nmap 用来存储目标端口对应服务描述的db文件
    
        
		nmap-rpc
		Nmap在扫描的时候调用RPC进行服务发现的db文件
    
    
		nmap-service-probes
		Nmap针对响应数据包内容进行正则匹配从而判断服务的db文件
    
    
		nmap-services
		Nmap存储一个TCP/UDP服务的db文件
    
    
		nmap-xsl 
		Nmap导出xml文件的模板
    
    
		nselib
		Nmap的脚本引擎扩展库
    
    
		
		
    
    
		nse_main.lua
		在调用任何Nmap脚本都会提前自动调用的预处理Lua脚本
    
    
		Scripts
		Nmap的脚本扩展
    

扫描流程 V1
"><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.148.2"><meta itemprop=name content="Nmap扩展开发"><meta itemprop=description content="Nmap进行漏洞扫描，编写扩展"><meta itemprop=datePublished content="2017-08-07T00:00:00+00:00"><meta itemprop=dateModified content="2017-08-07T00:00:00+00:00"><meta itemprop=wordCount content="668"><meta property="og:url" content="https://payloads.online/archivers/2017-08-07/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="Nmap扩展开发"><meta property="og:description" content="Nmap进行漏洞扫描，编写扩展"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-08-07T00:00:00+00:00"><meta property="article:modified_time" content="2017-08-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nmap扩展开发"><meta name=twitter:description content="Nmap进行漏洞扫描，编写扩展"><link rel=canonical href=https://payloads.online/archivers/2017-08-07/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">Nmap扩展开发</h1><div class="text-xs antialiased opacity-60"><time>Aug 7, 2017</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x00-资产扫描汇总实时监控>0x00 资产扫描、汇总、实时监控</h2><p>资产扫描能够有利于企业内部查看终端、监控终端、对终端进行安全加固。周期性的扫描能有效快速修补漏洞、降低办公网络风险。</p><h3 id=如何进行汇总实时监控>如何进行汇总、实时监控？</h3><p>在我们要进行汇总的时候，有如下几个可以考虑的方案。</p><ul><li>PDF</li><li>Excel</li><li>Text</li><li>Database / SQL</li></ul><p>PDF && Excel && Text 都不适合实时View</p><p>Database / SQL 有利于生成数据汇总、图表，并且可移植性很高。</p><p>Database -> Web -> Excel/PDF &mldr;. 可行性都变得高了起来</p><p>实时监控采用任务调度，数据库采用IO效率高的NO SQL产品，详细信息采用普通的数据库：MySQL、SQL Server、Oracel&mldr;</p><h2 id=0x01-解决方案>0X01 解决方案</h2><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x01.png alt=解决方案></p><h3 id=nmap简介目录结构扫描流程nse-engine>Nmap简介、目录结构、扫描流程、Nse Engine</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/nmap.jpg alt=Nmap></p><h3 id=0x02-简介>0X02 简介</h3><p>Nmap (“Network Mapper(网络映射器)”) 是一款开放源代码的 网络探测和安全审核的工具。它的设计目标是快速地扫描大型网络，当然用它扫描单个 主机也没有问题。Nmap以新颖的方式使用原始IP报文来发现网络上有哪些主机，那些 主机提供什么服务(应用程序名和版本)，那些服务运行在什么操作系统(包括版本信息)， 它们使用什么类型的报文过滤器/防火墙，以及一堆其它功能。虽然Nmap通常用于安全审核， 许多系统管理员和网络管理员也用它来做一些日常的工作，比如查看整个网络的信息， 管理服务升级计划，以及监视主机和服务的运行。</p><h3 id=目录结构>目录结构</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x02.png alt=目录结构></p><table><tr><td>文件名称</td><td>文件说明</td></tr><tr><td>nmap.dtd</td><td>Nmap输出的XML格式内部变量的定义</td></tr><tr><td>nmap-mac-prefixes</td><td>是Nmap针对不同终端的MAC地址所收集的指纹（常用于内网扫描）</td></tr><tr><td>nmap-os-db</td><td>Nmap针对不同终端的操作系统返回的数据包特征所收集的指纹</td></tr><tr><td>nmap-payloads</td><td>是Nmap在扫描时将payload向扫描目标发送的数据</td></tr><tr><td>nmap-protocols</td><td>Nmap 用来存储目标端口对应服务描述的db文件</td></tr><tr><td>nmap-rpc</td><td>Nmap在扫描的时候调用RPC进行服务发现的db文件</td></tr><tr><td>nmap-service-probes</td><td>Nmap针对响应数据包内容进行正则匹配从而判断服务的db文件</td></tr><tr><td>nmap-services</td><td>Nmap存储一个TCP/UDP服务的db文件</td></tr><tr><td>nmap-xsl</td><td>Nmap导出xml文件的模板</td></tr><tr><td>nselib</td><td>Nmap的脚本引擎扩展库</td></tr><tr><td></td><td></td></tr><tr><td>nse_main.lua</td><td>在调用任何Nmap脚本都会提前自动调用的预处理Lua脚本</td></tr><tr><td>Scripts</td><td>Nmap的脚本扩展</td></tr></table><h3 id=扫描流程-v1>扫描流程 V1</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x03.png alt="扫描流程 V1"></p><h3 id=扫描流程-v2>扫描流程 V2</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x05.png alt="扫描流程 V2"></p><h3 id=nse-enginenmap-脚本引擎>Nse Engine（Nmap 脚本引擎）</h3><p>Nmap Nse 脚本引擎用于针对发现的OS、主机、端口进行不同的操作，例如：Fuzz测试、漏洞发现、漏洞利用等。这对Nmap又增添了一大亮点，所以说Nmap不只是一个扫描工具，在黑客的手中，更是一款爱不释手的渗透工具。</p><h3 id=nse-engine的执行流程>Nse Engine的执行流程</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x04.png alt=Nse流程></p><h2 id=0x03-一个简单的扩展打开世界>0X03 一个简单的扩展打开世界</h2><p><a href=https://nmap.org/book/nse-api.html>https://nmap.org/book/nse-api.html</a></p><p>Nmap扩展主要由以下几个变量构成。编码方式：变量绑定函数</p><table><tr><td>变量名称</td><td>函数执行顺序</td></tr><tr><td>prerule()</td><td>最先执行</td></tr><tr><td>hostrule(host)</td><td>第二步执行</td></tr><tr><td>portrule(host,port)</td><td>第二步执行</td></tr><tr><td>postrule()</td><td>最后一步执行</td></tr></table><p>顺序为：<code>Prerule -> Hostrule or Portrule -> Action -> Postrule</code></p><p>当 <code>Hostrule</code> 或者 <code>Portrule</code> 的绑定函数返回<code>true</code>的时候，都会执行一次<code>Action</code>的绑定函数。</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x06.png alt=函数流程></p><h3 id=入库>入库</h3><p>获取参数->连接数据库 -> 采用不同条件判断期望获取到的值->执行SQL</p><p>获取参数：stdnse lib [stdnse.get_script_args()]</p><p>连接数据库：mysql lib</p><p>获取socket : nmap socket lib</p><p>socket = nmap.new_socket() &ndash; 获得一个新的socket套接字</p><p>socket:set_timeout(1000) &ndash; 设置超时时间</p><p>socket:connect(host_ip,port_number) &ndash; 连接目标</p><p>socket:close() &ndash; 关闭套接字连接</p><p>我自己根据API封装了一个执行MySQL Query的扩展：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> mysql <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;mysql&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> nmap <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;nmap&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stdnse <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;stdnse&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>description <span style=color:#f92672>=</span><span style=color:#e6db74>[[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>This is a Lua script that performs the MySQL statement.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>]]</span>
</span></span><span style=display:flex><span>author <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;China CoraLab payloads&#34;</span>
</span></span><span style=display:flex><span>license <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Same as Nmap--See https://nmap.org/book/man-legal.html&#34;</span>
</span></span><span style=display:flex><span>categories <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;external&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>socket <span style=color:#f92672>=</span> nmap.new_socket()
</span></span><span style=display:flex><span>socket:set_timeout(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>try <span style=color:#f92672>=</span> nmap.new_try(<span style=color:#66d9ef>function</span>() socket:close() <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>optionsConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>    sqlQuery <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SELECT MD5(&#39;admin&#39;),&#34;</span>,
</span></span><span style=display:flex><span>    host     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>    port     <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>optionsConfig.username <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.username&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.username
</span></span><span style=display:flex><span>optionsConfig.password <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.password&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.password
</span></span><span style=display:flex><span>optionsConfig.database <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.database&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.database
</span></span><span style=display:flex><span>optionsConfig.host <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.host&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.host
</span></span><span style=display:flex><span>optionsConfig.port <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.port&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.port
</span></span><span style=display:flex><span>optionsConfig.sqlQuery <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.sql&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.sqlQuery
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mysqlLogin</span>(socket, username, password)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> status, response <span style=color:#f92672>=</span> mysql.receiveGreeting( socket )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>not</span>(status) ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mysql.loginRequest( socket, { authversion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;post41&#34;</span>, charset <span style=color:#f92672>=</span> response.charset }, username, password, response.salt )
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>portrule <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (host,port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>action <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(host,port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(socket:connect(optionsConfig.host,optionsConfig.port))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> status,response <span style=color:#f92672>=</span> mysqlLogin(socket,optionsConfig.username,optionsConfig.password)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(status)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> status, rs <span style=color:#f92672>=</span> mysql.sqlQuery( socket, optionsConfig.sqlQuery )
</span></span><span style=display:flex><span>            socket:close()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> result <span style=color:#f92672>=</span> mysql.formatResultset(rs, { noheaders <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>            stdnse.debug(string.format(<span style=color:#e6db74>&#34;[*]Query is %s | Result is  %s&#34;</span>,optionsConfig.sqlQuery,result))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> stdnse.format_output(<span style=color:#66d9ef>true</span>,result)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Connect to mysql Failed !!!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p><code>stdnse.get_script_args</code>是用于获取参数的函数，对应Nmap的&ndash;script-args参数。</p><h3 id=遇到的问题>遇到的问题</h3><p>在Nse扩展库中，无法与外部地址(除去扫描范围以外的目标)进行Socket连接。</p><p>因为大部分函数都接收绑定函数中的Host与Port参数，他们是一个table数据类型。</p><p>于是我翻阅API扩展，发现了一个方法可以直接获取一个IP+端口的套接字：</p><pre tabindex=0><code>socket = nmap.new_socket()
socket:set_timeout(1000)
socket:connect(HOST_ADDRESS,PORT_NUMBER)
</code></pre><p>如上方法我们可以直接传递IP地址与端口号就可以获得套接字了。</p><h2 id=0x04-扩展结构设计>0X04 扩展结构设计</h2><p>nse_main.lua 是声明全局变量、装载script db的预处理脚本，我们可以在其中将连接数据库的行为载入，然后用portrule函数进行数据库的读写。</p><blockquote><p>nmap &ndash;script=scan_save_database 127.0.0.1</p></blockquote><p>执行流程：</p><ul><li>nse_main.lua 装载</li><li>寻找 scan_save_database 脚本</li><li>主机发现</li><li>端口扫描</li><li>版本侦测</li><li>系统指纹侦测</li><li>&mldr;.</li><li>执行prerule函数</li><li>执行hostrule函数（如果返回true，执行action）</li><li>执行portrule函数 （如果返回true，执行action）</li><li>执行postrule函数</li></ul><p>主要是在扩展脚本中的portrule or hostrule 过滤我们的想要的数据，最后再action中对数据库进行读写。</p><p>下面演示一下获取开启80端口的所有主机：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> mysql <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;mysql&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> nmap <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;nmap&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stdnse <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;stdnse&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> shortport <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;shortport&#34;</span>
</span></span><span style=display:flex><span>description <span style=color:#f92672>=</span><span style=color:#e6db74>[[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>This is a Lua script that performs the MySQL statement.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>]]</span>
</span></span><span style=display:flex><span>author <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;China CoraLab payloads&#34;</span>
</span></span><span style=display:flex><span>license <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Same as Nmap--See https://nmap.org/book/man-legal.html&#34;</span>
</span></span><span style=display:flex><span>categories <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;external&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>socket <span style=color:#f92672>=</span> nmap.new_socket()
</span></span><span style=display:flex><span>socket:set_timeout(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>try <span style=color:#f92672>=</span> nmap.new_try(<span style=color:#66d9ef>function</span>() socket:close() <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>optionsConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>    sqlQuery <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INSERT INTO scan_table VALUES (NULL,&#39;%s&#39;,&#39;%s&#39;,&#39;%s&#39;)&#34;</span>,
</span></span><span style=display:flex><span>    host     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>    port     <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>optionsConfig.username <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.username&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.username
</span></span><span style=display:flex><span>optionsConfig.password <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.password&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.password
</span></span><span style=display:flex><span>optionsConfig.database <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.database&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.database
</span></span><span style=display:flex><span>optionsConfig.host <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.host&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.host
</span></span><span style=display:flex><span>optionsConfig.port <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.port&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.port
</span></span><span style=display:flex><span>optionsConfig.sqlQuery <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.sql&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.sqlQuery
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mysqlLogin</span>(socket, username, password)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> status, response <span style=color:#f92672>=</span> mysql.receiveGreeting( socket )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>not</span>(status) ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mysql.loginRequest( socket, { authversion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;post41&#34;</span>, charset <span style=color:#f92672>=</span> response.charset }, username, password, response.salt )
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>portrule<span style=color:#f92672>=</span><span style=color:#66d9ef>function</span>(host,port)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(port.number<span style=color:#f92672>==</span><span style=color:#ae81ff>80</span>) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;[*] Scan this host open 80 port -- &#34;</span> <span style=color:#f92672>..</span> host.ip)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- </span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- portrule = shortport.portnumber({80,443,8080},&#34;tcp&#34;,{&#34;open&#34;,&#34;open|filtered&#34;})</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- portrule = shortport.port_or_service({80,443,8080},&#34;http&#34;,&#34;tcp&#34;,{&#34;open&#34;,&#34;open|filtered&#34;})</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- portrule = service(&#34;http&#34;,&#34;tcp&#34;,{&#34;open&#34;})</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- </span>
</span></span><span style=display:flex><span>action<span style=color:#f92672>=</span><span style=color:#66d9ef>function</span>(host,port)
</span></span><span style=display:flex><span>	<span style=color:#75715e>-- load mysql lib</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>-- get scan info</span>
</span></span><span style=display:flex><span>	optionsConfig.sqlQuery <span style=color:#f92672>=</span> string.format(<span style=color:#e6db74>&#34;INSERT INTO scan_table VALUES (NULL,&#39;%s&#39;,&#39;%s&#39;,&#39;%s&#39;)&#34;</span>,host.ip,port.number,port.service)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(socket:connect(optionsConfig.host,optionsConfig.port))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> status,response <span style=color:#f92672>=</span> mysqlLogin(socket,optionsConfig.username,optionsConfig.password)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(status)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> status, rs <span style=color:#f92672>=</span> mysql.sqlQuery( socket, optionsConfig.sqlQuery )
</span></span><span style=display:flex><span>            socket:close()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> result <span style=color:#f92672>=</span> mysql.formatResultset(rs, { noheaders <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>            stdnse.debug(string.format(<span style=color:#e6db74>&#34;Query is %s | Result is  %s&#34;</span>,optionsConfig.sqlQuery,result))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> stdnse.format_output(<span style=color:#66d9ef>true</span>,host.ip)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Connect to mysql Failed !!!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>执行扫描：<code>nmap --script=scan_db --script-args username=root 192.168.3.183 -d -p 80</code></p><p>执行过程：</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x10.png alt=过程></p><p>不开启debug&mldr;</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x11.png alt=过程></p><p>结果：</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x12.png alt=结果></p><h2 id=0x05-more-ideas>0X05 More ideas</h2><h4 id=更多插件>更多插件&mldr;</h4><h4 id=实用的函数手册>实用的函数手册&mldr;</h4><h4 id=代码规范>代码规范</h4><h4 id=共同维护>共同维护</h4><h4 id=有效的任务调度>有效的任务调度</h4><h2 id=0x06-共同探讨>0x06 共同探讨</h2><p>倾旋
Email:payloads@aliyun.com</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2017-08-18/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>记一次某Cms的审计</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2017-07-31/1/><span>端口转发工具小结</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav></article></main><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>