<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Nmap扩展开发 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>07</span>
<span class=rest>Aug 2017</span></div></div><div class=matter><h1 class=title>Nmap扩展开发</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#0x00-资产扫描汇总实时监控>0x00 资产扫描、汇总、实时监控</a><ol><li><a href=#如何进行汇总实时监控>如何进行汇总、实时监控？</a></li></ol></li><li><a href=#0x01-解决方案>0X01 解决方案</a><ol><li><a href=#nmap简介目录结构扫描流程nse-engine>Nmap简介、目录结构、扫描流程、Nse Engine</a></li><li><a href=#0x02-简介>0X02 简介</a></li><li><a href=#目录结构>目录结构</a></li><li><a href=#扫描流程-v1>扫描流程 V1</a></li><li><a href=#扫描流程-v2>扫描流程 V2</a></li><li><a href=#nse-enginenmap-脚本引擎>Nse Engine（Nmap 脚本引擎）</a></li><li><a href=#nse-engine的执行流程>Nse Engine的执行流程</a></li></ol></li><li><a href=#0x03-一个简单的扩展打开世界>0X03 一个简单的扩展打开世界</a><ol><li><a href=#入库>入库</a></li><li><a href=#遇到的问题>遇到的问题</a></li></ol></li><li><a href=#0x04-扩展结构设计>0X04 扩展结构设计</a></li><li><a href=#0x05-more-ideas>0X05 More ideas</a><ol><li></li></ol></li><li><a href=#0x06-共同探讨>0x06 共同探讨</a></li></ol></nav></aside><h2 id=0x00-资产扫描汇总实时监控>0x00 资产扫描、汇总、实时监控</h2><p>资产扫描能够有利于企业内部查看终端、监控终端、对终端进行安全加固。周期性的扫描能有效快速修补漏洞、降低办公网络风险。</p><h3 id=如何进行汇总实时监控>如何进行汇总、实时监控？</h3><p>在我们要进行汇总的时候，有如下几个可以考虑的方案。</p><ul><li>PDF</li><li>Excel</li><li>Text</li><li>Database / SQL</li></ul><p>PDF && Excel && Text 都不适合实时View</p><p>Database / SQL 有利于生成数据汇总、图表，并且可移植性很高。</p><p>Database -> Web -> Excel/PDF &mldr;. 可行性都变得高了起来</p><p>实时监控采用任务调度，数据库采用IO效率高的NO SQL产品，详细信息采用普通的数据库：MySQL、SQL Server、Oracel&mldr;</p><h2 id=0x01-解决方案>0X01 解决方案</h2><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x01.png alt=解决方案></p><h3 id=nmap简介目录结构扫描流程nse-engine>Nmap简介、目录结构、扫描流程、Nse Engine</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/nmap.jpg alt=Nmap></p><h3 id=0x02-简介>0X02 简介</h3><p>Nmap (“Network Mapper(网络映射器)”) 是一款开放源代码的 网络探测和安全审核的工具。它的设计目标是快速地扫描大型网络，当然用它扫描单个 主机也没有问题。Nmap以新颖的方式使用原始IP报文来发现网络上有哪些主机，那些 主机提供什么服务(应用程序名和版本)，那些服务运行在什么操作系统(包括版本信息)， 它们使用什么类型的报文过滤器/防火墙，以及一堆其它功能。虽然Nmap通常用于安全审核， 许多系统管理员和网络管理员也用它来做一些日常的工作，比如查看整个网络的信息， 管理服务升级计划，以及监视主机和服务的运行。</p><h3 id=目录结构>目录结构</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x02.png alt=目录结构></p><h3 id=扫描流程-v1>扫描流程 V1</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x03.png alt="扫描流程 V1"></p><h3 id=扫描流程-v2>扫描流程 V2</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x05.png alt="扫描流程 V2"></p><h3 id=nse-enginenmap-脚本引擎>Nse Engine（Nmap 脚本引擎）</h3><p>Nmap Nse 脚本引擎用于针对发现的OS、主机、端口进行不同的操作，例如：Fuzz测试、漏洞发现、漏洞利用等。这对Nmap又增添了一大亮点，所以说Nmap不只是一个扫描工具，在黑客的手中，更是一款爱不释手的渗透工具。</p><h3 id=nse-engine的执行流程>Nse Engine的执行流程</h3><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x04.png alt=Nse流程></p><h2 id=0x03-一个简单的扩展打开世界>0X03 一个简单的扩展打开世界</h2><p><a href=https://nmap.org/book/nse-api.html>https://nmap.org/book/nse-api.html</a></p><p>Nmap扩展主要由以下几个变量构成。编码方式：变量绑定函数</p><p>顺序为：<code>Prerule -> Hostrule or Portrule -> Action -> Postrule</code></p><p>当 <code>Hostrule</code> 或者 <code>Portrule</code> 的绑定函数返回<code>true</code>的时候，都会执行一次<code>Action</code>的绑定函数。</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x06.png alt=函数流程></p><h3 id=入库>入库</h3><p>获取参数->连接数据库 -> 采用不同条件判断期望获取到的值->执行SQL</p><p>获取参数：stdnse lib [stdnse.get_script_args()]</p><p>连接数据库：mysql lib</p><p>获取socket : nmap socket lib</p><p>socket = nmap.new_socket() &ndash; 获得一个新的socket套接字</p><p>socket:set_timeout(1000) &ndash; 设置超时时间</p><p>socket:connect(host_ip,port_number) &ndash; 连接目标</p><p>socket:close() &ndash; 关闭套接字连接</p><p>我自己根据API封装了一个执行MySQL Query的扩展：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> mysql <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;mysql&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> nmap <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;nmap&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stdnse <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;stdnse&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>description <span style=color:#f92672>=</span><span style=color:#e6db74>[[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>This is a Lua script that performs the MySQL statement.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>]]</span>
</span></span><span style=display:flex><span>author <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;China CoraLab payloads&#34;</span>
</span></span><span style=display:flex><span>license <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Same as Nmap--See https://nmap.org/book/man-legal.html&#34;</span>
</span></span><span style=display:flex><span>categories <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;external&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>socket <span style=color:#f92672>=</span> nmap.new_socket()
</span></span><span style=display:flex><span>socket:set_timeout(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>try <span style=color:#f92672>=</span> nmap.new_try(<span style=color:#66d9ef>function</span>() socket:close() <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>optionsConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>    sqlQuery <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SELECT MD5(&#39;admin&#39;),&#34;</span>,
</span></span><span style=display:flex><span>    host     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>    port     <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>optionsConfig.username <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.username&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.username
</span></span><span style=display:flex><span>optionsConfig.password <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.password&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.password
</span></span><span style=display:flex><span>optionsConfig.database <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.database&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.database
</span></span><span style=display:flex><span>optionsConfig.host <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.host&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.host
</span></span><span style=display:flex><span>optionsConfig.port <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.port&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.port
</span></span><span style=display:flex><span>optionsConfig.sqlQuery <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.sql&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.sqlQuery
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mysqlLogin</span>(socket, username, password)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> status, response <span style=color:#f92672>=</span> mysql.receiveGreeting( socket )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>not</span>(status) ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mysql.loginRequest( socket, { authversion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;post41&#34;</span>, charset <span style=color:#f92672>=</span> response.charset }, username, password, response.salt )
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>portrule <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (host,port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>action <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(host,port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(socket:connect(optionsConfig.host,optionsConfig.port))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> status,response <span style=color:#f92672>=</span> mysqlLogin(socket,optionsConfig.username,optionsConfig.password)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(status)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> status, rs <span style=color:#f92672>=</span> mysql.sqlQuery( socket, optionsConfig.sqlQuery )
</span></span><span style=display:flex><span>            socket:close()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> result <span style=color:#f92672>=</span> mysql.formatResultset(rs, { noheaders <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>            stdnse.debug(string.format(<span style=color:#e6db74>&#34;[*]Query is %s | Result is  %s&#34;</span>,optionsConfig.sqlQuery,result))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> stdnse.format_output(<span style=color:#66d9ef>true</span>,result)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Connect to mysql Failed !!!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p><code>stdnse.get_script_args</code>是用于获取参数的函数，对应Nmap的&ndash;script-args参数。</p><h3 id=遇到的问题>遇到的问题</h3><p>在Nse扩展库中，无法与外部地址(除去扫描范围以外的目标)进行Socket连接。</p><p>因为大部分函数都接收绑定函数中的Host与Port参数，他们是一个table数据类型。</p><p>于是我翻阅API扩展，发现了一个方法可以直接获取一个IP+端口的套接字：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>socket = nmap.new_socket()
</span></span><span style=display:flex><span>socket:set_timeout(1000)
</span></span><span style=display:flex><span>socket:connect(HOST_ADDRESS,PORT_NUMBER)
</span></span></code></pre></td></tr></table></div></div><p>如上方法我们可以直接传递IP地址与端口号就可以获得套接字了。</p><h2 id=0x04-扩展结构设计>0X04 扩展结构设计</h2><p>nse_main.lua 是声明全局变量、装载script db的预处理脚本，我们可以在其中将连接数据库的行为载入，然后用portrule函数进行数据库的读写。</p><blockquote><p>nmap &ndash;script=scan_save_database 127.0.0.1</p></blockquote><p>执行流程：</p><ul><li>nse_main.lua 装载</li><li>寻找 scan_save_database 脚本</li><li>主机发现</li><li>端口扫描</li><li>版本侦测</li><li>系统指纹侦测</li><li>&mldr;.</li><li>执行prerule函数</li><li>执行hostrule函数（如果返回true，执行action）</li><li>执行portrule函数 （如果返回true，执行action）</li><li>执行postrule函数</li></ul><p>主要是在扩展脚本中的portrule or hostrule 过滤我们的想要的数据，最后再action中对数据库进行读写。</p><p>下面演示一下获取开启80端口的所有主机：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> mysql <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;mysql&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> nmap <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;nmap&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> stdnse <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;stdnse&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> shortport <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;shortport&#34;</span>
</span></span><span style=display:flex><span>description <span style=color:#f92672>=</span><span style=color:#e6db74>[[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>This is a Lua script that performs the MySQL statement.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>]]</span>
</span></span><span style=display:flex><span>author <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;China CoraLab payloads&#34;</span>
</span></span><span style=display:flex><span>license <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Same as Nmap--See https://nmap.org/book/man-legal.html&#34;</span>
</span></span><span style=display:flex><span>categories <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;external&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>socket <span style=color:#f92672>=</span> nmap.new_socket()
</span></span><span style=display:flex><span>socket:set_timeout(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>try <span style=color:#f92672>=</span> nmap.new_try(<span style=color:#66d9ef>function</span>() socket:close() <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>optionsConfig <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>    sqlQuery <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;INSERT INTO scan_table VALUES (NULL,&#39;%s&#39;,&#39;%s&#39;,&#39;%s&#39;)&#34;</span>,
</span></span><span style=display:flex><span>    host     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>    port     <span style=color:#f92672>=</span>  <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>optionsConfig.username <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.username&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.username
</span></span><span style=display:flex><span>optionsConfig.password <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.password&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.password
</span></span><span style=display:flex><span>optionsConfig.database <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.database&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.database
</span></span><span style=display:flex><span>optionsConfig.host <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.host&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.host
</span></span><span style=display:flex><span>optionsConfig.port <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.port&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.port
</span></span><span style=display:flex><span>optionsConfig.sqlQuery <span style=color:#f92672>=</span> stdnse.get_script_args(SCRIPT_NAME <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;.sql&#34;</span>) <span style=color:#f92672>or</span> optionsConfig.sqlQuery
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mysqlLogin</span>(socket, username, password)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> status, response <span style=color:#f92672>=</span> mysql.receiveGreeting( socket )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>not</span>(status) ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mysql.loginRequest( socket, { authversion <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;post41&#34;</span>, charset <span style=color:#f92672>=</span> response.charset }, username, password, response.salt )
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>portrule<span style=color:#f92672>=</span><span style=color:#66d9ef>function</span>(host,port)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(port.number<span style=color:#f92672>==</span><span style=color:#ae81ff>80</span>) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;[*] Scan this host open 80 port -- &#34;</span> <span style=color:#f92672>..</span> host.ip)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- </span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- portrule = shortport.portnumber({80,443,8080},&#34;tcp&#34;,{&#34;open&#34;,&#34;open|filtered&#34;})</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- portrule = shortport.port_or_service({80,443,8080},&#34;http&#34;,&#34;tcp&#34;,{&#34;open&#34;,&#34;open|filtered&#34;})</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- portrule = service(&#34;http&#34;,&#34;tcp&#34;,{&#34;open&#34;})</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- </span>
</span></span><span style=display:flex><span>action<span style=color:#f92672>=</span><span style=color:#66d9ef>function</span>(host,port)
</span></span><span style=display:flex><span>	<span style=color:#75715e>-- load mysql lib</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>-- get scan info</span>
</span></span><span style=display:flex><span>	optionsConfig.sqlQuery <span style=color:#f92672>=</span> string.format(<span style=color:#e6db74>&#34;INSERT INTO scan_table VALUES (NULL,&#39;%s&#39;,&#39;%s&#39;,&#39;%s&#39;)&#34;</span>,host.ip,port.number,port.service)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(socket:connect(optionsConfig.host,optionsConfig.port))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> status,response <span style=color:#f92672>=</span> mysqlLogin(socket,optionsConfig.username,optionsConfig.password)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(status)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> status, rs <span style=color:#f92672>=</span> mysql.sqlQuery( socket, optionsConfig.sqlQuery )
</span></span><span style=display:flex><span>            socket:close()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> result <span style=color:#f92672>=</span> mysql.formatResultset(rs, { noheaders <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> })
</span></span><span style=display:flex><span>            stdnse.debug(string.format(<span style=color:#e6db74>&#34;Query is %s | Result is  %s&#34;</span>,optionsConfig.sqlQuery,result))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> stdnse.format_output(<span style=color:#66d9ef>true</span>,host.ip)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Connect to mysql Failed !!!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></td></tr></table></div></div><p>执行扫描：<code>nmap --script=scan_db --script-args username=root 192.168.3.183 -d -p 80</code></p><p>执行过程：</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x10.png alt=过程></p><p>不开启debug&mldr;</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x11.png alt=过程></p><p>结果：</p><p><img src=https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2017-08-07/0x12.png alt=结果></p><h2 id=0x05-more-ideas>0X05 More ideas</h2><h4 id=更多插件>更多插件&mldr;</h4><h4 id=实用的函数手册>实用的函数手册&mldr;</h4><h4 id=代码规范>代码规范</h4><h4 id=共同维护>共同维护</h4><h4 id=有效的任务调度>有效的任务调度</h4><h2 id=0x06-共同探讨>0x06 共同探讨</h2><p>倾旋
Email:payloads@aliyun.com</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#0x00-资产扫描汇总实时监控>0x00 资产扫描、汇总、实时监控</a><ol><li><a href=#如何进行汇总实时监控>如何进行汇总、实时监控？</a></li></ol></li><li><a href=#0x01-解决方案>0X01 解决方案</a><ol><li><a href=#nmap简介目录结构扫描流程nse-engine>Nmap简介、目录结构、扫描流程、Nse Engine</a></li><li><a href=#0x02-简介>0X02 简介</a></li><li><a href=#目录结构>目录结构</a></li><li><a href=#扫描流程-v1>扫描流程 V1</a></li><li><a href=#扫描流程-v2>扫描流程 V2</a></li><li><a href=#nse-enginenmap-脚本引擎>Nse Engine（Nmap 脚本引擎）</a></li><li><a href=#nse-engine的执行流程>Nse Engine的执行流程</a></li></ol></li><li><a href=#0x03-一个简单的扩展打开世界>0X03 一个简单的扩展打开世界</a><ol><li><a href=#入库>入库</a></li><li><a href=#遇到的问题>遇到的问题</a></li></ol></li><li><a href=#0x04-扩展结构设计>0X04 扩展结构设计</a></li><li><a href=#0x05-more-ideas>0X05 More ideas</a><ol><li></li></ol></li><li><a href=#0x06-共同探讨>0x06 共同探讨</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2017 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>