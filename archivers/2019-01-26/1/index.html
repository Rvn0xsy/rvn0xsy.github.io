<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Windows 2019 Bypass (UAC、Defender) to Metasploit - 倾旋的博客</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/main.css><link rel=stylesheet type=text/css media=screen href=https://payloads.online/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://payloads.online/css/dark.css><script src=https://payloads.online/js/feather.min.js></script><script src=https://payloads.online/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://payloads.online/><img src=/avatar.jpeg alt=倾旋的博客></a></div><h1 class=site-title><a href=https://payloads.online/>倾旋的博客</a></h1><div class=site-description><p>现阶段在进行有效性验证/攻击模拟相关的安全研究工作，我的博客会记录一些我的学习过程和部分安全技术研究成果。</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/rvn0xsy/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/>文章列表</a></li><li><a href=/tags>标签</a></li><li><a href=/projects>开源项目</a></li><li><a href=/about>关于我</a></li><li><a href=/links/>友情链接</a></li><li><a href=/message>留言</a></li><li><a href=/sponsor>赞助</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>26</span>
<span class=rest>Jan 2019</span></div></div><div class=matter><h1 class=title>Windows 2019 Bypass (UAC、Defender) to Metasploit</h1></div></div><h2 id=0x00-前言>0x00 前言</h2><p>昨天下午在小密圈看到一篇文章：https://egre55.github.io/system-properties-uac-bypass/</p><p>文中指出 <code>SystemPropertiesAdvanced.exe</code> 有DLL劫持漏洞，经过分析，在Windows 10下无法复现</p><p>之前也做过关于DLL劫持、Bypass UAC的议题：<a href=https://payloads.online/archivers/2018-12-22/1>DLL Hijacking & COM Hijacking ByPass UAC - 议题解读</a></p><p>在向下阅读前，请先掌握DLL劫持和Bypass UAC的基本知识。</p><p>微信交流群，加我微信：Guest_Killer_0nlis。</p><h2 id=0x01-cooolis>0x01 Cooolis</h2><p>Cooolis是我写的一个支持MSF与Cobaltstrike上线的加载器，能够100%绕过绝大部分杀软，包含国内90%以上、Windows Defender等。</p><p>之前发出了演示视频，在这里可以看到：<a href=https://payloads.online/archivers/2019-01-21/1>Cobalt Strike - Metasploit Bypass AV</a></p><p>然后这个操作系统缺陷由于拥有自动权限提升的权限 <code>autoElevate</code>属性，我们可以利用它来执行Cooolis，使得Coolis上线的会话同样拥有管理员权限。</p><p>关于Bypass UAC的挖掘方法与原理，我的议题已经转化成了视频：</p><h2 id=0x02-效果演示>0x02 效果演示</h2><p>Windows 2019中的<code>C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe</code>在运行时，会寻找<code>srrstr.dll</code>，这个DLL文件并不存在于：</p><ul><li>C:\Windows\SysWOW64\srrstr.dll</li><li>C:\Windows\System\srrstr.dll</li><li>C:\Windows\srrstr.dll</li><li>C:\Windows\SysWOW64\wbem\srrstr.dll</li><li>C:\Windows\SysWOW64\WindowsPowershell\v1.0\srrstr.dll</li><li>C:\Users&lt;Username>\APPData\Local\Microsoft\WindowsApps\srrstr.dll</li></ul><p>在最后它会寻找<code>C:\Users\&lt;Username>\APPData\Local\Microsoft\WindowsApps\</code>这个目录，而这个目录的读写是不需要触发UAC获得管理员权限来操作的。</p><p>由此，可以利用该缺陷，将Coolis转换成DLL，上传至<code>C:\Users\&lt;Username>\APPData\Local\Microsoft\WindowsApps\</code>，紧接着执行SystemPropertiesAdvanced.exe，它会自动将<code>srrstr.dll</code>加载至SystemPropertiesAdvanced.exe进程的内存，同样的，我们也就拥有了管理员权限。</p><p>在此之前，我有想过在下列模块里做一些优化：</p><ul><li>exploit/windows/local/bypassuac_fodhelper</li><li>exploit/windows/local/bypassuac_injection</li><li>exploit/windows/local/bypassuac_comhijack</li></ul><p>我觉得COM劫持的空间还是很大的，并且也一定程度上能够bypass AV。</p><p>Demo：</p><h2 id=0x03-总结>0x03 总结</h2><p>UAC、DLL劫持、COM劫持的问题肯定还会有很多、但是以前的轮子到现在拿起来用基本上都会被行为拦截，这就需要掌握原理去自己探索、创造。</p><p>系统镜像：<code>ed2k://|file|cn_windows_server_2019_x64_dvd_4de40f33.iso|5086887936|7DCDDD6B0C60A0D019B6A93D8F2B6D31|/</code></p><hr class=footer-separator><div class=tags></div><div class=back><a href=https://payloads.online/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><script src=https://giscus.app/client.js data-repo=Rvn0xsy/rvn0xsy.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk0MDEyMzI3MTY=" data-category=General data-category-id=DIC_kwDOF-pTTM4CRDk_ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark_tritanopia data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2019 倾旋 All rights reserved</div></nav></div><script>feather.replace()</script></body></html>